#!/bin/bash
# Hook pre-commit pour bloquer les secrets hardcod√©s

echo "üîç V√©rification des secrets hardcod√©s..."

# Patterns √† d√©tecter
PATTERNS=(
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"  # JWT Supabase
    "sk-ant-api"                              # Cl√© Anthropic
    "supabaseKey.*=.*['\"]eyJ"                # Variable avec cl√© Supabase
    "SUPABASE.*KEY.*=.*['\"]eyJ"              # Variable env avec cl√©
)

# Fichiers √† scanner (staged)
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|json|sql|sh)$')

if [ -z "$FILES" ]; then
    echo "‚úÖ Aucun fichier √† v√©rifier"
    exit 0
fi

FOUND_SECRET=0

for FILE in $FILES; do
    for PATTERN in "${PATTERNS[@]}"; do
        if grep -qE "$PATTERN" "$FILE" 2>/dev/null; then
            echo "‚ùå SECRET D√âTECT√â dans $FILE"
            echo "   Pattern: $PATTERN"
            FOUND_SECRET=1
        fi
    done
done

if [ $FOUND_SECRET -eq 1 ]; then
    echo ""
    echo "üö® COMMIT BLOQU√â - Secrets d√©tect√©s !"
    echo "‚ö†Ô∏è  Utilise des variables d'environnement au lieu de hardcoder."
    echo ""
    exit 1
fi

echo "‚úÖ Aucun secret d√©tect√© - Commit autoris√©"
exit 0
