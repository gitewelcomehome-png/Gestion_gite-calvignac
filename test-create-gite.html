<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Cr√©ation G√Æte</title>
</head>
<body>
    <h1>Test Cr√©ation G√Æte - Diagnostic</h1>
    <div id="logs" style="font-family: monospace; white-space: pre-wrap;"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/shared-config.js"></script>
    
    <script>
        const log = (msg) => {
            console.log(msg);
            document.getElementById('logs').innerHTML += msg + '\n';
        };
        
        async function testCreateGite() {
            try {
                log('=== TEST CR√âATION G√éTE ===\n');
                
                // 1. V√©rifier la connexion
                log('1Ô∏è‚É£ V√©rification session...');
                const { data: { session }, error: sessionError } = await window.supabaseClient.auth.getSession();
                if (sessionError) throw sessionError;
                if (!session) throw new Error('Pas de session');
                log(`‚úÖ Session OK: ${session.user.email}`);
                log(`   User ID: ${session.user.id}\n`);
                
                // 2. V√©rifier la table gites
                log('2Ô∏è‚É£ Test lecture table gites...');
                const { data: existingGites, error: readError } = await window.supabaseClient
                    .from('gites')
                    .select('*');
                if (readError) {
                    log(`‚ùå Erreur lecture: ${readError.message}`);
                    log(`   Code: ${readError.code}`);
                    log(`   Details: ${readError.details}\n`);
                } else {
                    log(`‚úÖ Lecture OK: ${existingGites.length} g√Æte(s) existant(s)\n`);
                }
                
                // 3. Pr√©parer les donn√©es
                log('3Ô∏è‚É£ Pr√©paration donn√©es...');
                const testData = {
                    owner_user_id: session.user.id,
                    name: 'Test G√Æte ' + Date.now(),
                    slug: 'test-gite-' + Date.now(),
                    icon: 'home',
                    color: '#667eea',
                    capacity: 4,
                    address: 'Test Address',
                    ical_sources: {},
                    is_active: true
                };
                log('üì¶ Donn√©es √† ins√©rer:');
                log(JSON.stringify(testData, null, 2) + '\n');
                
                // 4. Tester l'insertion
                log('4Ô∏è‚É£ Test insertion...');
                const { data, error } = await window.supabaseClient
                    .from('gites')
                    .insert(testData)
                    .select()
                    .single();
                
                if (error) {
                    log(`‚ùå ERREUR INSERTION:`);
                    log(`   Message: ${error.message}`);
                    log(`   Code: ${error.code}`);
                    log(`   Details: ${error.details}`);
                    log(`   Hint: ${error.hint || 'N/A'}`);
                    
                    // Afficher l'erreur compl√®te
                    log(`\nüìã Erreur compl√®te:`);
                    log(JSON.stringify(error, null, 2));
                } else {
                    log(`‚úÖ SUCC√àS !`);
                    log(`   ID: ${data.id}`);
                    log(`   Nom: ${data.name}`);
                    log(`\nüéâ Le g√Æte a √©t√© cr√©√© avec succ√®s !`);
                }
                
            } catch (error) {
                log(`\nüí• EXCEPTION:`);
                log(`   ${error.message}`);
                log(JSON.stringify(error, null, 2));
            }
        }
        
        // Lancer le test automatiquement
        window.addEventListener('load', () => {
            setTimeout(testCreateGite, 1000);
        });
    </script>
</body>
</html>
