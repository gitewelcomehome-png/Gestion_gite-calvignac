// ================================================================
// üé´ WIDGET SUPPORT DASHBOARD
// ================================================================
// Affiche les tickets support en attente sur le dashboard admin
// ================================================================

console.log('üöÄ DEBUG: Fichier dashboard-support-widget.js charg√©');

async function loadSupportTickets() {
    console.log('üîç DEBUG: Chargement tickets support...');
    
    try {
        // V√©rifier que Supabase est charg√©
        if (!window.supabaseClient) {
            console.error('‚ùå DEBUG: window.supabaseClient non disponible');
            return;
        }
        console.log('‚úÖ DEBUG: Supabase client OK');
        
        // V√©rifier les √©l√©ments DOM
        const section = document.getElementById('dashboard-tickets-support');
        const badge = document.getElementById('badge-tickets-count');
        const liste = document.getElementById('liste-tickets-support');
        
        console.log('üîç DEBUG: √âl√©ments DOM:', {
            section: !!section,
            badge: !!badge,
            liste: !!liste
        });
        
        if (!section || !badge || !liste) {
            console.error('‚ùå DEBUG: √âl√©ments DOM manquants');
            return;
        }
        
        // R√©cup√©rer les tickets en attente (ouvert, en_cours, en_attente)
        console.log('üîç DEBUG: Requ√™te Supabase...');
        const { data: tickets, error } = await window.supabaseClient
            .from('cm_support_tickets')
            .select(`
                *,
                cm_clients!inner(nom_entreprise, email)
            `)
            .in('statut', ['ouvert', 'en_cours', 'en_attente'])
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (error) {
            console.error('‚ùå DEBUG: Erreur Supabase:', error);
            throw error;
        }
        
        console.log('üìä DEBUG: Tickets re√ßus:', tickets ? tickets.length : 0, tickets);
        
        if (!tickets || tickets.length === 0) {
            console.log('‚ö†Ô∏è DEBUG: Aucun ticket en attente - masquage section');
            section.style.display = 'none';
            return;
        }
        
        // Afficher la section
        console.log('‚úÖ DEBUG: Affichage de', tickets.length, 'ticket(s)');
        section.style.display = 'block';
        badge.textContent = tickets.length;
        
        // Construire le HTML
        const html = tickets.map(ticket => {
            const priorityClass = ticket.priorite === 'haute' ? 'danger' : ticket.priorite === 'normale' ? 'warning' : 'info';
            const statutLabel = {
                'ouvert': 'Nouveau',
                'en_cours': 'En cours',
                'en_attente': 'En attente'
            }[ticket.statut] || ticket.statut;
            
            return `
                <div class="alert-item" onclick="window.location.href='pages/admin-support.html?ticket=${ticket.id}';" style="cursor: pointer;">
                    <div class="alert-item__header">
                        <span class="badge badge--${priorityClass}">${ticket.priorite}</span>
                        <span class="badge badge--outline">${statutLabel}</span>
                        <span class="alert-item__date">${getTimeAgo(ticket.created_at)}</span>
                    </div>
                    <div class="alert-item__content">
                        <strong>${escapeHtml(ticket.sujet)}</strong>
                        <p>${escapeHtml(ticket.cm_clients.nom_entreprise || ticket.cm_clients.email)}</p>
                    </div>
                </div>
            `;
        }).join('');
        console.log('üìù DEBUG: HTML g√©n√©r√©:', html.substring(0, 200) + '...');
        liste.innerHTML = html;
        console.log('‚úÖ DEBUG: Widget tickets support affich√© avec succ√®s');
        
    } catch (error) {
        console.error('‚ùå DEBUG: Erreur chargement tickets support:', error);
        console.error('‚ùå DEBUG: Stack:', error.stack
        console.error('‚ùå Erreur chargement tickets support:', error);
    }
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - new Date(date)) / 1000);
    if (seconds < 60) return '√Ä l\'instant';
    if (seconds < 3600) return `Il y a ${Math.floor(seconds / 60)} min`;
    if (seconds < 86400) return `Il y a ${Math.floor(seconds / 3600)} h`;
    return `Il y a ${Math.floor(seconds / 86400)} j`;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
console.log('üöÄ DEBUG: Initialisation widget support dashboard');

const widgetSection = document.getElementById('dashboard-tickets-support');
console.log('üîç DEBUG: Section trouv√©e:', !!widgetSection);

if (widgetSection) {
    // Attendre que Supabase soit charg√©
    let attemptCount = 0;
    const checkSupabase = setInterval(() => {
        attemptCount++;
        console.log(`üîç DEBUG: Tentative ${attemptCount} - V√©rification Supabase...`);
        
        if (window.supabaseClient) {
            console.log('‚úÖ DEBUG: Supabase d√©tect√© - chargement tickets');
            clearInterval(checkSupabase);
            loadSupportTickets();
            setInterval(loadSupportTickets, 30000); // Actualisation toutes les 30s
        } else if (attemptCount >= 50) {
            console.error('‚ùå DEBUG: Timeout - Supabase non charg√© apr√®s 5s');
            clearInterval(checkSupabase);
        }
    }, 100);
} else {
    console.error('‚ùå DEBUG: Section dashboard-tickets-support introuvable dans le DOM'
    
    // Timeout apr√®s 5 secondes
    setTimeout(() => clearInterval(checkSupabase), 5000);
}

console.log('‚úÖ Widget Support Dashboard charg√©');

})(); // Fin IIFE
