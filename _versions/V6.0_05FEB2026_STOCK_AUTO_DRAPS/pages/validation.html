<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation M√©nages - Entreprise</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuration partag√©e -->
    <script src="../js/shared-config.js"></script>
    
    <!-- üè¢ MULTI-TENANT: Gestionnaire dynamique des g√Ætes -->
    <script src="../js/gites-manager.js"></script>
    
    <!-- üõ°Ô∏è PHASE 3 S√âCURIT√â: Protection XSS -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <script type="module" src="../js/security-utils.js"></script>
    
    <!-- CSS Neo-Brutalism du site -->
    <link rel="stylesheet" href="../css/main.css?v=1.0" />
    
    <style>
        body {
            padding-top: 20px !important;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border: 3px solid #2D3436;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 4px 4px 0 #2D3436;
            text-align: center;
        }

        .header h1 {
            color: #2D3436;
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .header p {
            color: #636e72;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .week-card {
            background: white;
            border: 3px solid #2D3436;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 4px 4px 0 #2D3436;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: white;
            border: 3px solid #2D3436;
            border-radius: 10px;
            box-shadow: 3px 3px 0 #2D3436;
        }

        .week-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2D3436;
            text-transform: uppercase;
        }

        .week-dates {
            color: #636e72;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .gites-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .gite-column {
            width: 100%;
            background: white;
            border: 3px solid #2D3436;
            border-radius: 12px;
            padding: 0;
            box-shadow: 4px 4px 0 #2D3436;
        }

        .gite-header {
            font-size: 1.1rem;
            font-weight: 700;
            padding: 15px;
            color: #2D3436;
            text-align: center;
            border-bottom: 3px solid #2D3436;
            border-radius: 9px 9px 0 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: white;
        }

        /* Style Vision Globale - fond l√©ger color√© */
        .gite-column[data-gite-slug*="trvoux"] .gite-header {
            background: rgba(102, 126, 234, 0.08);
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .gite-column[data-gite-slug*="couzon"] .gite-header {
            background: rgba(231, 76, 60, 0.08);
            border-bottom-color: #E74C3C;
            color: #E74C3C;
        }

        .gite-column[data-gite-slug*="3me"] .gite-header {
            background: rgba(39, 174, 96, 0.08);
            border-bottom-color: #27AE60;
            color: #27AE60;
        }

        .gite-column[data-gite-slug*="4me"] .gite-header {
            background: rgba(162, 155, 254, 0.08);
            border-bottom-color: #a29bfe;
            color: #a29bfe;
        }

        /* Items de m√©nage - Style Vision Globale */
        .menage-item {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin: 12px;
            transition: all 0.2s;
        }

        /* Couleurs des bordures et ombres par g√Æte */
        .gite-column[data-gite-slug*="trvoux"] .menage-item {
            border: 2px solid #667eea !important;
            box-shadow: 2px 2px 0 #667eea !important;
        }

        .gite-column[data-gite-slug*="couzon"] .menage-item {
            border: 2px solid #E74C3C !important;
            box-shadow: 2px 2px 0 #E74C3C !important;
        }

        .gite-column[data-gite-slug*="3me"] .menage-item {
            border: 2px solid #27AE60 !important;
            box-shadow: 2px 2px 0 #27AE60 !important;
        }

        .gite-column[data-gite-slug*="4me"] .menage-item {
            border: 2px solid #a29bfe !important;
            box-shadow: 2px 2px 0 #a29bfe !important;
        }

        .menage-item:hover {
            transform: translate(-1px, -1px);
        }

        .gite-column[data-gite-slug*="trvoux"] .menage-item:hover {
            box-shadow: 3px 3px 0 #667eea !important;
        }

        .gite-column[data-gite-slug*="couzon"] .menage-item:hover {
            box-shadow: 3px 3px 0 #E74C3C !important;
        }

        .gite-column[data-gite-slug*="3me"] .menage-item:hover {
            box-shadow: 3px 3px 0 #27AE60 !important;
        }

        .gite-column[data-gite-slug*="4me"] .menage-item:hover {
            box-shadow: 3px 3px 0 #a29bfe !important;
        }

        .menage-date {
            font-weight: 700;
            color: #2D3436;
            margin-bottom: 8px;
            font-size: 1.05rem;
        }

        .menage-client {
            color: #636e72;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .menage-period {
            font-size: 0.9rem;
            color: #636e72;
            margin-bottom: 10px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.03);
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            font-weight: 600;
        }

        .time-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .time-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #2D3436;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            box-shadow: 2px 2px 0 #2D3436;
        }

        .time-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 #2D3436;
        }

        .time-btn.selected {
            background: #74b9ff;
            color: #2D3436;
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 #2D3436;
        }

        .date-selector {
            margin-bottom: 10px;
        }

        .date-selector label {
            display: block;
            font-weight: 700;
            margin-bottom: 5px;
            color: #2D3436;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .date-selector input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #2D3436;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #2D3436;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: 3px 3px 0 #2D3436;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 #2D3436;
        }

        .btn:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 #2D3436;
        }

        .btn-validate {
            background: #55efc4;
            color: #2D3436;
        }

        .btn-propose {
            background: #74b9ff;
            color: #2D3436;
        }

        .btn-cancel {
            background: #ff6b6b;
            color: white;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-waiting {
            background: #d1ecf1;
            color: #0c5460;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-validated {
            background: #d4edda;
            color: #155724;
        }

        .status-refused {
            background: #f8d7da;
            color: #721c24;
        }

        .status-modified {
            background: #d1ecf1;
            color: #0c5460;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .gites-container {
                flex-direction: column;
            }
            .gite-column {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßπ Validation des M√©nages</h1>
            <p>Entreprise de m√©nage - Valider ou proposer d'autres dates</p>
        </div>

        <div id="notificationsBanner" style="display: none;"></div>

        <div id="planningContainer">
            <div class="week-card">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <h2>Chargement...</h2>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">
        <span id="toastIcon" style="font-size: 1.5rem;">‚úì</span>
        <span id="toastMessage"></span>
    </div>

    <script>
        // Utiliser le client Supabase d√©j√† initialis√© dans shared-config.js
        const supabaseClient = window.supabaseClient;

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');

            icon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
            messageEl.textContent = message;
            
            toast.style.display = 'flex';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function displayNotifications(menages) {
            const banner = document.getElementById('notificationsBanner');
            
            // Calculer la date limite (dans 2 semaines)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const twoWeeksLater = new Date(today);
            twoWeeksLater.setDate(today.getDate() + 14);
            
            // Filtrer les notifications des 2 prochaines semaines uniquement
            const menagesDeuxSemaines = menages.filter(m => {
                const menageDate = m.scheduledDate;
                return menageDate >= today && menageDate <= twoWeeksLater;
            });
            
            // Afficher UNIQUEMENT les refus√©s (√† corriger)
            const notifications = menagesDeuxSemaines.filter(m => m.status === 'refused');
            
            if (notifications.length === 0) {
                banner.style.display = 'none';
                return;
            }
            
            let html = '<div class="notifications-banner">';
            html += '<div class="banner-header">';
            html += '<span>üîî Refus √† corriger (2 prochaines semaines)</span>';
            html += `<span class="notification-count">${notifications.length}</span>`;
            html += '</div>';
            
            notifications.forEach(menageInfo => {
                const menageDate = menageInfo.scheduledDate;
                const day = menageDate.getDate();
                const month = menageDate.getMonth() + 1;
                const year = menageDate.getFullYear();
                const dateFormatted = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
                
                html += `<div class="notification-item refused">`;
                html += `<span class="notification-icon">‚ùå</span>`;
                html += '<div class="notification-content">';
                html += `<div class="notification-title">Refus√© par le propri√©taire</div>`;
                html += `<div class="notification-details">`;
                html += `<strong>${menageInfo.reservation.gite}</strong> - ${menageInfo.reservation.nom || 'Client'} - `;
                html += `M√©nage du ${dateFormatted}`;
                html += `</div>`;
                
                if (menageInfo.cleaning?.notes) {
                    html += `<div class="notification-reason">üí¨ Raison : ${menageInfo.cleaning.notes}</div>`;
                }
                
                html += '</div>';
                html += '</div>';
            });
            
            html += '</div>';
            window.SecurityUtils.setInnerHTML(banner, html);
            banner.style.display = 'block';
        }

        function parseLocalDate(dateStr) {
            const [day, month, year] = dateStr.split('/');
            return new Date(year, month - 1, day);
        }

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        async function loadPlanning() {
            const container = document.getElementById('planningContainer');
            
            try {
                // Charger les g√Ætes
                const gites = await window.gitesManager.getAll();
                if (!gites || gites.length === 0) {
                    console.error('‚ùå Aucun g√Æte trouv√©');
                    return;
                }
                
                // Cr√©er un map gite_id -> nom
                const giteMap = {};
                gites.forEach(g => {
                    giteMap[g.id] = g.name;
                });
                
                // R√©cup√©rer toutes les r√©servations futures
                const { data: reservations, error: resError } = await supabaseClient
                    .from('reservations')
                    .select('*')
                    .order('check_out', { ascending: true });

                if (resError) throw resError;

                // R√©cup√©rer tous les m√©nages planifi√©s
                const { data: cleaningSchedules, error: cleanError } = await supabaseClient
                    .from('cleaning_schedule')
                    .select('*');

                if (cleanError) throw cleanError;

                // Organiser par semaine
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const weeks = {};
                
                console.log('üîç DEBUG: Nombre de r√©servations:', reservations.length);
                console.log('üîç DEBUG: Nombre de cleaning_schedules:', cleaningSchedules?.length);
                
                reservations.forEach(res => {
                    const dateFin = new Date(res.check_out);
                    const today = new Date();
                    
                    if (dateFin < today) return; // Ignorer le pass√©

                    // Trouver le cleaning_schedule correspondant
                    const cleaning = cleaningSchedules?.find(c => c.reservation_id === res.id);
                    
                    console.log(`üìã R√©servation ${res.id} (${res.gite_id}) - check_out: ${res.check_out}`);
                    console.log(`   ‚û°Ô∏è cleaning.scheduled_date: ${cleaning?.scheduled_date || 'AUCUN'}`);
                    
                    // Parser scheduled_date sans d√©calage horaire UTC
                    let scheduledDate;
                    if (cleaning?.scheduled_date) {
                        const [year, month, day] = cleaning.scheduled_date.split('-');
                        scheduledDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        console.log(`   ‚û°Ô∏è scheduledDate pars√©e: ${scheduledDate.toLocaleDateString('fr-FR')}`);
                    } else {
                        scheduledDate = dateFin;
                        console.log(`   ‚û°Ô∏è Utilisation check_out par d√©faut: ${scheduledDate.toLocaleDateString('fr-FR')}`);
                    }
                    
                    // Trouver le lundi de la semaine
                    const dayOfWeek = scheduledDate.getDay();
                    const monday = new Date(scheduledDate);
                    monday.setDate(scheduledDate.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                    monday.setHours(0, 0, 0, 0);
                    
                    const weekKey = monday.toISOString().split('T')[0];
                    
                    if (!weeks[weekKey]) {
                        const sunday = new Date(monday);
                        sunday.setDate(monday.getDate() + 6);
                        
                        weeks[weekKey] = {
                            monday,
                            sunday,
                            weekNumber: getWeekNumber(monday),
                            gites: {} // Dynamique par gite_id
                        };
                        
                        // Initialiser un tableau pour chaque g√Æte
                        gites.forEach(g => {
                            weeks[weekKey].gites[g.id] = [];
                        });
                    }
                    
                    // Trouver la prochaine r√©servation pour d√©finir la p√©riode disponible
                    // Filtrer, trier par date et prendre la plus proche
                    const nextRes = reservations
                        .filter(r => r.gite_id === res.gite_id && new Date(r.check_in) >= dateFin)
                        .sort((a, b) => new Date(a.check_in) - new Date(b.check_in))[0];
                    
                    const menageInfo = {
                        reservation: res,
                        cleaning: cleaning,
                        dateFin: dateFin,
                        scheduledDate: scheduledDate,
                        nextReservationDate: nextRes ? new Date(nextRes.check_in) : null,
                        timeOfDay: cleaning?.time_of_day || 'afternoon',
                        status: cleaning?.status || 'pending',
                        validated: cleaning?.validated_by_company || false,
                        giteId: res.gite_id,
                        giteName: giteMap[res.gite_id] || 'G√Æte inconnu'
                    };
                    
                    // Ajouter au g√Æte correspondant
                    if (weeks[weekKey].gites[res.gite_id]) {
                        weeks[weekKey].gites[res.gite_id].push(menageInfo);
                    }
                });

                // G√©n√©rer HTML
                const sortedWeeks = Object.keys(weeks).sort();
                
                // Collecter tous les m√©nages pour les notifications
                const allMenages = [];
                Object.values(weeks).forEach(week => {
                    Object.values(week.gites).forEach(giteMenages => {
                        allMenages.push(...giteMenages);
                    });
                });
                
                // Calculer la date limite (dans 2 semaines) - r√©utilisation de today d√©j√† d√©clar√©
                const twoWeeksLater = new Date(today);
                twoWeeksLater.setDate(today.getDate() + 14);
                
                // Filtrer les m√©nages des 2 prochaines semaines uniquement
                const menagesDeuxSemaines = allMenages.filter(m => {
                    const menageDate = m.scheduledDate;
                    return menageDate >= today && menageDate <= twoWeeksLater;
                });
                
                // Compter nouveaux m√©nages (pending) et modifications en attente (pending_validation)
                // uniquement pour les 2 prochaines semaines
                const nbNew = menagesDeuxSemaines.filter(m => m.status === 'pending').length;
                const nbModified = menagesDeuxSemaines.filter(m => m.status === 'pending_validation').length;
                
                // Mettre √† jour le titre de l'onglet avec compteurs
                const totalNotifications = nbNew + nbModified;
                if (totalNotifications > 0) {
                    let title = '(';
                    if (nbNew > 0) title += `üÜï${nbNew}`;
                    if (nbNew > 0 && nbModified > 0) title += ' ';
                    if (nbModified > 0) title += `‚úèÔ∏è${nbModified}`;
                    title += ') Validation M√©nage';
                    document.title = title;
                } else {
                    document.title = 'Validation M√©nage';
                }

                // Afficher les notifications
                displayNotifications(allMenages);
                
                if (sortedWeeks.length === 0) {
                    window.SecurityUtils.setInnerHTML(container, `
                        <div class="week-card">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <h2>Aucun m√©nage √† planifier</h2>
                                <p>Tous les m√©nages sont √† jour</p>
                            </div>
                        </div>
                    `);
                    return;
                }

                let html = '';
                sortedWeeks.forEach(weekKey => {
                    const week = weeks[weekKey];
                    const weekDisplay = `${week.monday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })} - ${week.sunday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}`;
                    
                    html += `
                        <div class="week-card">
                            <div class="week-header">
                                <div class="week-title">Semaine ${week.weekNumber}</div>
                                <div class="week-dates">${weekDisplay}</div>
                            </div>
                            <div class="gites-container">
                    `;
                    
                    // G√©n√©rer une colonne par g√Æte
                    gites.forEach(gite => {
                        const giteMenages = week.gites[gite.id] || [];
                        const giteIcon = gite.icon || 'üè†';
                        const giteColor = gite.color || '#667eea';
                        const giteSlug = gite.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                        
                        html += `
                            <div class="gite-column" data-gite-id="${gite.id}" data-gite-slug="${giteSlug}">
                                <div class="gite-header">
                                    ${gite.name}
                                </div>
                                ${giteMenages.length > 0 ? 
                                    giteMenages.map(m => generateMenageHTML(m)).join('') :
                                    '<p style="color: #999; padding: 20px; text-align: center; font-weight: 600;">Aucun m√©nage</p>'
                                }
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });

                window.SecurityUtils.setInnerHTML(container, html);

            } catch (error) {
                console.error('Erreur:', error);
                window.SecurityUtils.setInnerHTML(container, `
                    <div class="week-card">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ùå</div>
                            <h2>Erreur de chargement</h2>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `);
            }
        }

        function generateMenageHTML(menage) {
            const { reservation, cleaning, dateFin, scheduledDate, nextReservationDate, timeOfDay, status, validated } = menage;
            const proposedBy = cleaning?.proposed_by; // Qui a propos√© : 'owner' (site principal) ou 'company' (soci√©t√©)
            
            const statusBadge = validated ? 
                '<span class="status-badge status-validated">‚úì Valid√© par le client</span>' :
                status === 'pending_validation' && proposedBy === 'owner' ?
                '<span class="status-badge status-waiting">‚è∞ Proposition du site principal</span>' :
                status === 'pending_validation' && proposedBy === 'company' ?
                '<span class="status-badge status-waiting">‚åõ En attente validation site principal</span>' :
                status === 'refused' ?
                '<span class="status-badge status-refused">‚úó Refus√©</span>' :
                '<span class="status-badge status-pending">‚è≥ En attente</span>';
            
            // R√©cup√©rer raison du refus si elle existe
            const refusalReason = cleaning?.notes && status === 'refused' ? cleaning.notes : null;
            
            // Formater dates sans d√©calage UTC
            const minDate = `${dateFin.getFullYear()}-${String(dateFin.getMonth() + 1).padStart(2, '0')}-${String(dateFin.getDate()).padStart(2, '0')}`;
            const maxDate = nextReservationDate ? `${nextReservationDate.getFullYear()}-${String(nextReservationDate.getMonth() + 1).padStart(2, '0')}-${String(nextReservationDate.getDate()).padStart(2, '0')}` : null;
            const scheduledDateISO = `${scheduledDate.getFullYear()}-${String(scheduledDate.getMonth() + 1).padStart(2, '0')}-${String(scheduledDate.getDate()).padStart(2, '0')}`;
            
            const periodText = nextReservationDate ?
                `üö™ D√©part: ${dateFin.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })} | üîë Entr√©e suivante: ${nextReservationDate.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}` :
                `üö™ D√©part: ${dateFin.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}`;

            const dateInputId = `date-${reservation.id}`;
            const morningId = `morning-${reservation.id}`;
            const afternoonId = `afternoon-${reservation.id}`;
            const formId = `form-${reservation.id}`;

            return `
                <div class="menage-item ${validated ? 'validated' : status}">
                    ${statusBadge}
                    <div class="menage-date">
                        üìÖ ${scheduledDate.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' })}
                        ${timeOfDay === 'morning' ? 'üåÖ Matin' : 'üåá Apr√®s-midi'}
                    </div>
                    <div class="menage-period">üìç ${periodText}</div>
                    
                    ${refusalReason ? `
                        <div class="refusal-reason" style="background: #ffebee; padding: 10px; margin: 10px 0; border-left: 3px solid #f44336; border-radius: 4px;">
                            <strong>‚ùå Refus√© par le client :</strong>
                            <p style="margin: 5px 0 0 0;">${refusalReason}</p>
                        </div>
                    ` : ''}
                    
                    ${!validated && status !== 'pending_validation' && status !== 'refused' ? `
                        <div id="${formId}" style="display: none;">
                            <div class="date-selector">
                                <label>Choisir une date :</label>
                                <input 
                                    type="date" 
                                    id="${dateInputId}"
                                    value="${scheduledDateISO}"
                                    min="${minDate}"
                                    ${maxDate ? `max="${maxDate}"` : ''}
                                    onchange="checkDateForMorning(${reservation.id}, '${minDate}')"
                                    data-departure-date="${minDate}"
                                />
                            </div>
                            
                            <div class="time-selector">
                                <button 
                                    type="button" 
                                    class="time-btn ${timeOfDay === 'morning' ? 'selected' : ''}" 
                                    id="${morningId}"
                                    onclick="selectTime('${reservation.id}', 'morning')"
                                >
                                    üåÖ Matin
                                </button>
                                <button 
                                    type="button" 
                                    class="time-btn ${timeOfDay === 'afternoon' ? 'selected' : ''}"
                                    id="${afternoonId}"
                                    onclick="selectTime('${reservation.id}', 'afternoon')"
                                >
                                    üåá Apr√®s-midi
                                </button>
                            </div>
                        </div>
                        
                        <div class="actions" id="actions-${reservation.id}">
                            <button class="btn btn-validate" onclick="validateMenage('${reservation.id}')" id="btn-validate-${reservation.id}">
                                ‚úì Valider
                            </button>
                            <button class="btn btn-propose" onclick="showProposeForm('${reservation.id}')">
                                üìù Modifier la date
                            </button>
                        </div>
                    ` : status === 'pending_validation' && proposedBy === 'owner' ? `
                        <div class="proposal-alert" style="background: #e3f2fd; padding: 15px; margin: 10px 0; border: 2px solid #2196F3; border-radius: 8px; box-shadow: 2px 2px 0 #2196F3;">
                            <strong>üì© Proposition du site principal</strong>
                            <p style="margin: 8px 0;">Date propos√©e : <strong>${scheduledDate.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' })}</strong></p>
                        </div>
                        <div class="actions">
                            <button class="btn btn-validate" onclick="acceptProposal('${reservation.id}')">
                                ‚úì Accepter la proposition
                            </button>
                            <button class="btn btn-cancel" onclick="cancelValidation('${reservation.id}')">
                                ‚Ü©Ô∏è Refuser la proposition
                            </button>
                        </div>
                    ` : status === 'pending_validation' && proposedBy === 'company' ? `
                        <div class="proposal-alert" style="background: #fff3cd; padding: 15px; margin: 10px 0; border: 2px solid #f39c12; border-radius: 8px; box-shadow: 2px 2px 0 #f39c12;">
                            <strong>‚åõ En attente validation site principal</strong>
                            <p style="margin: 8px 0;">Vous avez propos√© : <strong>${scheduledDate.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' })}</strong></p>
                            <p style="margin: 5px 0; font-size: 0.9em; color: #856404;">En attente de validation par le site principal</p>
                        </div>
                        <div class="actions">
                            <button class="btn btn-cancel" onclick="cancelValidation('${reservation.id}')">
                                ‚Ü©Ô∏è Annuler ma proposition
                            </button>
                        </div>
                    ` : validated ? `
                        <div class="actions">
                            <button class="btn btn-cancel" onclick="cancelValidation('${reservation.id}')">
                                ‚Ü©Ô∏è Annuler validation
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        let selectedTimes = {};
        
        function showProposeForm(reservationId) {
            const form = document.getElementById(`form-${reservationId}`);
            const btnValidate = document.getElementById(`btn-validate-${reservationId}`);
            const btnPropose = document.querySelector(`#actions-${reservationId} .btn-propose`);
            
            if (form) {
                form.style.display = 'block';
                // Cacher le bouton Valider, changer le texte et l'action du bouton Modifier
                if (btnValidate) btnValidate.style.display = 'none';
                if (btnPropose) {
                    btnPropose.textContent = 'üìù Proposer cette date';
                    btnPropose.onclick = () => proposeMenage(reservationId);
                }
                
                // V√©rifier si on peut proposer le matin
                const dateInput = document.getElementById(`date-${reservationId}`);
                checkDateForMorning(reservationId, dateInput.dataset.departureDate);
            }
        }

        function checkDateForMorning(reservationId, departureDate) {
            const dateInput = document.getElementById(`date-${reservationId}`);
            const morningBtn = document.getElementById(`morning-${reservationId}`);
            const selectedDate = dateInput.value;
            
            // Si la date s√©lectionn√©e = date de d√©part, bloquer le matin
            if (selectedDate === departureDate) {
                morningBtn.disabled = true;
                morningBtn.style.opacity = '0.5';
                morningBtn.style.cursor = 'not-allowed';
                morningBtn.title = 'Matin impossible le jour du d√©part';
                
                // Forcer l'apr√®s-midi
                selectTime(reservationId, 'afternoon');
            } else {
                morningBtn.disabled = false;
                morningBtn.style.opacity = '1';
                morningBtn.style.cursor = 'pointer';
                morningBtn.title = '';
            }
        }
        
        function selectTime(reservationId, timeOfDay) {
            selectedTimes[reservationId] = timeOfDay;
            
            const morningBtn = document.getElementById(`morning-${reservationId}`);
            const afternoonBtn = document.getElementById(`afternoon-${reservationId}`);
            
            if (timeOfDay === 'morning') {
                morningBtn.classList.add('selected');
                afternoonBtn.classList.remove('selected');
            } else {
                morningBtn.classList.remove('selected');
                afternoonBtn.classList.add('selected');
            }
        }

        async function validateMenage(reservationId) {
            const dateInput = document.getElementById(`date-${reservationId}`);
            
            // Si le formulaire est cach√©, utiliser les valeurs actuelles
            const form = document.getElementById(`form-${reservationId}`);
            let scheduledDate, timeOfDay;
            
            if (form && form.style.display === 'none') {
                // Valider la proposition actuelle
                scheduledDate = dateInput.value;
                timeOfDay = selectedTimes[reservationId] || 'afternoon';
            } else {
                // Utiliser les valeurs du formulaire
                scheduledDate = dateInput.value;
                timeOfDay = selectedTimes[reservationId] || 'afternoon';
            }
            
            if (!scheduledDate) {
                showToast('Veuillez s√©lectionner une date', 'error');
                return;
            }
            
            try {
                // R√©cup√©rer les infos de la r√©servation pour le gite
                const { data: reservation, error: resError } = await supabaseClient
                    .from('reservations')
                    .select('gite_id, check_out, check_in')
                    .eq('id', reservationId)
                    .single();
                
                if (resError) throw resError;
                
                // R√©cup√©rer l'utilisateur actuel
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                const { error } = await supabaseClient
                    .from('cleaning_schedule')
                    .upsert({
                        owner_user_id: user.id,
                        reservation_id: reservationId,
                        gite_id: reservation.gite_id,
                        scheduled_date: scheduledDate,
                        time_of_day: timeOfDay,
                        status: 'validated',
                        validated_by_company: true,
                        reservation_end: reservation.check_out
                    }, { onConflict: 'reservation_id' });
                
                if (error) throw error;
                
                showToast('‚úì M√©nage valid√© !', 'success');
                await loadPlanning();
            } catch (error) {
                console.error(error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function proposeMenage(reservationId) {
            const dateInput = document.getElementById(`date-${reservationId}`);
            const scheduledDate = dateInput.value;
            const timeOfDay = selectedTimes[reservationId] || 'afternoon';
            
            if (!scheduledDate) {
                showToast('Veuillez s√©lectionner une date', 'error');
                return;
            }
            
            try {
                // R√©cup√©rer les infos de la r√©servation pour le gite
                const { data: reservation, error: resError } = await supabaseClient
                    .from('reservations')
                    .select('gite_id, check_out, check_in')
                    .eq('id', reservationId)
                    .single();
                
                if (resError) throw resError;
                
                // R√©cup√©rer l'utilisateur actuel
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                const dataToPropose = {
                    owner_user_id: user.id,
                    reservation_id: reservationId,
                    gite_id: reservation.gite_id,
                    scheduled_date: scheduledDate,
                    time_of_day: timeOfDay,
                    status: 'pending_validation',
                    proposed_by: 'company',
                    validated_by_company: false
                };
                
                console.log('üì§ Donn√©es √† proposer:', dataToPropose);
                
                const { data, error } = await supabaseClient
                    .from('cleaning_schedule')
                    .upsert(dataToPropose, { onConflict: 'reservation_id' });
                
                if (error) {
                    console.error('‚ùå Erreur Supabase:', error);
                    throw error;
                }
                
                console.log('‚úÖ Proposition envoy√©e au site principal:', data);
                
                showToast('üìù Proposition envoy√©e au site principal pour validation', 'success');
                await loadPlanning();
            } catch (error) {
                console.error(error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function acceptProposal(reservationId) {
            try {
                const { error } = await supabaseClient
                    .from('cleaning_schedule')
                    .update({
                        status: 'validated',
                        validated_by_company: true
                    })
                    .eq('reservation_id', reservationId);
                
                if (error) throw error;
                
                showToast('‚úì Proposition accept√©e !', 'success');
                await loadPlanning();
            } catch (error) {
                console.error(error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function cancelValidation(reservationId) {
            if (!confirm('Annuler la validation ?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('cleaning_schedule')
                    .update({
                        status: 'pending',
                        validated_by_company: false
                    })
                    .eq('reservation_id', reservationId);
                
                if (error) throw error;
                
                showToast('‚Ü©Ô∏è Validation annul√©e', 'success');
                await loadPlanning();
            } catch (error) {
                console.error(error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        // Charger au d√©marrage
        loadPlanning();

        // Recharger toutes les 30 secondes
        setInterval(loadPlanning, 30000);
    </script>
</body>
</html>
