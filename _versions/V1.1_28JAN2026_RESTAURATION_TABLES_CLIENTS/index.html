<!DOCTYPE html>
<!-- 
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è  FICHIER DESKTOP - NE PAS MODIFIER  ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è                      ‚ïë
‚ïë                                                                          ‚ïë
‚ïë  Ce fichier est EN PRODUCTION et doit rester STABLE                     ‚ïë
‚ïë  Pour le mobile, utiliser les fichiers dans tabs/mobile/                ‚ïë
‚ïë  NE TOUCHER √Ä CE FICHIER QUE SUR DEMANDE EXPLICITE                      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="fr" data-theme="dark" id="app-root" class="theme-dark style-sidebar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ‚ö° CHARGEMENT TH√àME IMM√âDIAT - AVANT TOUT -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('icalou-theme') || 'dark';
            const savedStyle = localStorage.getItem('icalou-style') || 'sidebar';
            const root = document.documentElement;
            root.setAttribute('data-theme', savedTheme);
            root.setAttribute('id', 'app-root');
            root.classList.add(`theme-${savedTheme}`, `style-${savedStyle}`);
            document.documentElement.className = 'theme-' + savedTheme + ' style-' + savedStyle;
            
            // üî• FORCE CACHE BUST : Supprimer le cache CSS ancien
            if (!sessionStorage.getItem('css-v2.4.1-loaded')) {
                sessionStorage.setItem('css-v2.4.1-loaded', 'true');
                // Force rechargement en ajoutant timestamp si pas d√©j√† fait
                const cssLink = document.querySelector('link[href*="main.css"]');
                if (cssLink && !cssLink.href.includes('t=')) {
                    location.reload(true);
                }
            }
        })();
    </script>
    
    <title>UpStay - Gestion Synchronis√©e</title>
    
    <!-- Google Fonts - Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- üé® Font Awesome Icons (legacy support) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <!-- üé® Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Favicon vide pour √©viter requ√™te 404 -->
    <link rel="icon" href="data:,">
    
    <!-- üõ°Ô∏è Masquer TOUTES les erreurs des extensions Chrome - DOIT √™tre en premier -->
    <script>
        // Capturer TOUTES les erreurs avant tout autre script
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            // Bloquer toutes les erreurs d'extensions Chrome
            if (url && url.includes('chrome-extension://')) {
                return true; // Emp√™che l'affichage dans la console
            }
            // Bloquer les erreurs de syntaxe export (extensions)
            if (msg && (msg.includes('Unexpected token') || msg.includes('export'))) {
                return true;
            }
            return false;
        };

        // BLOQUER IMM√âDIATEMENT les scripts inject√©s qui cassent l'application
        (function() {
            // window.onerror DOIT √™tre d√©fini AVANT addEventListener
            window.onerror = function(msg, source, lineno, colno, error) {
                const msgStr = String(msg || '');
                const srcStr = String(source || '');
                if (msgStr.includes('webpage_content_reporter') || 
                    srcStr.includes('webpage_content_reporter') ||
                    msgStr.includes('Unexpected token') ||
                    msgStr.includes('export') ||
                    msgStr.includes('import') ||
                    srcStr.includes('chrome-extension')) {
                    return true; // Supprimer l'erreur
                }
            };
            
            // Puis addEventListener en mode capture
            window.addEventListener('error', function(event) {
                const msg = event.message || '';
                const src = event.filename || '';
                
                if (src.includes('webpage_content_reporter') || 
                    msg.includes('webpage_content_reporter') ||
                    msg.includes('Unexpected token') || 
                    msg.includes('export') ||
                    msg.includes('import') ||
                    src.includes('chrome-extension')) {
                    event.preventDefault();
                    event.stopImmediatePropagation();
                    event.stopPropagation();
                    return true;
                }
            }, true);
            
            // Bloquer console.error
            const _consoleError = console.error;
            console.error = function(...args) {
                const str = args.join(' ');
                if (str.includes('chrome-extension') || 
                    str.includes('webpage_content_reporter') || 
                    str.includes('Unexpected token') ||
                    str.includes('export') ||
                    str.includes('import')) {
                    return;
                }
                _consoleError.apply(console, args);
            };
        })();
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    
    <!-- üîí PHASE 2 S√âCURIT√â: Configuration locale optionnelle -->
    <!-- config.local.js d√©sactiv√© (fichier absent) - Configuration en dur dans shared-config.js -->
    
    <!-- Scripts modulaires de l'application -->
    <script src="js/shared-config.js"></script>
    <script src="js/gites-manager.js"></script>
    <!-- üîí PHASE 1 S√âCURIT√â: Authentification obligatoire -->
    <script src="js/auth.js"></script>
    <!-- üõ°Ô∏è PHASE 3 S√âCURIT√â: Protection XSS -->
    <script src="js/security-utils.js"></script>
    <!-- üõ°Ô∏è PHASE 4 S√âCURIT√â: Validation des entr√©es -->
    <script src="js/validation-utils.js"></script>
    <!-- üìä PHASE 4 S√âCURIT√â: Logging centralis√© -->
    <script src="js/error-logger.js"></script>
    <!-- üõ°Ô∏è PHASE 4 S√âCURIT√â: Rate limiting anti-spam -->
    <script src="js/rate-limiter.js"></script>
    <script src="js/init-validation.js?v=3.0"></script>
    <script src="js/shared-utils.js?v=4.1"></script>
    <script src="js/supabase-operations.js"></script>
    <script src="js/icons.js"></script>
    <script src="js/dashboard.js?v=4.8"></script>
    <script src="js/sync-ical-v2.js?v=2.2"></script>
    <script src="js/statistiques.js"></script>
    <script src="js/menage.js?v=1737504444"></script>
    <script src="js/cleaning-rules.js"></script>
    <script src="js/cleaning-rules-modal.js"></script>
    <script src="js/decouvrir.js?v=3.0"></script>
    <!-- Reservations.js : CHARG√â POUR DESKTOP ET MOBILE (fonctions de filtrage communes) -->
    <script src="js/reservations.js?v=5.1"></script>
    <script src="js/archives.js"></script>
    <script src="js/km-manager.js"></script>
    <script src="js/taux-fiscaux-config.js?v=1.0"></script>
    <script src="js/fiscalite-v2.js?v=1737331400"></script>
    <script src="js/infos-gites.js?v=3.5"></script>
    <script src="js/fiche-client.js?v=3.0" type="module"></script>
    <script src="js/widget-horaires-clients.js" type="module"></script>
    <script src="js/faq.js?v=3.0"></script>
    <script src="js/fiches-clients.js"></script>
    <script src="js/checklists.js"></script>
    <script src="js/draps.js?v=2.7"></script>
    <script src="js/platform-icons.js"></script>
    <script src="js/property-icons.js"></script>
    <script src="js/gites-crud.js"></script>
    <script src="js/calendrier-tarifs.js?v=4.3"></script>
    <script src="js/remplissage-auto-tarifs.js?v=1.8"></script>
    
    <!-- SheetJS pour export Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Leaflet pour la carte interactive -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- üé® CSS UNIQUE CONSOLID√â - V2.1.0 ICALOU COMPLET PARTOUT (25 jan 2026) -->
    <link rel="stylesheet" href="css/main.css?v=2.5.5" />
    <link rel="stylesheet" href="css/tab-reservations.css?v=2.3" />
    <link rel="stylesheet" href="css/tab-menage.css?v=1.0" />
    <link rel="stylesheet" href="css/tab-fiscalite.css?v=1.0" />
    <link rel="stylesheet" href="css/tab-infos-gites.css?v=1.7" />
    <link rel="stylesheet" href="css/tab-calendrier-tarifs.css?v=1.0" />
    <link rel="stylesheet" href="css/tab-calendrier.css?v=1.0" />
    <link rel="stylesheet" href="css/tab-statistiques.css?v=2.1" />
</head>
<body>
    <!-- üé® CONTR√îLES TH√àMES -->
    <div class="theme-controls">
        <button onclick="setTheme('light')" id="t-light" class="ctrl-btn">JOUR</button>
        <button onclick="setTheme('dark')" id="t-dark" class="ctrl-btn active">NUIT</button>
        <div class="ctrl-separator"></div>
        <button onclick="setStyle('apple')" id="s-apple" class="ctrl-btn">APPLE</button>
        <button onclick="setStyle('sidebar')" id="s-sidebar" class="ctrl-btn active">SIDEBAR</button>
        <div class="ctrl-separator"></div>
        <button onclick="showAdminMenu()" class="ctrl-btn ctrl-btn-admin" title="Menu Admin">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
        </button>
        <div id="adminDropdown" style="display: none; position: fixed; top: 70px; right: 20px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 9999; min-width: 200px; overflow: hidden; border: 2px solid #06b6d4;">
            <button onclick="switchTab('gestion'); hideAdminMenu();" style="width: 100%; padding: 12px 16px; border: none; background: white; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                <span><i data-lucide="home"></i></span> <span>G√©rer mes g√Ætes</span>
            </button>
            <button onclick="switchTab('checklists'); hideAdminMenu();" style="width: 100%; padding: 12px 16px; border: none; background: white; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                <span>‚úÖ</span> <span>Check-list</span>
            </button>
            <button onclick="switchTab('archives'); hideAdminMenu();" style="width: 100%; padding: 12px 16px; border: none; background: white; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                <span><i data-lucide="archive"></i></span> <span>Archives</span>
            </button>
            <button onclick="switchTab('faq'); hideAdminMenu();" style="width: 100%; padding: 12px 16px; border: none; background: white; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                <span>‚ùì</span> <span>FAQ</span>
            </button>
            <div style="height: 1px; background: #e5e7eb; margin: 4px 0;"></div>
            <button onclick="handleLogout(); hideAdminMenu();" style="width: 100%; padding: 12px 16px; border: none; background: white; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; color: #ef4444; transition: background 0.2s;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='white'">
                <span><i data-lucide="log-out"></i></span> <span>D√©connexion</span>
            </button>
        </div>
    </div>

    <script>
        // ‚ö° FONCTIONS TH√àME ET STYLE - Disponibles imm√©diatement
        window.setTheme = function(theme) {
            const root = document.documentElement;
            // Retirer TOUTES les classes de th√®me existantes
            root.classList.remove('theme-light', 'theme-dark');
            // Ajouter la nouvelle
            root.classList.add('theme-' + theme);
            
            // Gestion des boutons actifs via classes CSS
            const lightBtn = document.getElementById('t-light');
            const darkBtn = document.getElementById('t-dark');
            if (lightBtn && darkBtn) {
                lightBtn.classList.remove('active');
                darkBtn.classList.remove('active');
                
                if (theme === 'light') {
                    lightBtn.classList.add('active');
                } else {
                    darkBtn.classList.add('active');
                }
            }
            
            localStorage.setItem('icalou-theme', theme);
            
            // D√©clencher le nettoyage des styles
            window.dispatchEvent(new Event('theme-changed'));
            if (typeof window.cleanThemeStyles === 'function') {
                setTimeout(() => window.cleanThemeStyles(), 100);
            }
        };
        
        window.setStyle = function(style) {
            const root = document.documentElement;
            // Retirer TOUTES les classes de style existantes
            root.classList.remove('style-apple', 'style-sidebar');
            // Ajouter la nouvelle
            root.classList.add('style-' + style);
            
            // Gestion des boutons actifs via classes CSS
            const appleBtn = document.getElementById('s-apple');
            const sidebarBtn = document.getElementById('s-sidebar');
            if (appleBtn && sidebarBtn) {
                appleBtn.classList.remove('active');
                sidebarBtn.classList.remove('active');
                
                if (style === 'apple') {
                    appleBtn.classList.add('active');
                } else {
                    sidebarBtn.classList.add('active');
                }
            }
            
            localStorage.setItem('icalou-style', style);
            
            // D√©clencher le nettoyage des styles
            window.dispatchEvent(new Event('theme-changed'));
            if (typeof window.cleanThemeStyles === 'function') {
                setTimeout(() => window.cleanThemeStyles(), 100);
            }
        };
    </script>

    <!-- Menu hamburger mobile (inject√© dynamiquement) -->
    <div id="mobile-menu-container"></div>

    <script>
    // ‚ö° D√âTECTION MOBILE/DESKTOP - CHARGEMENT S√âPAR√â
    const forceMobileMode = false; // localStorage.getItem('force_mobile') === 'true';
    const isMobile = forceMobileMode || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    
    // Ajouter classe sur body pour cibler CSS
    if (isMobile) {
        document.documentElement.classList.add('is-mobile');
    } else {
        document.documentElement.classList.add('is-desktop');
    }
    
    // Charger CSS mobile si n√©cessaire
    if (isMobile) {
        const mobileCss = document.createElement('link');
        mobileCss.rel = 'stylesheet';
        mobileCss.href = 'css/mobile/main.css?v=4.5';
        document.head.appendChild(mobileCss);
        
        // Charger JS mobile
        const mobileJs = document.createElement('script');
        mobileJs.src = 'js/mobile/init.js?v=4.3';
        document.head.appendChild(mobileJs);
        
        console.log('üì± Mode MOBILE d√©tect√© - CSS et JS mobile charg√©s');
    }

    // Chargement dynamique des onglets
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser les ic√¥nes Lucide imm√©diatement
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        const cacheBuster = '?v=' + Date.now();
        
        // Liste compl√®te pour DESKTOP
        const desktopTabs = {
            'tab-dashboard': 'tabs/tab-dashboard.html' + cacheBuster,
            'tab-gestion': 'tabs/tab-gestion.html',
            'tab-reservations': 'tabs/tab-reservations.html',
            'tab-archives': 'tabs/tab-archives.html',
            'tab-statistiques': 'tabs/tab-statistiques.html',
            'tab-charges': 'tabs/tab-fiscalite-v2.html?v=1737243700',
            'tab-menage': 'tabs/tab-menage.html?v=4.1' + cacheBuster,
            'tab-infos-gites': 'tabs/tab-infos-gites.html?v=1737649300' + cacheBuster,
            'tab-fiches-clients': 'tabs/tab-fiches-clients.html',
            'tab-decouvrir': 'tabs/tab-decouvrir.html',
            'tab-faq': 'tabs/tab-faq.html',
            'tab-draps': 'tabs/tab-draps.html',
            'tab-checklists': 'tabs/tab-checklists.html',
        };
        
        // Liste R√âDUITE pour MOBILE (onglets exclus du menu mobile)
        const mobileTabs = {
            'tab-dashboard': 'tabs/mobile/dashboard.html' + cacheBuster,
            'tab-gestion': 'tabs/mobile/gestion.html' + cacheBuster,
            'tab-reservations': 'tabs/mobile/reservations.html' + cacheBuster,
            'tab-archives': 'tabs/mobile/archives.html' + cacheBuster,
            'tab-menage': 'tabs/mobile/menage.html' + cacheBuster,
            'tab-infos-gites': 'tabs/mobile/infos-gites.html' + cacheBuster,
            'tab-fiches-clients': 'tabs/mobile/fiches-clients.html' + cacheBuster,
            'tab-draps': 'tabs/mobile/draps.html' + cacheBuster,
            'tab-checklists': 'tabs/mobile/checklists.html' + cacheBuster,
            'tab-calendrier-tarifs': 'tabs/mobile/calendrier-tarifs.html?v=1.1' + cacheBuster,
        };
        
        const tabFiles = isMobile ? mobileTabs : desktopTabs;
        for (const [tabId, file] of Object.entries(tabFiles)) {
            fetch(file)
                .then(r => r.text())
                .then(html => {
                    const targetElement = document.getElementById(tabId);
                    if (!targetElement) {
                        console.error(`‚ùå Element #${tabId} introuvable dans le DOM!`);
                        return;
                    }
                    if (tabId === 'tab-dashboard') {
                        window.MOBILE_DASHBOARD_LOADED = isMobile;
                    }
                    // Contenu trusted (fichiers HTML statiques du projet)
                    window.SecurityUtils.setInnerHTML(targetElement, html, { trusted: true });
                    
                    // Initialiser les ic√¥nes Lucide apr√®s chargement du HTML
                    if (typeof lucide !== 'undefined') {
                        setTimeout(() => lucide.createIcons(), 50);
                    }
                    
                    // Initialiser le Dashboard apr√®s chargement du HTML
                    if (tabId === 'tab-dashboard' && typeof refreshDashboard === 'function') {
                        // Attendre que le DOM soit rendu
                        setTimeout(() => {
                            refreshDashboard();
                            // Pour mobile, initialiser le modal TODO
                            if (isMobile && typeof initializeTodoModal === 'function') {
                                setTimeout(() => initializeTodoModal(), 200);
                            }
                        }, 100);
                    }
                    // Initialiser la FAQ apr√®s chargement du HTML
                    if (tabId === 'tab-faq' && typeof window.initFAQ === 'function') {
                        window.initFAQ();
                    }
                    // Initialiser Draps apr√®s chargement du HTML
                    if (tabId === 'tab-draps' && typeof window.initDraps === 'function') {
                        window.initDraps();
                    }
                })
                .catch(err => {
                    if (file.includes('tab-dashboard')) {
                        console.error(`‚ùå Erreur chargement dashboard: ${file}`, err);
                    }
                });
        }
        
        // Activer le premier onglet (dashboard) apr√®s chargement
        setTimeout(() => {
            const dashboardTab = document.getElementById('tab-dashboard');
            if (dashboardTab) {
                dashboardTab.classList.add('active');
            }
        }, 100);
        
        // üîß Fonction toggle menu (inline pour √©viter les probl√®mes de chargement)
        window.toggleUserMenu = function() {
            const dropdown = document.getElementById('userMenuDropdown');
            const button = document.getElementById('userMenuButton');
            if (!dropdown) return;
            
            const isVisible = dropdown.classList.contains('open');
            
            if (isVisible) {
                dropdown.classList.remove('open');
                if (button) button.classList.remove('open');
                dropdown.style.display = 'none';
            } else {
                dropdown.classList.add('open');
                if (button) button.classList.add('open');
                dropdown.style.display = 'block';
            }
            
            // Fermer si clic ailleurs
            if (!isVisible) {
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!e.target.closest('.user-menu-container')) {
                            dropdown.classList.remove('open');
                            if (button) button.classList.remove('open');
                            dropdown.style.display = 'none';
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 10);
            }
        };
        
        
        // üîß Event listeners pour le menu admin
        // Attendre que tout soit bien charg√© (delayed pour √©viter les probl√®mes de timing)
        setTimeout(() => {
            const actionButtons = document.querySelectorAll('.user-menu-item[data-action]');
            
            actionButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const action = this.getAttribute('data-action');
                    
                    // Fermer le menu
                    if (window.toggleUserMenu) window.toggleUserMenu();
                    
                    // Ex√©cuter l'action
                    if (action === 'gites') {
                        if (window.showGitesManager) {
                            window.showGitesManager();
                        } else {
                            console.error('‚ùå showGitesManager non disponible');
                        }
                    } else if (action === 'faq') {
                        window.switchTab('faq');
                    } else if (window.handleQuickAction) {
                        window.handleQuickAction(action);
                    }
                });
            });
        }, 500);
        
        // Bouton logout
        setTimeout(() => {
            const logoutBtn = document.getElementById('logoutButton');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (window.logout) {
                        window.logout();
                    }
                });
            }
        }, 500);
    });
    </script>
    </body>
    <div class="container">
        <!-- Header Sticky Neo-Brutalism -->
        <div class="sticky-header">
            <div class="site-title">
                <!-- Logo UpStay -->
                <div class="icalou-icon">
                    <svg class="upstay-logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M50 5L15 40H30V90H70V40H85L50 5Z" fill="url(#paint0_linear)"/>
                        <path d="M50 35L35 50H45V75H55V50H65L50 35Z" fill="white" fill-opacity="0.8"/>
                        <defs>
                            <linearGradient id="paint0_linear" x1="50" y1="5" x2="50" y2="90" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#00C2CB"/>
                                <stop offset="1" stop-color="#005288"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <!-- Nom UpStay -->
                <div class="brand-identity">
                    <h1 class="brand-name">UPSTAY</h1>
                    <p class="brand-tagline">Gestion Synchronis√©e</p>
                </div>
            </div>
        </div>
        
        <!-- Navigation iCalou Moderne -->
        <nav class="icalou-modern-nav">
            <div class="nav-container">
                <button class="nav-tab active" data-tab="dashboard" data-theme="blue">
                    <i data-lucide="layout-grid" class="tab-icon"></i>
                    <span class="tab-label">Dashboard</span>
                </button>

                <button class="nav-tab" data-tab="reservations" data-theme="blue">
                    <i data-lucide="calendar" class="tab-icon"></i>
                    <span class="tab-label">R√©sa</span>
                </button>

                <button class="nav-tab" data-tab="statistiques" data-theme="green">
                    <i data-lucide="bar-chart-3" class="tab-icon"></i>
                    <span class="tab-label">Stats</span>
                </button>

                <button class="nav-tab" data-tab="draps" data-theme="blue">
                    <i data-lucide="bed-double" class="tab-icon"></i>
                    <span class="tab-label">Draps</span>
                </button>

                <button class="nav-tab" data-tab="menage" data-theme="blue">
                    <i data-lucide="trash-2" class="tab-icon"></i>
                    <span class="tab-label">M√©nage</span>
                </button>

                <button class="nav-tab" data-tab="charges" data-theme="yellow">
                    <i data-lucide="dollar-sign" class="tab-icon"></i>
                    <span class="tab-label">Fiscal</span>
                </button>

                <button class="nav-tab" data-tab="decouvrir" data-theme="green">
                    <i data-lucide="compass" class="tab-icon"></i>
                    <span class="tab-label">D√©couvrir</span>
                </button>

                <button class="nav-tab" data-tab="calendrier-tarifs" data-theme="yellow">
                    <i data-lucide="calendar-days" class="tab-icon"></i>
                    <span class="tab-label">Cal. & Tarifs</span>
                </button>

                <button class="nav-tab" data-tab="infos-gites" data-theme="blue">
                    <i data-lucide="info" class="tab-icon"></i>
                    <span class="tab-label">Infos</span>
                </button>
            </div>
        </nav>
        

        <!-- Conteneurs dynamiques pour chaque onglet -->
        <div id="tab-dashboard" class="tab-content"></div>
        <div id="tab-gestion" class="tab-content"></div>
        <div id="tab-reservations" class="tab-content"></div>
        <div id="tab-archives" class="tab-content"></div>
        <div id="tab-faq" class="tab-content"></div>
        <div id="tab-draps" class="tab-content"></div>
        <div id="tab-statistiques" class="tab-content"></div>
        <div id="tab-charges" class="tab-content"></div>
        <div id="tab-menage" class="tab-content"></div>
        <div id="tab-infos-gites" class="tab-content"></div>
        <div id="tab-fiches-clients" class="tab-content"></div>
        <div id="tab-checklists" class="tab-content"></div>
        <div id="tab-decouvrir" class="tab-content"></div>
        <div id="tab-calendrier-tarifs" class="tab-content"></div>
    </div>
    
        </div>
    </div>
    
    <!-- Modal √âdition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="card-header">
                <span class="card-icon">‚úèÔ∏è</span>
                <h2 class="card-title">Modifier R√©servation</h2>
            </div>
            
            <form id="editForm">
                <input type="hidden" id="editId">
                
                <div class="form-group">
                    <label>Nom <span class="required">*</span></label>
                    <input type="text" id="editNom">
                </div>
                
                <div class="form-group">
                    <label>üì± T√©l√©phone</label>
                    <input type="tel" id="editTelephone" placeholder="+33 6 12 34 56 78" pattern="[0-9+\- ]*">
                </div>
                
                <div class="form-group">
                    <label>Provenance</label>
                    <input type="text" id="editProvenance">
                </div>
                
                <div class="form-group">
                    <label>Nb Personnes</label>
                    <input type="number" id="editNbPersonnes" min="1">
                </div>
                
                <div class="form-group">
                    <label>Montant (‚Ç¨) <span class="required">*</span></label>
                    <input type="number" id="editMontant" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Acompte (‚Ç¨)</label>
                    <input type="number" id="editAcompte" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Statut paiement</label>
                    <select id="editPaiement">
                        <option value="En attente">En attente</option>
                        <option value="Partiellement pay√©">Partiellement pay√©</option>
                        <option value="Pay√©">Pay√©</option>
                        <option value="Annul√©">Annul√©</option>
                    </select>
                </div>
                
                <div class="flex-gap-10-mt">
                    <button type="submit" class="btn btn-primary">
                        <span>‚úì</span> Enregistrer
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <span style="font-size: 1.5rem;">‚úì</span>
        <span id="toastMessage"></span>
    </div>

    <!-- Modal R√®gles M√©nage -->
    <div id="rulesModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="card-header card-header-gradient">
                <span class="card-icon">üìã</span>
                <h2 class="card-title">R√®gles de Gestion du Planning M√©nage</h2>
            </div>
            
            <div style="padding: 20px;">
                <h3 style="color: #3498db; margin-bottom: 15px;">üéØ Priorit√©s</h3>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li><strong>Priorit√© 1 :</strong> M√©nages entre r√©servations (m√™me jour)</li>
                    <li><strong>Priorit√© 2 :</strong> M√©nages de fin de p√©riode (d√©part sans nouvelle r√©servation)</li>
                    <li><strong>Priorit√© 3 :</strong> M√©nages d'entretien hebdomadaire si disponible</li>
                </ul>

                <h3 style="color: #e74c3c; margin-bottom: 15px;">‚ö†Ô∏è Contraintes</h3>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>Pas de m√©nage les dimanches (sauf urgence)</li>
                    <li>Pas de m√©nage les jours f√©ri√©s</li>
                    <li>Temps minimum entre m√©nages : 2h</li>
                    <li>Maximum 3 m√©nages par jour pour la soci√©t√©</li>
                </ul>

                <h3 style="color: #27ae60; margin-bottom: 15px;">‚úÖ Validation Soci√©t√©</h3>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>La soci√©t√© de m√©nage doit valider chaque m√©nage dans les 24h</li>
                    <li>En cas de refus, le m√©nage est marqu√© en rouge (√† replanifier)</li>
                    <li>Les m√©nages valid√©s apparaissent en vert</li>
                    <li>Les m√©nages en attente sont en orange</li>
                </ul>

                <h3 style="color: #9b59b6; margin-bottom: 15px;">‚è∞ Horaires</h3>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li><strong>Matin :</strong> 8h - 12h (pour les d√©parts matinaux)</li>
                    <li><strong>Apr√®s-midi :</strong> 14h - 18h (cas g√©n√©ral)</li>
                    <li>Temps estim√© par m√©nage : 2h</li>
                </ul>

                <div class="alert-info">
                    <p>
                        <strong>üí° Note :</strong> Ces r√®gles sont appliqu√©es automatiquement lors de la g√©n√©ration du planning. 
                        La soci√©t√© de m√©nage peut proposer des modifications via la page de validation.
                    </p>
                </div>

                <div class="flex-center-mt">
                    <button type="button" class="btn btn-primary" onclick="closeRulesModal()">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Les configurations et fonctions de base sont maintenant dans js/shared-config.js et js/shared-utils.js
        // Utiliser window.supabaseClient pour acc√©der au client Supabase
        // Note: On utilise var pour √©viter les conflits de scope avec d'autres scripts
        var supabase = window.supabaseClient;
        
        // Variables globales
        let caChartInstance, gitesChartInstance, platformsChartInstance, profitChartInstance;
        window.ICAL_CONFIGS = window.DEFAULT_ICAL_CONFIGS;
        
        // ==========================================
        // ‚ö†Ô∏è SECTION SYNCHRONISATION iCAL - NE PAS MODIFIER SANS DEMANDE EXPLICITE ‚ö†Ô∏è
        // ==========================================
        
        // Fonction pour obtenir les URLs iCal (depuis localStorage ou d√©faut)
        function getIcalConfigs() {
            const stored = localStorage.getItem('icalUrls');
            if (stored) {
                return JSON.parse(stored);
            }
            return window.DEFAULT_ICAL_CONFIGS;
        }
        
        // Exporter vers le scope global
        window.getIcalConfigs = getIcalConfigs;
        
        // Charger les URLs dans les champs du formulaire
        function chargerUrlsIcal() {
            const configs = getIcalConfigs();
            // V√©rifier que les √©l√©ments existent avant de les modifier
            const airbnbCouzon = document.getElementById('icalAirbnbCouzon');
            const abritelCouzon = document.getElementById('icalAbritelCouzon');
            const gitesCouzon = document.getElementById('icalGitesCouzon');
            const airbnbTrevoux = document.getElementById('icalAirbnbTrevoux');
            const abritelTrevoux = document.getElementById('icalAbritelTrevoux');
            const gitesTrevoux = document.getElementById('icalGitesTrevoux');
            
            if (airbnbCouzon) airbnbCouzon.value = configs.couzon.airbnb;
            if (abritelCouzon) abritelCouzon.value = configs.couzon.abritel;
            if (gitesCouzon) gitesCouzon.value = configs.couzon.gitesDeFrance;
            if (airbnbTrevoux) airbnbTrevoux.value = configs.trevoux.airbnb;
            if (abritelTrevoux) abritelTrevoux.value = configs.trevoux.abritel;
            if (gitesTrevoux) gitesTrevoux.value = configs.trevoux.gitesDeFrance;
        }
        
        // Sauvegarder les URLs depuis le formulaire
        function sauvegarderUrlsIcal() {
            const configs = {
                couzon: {
                    airbnb: document.getElementById('icalAirbnbCouzon').value.trim(),
                    abritel: document.getElementById('icalAbritelCouzon').value.trim(),
                    gitesDeFrance: document.getElementById('icalGitesCouzon').value.trim()
                },
                trevoux: {
                    airbnb: document.getElementById('icalAirbnbTrevoux').value.trim(),
                    abritel: document.getElementById('icalAbritelTrevoux').value.trim(),
                    gitesDeFrance: document.getElementById('icalGitesTrevoux').value.trim()
                }
            };
            localStorage.setItem('icalUrls', JSON.stringify(configs));
            showToast('‚úì URLs iCal sauvegard√©es');
        }
        
        // Variable globale pour les configs (charger depuis localStorage)
        ICAL_CONFIGS = getIcalConfigs();
        
        // ==========================================
        // üîç RECHERCHE R√âSERVATIONS - D√©plac√© dans js/reservations.js
        // ==========================================
        // Functions: filterReservations, displayFilteredReservations
        
        // ==========================================
        // üìä STATISTIQUES - D√©plac√© dans js/statistiques.js
        // ==========================================
        // Functions: updatePlatformCounters, updateAdvancedStats, populateYearFilter, 
        // filterStatsByYear, updateAllCharts
        
        // ==========================================
        // üíæ SAUVEGARDE - D√©plac√© dans js/sauvegarde.js
        // ==========================================
        // Functions: exportToExcel, exportAllData, importAllData, sauvegarderTout
        
        // Gestion du menu Actions
        function handleQuickAction(action) {
            if (action === 'gites') {
                if (window.showGitesManager) {
                    window.showGitesManager();
                } else {
                    console.error('‚ùå window.showGitesManager n\'est pas d√©fini');
                }
            } else if (action === 'ical') {
                window.switchTab('gestion');
            } else if (action === 'archives') {
                window.switchTab('archives');
            }
        }
        
        function showRulesModal() {
            const modal = document.getElementById('rulesModal');
            if (modal) modal.style.display = 'flex';
        }
        
        function closeRulesModal() {
            const modal = document.getElementById('rulesModal');
            if (modal) modal.style.display = 'none';
        }
        
        // Exporter dans le scope global
        window.showRulesModal = showRulesModal;
        window.closeRulesModal = closeRulesModal;
        
        function ouvrirPageValidation() {
            // Ouvrir validation.html dans un nouvel onglet
            window.open('pages/validation.html', '_blank');
        }
        
        function ouvrirPageFemmeMenage() {
            // Ouvrir dans un nouvel onglet au lieu d'une modal
            window.open('pages/femme-menage.html', '_blank');
        }
        
        // Exporter dans le scope global
        window.ouvrirPageValidation = ouvrirPageValidation;
        window.ouvrirPageFemmeMenage = ouvrirPageFemmeMenage;
        
        function autoSetDateFin() {
            const dateDebut = document.getElementById('dateDebut').value;
            if (dateDebut) {
                const date = new Date(dateDebut);
                date.setDate(date.getDate() + 2);
                document.getElementById('dateFin').value = date.toISOString().split('T')[0];
            }
        }
        
        // ==========================================
        // üîÑ SYNCHRONISATION iCAL - D√©plac√© dans js/sync-ical.js
        // ==========================================
        // Functions: syncAllCalendars, syncCalendar, checkDateOverlap, updateBlockedDates
        
        // ==========================================
        // ‚úèÔ∏è √âDITION R√âSERVATIONS - D√©plac√© dans js/reservations.js
        // ==========================================
        // Functions: autoSaveJSON, openEditModal, closeEditModal, 
        // updatePaiementStatus, deleteReservationById
        
        // ==========================================
        // üìÖ AFFICHAGE R√âSERVATIONS - D√©plac√© dans js/reservations.js
        // ==========================================
        // Functions: updateReservationsList, generateWeekReservations, getPlatformLogo
        
        // ==========================================
        // üßπ PLANNING M√âNAGE - D√©plac√© dans js/menage.js
        // ==========================================
        // Functions: calculerDateMenage, isJourFerie, formatDateShort, genererPlanningMenage, 
        // afficherPlanningParSemaine, generateCleaningItemHTML, telechargerPlanningMenage
        
        // Fonctions additionnelles pour la gestion des modifications par la soci√©t√© de m√©nage
        
        async function updateArchivesDisplay() {
            const reservations = await getAllReservations();
            const section = document.getElementById('archivesSection');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const archives = reservations.filter(r => parseLocalDate(r.dateFin) < today);
            archives.sort((a, b) => parseLocalDate(b.dateFin) - parseLocalDate(a.dateFin));
            
            if (archives.length === 0) {
                window.SecurityUtils.setInnerHTML(section, '<p style="text-align: center; color: #999; padding: 40px;">Aucune archive</p>');
                return;
            }
            
            let html = '<div class="gite-section">';
            
            archives.forEach(r => {
                const badgeClass = getPlatformBadgeClass(r.site);
                html += `
                    <div class="reservation-item ${r.gite.toLowerCase()}">
                        <div class="reservation-header">
                            <span class="reservation-name">${r.nom} - ${r.gite}</span>
                            <span class="badge-platform ${badgeClass}">
                                ${r.site}
                            </span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem; color: #666;">
                            üìÖ ${formatDate(r.dateDebut)} ‚Üí ${formatDate(r.dateFin)} (${r.nuits} nuits)
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem;">
                            üí∞ ${r.montant ? r.montant.toFixed(2) : '0.00'} ‚Ç¨ | Statut: ${r.paiement}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            window.SecurityUtils.setInnerHTML(section, html);
        }
        
        async function updateStats() {
            const reservations = await getAllReservations();
            const historicalData = await getAllHistoricalData();
            
            // Filtrer par l'ann√©e s√©lectionn√©e
            const selectedYear = parseInt(document.getElementById('yearFilterStats')?.value || new Date().getFullYear());
            
            // V√©rifier si des donn√©es historiques "Total" existent pour cette ann√©e
            const histTotal = historicalData.find(d => d.year === selectedYear && d.gite === 'Total');
            
            let caTotal = 0;
            let totalReservations = 0;
            
            if (histTotal) {
                // Utiliser UNIQUEMENT les donn√©es historiques (pas les r√©servations)
                const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                months.forEach(m => {
                    caTotal += histTotal.months[m] || 0;
                });
                // Pour les donn√©es historiques, on ne peut pas compter les r√©servations individuelles
                totalReservations = '-';
                const statTotalEl = document.getElementById('statTotal');
                if (statTotalEl) statTotalEl.textContent = totalReservations;
                
                // Mettre √† jour dynamiquement pour N g√Ætes
                const gites = await window.gitesManager.getAll();
                gites.forEach(g => {
                    const statEl = document.getElementById(`stat${g.slug}`);
                    if (statEl) statEl.textContent = '-';
                });
            } else {
                // Utiliser les r√©servations automatiques (dynamique N g√Ætes)
                const filteredReservations = reservations.filter(r => {
                    // Utiliser check_in au lieu de dateDebut
                    const checkIn = r.check_in ? new Date(r.check_in) : null;
                    if (!checkIn) return false;
                    return checkIn.getFullYear() === selectedYear;
                });
                
                const gites = await window.gitesManager.getAll();
                caTotal = 0;
                totalReservations = 0;
                
                gites.forEach(gite => {
                    const reservationsGite = filteredReservations.filter(r => r.gite_id === gite.id);
                    // Utiliser total_price au lieu de montant
                    const caGite = reservationsGite.reduce((sum, r) => sum + (parseFloat(r.total_price) || 0), 0);
                    caTotal += caGite;
                    totalReservations += reservationsGite.length;
                    
                    // Capitaliser la premi√®re lettre du slug pour matcher l'HTML (statTrevoux, statCouzon)
                    const slugCapitalized = gite.slug.charAt(0).toUpperCase() + gite.slug.slice(1);
                    const statEl = document.getElementById(`stat${slugCapitalized}`);
                    if (statEl) statEl.textContent = reservationsGite.length;
                });
                
                const statTotalEl = document.getElementById('statTotal');
                if (statTotalEl) statTotalEl.textContent = totalReservations;
                
                // Mettre √† jour les compteurs par plateforme et statistiques avanc√©es
                if (typeof updatePlatformCounters === 'function') {
                    updatePlatformCounters(filteredReservations);
                }
                if (typeof updateAdvancedStats === 'function') {
                    updateAdvancedStats(filteredReservations);
                }
            }
            
            const statCAEl = document.getElementById('statCA');
            if (statCAEl) statCAEl.textContent = caTotal.toFixed(0) + ' ‚Ç¨';
            
            // G√©n√©rer les checkboxes de comparaison d'ann√©es
            generateYearComparisonCheckboxes(reservations, historicalData);
            
            // Mettre √† jour les graphiques avec les donn√©es filtr√©es
            const filteredReservations = reservations.filter(r => {
                const checkIn = r.check_in ? new Date(r.check_in) : null;
                if (!checkIn) return false;
                return checkIn.getFullYear() === selectedYear;
            });
            updateAllCharts(filteredReservations);
        }
        
        function generateYearComparisonCheckboxes(reservations, historicalData) {
            const container = document.getElementById('yearComparisonCheckboxes');
            if (!container) return; // Conteneur pas encore charg√©
            const allYears = new Set();
            const yearsWithReservations = new Set();
            const yearsWithTotal = new Set();
            
            // Ann√©es des r√©servations (utiliser check_in)
            reservations.forEach(r => {
                if (r.check_in) {
                    const year = new Date(r.check_in).getFullYear();
                    allYears.add(year);
                    yearsWithReservations.add(year);
                }
            });
            
            // Ann√©es historiques
            historicalData.forEach(d => {
                allYears.add(d.year);
                if (d.gite === 'Total') {
                    yearsWithTotal.add(d.year);
                }
            });
            
            const sortedYears = Array.from(allYears).sort((a, b) => b - a);
            const currentYear = new Date().getFullYear();
            
            let html = '';
            sortedYears.forEach(year => {
                const isCurrentYear = year === currentYear;
                // Badge "Auto" UNIQUEMENT pour l'ann√©e en cours ET qui a des r√©servations ET pas de Total manuel
                const isAuto = isCurrentYear && yearsWithReservations.has(year) && !yearsWithTotal.has(year);
                // Ne cocher automatiquement QUE l'ann√©e en cours
                const checked = isCurrentYear ? 'checked' : '';
                const badge = isAuto ? '<span class="badge-auto">Auto ‚ö°</span>' : '';
                const labelClass = isAuto ? 'year-selector-label auto' : 'year-selector-label';
                
                html += `
                    <label class="${labelClass}">
                        <input type="checkbox" value="${year}" ${checked} onchange="updateAllCharts()">
                        <span>${year}${badge}</span>
                    </label>
                `;
            });
            
            window.SecurityUtils.setInnerHTML(container, html);
        }
        
        // ==========================================
        // Note: updateAllCharts d√©plac√© vers js/statistiques.js
        // Note: exportToExcel, sauvegarderTout, exportAllData, importAllData d√©plac√©s vers js/sauvegarde.js
        // ==========================================
        
        // Gestionnaire formulaire charges - sera appel√© apr√®s chargement de l'onglet
        window.initChargeForm = function() {
            const chargeForm = document.getElementById('chargeForm');
            if (!chargeForm || chargeForm._initialized) return;
            
            chargeForm._initialized = true;
            chargeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const charge = {
                    gite: document.getElementById('chargeGite').value,
                    nom: document.getElementById('chargeNom').value,
                    montant: parseFloat(document.getElementById('chargeMontant').value),
                    type: document.getElementById('chargeType').value,
                    date: document.getElementById('chargeDate').value || new Date().toISOString().split('T')[0],
                    notes: document.getElementById('chargeNotes').value,
                    timestamp: new Date().toISOString()
                };
                
                await addCharge(charge);
                this.reset();
                await updateChargesDisplay();
                await updateStats(); // Mettre √† jour le graphique CA vs Charges
                showToast('‚úì Charge ajout√©e');
            });
        };
        
        async function updateChargesDisplay() {
            const reservations = await getAllReservations();
            const charges = await getAllCharges();
            
            // Calcul recettes
            const totalRecettes = reservations.reduce((sum, r) => sum + r.montant, 0);
            
            // Calcul charges
            let totalCharges = 0;
            charges.forEach(c => {
                if (c.type === 'mensuelle') {
                    totalCharges += c.montant * 12;
                } else if (c.type === 'annuelle') {
                    totalCharges += c.montant;
                } else {
                    totalCharges += c.montant;
                }
            });
            
            // Calcul URSSAF (22% des recettes)
            const provisionUrssaf = totalRecettes * 0.22;
            
            // R√©sultat net
            const resultatNet = totalRecettes - totalCharges - provisionUrssaf;
            
            document.getElementById('totalRecettes').textContent = totalRecettes.toFixed(0) + ' ‚Ç¨';
            document.getElementById('totalCharges').textContent = totalCharges.toFixed(0) + ' ‚Ç¨';
            document.getElementById('provisionUrssaf').textContent = provisionUrssaf.toFixed(0) + ' ‚Ç¨';
            document.getElementById('resultatNet').textContent = resultatNet.toFixed(0) + ' ‚Ç¨';
            
            // Liste des charges
            const chargesList = document.getElementById('chargesList');
            if (charges.length === 0) {
                window.SecurityUtils.setInnerHTML(chargesList, '<p style="text-align: center; color: #999; padding: 20px;">Aucune charge enregistr√©e</p>');
                return;
            }
            
            let html = '';
            charges.forEach(c => {
                html += `
                    <div class="charge-item">
                        <div class="charge-info">
                            <div class="charge-name">${c.nom} - ${c.gite}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${c.type ? (c.type.charAt(0).toUpperCase() + c.type.slice(1)) : 'Autre'} ${c.date ? '| ' + formatDate(c.date) : ''}
                                ${c.notes ? '<br>' + c.notes : ''}
                            </div>
                        </div>
                        <div class="flex-items-gap">
                            <div class="charge-amount">${c.montant ? c.montant.toFixed(2) : '0.00'} ‚Ç¨</div>
                            <button class="btn btn-danger btn-small" onclick="deleteChargeById(${c.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            window.SecurityUtils.setInnerHTML(chargesList, html);
        }
        
        async function deleteChargeById(id) {
            if (confirm('Supprimer cette charge ?')) {
                await deleteCharge(id);
                await updateChargesDisplay();
                await updateStats(); // Mettre √† jour le graphique CA vs Charges
                showToast('‚úì Charge supprim√©e');
            }
        }
        
        // ==========================================
        // üìä GESTION DONN√âES HISTORIQUES
        // ==========================================
        
        function toggleHistoricalDataForm() {
            const form = document.getElementById('historicalDataForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                displayHistoricalYearsList();
            } else {
                form.style.display = 'none';
            }
        }
        
        async function saveHistoricalData() {
            const year = parseInt(document.getElementById('historicalYear').value);
            const gite = document.getElementById('historicalGite').value;
            const currentYear = new Date().getFullYear();
            
            if (!year || year < 2000 || year >= currentYear) {
                showToast(`‚ö†Ô∏è Saisissez une ann√©e pr√©c√©dente (max: ${currentYear - 1})`, 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            const data = {
                year: year,
                gite: gite,
                months: {}
            };
            
            months.forEach(m => {
                const value = parseFloat(document.getElementById(`hist_${m}`).value) || 0;
                data.months[m] = value;
            });
            
            try {
                // Supprimer l'ancien si existe
                const existing = await getHistoricalData(year, gite);
                if (existing) {
                    await deleteHistoricalDataById(existing.id);
                }
                
                // Ajouter le nouveau avec Promise
                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(['historicalData'], 'readwrite');
                    const request = transaction.objectStore('historicalData').add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Erreur ajout');
                });
                
                showToast(`‚úì Donn√©es ${year} - ${gite} sauvegard√©es`);
                displayHistoricalYearsList();
                clearHistoricalForm();
                updateStats(); // Rafra√Æchir les graphiques
            } catch (error) {
                showToast('‚ùå Erreur sauvegarde', 'error');
                console.error(error);
            }
        }
        
        // ==========================================
        // üî• FONCTIONS HISTORICAL DATA - Supabase
        // ==========================================
        
        async function getHistoricalData(year, gite) {
            try {
                const { data, error } = await supabase
                    .from('historical_data')
                    .select('*')
                    .eq('table_name', 'historical_fiscal')
                    .eq('new_data->>year', year.toString())
                    .eq('new_data->>gite', gite)
                    .maybeSingle();
                
                if (error) throw error;
                if (!data) return null;
                
                return {
                    id: data.id,
                    year: parseInt(data.new_data.year),
                    gite: data.new_data.gite,
                    months: data.new_data.months
                };
            } catch (error) {
                console.error('Erreur getHistoricalData:', error);
                return null;
            }
        }
        
        async function getAllHistoricalData() {
            try {
                const { data, error } = await supabase
                    .from('historical_data')
                    .select('*')
                    .eq('table_name', 'historical_fiscal')
                    .order('changed_at', { ascending: false });
                
                if (error) throw error;
                
                return (data || []).map(d => ({
                    id: d.id,
                    year: parseInt(d.new_data.year),
                    gite: d.new_data.gite,
                    months: d.new_data.months
                }));
            } catch (error) {
                console.error('Erreur getAllHistoricalData:', error);
                return [];
            }
        }
        
        async function deleteHistoricalDataById(id) {
            try {
                const { error } = await supabase
                    .from('historical_data')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
            } catch (error) {
                console.error('Erreur deleteHistoricalDataById:', error);
                throw error;
            }
        }
        
        async function saveHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year || year < 2000 || year > 2030) {
                showToast('‚ö†Ô∏è Ann√©e invalide (entre 2000 et 2030)', 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            
            const monthsData = {};
            months.forEach(m => {
                const inputValue = document.getElementById(`hist_total_${m}`).value;
                // Ne mettre √† jour que si la valeur est renseign√©e
                if (inputValue !== '' && inputValue !== null && inputValue !== undefined) {
                    monthsData[m] = parseFloat(inputValue) || 0;
                }
            });
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    showToast('‚ùå Non connect√©', 'error');
                    return;
                }
                
                const existing = await getHistoricalData(year, 'Total');
                
                if (existing) {
                    // Fusionner avec les donn√©es existantes
                    const mergedMonths = { ...existing.months, ...monthsData };
                    
                    const { error } = await supabase
                        .from('historical_data')
                        .update({ 
                            new_data: { year, gite: 'Total', months: mergedMonths },
                            changed_at: new Date().toISOString()
                        })
                        .eq('id', existing.id);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('historical_data')
                        .insert({ 
                            owner_user_id: user.id,
                            table_name: 'historical_fiscal',
                            record_id: crypto.randomUUID(),
                            action: 'INSERT',
                            new_data: { year, gite: 'Total', months: monthsData }
                        });
                    
                    if (error) throw error;
                }
                
                showToast(`‚úì Donn√©es ${year} sauvegard√©es`);
                displayHistoricalYearsList();
                clearHistoricalFormTotal();
                updateStats();
            } catch (error) {
                showToast('‚ùå Erreur sauvegarde', 'error');
                console.error(error);
            }
        }
        
        async function loadHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year) {
                showToast('‚ö†Ô∏è S√©lectionnez une ann√©e', 'error');
                return;
            }
            
            try {
                const dataTotal = await getHistoricalData(year, 'Total');
                
                if (!dataTotal) {
                    showToast(`‚ÑπÔ∏è Aucune donn√©e pour ${year}`, 'error');
                    return;
                }
                
                const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                months.forEach(m => {
                    document.getElementById(`hist_total_${m}`).value = dataTotal.months[m] || 0;
                });
                
                showToast(`‚úì Donn√©es ${year} charg√©es`);
            } catch (error) {
                showToast('‚ùå Erreur chargement', 'error');
                console.error(error);
            }
        }
        
        async function deleteHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year) {
                showToast('‚ö†Ô∏è S√©lectionnez une ann√©e', 'error');
                return;
            }
            
            if (!confirm(`Supprimer toutes les donn√©es ${year} ?`)) {
                return;
            }
            
            try {
                const dataTotal = await getHistoricalData(year, 'Total');
                
                if (dataTotal) {
                    await deleteHistoricalDataById(dataTotal.id);
                }
                
                showToast(`‚úì Donn√©es ${year} supprim√©es`);
                clearHistoricalFormTotal();
                displayHistoricalYearsList();
                updateStats();
            } catch (error) {
                showToast('‚ùå Erreur suppression', 'error');
                console.error(error);
            }
        }
        
        function clearHistoricalFormTotal() {
            document.getElementById('historicalYear').value = '';
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            months.forEach(m => {
                document.getElementById(`hist_total_${m}`).value = '';
            });
        }
        
        // Fonctions anciennes - d√©sactiv√©es
        async function loadHistoricalData() {
            showToast('‚ö†Ô∏è Utilisez le formulaire Total', 'error');
        }
        
        async function deleteHistoricalData() {
            showToast('‚ö†Ô∏è Utilisez le formulaire Total', 'error');
        }
        
        function clearHistoricalForm() {
            clearHistoricalFormTotal();
        }
        
        async function displayHistoricalYearsList() {
            const data = await getAllHistoricalData();
            const container = document.getElementById('historicalYearsList');
            
            if (data.length === 0) {
                window.SecurityUtils.setInnerHTML(container, '<p style="color: #999; font-style: italic;">Aucune donn√©e historique enregistr√©e</p>');
                return;
            }
            
            // Grouper par ann√©e
            const byYear = {};
            data.forEach(d => {
                if (!byYear[d.year]) byYear[d.year] = {};
                byYear[d.year][d.gite] = d;
            });
            
            let html = '<div class="flex-wrap-gap">';
            Object.keys(byYear).sort().reverse().forEach(year => {
                html += `
                    <div class="historic-year-card">
                        <div class="historic-year-title">üìÖ ${year}</div>
                `;
                
                if (byYear[year]['Total']) {
                    const total = Object.values(byYear[year]['Total'].months).reduce((a, b) => a + b, 0);
                    html += `
                        <div style="margin-bottom: 5px;">
                            <span style="font-weight: 600;">Total:</span> ${total.toFixed(2)} ‚Ç¨
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            html += '</div>';
            
            window.SecurityUtils.setInnerHTML(container, html);
        }
        
        // ==========================================
        // FIN GESTION DONN√âES HISTORIQUES
        // ==========================================
        
        // ==========================================
        // üßπ NOUVEAU SYST√àME PLANNING M√âNAGE
        // ==========================================
        
        /**
         * Parse une date DD/MM/YYYY ou YYYY-MM-DD en objet Date
         */
        function parseDateMenage(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            
            // Format ISO YYYY-MM-DD
            if (dateStr.includes('-')) {
                const [y, m, d] = dateStr.split('-');
                return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
            }
            
            // Format fran√ßais DD/MM/YYYY
            const [d, m, y] = dateStr.split('/');
            return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
        }
        
        /**
         * Calcule le num√©ro de semaine ISO
         */
        function getWeekNum(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        /**
         * V√©rifie si c'est un jour f√©ri√©
         */
        function estJourFerie(date) {
            const y = date.getFullYear();
            const m = date.getMonth() + 1;
            const d = date.getDate();
            
            const feries = [
                `${y}-01-01`, `${y}-05-01`, `${y}-05-08`, `${y}-07-14`,
                `${y}-08-15`, `${y}-11-01`, `${y}-11-11`, `${y}-12-25`
            ];
            
            const key = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            return feries.includes(key);
        }
        
        /**
         * Calcule la date et l'heure du m√©nage selon les r√®gles m√©tier
         */
        function calculerMenageNew(reservation, toutesReservations) {
            const dateFin = parseDateMenage(reservation.date_fin || reservation.dateFin);
            if (!dateFin) {
                console.error('‚ùå Date fin invalide:', reservation);
                return { date: new Date(), moment: 'afternoon' };
            }
            const jour = dateFin.getDay(); // 0=dimanche, 6=samedi
            
            let dateMenage = new Date(dateFin);
            let moment = 'afternoon'; // Par d√©faut apr√®s-midi
            
            // Trouver enchainement (arriv√©e le jour du d√©part)
            const enchainement = toutesReservations.some(r => 
                r.gite === reservation.gite &&
                r.id !== reservation.id &&
                parseDateMenage(r.date_debut || r.dateDebut)?.toDateString() === dateFin.toDateString()
            );
            
            // R√àGLE DIMANCHE (0)
            if (jour === 0) {
                if (enchainement) {
                    // Enchainement dimanche ‚Üí 13h m√™me jour
                    moment = 'afternoon';
                } else {
                    // Pas d'enchainement ‚Üí lundi
                    dateMenage.setDate(dateMenage.getDate() + 1);
                    moment = 'afternoon';
                }
            }
            // R√àGLE SAMEDI (6)
            else if (jour === 6) {
                if (!enchainement) {
                    // V√©rifier si r√©sa samedi ou dimanche
                    const samedi = new Date(dateFin);
                    const dimanche = new Date(dateFin);
                    dimanche.setDate(dimanche.getDate() + 1);
                    
                    const resaWeekend = toutesReservations.some(r =>
                        r.gite === reservation.gite &&
                        r.id !== reservation.id &&
                        (parseDateMenage(r.date_debut || r.dateDebut)?.toDateString() === samedi.toDateString() ||
                         parseDateMenage(r.date_debut || r.dateDebut)?.toDateString() === dimanche.toDateString())
                    );
                    
                    if (!resaWeekend) {
                        // Pas de r√©sa weekend ‚Üí lundi
                        dateMenage.setDate(dateMenage.getDate() + 2);
                    }
                }
                moment = 'afternoon';
            }
            // R√àGLE MERCREDI (3) / JEUDI (4)
            else if (jour === 3 || jour === 4) {
                if (!enchainement) {
                    const vendredi = new Date(dateFin);
                    vendredi.setDate(vendredi.getDate() + (jour === 3 ? 2 : 1));
                    
                    const resaAvantVendredi = toutesReservations.some(r => {
                        const dateDebut = parseDateMenage(r.date_debut || r.dateDebut);
                        return r.gite === reservation.gite &&
                            r.id !== reservation.id &&
                            dateDebut && dateDebut < vendredi;
                    });
                    
                    if (!resaAvantVendredi) {
                        // Pas de r√©sa avant vendredi ‚Üí vendredi
                        dateMenage = vendredi;
                    }
                }
                moment = 'afternoon';
            }
            // AUTRES JOURS (lundi, mardi, vendredi)
            else {
                moment = 'afternoon';
            }
            
            // Reporter si jour f√©ri√© (sauf si enchainement)
            while (estJourFerie(dateMenage) && !enchainement) {
                dateMenage.setDate(dateMenage.getDate() + 1);
                // √âviter les dimanches
                if (dateMenage.getDay() === 0) {
                    dateMenage.setDate(dateMenage.getDate() + 1);
                }
            }
            
            return { date: dateMenage, moment };
        }
        
        /**
         * Affiche le planning par semaine avec les 2 g√Ætes
         */
        async function afficherPlanningMenageNew() {
            // En mode mobile, ne rien faire (la page mobile g√®re le chargement)
            if (isMobile) {
                console.log('üì± Mode mobile: afficherPlanningMenageNew() ignor√©e');
                return;
            }
            
            console.log('üßπ afficherPlanningMenageNew() appel√©e');
            
            // Appeler directement la fonction du fichier menage.js qui g√®re tout
            if (typeof window.afficherPlanningParSemaine === 'function') {
                console.log('‚úÖ Appel de afficherPlanningParSemaine()...');
                await window.afficherPlanningParSemaine();
            } else {
                console.error('‚ùå fonction afficherPlanningParSemaine non trouv√©e !');
            }
        }
        
        function genererMenageCard(m) {
            console.log('üé¥ genererMenageCard:', {
                nom: m.reservation.nom,
                date_fin: m.reservation.date_fin || m.reservation.dateFin,
                dateMenage: m.dateMenage.toLocaleDateString('fr-FR'),
                nextArrivee: m.nextArrivee?.toLocaleDateString('fr-FR') || 'aucune'
            });
            
            const statusClass = m.validated ? 'validated' : m.status === 'pending_validation' ? 'pending-validation' : '';
            const statusBadge = m.validated ? 
                '<span class="menage-status status-validated">‚úì Valid√©</span>' :
                m.status === 'pending_validation' ?
                '<span class="menage-status status-waiting">‚è∞ En attente validation client</span>' :
                '<span class="menage-status status-pending">‚è≥ √Ä valider</span>';
            
            const momentIcon = m.moment === 'morning' ? 'üåÖ Matin' : 'üåá Apr√®s-midi';
            
            const dateDepartStr = parseDateMenage(m.reservation.date_fin || m.reservation.dateFin)?.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) || 'Date inconnue';
            
            // Formater la date du m√©nage pour le calendrier (√©viter d√©calage UTC)
            const year = m.dateMenage.getFullYear();
            const month = String(m.dateMenage.getMonth() + 1).padStart(2, '0');
            const day = String(m.dateMenage.getDate()).padStart(2, '0');
            const dateMenageISO = `${year}-${month}-${day}`;
            
            return `
                <div class="menage-card ${statusClass}">
                    ${statusBadge}
                    <div class="menage-date-main">
                        üìÖ ${m.dateMenage.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' })}
                        ${momentIcon}
                    </div>
                    <div class="menage-info-row">
                        <span>üë§ ${m.reservation.nom}</span>
                    </div>
                    <div class="menage-info-row">
                        <span>üö™ D√©part: ${dateDepartStr}</span>
                        ${m.nextArrivee ? `<span>üîë Entr√©e suivante: ${m.nextArrivee.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}</span>` : ''}
                    </div>
                    
                    ${m.status === 'pending_validation' ? `
                        <div class="menage-proposition">
                            <p><strong>üì© Proposition soci√©t√© de m√©nage :</strong></p>
                            <div class="proposition-actions">
                                <button class="btn btn-success" onclick="approveModification(${m.reservation.id})">
                                    ‚úì Approuver
                                </button>
                                <button class="btn btn-danger" onclick="refuserProposition(${m.reservation.id})">
                                    ‚úó Refuser
                                </button>
                            </div>
                            <div id="refus-form-${m.reservation.id}" style="display: none; margin-top: 10px;">
                                <textarea id="refus-reason-${m.reservation.id}" placeholder="Raison du refus..." style="width: 100%; min-height: 60px; margin-bottom: 10px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;"></textarea>
                                <button class="btn btn-primary" onclick="envoyerRefus(${m.reservation.id})">
                                    Envoyer le refus
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div class="menage-modifier">
                            <div class="modifier-form">
                                <input 
                                    type="date" 
                                    id="date-${m.reservation.id}" 
                                    value="${dateMenageISO}"
                                    onchange="modifierMenageAuto(${m.reservation.id})"
                                >
                                <select id="moment-${m.reservation.id}" onchange="modifierMenageAuto(${m.reservation.id})">
                                    <option value="morning" ${m.moment === 'morning' ? 'selected' : ''}>üåÖ Matin</option>
                                    <option value="afternoon" ${m.moment === 'afternoon' ? 'selected' : ''}>üåá Apr√®s-midi</option>
                                </select>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }
        
        function afficherRefusForm(resaId) {
            const form = document.getElementById(`refus-form-${resaId}`);
            const btnRefuser = event?.target;
            
            if (form) {
                form.style.display = 'block';
                // Scroll jusqu'au formulaire
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                // Focus sur le textarea
                const textarea = document.getElementById(`refus-reason-${resaId}`);
                if (textarea) {
                    setTimeout(() => textarea.focus(), 300);
                }
                
                // Cacher le bouton refuser pour √©viter double clic
                if (btnRefuser) {
                    btnRefuser.style.display = 'none';
                }
            } else {
                console.error('‚ùå Formulaire refus-form-' + resaId + ' non trouv√© dans le DOM');
                // V√©rifier si l'√©l√©ment existe vraiment
            }
        }
        
        async function approuverProposition(resaId) {
            if (!confirm('Approuver cette proposition de la soci√©t√© de m√©nage ?')) return;
            
            try {
                const { error } = await supabase.from('cleaning_schedule')
                    .update({
                        status: 'validated',
                        validated_by_company: true
                    })
                    .eq('reservation_id', resaId);
                
                if (error) throw error;
                
                showToast('‚úì Proposition approuv√©e !', 'success');
                await afficherPlanningMenageNew();
            } catch (error) {
                console.error(error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }
        
        async function refuserProposition(resaId) {
            const reasonElement = document.getElementById(`refus-reason-${resaId}`);
            
            if (!reasonElement) {
                console.error('‚ùå √âl√©ment refus-reason non trouv√© pour r√©sa', resaId);
                showToast('Erreur: formulaire non trouv√©', 'error');
                return;
            }
            
            const reason = reasonElement.value.trim();
            
            if (!reason) {
                showToast('Veuillez indiquer une raison', 'error');
                return;
            }
            
            try {
                // D'abord v√©rifier si la colonne existe, sinon juste update status
                const { error } = await supabase.from('cleaning_schedule')
                    .update({
                        status: 'refused',
                        validated_by_company: false,
                        notes: reason
                    })
                    .eq('reservation_id', resaId);
                
                if (error) throw error;
                
                showToast('‚úó Proposition refus√©e', 'info');
                await afficherPlanningMenageNew();
            } catch (error) {
                console.error(error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }
        
        async function modifierMenageAuto(resaId) {
            const newDate = document.getElementById(`date-${resaId}`).value;
            const newMoment = document.getElementById(`moment-${resaId}`).value;
            
            try {
                // R√©cup√©rer le gite de la r√©servation
                const reservations = await getAllReservations();
                const reservation = reservations.find(r => r.id === resaId);
                
                if (!reservation) {
                    throw new Error('R√©servation non trouv√©e');
                }
                
                const dataToUpdate = {
                    reservation_id: resaId,
                    gite: reservation.gite,
                    scheduled_date: newDate,
                    time_of_day: newMoment,
                    status: 'pending'
                };
                
                
                const { data, error } = await supabase.from('cleaning_schedule').upsert(dataToUpdate, { onConflict: 'reservation_id' });
                
                if (error) {
                    console.error('Erreur Supabase:', error);
                    throw error;
                }
                
                
                showToast('‚úì Enregistr√©', 'success');
                await afficherPlanningMenageNew();
            } catch (err) {
                console.error('Erreur modification:', err);
                showToast('Erreur enregistrement', 'error');
            }
        }
        
        // ==========================================
        // FIN NOUVEAU SYST√àME PLANNING M√âNAGE
        // ==========================================
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        async function exportPlanningMenageMois() {
            const reservations = await getAllReservations();
            
            // R√©cup√©rer les validations de la soci√©t√© de m√©nage
            const { data: cleaningSchedules } = await supabase
                .from('cleaning_schedule')
                .select('*');
            
            const validationMap = {};
            let pendingModifications = 0;
            if (cleaningSchedules) {
                cleaningSchedules.forEach(cs => {
                    validationMap[cs.reservation_id] = cs;
                    if (cs.status === 'proposed') {
                        pendingModifications++;
                    }
                });
            }
            
            // Afficher le badge de notification si modifications en attente
            const notifBadge = document.getElementById('cleaning-notif-badge');
            if (notifBadge) {
                if (pendingModifications > 0) {
                    notifBadge.textContent = pendingModifications;
                    notifBadge.style.display = 'inline-block';
                } else {
                    notifBadge.style.display = 'none';
                }
            }
            
            // Filtrer √† partir de la date actuelle
            const now = new Date();
            now.setHours(0, 0, 0, 0); // D√©but de journ√©e
            const twoMonthsLater = new Date(now);
            twoMonthsLater.setMonth(now.getMonth() + 12);
            
            // Adapter les r√©servations de snake_case √† camelCase pour calculerDateMenage()
            const reservationsAdapted = reservations.map(r => ({
                ...r,
                dateFin: r.dateFin || r.date_fin,
                dateDebut: r.dateDebut || r.date_debut
            }));
            
            const relevant = reservationsAdapted.filter(r => {
                const dateFin = parseLocalDate(r.dateFin);
                return dateFin >= now && dateFin <= twoMonthsLater;
            });
            
            // Organiser par semaine
            const weeks = {};
            const weekStarts = new Set();
            
            for (const r of relevant) {
                const dateFin = parseLocalDate(r.dateFin);
                const validation = validationMap[r.id];
                
                // Calculer la date avec les r√®gles m√©tier
                const dateMenageFormatted = calculerDateMenage(r, relevant);
                
                // Parser le r√©sultat "Lundi 23 d√©c. √† 12h00" (avec accents possibles)
                const match = dateMenageFormatted.match(/(\w+) (\d+) ([a-z√©√ª]+)\. √† (\d+h\d+)/i);
                let dateMenage;
                let calculatedTimeOfDay;
                
                if (match) {
                    const [_, jourNom, jour, mois, heure] = match;
                    const moisMap = {
                        'janv': 0, 'f√©vr': 1, 'mars': 2, 'avr': 3, 'mai': 4, 'juin': 5,
                        'juil': 6, 'ao√ªt': 7, 'sept': 8, 'oct': 9, 'nov': 10, 'd√©c': 11
                    };
                    
                    const moisIndex = moisMap[mois];
                    const jourInt = parseInt(jour);
                    
                    // Cr√©er la date avec l'ann√©e actuelle d'abord
                    dateMenage = new Date(dateFin.getFullYear(), moisIndex, jourInt);
                    
                    // Si la date est avant la date de fin, c'est l'ann√©e suivante
                    if (dateMenage < dateFin) {
                        dateMenage = new Date(dateFin.getFullYear() + 1, moisIndex, jourInt);
                    }
                    
                    calculatedTimeOfDay = (heure.startsWith('07') || heure.startsWith('08')) ? 'morning' : 'afternoon';
                } else {
                    dateMenage = new Date(dateFin);
                    calculatedTimeOfDay = 'afternoon';
                }
                
                // Trouver le lundi de cette semaine
                const dayOfWeek = dateMenage.getDay();
                const monday = new Date(dateMenage);
                monday.setDate(dateMenage.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                monday.setHours(0, 0, 0, 0);
                
                const weekKey = monday.toISOString().split('T')[0];
                weekStarts.add(weekKey);
                
                if (!weeks[weekKey]) {
                    weeks[weekKey] = {
                        monday: monday,
                        trevoux: [],
                        couzon: []
                    };
                }
                
                // Sauvegarder si pas encore fait ou si status pending
                if (!validation || validation.status === 'pending') {
                    const nextRes = reservations
                        .filter(next => next.gite === r.gite && parseLocalDate(next.dateFin || next.date_fin) > dateFin)
                        .sort((a, b) => parseLocalDate(a.dateDebut || a.date_debut) - parseLocalDate(b.dateDebut || b.date_debut))[0];
                    
                    try {
                        const scheduledDateStr = `${dateMenage.getFullYear()}-${String(dateMenage.getMonth() + 1).padStart(2, '0')}-${String(dateMenage.getDate()).padStart(2, '0')}`;
                        const dateFinStr = `${dateFin.getFullYear()}-${String(dateFin.getMonth() + 1).padStart(2, '0')}-${String(dateFin.getDate()).padStart(2, '0')}`;
                        let nextResStartStr = null;
                        if (nextRes) {
                            const nextResStart = parseLocalDate(nextRes.dateFin || nextRes.date_fin);
                            nextResStartStr = `${nextResStart.getFullYear()}-${String(nextResStart.getMonth() + 1).padStart(2, '0')}-${String(nextResStart.getDate()).padStart(2, '0')}`;
                        }
                        
                        await supabase.from('cleaning_schedule').upsert({
                            reservation_id: r.id,
                            gite: r.gite,
                            scheduled_date: scheduledDateStr,
                            time_of_day: calculatedTimeOfDay,
                            status: 'pending',
                            validated_by_company: false,
                            reservation_end: dateFinStr,
                            reservation_start_after: nextResStartStr
                        }, { onConflict: 'reservation_id' });
                    } catch (err) {
                        console.error('Erreur upsert:', err);
                    }
                }
                
                const menageInfo = {
                    reservation: r,
                    dateMenage: dateMenage,
                    validated: validation ? validation.validated_by_company : false,
                    proposedDate: validation ? validation.proposed_date : null,
                    status: validation ? validation.status : 'pending',
                    timeOfDay: validation ? validation.time_of_day : calculatedTimeOfDay,
                    reservationEndBefore: dateFin,
                    reservationStartAfter: null // √Ä calculer
                };
                
                // Chercher la r√©servation suivante pour ce g√Æte
                const nextReservation = reservations
                    .filter(next => next.gite === r.gite && parseLocalDate(next.dateDebut || next.date_debut) > dateFin)
                    .sort((a, b) => parseLocalDate(a.dateDebut || a.date_debut) - parseLocalDate(b.dateDebut || b.date_debut))[0];
                
                if (nextReservation) {
                    menageInfo.reservationStartAfter = parseLocalDate(nextReservation.dateDebut || nextReservation.date_debut);
                }
                
                // Ajouter dans la bonne colonne
                if (r.gite.toLowerCase().includes('trevoux') || r.gite.toLowerCase().includes('trevoux')) {
                    weeks[weekKey].trevoux.push(menageInfo);
                } else {
                    weeks[weekKey].couzon.push(menageInfo);
                }
            }
            
            // Trier les semaines
            const sortedWeeks = Array.from(weekStarts).sort();
            
            // G√©n√©rer le HTML
            let html = '<div style="margin-top: 20px;">';
            
            sortedWeeks.forEach((weekKey, index) => {
                const week = weeks[weekKey];
                const monday = week.monday;
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                
                // Calculer le vrai num√©ro de semaine de l'ann√©e
                const weekNumber = `S${getWeekNumber(monday)}`;
                const weekDisplay = `${monday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })} - ${sunday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}`;
                
                html += `
                    <div class="cleaning-week-table">
                        <div class="cleaning-week-header">
                            <div class="week-number-big">${weekNumber}</div>
                            <div class="week-dates-small">${weekDisplay}</div>
                        </div>
                        <div class="cleaning-week-body">
                            <div class="cleaning-column">
                                <div class="cleaning-column-header"><i data-lucide="building"></i> Trevoux</div>
                                ${week.trevoux.length > 0 ? 
                                    week.trevoux.map(m => generateCleaningItemHTML(m)).join('') :
                                    '<div class="cleaning-item empty">Aucun m√©nage pr√©vu</div>'
                                }
                            </div>
                            <div class="cleaning-column">
                                <div class="cleaning-column-header couzon">‚õ∞Ô∏è Couzon</div>
                                ${week.couzon.length > 0 ? 
                                    week.couzon.map(m => generateCleaningItemHTML(m)).join('') :
                                    '<div class="cleaning-item empty">Aucun m√©nage pr√©vu</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            window.SecurityUtils.setInnerHTML(document.getElementById('menagePlanning'), html);
        }
        
        function generateCleaningItemHTML(menageInfo) {
            const { reservation, dateMenage, validated, proposedDate, reservationEndBefore, reservationStartAfter, status, timeOfDay } = menageInfo;
            const displayDate = proposedDate ? new Date(proposedDate) : dateMenage;
            
            // Ic√¥ne et badge de statut - 3 √©tats uniquement :
            // Rouge = √† valider, Orange = en attente, Vert = valid√©
            let statusIcon = '';
            if (validated) {
                // VERT = Valid√©
                statusIcon = '<span class="validation-status validated" title="Valid√© par soci√©t√©">‚úì</span>';
            } else if (status === 'proposed') {
                // ORANGE = En attente de validation
                statusIcon = '<span class="validation-status pending" title="En attente validation">‚è≥</span>';
            } else {
                // ROUGE = √Ä valider
                statusIcon = '<span class="validation-status notvalidated" title="√Ä valider">‚úó</span>';
            }
            
            const dateStr = displayDate.toLocaleDateString('fr-FR', { 
                weekday: 'short', 
                day: '2-digit', 
                month: 'short' 
            });
            
            // R√©cup√©rer le moment sauvegard√©
            const savedTime = timeOfDay || localStorage.getItem(`cleaning_time_${reservation.id}`) || 'afternoon';
            
            // Afficher une alerte si modification propos√©e par la soci√©t√©
            const proposalAlert = status === 'proposed' ? `
                <div class="alert-warning">
                    <strong>‚ö†Ô∏è Modification propos√©e par la soci√©t√© de m√©nage</strong><br>
                    Nouvelle date: ${displayDate.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' })} - ${savedTime === 'morning' ? 'üåÖ Matin' : '‚òÄÔ∏è Apr√®s-midi'}
                    <div class="flex-gap-10" style="margin-top: 10px;">
                        <button class="btn-small btn-valider" onclick="approveModification(${reservation.id})">
                            ‚úì Approuver
                        </button>
                        <button class="btn-small btn-supprimer" onclick="rejectModification(${reservation.id})">
                            ‚úó Refuser
                        </button>
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="cleaning-item ${status === 'proposed' ? 'pending-approval' : ''}" style="${status === 'proposed' ? 'border: 2px solid #ff9800;' : ''}">
                    <div class="cleaning-date-row">
                        <span class="cleaning-date">üìÖ ${dateStr}</span>
                        ${statusIcon}
                    </div>
                    <div class="cleaning-details">
                        üö™ D√©part: ${reservationEndBefore.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}
                        ${reservationStartAfter ? `<br>üîë Arriv√©e suivante: ${reservationStartAfter.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}` : ''}
                    </div>
                    ${proposalAlert}
                    <div style="margin-top: 10px; display: flex; gap: 8px; align-items: center;">
                        <input type="date" id="date-${reservation.id}" value="${displayDate.toISOString().split('T')[0]}" style="flex: 1; padding: 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.9rem;">
                        <select id="time-${reservation.id}" style="padding: 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.9rem;">
                            <option value="morning" ${savedTime === 'morning' ? 'selected' : ''}>üåÖ Matin</option>
                            <option value="afternoon" ${savedTime === 'afternoon' ? 'selected' : ''}>‚òÄÔ∏è Apr√®s-midi</option>
                        </select>
                    </div>
                    <div class="cleaning-actions">
                        <button class="btn-small btn-modifier" onclick="modifierDateMenage(${reservation.id})">
                            ‚úèÔ∏è Enregistrer
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function modifierDateMenage(reservationId) {
            const newDate = document.getElementById(`date-${reservationId}`).value;
            const timeOfDay = document.getElementById(`time-${reservationId}`).value;
            
            if (!newDate) {
                showToast('Veuillez s√©lectionner une date', 'error');
                return;
            }
            
            const reservation = (await getAllReservations()).find(r => r.id === reservationId);
            if (!reservation) {
                showToast('R√©servation non trouv√©e', 'error');
                return;
            }
            
            // Sauvegarder le moment dans localStorage
            localStorage.setItem(`cleaning_time_${reservationId}`, timeOfDay);
            
            // Sauvegarder dans cleaning_schedule avec le moment
            const { error } = await supabase
                .from('cleaning_schedule')
                .upsert({
                    reservation_id: reservationId,
                    gite: reservation.gite,
                    scheduled_date: newDate,
                    time_of_day: timeOfDay,
                    status: 'modified',
                    validated_by_company: false,
                    reservation_end: reservation.dateFin,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'reservation_id' });
            
            if (error) {
                showToast('Erreur: ' + error.message, 'error');
            } else {
                showToast('Date et horaire de m√©nage enregistr√©s avec succ√®s');
                afficherPlanningParSemaine();
            }
        }
        
        async function approveModification(reservationId) {
            const { error } = await supabase
                .from('cleaning_schedule')
                .update({
                    status: 'validated',
                    validated_by_company: true,
                    updated_at: new Date().toISOString()
                })
                .eq('reservation_id', reservationId);
            
            if (error) {
                showToast('Erreur lors de l\'approbation: ' + error.message, 'error');
            } else {
                showToast('‚úì Modification approuv√©e');
                afficherPlanningParSemaine();
            }
        }
        
        async function rejectModification(reservationId) {
            // Remettre la date d'origine (jour du d√©part) et supprimer la proposition
            const reservation = (await getAllReservations()).find(r => r.id === reservationId);
            if (!reservation) return;
            
            const { error } = await supabase
                .from('cleaning_schedule')
                .update({
                    scheduled_date: reservation.dateFin,
                    proposed_date: null,
                    status: 'pending',
                    validated_by_company: false,
                    updated_at: new Date().toISOString()
                })
                .eq('reservation_id', reservationId);
            
            if (error) {
                showToast('Erreur lors du refus: ' + error.message, 'error');
            } else {
                showToast('‚úó Modification refus√©e - Date d\'origine restaur√©e');
                afficherPlanningParSemaine();
            }
        }

        function telechargerPlanningMenage() {
            if (!window.planningMenageData || window.planningMenageData.length === 0) {
                showToast('Aucun planning √† t√©l√©charger. G√©n√©rez d\'abord le planning.', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(window.planningMenageData);
            
            // D√©finir les largeurs de colonnes
            ws['!cols'] = [
                { wch: 35 }, // Date compl√®te
                { wch: 10 }, // Heure
                { wch: 12 }, // G√Æte
                { wch: 20 }, // Client
                { wch: 15 }, // D√©part
                { wch: 15 }  // Enchainement
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Planning M√©nages');
            const dateToday = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `MenageCalvignac_${dateToday}.xlsx`);
            
            showToast('‚úì Planning Excel t√©l√©charg√©');
        }
        
        // ==========================================
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FIN SECTION PLANNING M√âNAGE - VERROUILL√âE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // ==========================================
        
        async function exportPlanningMenageMois() {
            const monthInput = document.getElementById('menageExportMonth').value;
            if (!monthInput) {
                showToast('S√©lectionnez un mois √† exporter', 'error');
                return;
            }

            const [yearStr, monthStr] = monthInput.split('-');
            const targetYear = parseInt(yearStr, 10);
            const targetMonth = parseInt(monthStr, 10) - 1;

            const reservations = await getAllReservations();
            if (!reservations || reservations.length === 0) {
                showToast('Aucune r√©servation enregistr√©e', 'error');
                return;
            }

            // On calcule un planning global puis on filtre sur le mois demand√©
            const relevant = [...reservations].sort((a, b) => parseLocalDate(a.dateFin) - parseLocalDate(b.dateFin));

            const planning = [];
            const occupiedSlots = {};

            relevant.forEach(r => {
                const departDate = parseLocalDate(r.dateFin);
                if (isNaN(departDate)) return;

                const departDay = departDate.getDay();

                const arriveeMemejour = relevant.find(resa =>
                    resa.gite === r.gite &&
                    parseLocalDate(resa.dateDebut).toDateString() === departDate.toDateString()
                );

                let menageDate = new Date(departDate);
                let heure = '12h00';

                // R√àGLE 1: D√©part dimanche
                if (departDay === 0) {
                    if (!arriveeMemejour) {
                        menageDate.setDate(menageDate.getDate() + 1);
                        const arriveeLundi = relevant.find(resa =>
                            resa.gite === r.gite &&
                            parseLocalDate(resa.dateDebut).toDateString() === menageDate.toDateString()
                        );
                        heure = arriveeLundi ? '07h00' : '12h00';
                    } else {
                        heure = '12h00';
                    }
                }
                // R√àGLE 2: Samedi
                else if (departDay === 6) {
                    if (arriveeMemejour) {
                        heure = '12h00';
                    } else {
                        menageDate.setDate(menageDate.getDate() + 2);
                        heure = '12h00';
                    }
                }
                // R√àGLE 3: Lundi-Vendredi
                else {
                    heure = '12h00';
                }

                const dateKey = menageDate.toISOString().split('T')[0];
                const period = heure === '07h00' ? 'matin' : 'apr√®s-midi';

                if (!occupiedSlots[dateKey]) {
                    occupiedSlots[dateKey] = { matin: null, 'apr√®s-midi': null };
                }

                if (!occupiedSlots[dateKey][period]) {
                    occupiedSlots[dateKey][period] = r.gite;
                    planning.push({
                        date: menageDate,
                        heure: heure,
                        period: period,
                        gite: r.gite,
                        clientName: r.nom,
                        departDate: departDate
                    });
                } else {
                    const autreCreneau = period === 'matin' ? 'apr√®s-midi' : 'matin';
                    const autreHeure = period === 'matin' ? '12h00' : '07h00';

                    if (!occupiedSlots[dateKey][autreCreneau]) {
                        occupiedSlots[dateKey][autreCreneau] = r.gite;
                        planning.push({
                            date: menageDate,
                            heure: autreHeure,
                            period: autreCreneau,
                            gite: r.gite,
                            clientName: r.nom,
                            departDate: departDate
                        });
                    }
                }
            });

            const planningForMonth = planning.filter(p =>
                p.date.getFullYear() === targetYear && p.date.getMonth() === targetMonth
            );

            if (planningForMonth.length === 0) {
                showToast('Aucun m√©nage √† planifier pour ce mois', 'error');
                return;
            }

            // Cr√©er le workbook avec style
            const wb = XLSX.utils.book_new();
            
            // Pr√©parer les donn√©es avec formatage
            const data = planningForMonth.map(p => ({
                'üìÖ Date': p.date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }),
                '‚è∞ Heure': p.heure,
                'üè† G√Æte': p.gite,
                'üë§ Client': p.clientName,
                'üö™ D√©part': p.departDate.toLocaleDateString('fr-FR'),
                '‚ö° Enchainement': p.period === 'matin' ? 'Oui' : 'Non'
            }));

            // Cr√©er la feuille
            const ws = XLSX.utils.json_to_sheet(data);
            
            // D√©finir les largeurs de colonnes
            ws['!cols'] = [
                { wch: 35 }, // Date
                { wch: 10 }, // Heure
                { wch: 12 }, // G√Æte
                { wch: 20 }, // Client
                { wch: 12 }, // D√©part
                { wch: 15 }  // Enchainement
            ];
            
            const sheetName = `M√©nages ${monthInput}`;
            XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31));
            const dateToday = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `MenageCalvignac_${dateToday}.xlsx`);

            showToast(`‚úì Export Excel t√©l√©charg√© ! (${planningForMonth.length} m√©nages)`);
        }

        
        
        // ==========================================
        // üìÑ GESTION INFOS G√éTES & COMMUNICATION CLIENTS
        // ==========================================
        // D√âPLAC√â dans js/infos-gites.js et js/fiche-client.js
        // Fonctions disponibles :
        // - loadInfosGites, genererPageClient, envoyerViaWhatsApp, envoyerViaSMS
        // - telechargerPageHTML, aper√ßuFicheClient
        // - sauvegarder/chargerActivitesEtSorties (restaurants, Lyon, Dombes, parcs)
        // - rechercherEvenements, clearAllData
        // - saveInfosGiteToSupabase, loadInfosGiteFromSupabase
        
        // ==========================================
        // üó∫Ô∏è GESTION "√Ä D√âCOUVRIR"
        // ==========================================
        
        // Coordonn√©es GPS des g√Ætes (d√©finies dans shared-config.js)
        // Utiliser window.GITES_COORDS
        
        // Informations compl√®tes des g√Ætes
        const GITES_INFOS = {
            'Trevoux': {
                nom: 'G√Æte de Trevoux',
                emoji: 'üè∞',
                couleur_principale: '#667eea',
                couleur_secondaire: '#764ba2',
                adresse: '2 Grande Rue, 01600 Trevoux',
                code_acces: '1234A',
                wifi_nom: 'Gite_Trevoux',
                wifi_mdp: 'BienvenueTrevoux2024',
                parking: 'Parking gratuit rue de la R√©publique (2min √† pied)',
                contact_email: 'gite.trevoux@example.com',
                contact_telephone: '06 12 34 56 78',
                check_in: '16h00',
                check_out: '10h00',
                infos_pratiques: [
                    {
                        titre: 'üîë Acc√®s au Logement',
                        contenu: `
                            <p><strong>Adresse :</strong> 2 Grande Rue, 01600 Trevoux</p>
                            <p><strong>Code d'acc√®s :</strong></p>
                            <div class="highlight">1234A</div>
                            <p>Le bo√Ætier √† code est situ√© √† gauche de la porte d'entr√©e.</p>
                        `
                    },
                    {
                        titre: 'üì∂ WiFi',
                        contenu: `
                            <p><strong>R√©seau :</strong> Gite_Trevoux</p>
                            <div class="highlight">Mot de passe : BienvenueTrevoux2024</div>
                        `
                    },
                    {
                        titre: 'üöó Parking',
                        contenu: `
                            <p>Parking public gratuit rue de la R√©publique (2 minutes √† pied)</p>
                            <p>Places limit√©es, arrivez t√¥t le week-end.</p>
                        `
                    },
                    {
                        titre: 'üïê Horaires',
                        contenu: `
                            <p><strong>Arriv√©e :</strong> √† partir de 16h00</p>
                            <p><strong>D√©part :</strong> avant 10h00</p>
                            <p>Merci de respecter ces horaires pour permettre le m√©nage.</p>
                        `
                    },
                    {
                        titre: '‚ôªÔ∏è Tri des D√©chets',
                        contenu: `
                            <p><strong>Poubelle jaune :</strong> Recyclables (plastique, carton, m√©tal)</p>
                            <p><strong>Poubelle noire :</strong> Ordures m√©nag√®res</p>
                            <p><strong>Poubelle verte :</strong> Verre</p>
                            <p>Conteneurs situ√©s rue de la Mairie (50m)</p>
                        `
                    },
                    {
                        titre: 'üèõÔ∏è √Ä Proximit√© Imm√©diate',
                        contenu: `
                            <p>‚Ä¢ Boulangerie Chazelle (100m)</p>
                            <p>‚Ä¢ Supermarch√© Carrefour City (200m)</p>
                            <p>‚Ä¢ Pharmacie (150m)</p>
                            <p>‚Ä¢ Ch√¢teau-Fort de Trevoux (400m)</p>
                        `
                    },
                    {
                        titre: 'üö® Urgences',
                        contenu: `
                            <p><strong>Pompiers :</strong> 18</p>
                            <p><strong>SAMU :</strong> 15</p>
                            <p><strong>Police :</strong> 17</p>
                            <p><strong>H√¥pital le plus proche :</strong> Centre Hospitalier de Trevoux (1km)</p>
                        `
                    }
                ]
            },
            'Couzon': {
                nom: 'G√Æte de Couzon-au-Mont-d\'Or',
                emoji: '‚õ∞Ô∏è',
                couleur_principale: '#f093fb',
                couleur_secondaire: '#f5576c',
                adresse: '14 rue de la R√©publique, 69270 Couzon-au-Mont-d\'Or',
                code_acces: '5678B',
                wifi_nom: 'Gite_Couzon',
                wifi_mdp: 'BienvenueCouzon2024',
                parking: 'Parking priv√© derri√®re le g√Æte',
                contact_email: 'gite.couzon@example.com',
                contact_telephone: '06 98 76 54 32',
                check_in: '16h00',
                check_out: '10h00',
                infos_pratiques: [
                    {
                        titre: 'üîë Acc√®s au Logement',
                        contenu: `
                            <p><strong>Adresse :</strong> 14 rue de la R√©publique, 69270 Couzon-au-Mont-d'Or</p>
                            <p><strong>Code d'acc√®s :</strong></p>
                            <div class="highlight">5678B</div>
                            <p>Le bo√Ætier √† code est situ√© √† droite de la porte d'entr√©e.</p>
                        `
                    },
                    {
                        titre: 'üì∂ WiFi',
                        contenu: `
                            <p><strong>R√©seau :</strong> Gite_Couzon</p>
                            <div class="highlight">Mot de passe : BienvenueCouzon2024</div>
                        `
                    },
                    {
                        titre: 'üöó Parking',
                        contenu: `
                            <p><strong>Parking priv√©</strong> derri√®re le g√Æte</p>
                            <p>Acc√®s par le portail, code identique √† l'entr√©e du g√Æte.</p>
                            <p>2 places disponibles.</p>
                        `
                    },
                    {
                        titre: 'üïê Horaires',
                        contenu: `
                            <p><strong>Arriv√©e :</strong> √† partir de 16h00</p>
                            <p><strong>D√©part :</strong> avant 10h00</p>
                            <p>Merci de respecter ces horaires pour permettre le m√©nage.</p>
                        `
                    },
                    {
                        titre: '‚ôªÔ∏è Tri des D√©chets',
                        contenu: `
                            <p><strong>Poubelle jaune :</strong> Recyclables (plastique, carton, m√©tal)</p>
                            <p><strong>Poubelle noire :</strong> Ordures m√©nag√®res</p>
                            <p><strong>Poubelle verte :</strong> Verre</p>
                            <p>Conteneurs au fond de l'impasse</p>
                        `
                    },
                    {
                        titre: 'üèõÔ∏è √Ä Proximit√© Imm√©diate',
                        contenu: `
                            <p>‚Ä¢ Boulangerie (200m)</p>
                            <p>‚Ä¢ Supermarch√© Intermarch√© √† Albigny (2km)</p>
                            <p>‚Ä¢ Pharmacie √† Albigny (2km)</p>
                            <p>‚Ä¢ Sentiers de randonn√©e Mont d'Or (500m)</p>
                        `
                    },
                    {
                        titre: 'üö® Urgences',
                        contenu: `
                            <p><strong>Pompiers :</strong> 18</p>
                            <p><strong>SAMU :</strong> 15</p>
                            <p><strong>Police :</strong> 17</p>
                            <p><strong>H√¥pital le plus proche :</strong> H√¥pital Lyon Nord (8km)</p>
                        `
                    }
                ]
            }
        };
        
        // Stocker les activit√©s par g√Æte - Initialis√© dynamiquement
        let activitesParGite = {};
        
        // Initialiser activitesParGite dynamiquement
        function initActivitesParGite() {
            if (window.gitesManager && window.gitesManager.gites) {
                window.gitesManager.gites.forEach(gite => {
                    activitesParGite[gite.name] = [];
                });
            }
        }
        
        // Appeler init au chargement
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initActivitesParGite);
        } else {
            initActivitesParGite();
        }
        
        // ==================== FONCTIONS D√âCOUVRIR - D√©plac√©es dans js/decouvrir.js ====================
        // Les fonctions suivantes sont maintenant g√©r√©es par le module decouvrir.js :
        // - ouvrirModalActivite, fermerModalActivite
        // - calculerDistance, obtenirCoordonnees
        // - afficherTypeRestoSiRestaurant
        // - chargerActivites, afficherActivites
        // - supprimerActivite, modifierActivite
        // - filtrerActivitesParCategorie
        // - chargerToutSurCarte
        
        // Utiliser GITES_COORDS depuis shared-config.js (window.GITES_COORDS)
        // Pas besoin de red√©clarer ici
        
        // Fonction pour g√©ocoder une adresse (convertir adresse ‚Üí coordonn√©es GPS)
        async function geocodeAddress(address, giteName) {
            try {
                // Si l'adresse est vide, utiliser les coordonn√©es du g√Æte
                if (!address || address.trim() === '') {
                    const gite = await window.gitesManager.getByName(giteName);
                    if (gite) {
                        return await window.gitesManager.getCoordinates(gite.id);
                    }
                    // Fallback si g√Æte introuvable
                    return { lat: 45.9, lng: 4.8 };
                }
                
                // Utiliser Nominatim (OpenStreetMap) pour le g√©ocodage
                const encodedAddress = encodeURIComponent(address + ', France');
                
                // Ajouter un d√©lai pour respecter la politique de Nominatim (1 req/sec max)
                await new Promise(resolve => setTimeout(resolve, 1100));
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`, {
                    headers: {
                        'User-Agent': 'GestionGite/1.0 (gite.welcomehome@gmail.com)'
                    }
                });
                
                if (!response.ok) {
                    // Utiliser coordonn√©es par d√©faut
                    const gite = await window.gitesManager.getByName(giteName);
                    return gite ? await window.gitesManager.getCoordinates(gite.id) : { lat: 45.9, lng: 4.8 };
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                
                // Si le g√©ocodage √©choue, coordonn√©es par d√©faut du g√Æte
                const gite = await window.gitesManager.getByName(giteName);
                return gite ? await window.gitesManager.getCoordinates(gite.id) : { lat: 45.9, lng: 4.8 };
            } catch (error) {
                console.error('Erreur g√©ocodage:', address, error);
                const gite = await window.gitesManager.getByName(giteName);
                return gite ? await window.gitesManager.getCoordinates(gite.id) : { lat: 45.9, lng: 4.8 };
            }
        }
        
        // ==================== CHARGER TOUT SUR CARTE - D√©plac√© dans js/decouvrir.js ====================
        
        // Rechercher automatiquement via Google Places API (simulation sans cl√© API)
        async function rechercherAutomatique(type) {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîç Filtrage en cours...', 'info');
            
            // Mapper les types de recherche vers les cat√©gories
            const typeToCategorie = {
                'restaurants': 'üçΩÔ∏è Restaurant',
                'tourist_attraction': 'üèõÔ∏è Site Touristique',
                'shopping_mall': 'üõçÔ∏è Commerce',
                'park': 'üå≥ Nature & Randonn√©e'
            };
            
            const categorieRecherchee = typeToCategorie[type];
            
            if (!categorieRecherchee) {
                showNotification('‚ö†Ô∏è Type de recherche non reconnu', 'warning');
                return;
            }
            
            // R√©cup√©rer la distance max actuelle
            const maxDistance = parseInt(document.getElementById('distanceFilter').value);
            
            // Filtrer tous les points (√©v√©nements + activit√©s) selon la cat√©gorie ET la distance
            if (window.allEvenements) {
                const pointsFiltres = window.allEvenements.filter(item => {
                    return item.categorie === categorieRecherchee && item.distance <= maxDistance;
                });
                
                
                // Mettre √† jour la carte avec les points filtr√©s
                if (pointsFiltres.length > 0) {
                    afficherCarteEvenements(pointsFiltres);
                    showNotification(`‚úì ${pointsFiltres.length} point(s) de type "${categorieRecherchee}" (‚â§${maxDistance}km)`, 'success');
                } else {
                    showNotification(`‚ÑπÔ∏è Aucun point de type "${categorieRecherchee}" √† ‚â§${maxDistance}km`, 'info');
                }
            }
            
            // R√©cup√©rer les activit√©s du g√Æte s√©lectionn√©
            const activites = activitesParGite[gite] || [];
            
            // Filtrer par cat√©gorie
            const activitesFiltrees = activites.filter(act => act.categorie === categorieRecherchee);
            
            // Afficher les r√©sultats dans la liste
            const container = document.getElementById('activitesParCategorie');
            
            if (activitesFiltrees.length === 0) {
                window.SecurityUtils.setInnerHTML(container, `
                    <div class="alert-no-results">
                        <h3>Aucun r√©sultat pour "${categorieRecherchee}"</h3>
                        <p>Essayez d'ajouter des activit√©s de cette cat√©gorie manuellement ci-dessous.</p>
                    </div>
                `);
                return;
                return;
            }
            
            // Afficher uniquement cette cat√©gorie
            let html = `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--primary); font-size: 1.3rem; border-bottom: 2px solid var(--border); padding-bottom: 10px; flex: 1;">
                            ${categorieRecherchee} (${activitesFiltrees.length})
                        </h3>
                        <button onclick="afficherActivites('${gite}')" class="btn btn-show-activities">
                            üîÑ Tout Afficher
                        </button>
                    </div>
                    <div style="display: grid; gap: 15px;">
            `;
            
            activitesFiltrees.forEach(act => {
                const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) : '';
                const distanceText = act.distance ? `üìç ${act.distance} km` : '';
                const prixText = act.prix || '';
                
                html += `
                    <div class="activity-card">
                        <div class="activity-header">
                            <h4>${act.nom}</h4>
                            <div class="activity-actions">
                                <button onclick="modifierActivite(${act.id})" title="Modifier" class="btn-icon">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="supprimerActivite(${act.id})" title="Supprimer" class="btn-icon">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        ${act.description ? `<p style="margin: 10px 0; color: #555;">${act.description}</p>` : ''}
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; font-size: 0.9rem; color: #666;">
                            ${distanceText ? `<span>${distanceText}</span>` : ''}
                            ${noteStars ? `<span>${noteStars} ${act.note}/5 ${act.avis ? `(${act.avis} avis)` : ''}</span>` : ''}
                            ${prixText ? `<span>üí∞ ${prixText}</span>` : ''}
                        </div>
                        
                        ${act.adresse ? `<p style="margin: 10px 0 5px 0; color: #666; font-size: 0.9rem;">üìç ${act.adresse}</p>` : ''}
                        ${act.telephone ? `<p style="margin: 5px 0; color: #666; font-size: 0.9rem;">üìû ${act.telephone}</p>` : ''}
                        
                        <div class="flex-gap-10-mt-wrap">
                            ${act.google_maps_link ? `
                                <a href="${act.google_maps_link}" target="_blank" title="Itin√©raire Google Maps" class="link-maps">
                                    <img src="./images/location-pin.svg" alt="Localisation" style="width: 20px; height: 20px; object-fit: contain;">
                                </a>
                            ` : ''}
                            ${act.website ? `
                                <a href="${act.website}" target="_blank" title="Site web" class="link-website">
                                    <img src="./images/web-redirect.svg" alt="Web" style="width: 20px; height: 20px; object-fit: contain;">
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            window.SecurityUtils.setInnerHTML(container, html);
            
            showNotification(`‚úì ${activitesFiltrees.length} activit√©(s) trouv√©e(s) pour "${categorieRecherchee}"`, 'success');
        }
        
        // Rechercher les √©v√©nements de la semaine
        async function rechercherEvenements() {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîç Recherche d\'√©v√©nements...', 'info');
            
            const evenementsDiv = document.getElementById('evenementsListe');
            const mapDiv = document.getElementById('mapEvenements');
            
            // Obtenir la date d'ouverture de la page (aujourd'hui)
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Lundi de cette semaine
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Dimanche
            
            const dateRangeStr = `${startOfWeek.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })} au ${endOfWeek.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}`;
            document.getElementById('dateEvenements').textContent = dateRangeStr;
            
            // Fonction pour g√©n√©rer les √©v√©nements de la semaine en cours
            function genererEvenementsSemaine(gite) {
                const evenements = [];
                const joursSemaine = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
                
                // √âv√©nements r√©currents selon le g√Æte
                if (gite === 'Trevoux') {
                    // March√© de Trevoux - tous les samedis
                    const samedi = new Date(startOfWeek);
                    samedi.setDate(startOfWeek.getDate() + 5); // Samedi
                    evenements.push({
                        titre: 'March√© de Trevoux',
                        date: `Samedi ${samedi.getDate()}/${samedi.getMonth() + 1} - 8h √† 13h`,
                        dateDebut: samedi,
                        dateFin: new Date(samedi.getTime() + 5 * 60 * 60 * 1000), // +5h
                        lieu: 'Place de la Terrasse, Trevoux',
                        description: 'March√© hebdomadaire avec produits locaux, fromages, fruits et l√©gumes frais',
                        lien: 'https://www.ville-trevoux.fr',
                        icone: 'üõí',
                        distance: 0.5,
                        lat: 45.9394,
                        lng: 4.7728,
                        type: 'evenement'
                    });
                    
                    // Visite du Ch√¢teau - mercredi au dimanche
                    for (let i = 3; i <= 6; i++) { // Mercredi √† samedi
                        const jour = new Date(startOfWeek);
                        jour.setDate(startOfWeek.getDate() + i - 1);
                        if (i === 3) { // Ajouter seulement une fois
                            evenements.push({
                                titre: 'Visite du Ch√¢teau-Fort',
                                date: `Mercredi au dimanche - 14h √† 18h`,
                                dateDebut: jour,
                                dateFin: endOfWeek,
                                lieu: 'Mont√©e du Ch√¢teau, Trevoux',
                                description: 'Monument Historique class√© en 1913. D√©couvrez l\'histoire du Parlement de Dombes',
                                lien: 'https://www.ain-tourisme.com',
                                icone: 'üè∞',
                                distance: 1,
                                lat: 45.9404,
                                lng: 4.7738,
                                type: 'evenement'
                            });
                        }
                    }
                    
                    // Concert √† l'√©glise - vendredi soir
                    const vendredi = new Date(startOfWeek);
                    vendredi.setDate(startOfWeek.getDate() + 4);
                    evenements.push({
                        titre: 'Concert √† l\'√âglise Saint-Symphorien',
                        date: `Vendredi ${vendredi.getDate()}/${vendredi.getMonth() + 1} - 20h30`,
                        dateDebut: vendredi,
                        dateFin: new Date(vendredi.getTime() + 2 * 60 * 60 * 1000),
                        lieu: '√âglise Saint-Symphorien, Trevoux',
                        description: 'Concert de musique classique avec l\'ensemble Les Cordes de l\'Ain',
                        lien: 'https://www.ville-trevoux.fr/culture',
                        icone: 'üéµ',
                        distance: 0.8,
                        lat: 45.9410,
                        lng: 4.7745,
                        type: 'evenement'
                    });
                    
                    // Atelier cr√©atif - mercredi apr√®s-midi
                    const mercredi = new Date(startOfWeek);
                    mercredi.setDate(startOfWeek.getDate() + 2);
                    evenements.push({
                        titre: 'Atelier Cr√©atif Enfants',
                        date: `Mercredi ${mercredi.getDate()}/${mercredi.getMonth() + 1} - 14h √† 16h`,
                        dateDebut: mercredi,
                        dateFin: new Date(mercredi.getTime() + 2 * 60 * 60 * 1000),
                        lieu: 'M√©diath√®que de Trevoux',
                        description: 'Atelier de cr√©ation manuelle pour les 6-12 ans. Inscription gratuite.',
                        lien: 'https://www.mediatheque-trevoux.fr',
                        icone: 'üé®',
                        distance: 0.6,
                        lat: 45.9398,
                        lng: 4.7720,
                        type: 'evenement'
                    });
                    
                } else if (gite === 'Couzon') {
                    // March√© de Couzon - tous les dimanches
                    const dimanche = new Date(startOfWeek);
                    dimanche.setDate(startOfWeek.getDate() + 6);
                    evenements.push({
                        titre: 'March√© de Couzon',
                        date: `Dimanche ${dimanche.getDate()}/${dimanche.getMonth() + 1} - 8h √† 13h`,
                        dateDebut: dimanche,
                        dateFin: new Date(dimanche.getTime() + 5 * 60 * 60 * 1000),
                        lieu: 'Place du village, Couzon',
                        description: 'March√© local avec producteurs de la r√©gion',
                        lien: 'https://www.couzon-au-mont-dor.fr',
                        icone: 'üõí',
                        distance: 0.3,
                        lat: 45.8452,
                        lng: 4.8375,
                        type: 'evenement'
                    });
                    
                    // Randonn√©e guid√©e - samedi matin
                    const samedi = new Date(startOfWeek);
                    samedi.setDate(startOfWeek.getDate() + 5);
                    evenements.push({
                        titre: 'Randonn√©e Guid√©e Mont d\'Or',
                        date: `Samedi ${samedi.getDate()}/${samedi.getMonth() + 1} - 9h`,
                        dateDebut: samedi,
                        dateFin: new Date(samedi.getTime() + 3 * 60 * 60 * 1000),
                        lieu: 'D√©part parking Mont d\'Or, Couzon',
                        description: 'Randonn√©e de 3h avec guide pour d√©couvrir la faune et la flore locale',
                        lien: 'https://www.monts-dor.com',
                        icone: 'ü•æ',
                        distance: 0.5,
                        lat: 45.8442,
                        lng: 4.8365,
                        type: 'evenement'
                    });
                    
                    // Yoga en plein air - mercredi et vendredi
                    const mercredi = new Date(startOfWeek);
                    mercredi.setDate(startOfWeek.getDate() + 2);
                    evenements.push({
                        titre: 'Yoga en Plein Air',
                        date: `Mercredi ${mercredi.getDate()}/${mercredi.getMonth() + 1} - 18h30`,
                        dateDebut: mercredi,
                        dateFin: new Date(mercredi.getTime() + 1.5 * 60 * 60 * 1000),
                        lieu: 'Parc de Couzon',
                        description: 'S√©ance de yoga tous niveaux en ext√©rieur. Apportez votre tapis.',
                        lien: 'https://www.couzon-au-mont-dor.fr/yoga',
                        icone: 'üßò',
                        distance: 0.4,
                        lat: 45.8445,
                        lng: 4.8370,
                        type: 'evenement'
                    });
                    
                    // D√©gustation de vins - jeudi soir
                    const jeudi = new Date(startOfWeek);
                    jeudi.setDate(startOfWeek.getDate() + 3);
                    evenements.push({
                        titre: 'D√©gustation Vins Locaux',
                        date: `Jeudi ${jeudi.getDate()}/${jeudi.getMonth() + 1} - 19h`,
                        dateDebut: jeudi,
                        dateFin: new Date(jeudi.getTime() + 2 * 60 * 60 * 1000),
                        lieu: 'Cave du Mont d\'Or, Couzon',
                        description: 'D√©couverte des vins de la r√©gion avec un sommelier. R√©servation conseill√©e.',
                        lien: 'https://www.cave-montdor.fr',
                        icone: 'üç∑',
                        distance: 0.7,
                        lat: 45.8448,
                        lng: 4.8372,
                        type: 'evenement'
                    });
                }
                
                return evenements;
            }
            
            // G√©n√©rer les √©v√©nements de la semaine en cours
            window.allEvenements = genererEvenementsSemaine(gite);
            
            if (window.allEvenements.length === 0) {
                window.SecurityUtils.setInnerHTML(evenementsDiv, '<p style="text-align: center; color: #999; padding: 40px;">Aucun √©v√©nement trouv√© pour ce g√Æte</p>');
                showNotification('‚ö†Ô∏è Aucun √©v√©nement trouv√©', 'warning');
                mapDiv.style.display = 'none';
                return;
            }
            
            // Afficher la carte
            mapDiv.style.display = 'block';
            afficherCarteEvenements(window.allEvenements);
            
            // Appliquer le filtre de distance
            filtrerEvenements();
            
            showNotification(`‚úì ${window.allEvenements.length} √©v√©nement(s) trouv√©(s)`, 'success');
        }
        
        // Fonction pour filtrer les √©v√©nements selon la distance
        function filtrerEvenements() {
            const distanceFilter = document.getElementById('distanceFilter');
            let maxDistance = 50; // Distance par d√©faut si pas de slider
            
            if (!distanceFilter) {
            } else {
                maxDistance = parseInt(distanceFilter.value);
            }
            
            const evenementsFiltres = window.allEvenements.filter(e => e.distance <= maxDistance);
            
            const evenementsDiv = document.getElementById('evenementsListe');
            const gite = document.getElementById('decouvrir_gite').value;
            
            if (evenementsFiltres.length === 0) {
                window.SecurityUtils.setInnerHTML(evenementsDiv, '<p style="text-align: center; color: #999; padding: 40px;">Aucun √©v√©nement trouv√© dans ce rayon</p>');
                return;
            }
            
            let html = `
                <div class="event-header">
                    <strong>üìÖ ${evenementsFiltres.length} √©v√©nement(s) autour de ${gite}</strong> (‚â§ ${maxDistance} km)<br>
                    <small>Mis √† jour le ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</small>
                </div>
            `;
            
            evenementsFiltres.forEach(event => {
                html += `
                    <div class="event-card">
                        <h3>
                            <span>${event.icone}</span> ${event.titre}
                        </h3>
                        <p><strong>üìç</strong> ${event.lieu} <span class="badge-distance">${event.distance} km</span></p>
                        <p><strong>üóìÔ∏è</strong> ${event.date}</p>
                        <p>${event.description}</p>
                        <a href="${event.lien}" target="_blank" class="link-event">
                            üîó Plus d'infos
                        </a>
                    </div>
                `;
            });
            
            window.SecurityUtils.setInnerHTML(evenementsDiv, html);
        }
        
        // Variables globales pour la carte
        let mapInstance = null;
        let markersLayer = null;
        let giteMarker = null;
        let filtreCategorieActive = null; // Variable pour stocker le filtre de cat√©gorie actif
        
        // Coordonn√©es des g√Ætes - Charg√©es dynamiquement depuis gitesManager
        const giteCoords = {};
        
        // Initialiser les coordonn√©es des g√Ætes au chargement
        function initGiteCoords() {
            if (window.gitesManager && window.gitesManager.gites) {
                window.gitesManager.gites.forEach(gite => {
                    if (gite.gps_lat && gite.gps_lon) {
                        giteCoords[gite.name] = { 
                            lat: parseFloat(gite.gps_lat), 
                            lng: parseFloat(gite.gps_lon) 
                        };
                    }
                });
            }
        }
        
        // Appeler init au chargement
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGiteCoords);
        } else {
            initGiteCoords();
        }
        
        // Fonction pour afficher tout (r√©initialise les filtres)
        function afficherTout() {
            if (window.allEvenements && window.allEvenements.length > 0) {
                // R√©initialiser le filtre de distance
                const maxDistance = parseInt(document.getElementById('distanceFilter').value);
                const pointsFiltres = window.allEvenements.filter(e => e.distance <= maxDistance);
                
                afficherCarteEvenements(pointsFiltres);
                showNotification(`‚úì ${pointsFiltres.length} points affich√©s (‚â§${maxDistance}km)`, 'success');
            }
        }
        
        // Fonction pour afficher la carte avec les √©v√©nements
        // üé® Fonction pour obtenir l'ic√¥ne du marqueur selon la cat√©gorie
        function getMarkerIcon(item) {
            let markerUrl = './images/location-pin.svg';
            let markerColor = '#667eea';
            
            if (item.isActivite && item.categorie) {
                switch(item.categorie) {
                    case 'Restaurant':
                        markerUrl = './images/marker-restaurant.svg';
                        markerColor = '#10b981';
                        break;
                    case 'Mus√©e':
                        markerUrl = './images/marker-musee.svg';
                        markerColor = '#3b82f6';
                        break;
                    case 'Caf√©':
                        markerUrl = './images/marker-cafe.svg';
                        markerColor = '#f59e0b';
                        break;
                    case 'Parc':
                        markerUrl = './images/marker-parc.svg';
                        markerColor = '#8b5cf6';
                        break;
                    case 'H√¥tel':
                        markerUrl = './images/marker-hotel.svg';
                        markerColor = '#ec4899';
                        break;
                }
            }
            
            // Cr√©er une ic√¥ne avec l'image SVG
            const iconHtml = `<img src="${markerUrl}" alt="${item.categorie || 'Marqueur'}" style="width: 40px; height: 40px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">`;
            
            return L.divIcon({
                html: iconHtml,
                className: 'custom-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }
        
        function afficherCarteEvenements(evenements) {
            const mapContainer = document.getElementById('mapEvenements');
            
            // Si aucun √©v√©nement n'est fourni, utiliser les activit√©s charg√©es
            if (!evenements) {
                const gite = document.getElementById('decouvrir_gite')?.value;
                if (gite && window.activitesParGite && window.activitesParGite[gite]) {
                    evenements = window.activitesParGite[gite];
                } else {
                    evenements = [];
                }
            }
            
            // Filtrer les √©v√©nements (ne garder que les activit√©s permanentes, pas les √©v√©nements)
            evenements = evenements.filter(e => !e.type || e.type !== 'evenement');
            
            // Filtrer les points avec des coordonn√©es valides
            let evenementsValides = evenements.filter(e => {
                const isValid = e.lat && e.lng && !isNaN(e.lat) && !isNaN(e.lng) && 
                               isFinite(e.lat) && isFinite(e.lng);
                return isValid;
            });
            
            const nbInvalides = evenements.length - evenementsValides.length;
            if (nbInvalides > 0) {
            }
            
            // üîç Appliquer le filtre de cat√©gorie s'il est actif
            if (window.filtreCategorieActive) {
                evenementsValides = evenementsValides.filter(e => 
                    e.categorie && e.categorie.toLowerCase().includes(window.filtreCategorieActive.toLowerCase())
                );
            }
            
            if (evenementsValides.length === 0) {
                // console.error('‚ùå Aucun point avec coordonn√©es valides');
                mapContainer.style.display = 'none';
                return;
            }
            
            mapContainer.style.display = 'block';
            
            // V√©rifier si la carte existe d√©j√† (via l'attribut Leaflet)
            const carteExiste = mapContainer._leaflet_id !== undefined;
            
            // Si la carte n'existe pas encore, la cr√©er
            if (!carteExiste && !mapInstance) {
                try {
                    
                    // Cr√©er la carte Leaflet avec zoom activ√©
                    mapInstance = L.map('mapEvenements', {
                        center: [46.2276, 2.2137],
                        zoom: 6,
                        zoomControl: true,
                        scrollWheelZoom: true,
                        doubleClickZoom: true,
                        boxZoom: true,
                        keyboard: true,
                        dragging: true
                    });
                    
                    // Ajouter les tuiles OpenStreetMap
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 18
                    }).addTo(mapInstance);
                    
                    // Cr√©er un layer group pour les marqueurs
                    markersLayer = L.layerGroup().addTo(mapInstance);
                    
                } catch (error) {
                    console.error('‚ùå Erreur cr√©ation carte:', error);
                    window.SecurityUtils.setInnerHTML(mapContainer, '<p style="text-align: center; padding: 40px; color: #999;">Erreur lors du chargement de la carte</p>');
                    return;
                }
            }
            
            // Si la carte existe mais les layers pas, les recr√©er
            if (mapInstance && !markersLayer) {
                markersLayer = L.layerGroup().addTo(mapInstance);
            }
            
            if (!mapInstance || !markersLayer) {
                console.error('‚ùå Carte ou layer non disponibles');
                return;
            }
            
            // Effacer tous les marqueurs existants
            markersLayer.clearLayers();
            
            // Ajouter un marqueur pour le g√Æte s√©lectionn√©
            const giteSelectionne = document.getElementById('decouvrir_gite').value;
            if (giteSelectionne && giteCoords[giteSelectionne]) {
                const coords = giteCoords[giteSelectionne];
                const giteIconHtml = `
                    <div class="gite-icon-marker">
                        <i data-lucide="building-2" style="width: 32px; height: 32px; color: #ff5a5f;"></i>
                    </div>
                `;
                const giteIcon = L.divIcon({
                    html: giteIconHtml,
                    className: 'gite-marker',
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                });
                
                giteMarker = L.marker([coords.lat, coords.lng], { icon: giteIcon });
                giteMarker.bindPopup(`
                    <div style="text-align: center; padding: 10px;">
                        <h3 style="margin: 0; font-size: 1rem; color: #ff5a5f; font-weight: 700; text-transform: uppercase;">
                            <i data-lucide="building-2"></i> Tr√©voux
                        </h3>
                        <p style="margin: 5px 0 0 0; font-size: 0.9rem;">Point de r√©f√©rence</p>
                    </div>
                `);
                giteMarker.addTo(markersLayer);
            }
            
            // Ajouter les nouveaux marqueurs
            evenementsValides.forEach((item, index) => {
                // Debug: afficher les 3 premiers points
                if (index < 3) {
                }
                
                // Utiliser la fonction pour obtenir l'ic√¥ne appropri√©e
                const customIcon = getMarkerIcon(item);
                
                const marker = L.marker([item.lat, item.lng], { icon: customIcon });
                
                // Popup avec les informations
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #667eea; font-size: 1.1rem;">
                            ${item.titre || item.nom}
                        </h3>
                        ${item.categorie ? `<p class="badge-category"><strong>üìÇ</strong> ${item.categorie}</p>` : ''}
                        <p style="margin: 8px 0; font-size: 0.9rem;"><strong>üìç</strong> ${item.lieu || item.adresse || 'Non sp√©cifi√©'}</p>
                        ${item.date ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>üóìÔ∏è</strong> ${item.date}</p>` : ''}
                        ${item.distance ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>üìè</strong> ${item.distance} km</p>` : ''}
                        ${item.description ? `<p style="margin: 10px 0; font-size: 0.85rem; line-height: 1.4;">${item.description}</p>` : ''}
                        ${item.note ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>‚≠ê</strong> ${item.note}/5</p>` : ''}
                        ${item.telephone ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>üìû</strong> ${item.telephone}</p>` : ''}
                        ${item.lien ? `<a href="${item.lien}" target="_blank" class="link-info">üîó Plus d'infos</a>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.addTo(markersLayer);
            });
            
            // Ajuster la vue pour inclure tous les marqueurs
            if (evenementsValides.length > 0) {
                const bounds = L.latLngBounds(evenementsValides.map(e => [e.lat, e.lng]));
                mapInstance.fitBounds(bounds.pad(0.1));
            }
        }
        
        // Mettre √† jour le label de distance
        function updateDistanceLabel() {
            const distance = document.getElementById('distanceFilter').value;
            document.getElementById('distanceLabel').textContent = `‚â§ ${distance} km`;
            
            // Refiltrer les √©v√©nements et la carte si des √©v√©nements sont charg√©s
            if (window.allEvenements && window.allEvenements.length > 0) {
                const maxDistance = parseInt(distance);
                const pointsFiltres = window.allEvenements.filter(e => e.distance <= maxDistance);
                
                // Mettre √† jour la carte avec les points filtr√©s
                afficherCarteEvenements(pointsFiltres);
                
                // Mettre √† jour la liste
                filtrerEvenements();
            }
        }
        
        // Rafra√Æchir les √©v√©nements
        function refreshEvenements() {
            rechercherEvenements();
        }
        
        // Mettre √† jour le label de distance pour la carte
        function updateDistanceLabelCarte() {
            const distance = document.getElementById('distanceSliderCarte')?.value || 50;
            const label = document.getElementById('distanceLabelCarte');
            if (label) label.textContent = `‚â§ ${distance} km`;
            
            // Filtrer les activit√©s affich√©es sur la carte par distance
            if (window.allActivites && window.allActivites.length > 0) {
                const distanceMax = parseFloat(distance);
                const activitesFiltrees = window.allActivites.filter(act => {
                    const actDistance = parseFloat(act.distance) || 0;
                    return actDistance <= distanceMax;
                });
                
                afficherCarteEvenements(activitesFiltrees);
            }
        }
        
        // Filtrer la carte par cat√©gorie
        function filtrerCarteParcategorie(categorie) {
            // Si pas de cat√©gorie fournie, utiliser "tous"
            if (!categorie) categorie = 'tous';
            
            // Mettre √† jour les boutons actifs
            const boutons = document.querySelectorAll('.btn-filtre-cat');
            boutons.forEach(btn => {
                const btnCat = btn.getAttribute('data-categorie');
                if (btnCat === categorie) {
                    btn.style.background = 'rgba(255,255,255,0.9)';
                    btn.style.color = '#667eea';
                    btn.style.borderColor = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'rgba(255,255,255,0.2)';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'transparent';
                    btn.classList.remove('active');
                }
            });
            
            const giteInput = document.getElementById('decouvrir_gite');
            const gite = giteInput ? giteInput.value : 'Trevoux';
            
            if (categorie === 'tous') {
                // Afficher toutes les activit√©s
                if (window.activitesParGite && window.activitesParGite[gite]) {
                    afficherCarteEvenements(window.activitesParGite[gite]);
                }
            } else {
                // Filtrer par cat√©gorie
                if (window.activitesParGite && window.activitesParGite[gite]) {
                    const filtered = window.activitesParGite[gite].filter(act => {
                        const actCategorie = act.categorie || act.type || '';
                        return actCategorie.toLowerCase().includes(categorie.toLowerCase()) || 
                               categorie.toLowerCase().includes(actCategorie.toLowerCase());
                    });
                    afficherCarteEvenements(filtered);
                }
            }
        }
        
        // Afficher tous les points sur la carte
        function afficherTout() {
            if (window.allEvenements && window.allEvenements.length > 0) {
                afficherCarteEvenements(window.allEvenements);
                filtrerEvenements();
                showNotification(`‚úì ${window.allEvenements.length} points affich√©s`, 'success');
                
                // R√©afficher toutes les activit√©s dans la liste
                const gite = document.getElementById('decouvrir_gite').value;
                if (gite) {
                    afficherActivites(gite);
                }
            } else {
                showNotification('‚ö†Ô∏è Chargez d\'abord les donn√©es en s√©lectionnant un g√Æte', 'warning');
            }
        }
        
        // Toggle du formulaire d'ajout d'activit√©
        function toggleFormAjout() {
            // Ouvrir la modale pour ajouter une activit√©
            ouvrirModalActivite(false);
        }
        
        // Ajouter une activit√© manuellement
        async function ajouterActivite() {
            const gite = document.getElementById('decouvrir_gite').value;
            const nom = document.getElementById('activite_nom').value.trim();
            const categorie = document.getElementById('activite_categorie').value;
            const description = document.getElementById('activite_description').value.trim();
            const adresse = document.getElementById('activite_adresse').value.trim();
            const distance = document.getElementById('activite_distance').value;
            const website = document.getElementById('activite_website').value.trim();
            const telephone = document.getElementById('activite_telephone').value.trim();
            const note = document.getElementById('activite_note').value;
            const avis = document.getElementById('activite_avis').value;
            const prixValue = document.getElementById('activite_prix').value;
            const typeRestaurant = document.getElementById('activite_type_resto').value.trim();
            const latitudeManuelle = document.getElementById('activite_latitude').value;
            const longitudeManuelle = document.getElementById('activite_longitude').value;
            
            if (!gite || !nom || !categorie || !adresse) {
                showNotification('‚ö†Ô∏è Remplissez les champs obligatoires (nom, cat√©gorie, adresse)', 'warning');
                return;
            }
            
            // Utiliser les coordonn√©es manuelles si fournies, sinon g√©ocoder
            let coords;
            if (latitudeManuelle && longitudeManuelle) {
                coords = {
                    lat: parseFloat(latitudeManuelle),
                    lng: parseFloat(longitudeManuelle)
                };
                showNotification('üìç Utilisation des coordonn√©es manuelles', 'info');
            } else {
                showNotification('üìç G√©ocodage de l\'adresse...', 'info');
                coords = await geocodeAddress(adresse, gite);
            }
            
            // Pr√©parer les donn√©es de base (sans gite ni distance)
            const activiteBase = {
                nom,
                categorie,
                description,
                adresse,
                website,
                telephone,
                note: note ? parseFloat(note) : null,
                avis: avis ? parseInt(avis) : null,
                prix: prixValue || null,
                latitude: coords.lat,
                longitude: coords.lng
            };
            
            try {
                // Mode MODIFICATION si un ID est stock√©
                if (window.activiteEnCoursDeModification) {
                    const { data, error } = await supabase
                        .from('activites_gites')
                        .update({ ...activiteBase, gite })
                        .eq('id', window.activiteEnCoursDeModification)
                        .select();
                    
                    if (error) throw error;
                    
                    showNotification('‚úì Activit√© modifi√©e avec succ√®s !', 'success');
                    
                    // R√©initialiser le mode modification
                    delete window.activiteEnCoursDeModification;
                    
                    // Fermer la modale
                    fermerModalActivite();
                    
                    // Recharger les activit√©s
                    await chargerActivites();
                    
                } else {
                    // Mode AJOUT : Cr√©er l'activit√© dans les DEUX g√Ætes avec distance calcul√©e
                    const activites = [];
                    
                    // Pour chaque g√Æte, calculer la distance et cr√©er une entr√©e
                    for (const [nomGite, coordsGite] of Object.entries(window.GITES_COORDS)) {
                        const distanceCalculee = calculerDistance(
                            coordsGite.lat, coordsGite.lng,
                            coords.lat, coords.lng
                        );
                        
                        activites.push({
                            ...activiteBase,
                            gite: nomGite,
                            distance: distanceCalculee
                        });
                    }
                    
                    const { data, error } = await supabase
                        .from('activites_gites')
                        .insert(activites)
                        .select();
                    
                    if (error) throw error;
                    
                    showNotification(`‚úì Activit√© ajout√©e dans Trevoux et Couzon !`, 'success');
                    
                    // Fermer la modale apr√®s ajout
                    fermerModalActivite();
                    
                    // Recharger les activit√©s
                    await chargerActivites();
                }
                
            } catch (error) {
                console.error('Erreur activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // Afficher les activit√©s par cat√©gorie
        // Fonction d'aide pour obtenir les couleurs par cat√©gorie
        function getCategoryColor(categorie) {
            const colors = {
                'Restaurant': { badge: '#10b981', light: '#d1fae5' },
                'Mus√©e': { badge: '#3b82f6', light: '#dbeafe' },
                'Caf√©': { badge: '#f59e0b', light: '#fef3c7' },
                'Parc': { badge: '#8b5cf6', light: '#ede9fe' },
                'H√¥tel': { badge: '#ec4899', light: '#fce7f3' }
            };
            return colors[categorie] || { badge: '#667eea', light: '#e0e7ff' };
        }
        
        // ‚ö†Ô∏è FONCTION SUPPRIM√âE - Maintenant dans js/decouvrir.js
        // La fonction afficherActivites() est d√©finie dans js/decouvrir.js
        // et export√©e vers window.afficherActivites
        
        // Supprimer une activit√©
        async function supprimerActivite(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette activit√© ?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('activites_gites')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showNotification('‚úì Activit√© supprim√©e', 'success');
                await chargerActivites();
                
            } catch (error) {
                console.error('Erreur suppression activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // ‚ö†Ô∏è FONCTIONS SUPPRIM√âES - Maintenant dans js/decouvrir.js
        // Les fonctions suivantes sont d√©finies dans js/decouvrir.js et export√©es vers window:
        // - filtrerActivitesParCategorie()
        // - afficherToutesActivites()
        // - afficherActivitesFiltr√©es()
        
        // Modifier une activit√©
        async function modifierActivite(id) {
            try {
                // R√©cup√©rer l'√©l√©ment de l'activit√©
                const element = document.querySelector(`[data-activite-id="${id}"]`);
                let positionY = window.innerHeight / 2; // Par d√©faut au centre
                
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Attendre un peu que le scroll soit fait
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // R√©cup√©rer la position de l'√©l√©ment
                    const rect = element.getBoundingClientRect();
                    positionY = rect.top + window.scrollY + rect.height / 2;
                }
                
                // R√©cup√©rer l'activit√© √† modifier
                const { data, error } = await supabase
                    .from('activites_gites')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Pr√©-remplir le formulaire
                document.getElementById('activite_nom').value = data.nom || '';
                document.getElementById('activite_categorie').value = data.categorie || '';
                document.getElementById('activite_description').value = data.description || '';
                document.getElementById('activite_adresse').value = data.adresse || '';
                document.getElementById('activite_distance').value = data.distance || '';
                document.getElementById('activite_note').value = data.note || '';
                document.getElementById('activite_avis').value = data.avis || '';
                document.getElementById('activite_prix').value = data.prix || '';
                document.getElementById('activite_telephone').value = data.telephone || '';
                document.getElementById('activite_website').value = data.website || '';
                
                // Afficher/cacher le champ type de restaurant selon la cat√©gorie
                afficherTypeRestoSiRestaurant();
                
                // Stocker l'ID en cours de modification
                window.activiteEnCoursDeModification = id;
                
                // Ouvrir la modale en mode modification avec position
                ouvrirModalActivite(true, positionY);
                
                showNotification('‚úèÔ∏è Mode modification activ√©', 'info');
                
            } catch (error) {
                console.error('Erreur modification activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // G√©n√©rer le guide PDF
        function genererGuideDecouverte() {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîÑ G√©n√©ration du guide en cours...', 'info');
            
            // TODO: Impl√©menter la g√©n√©ration PDF avec jsPDF
            setTimeout(() => {
                showNotification('‚úì Guide g√©n√©r√© ! (√Ä impl√©menter)', 'success');
            }, 1000);
        }
        
        // G√©n√©rer la fiche client pour une r√©servation
        async function genererFicheClient(reservation) {
            showNotification('‚ö†Ô∏è Fonctionnalit√© temporairement d√©sactiv√©e pour debug', 'warning');
            console.log('genererFicheClient appel√©e pour:', reservation);
        }
        
        // Aper√ßu fiche client depuis l'ID de r√©servation
        async function aper√ßuFicheClient(reservationId) {
            try {
                const reservations = await getAllReservations();
                const reservation = reservations.find(r => r.id === reservationId);
                
                if (!reservation) {
                    showNotification('‚ùå R√©servation introuvable', 'error');
                    return;
                }
                
                // Fermer le modal
                const modal = document.querySelector('[onclick*="this.closest"]');
                if (modal) modal.closest('div').parentElement.remove();
                
                // G√©n√©rer la fiche
                await genererFicheClient(reservation);
                
            } catch (error) {
                console.error('Erreur aper√ßu fiche client:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        
        // Syst√®me de notifications
        function showNotification(message, type = 'info') {
            // Cr√©er ou r√©cup√©rer le conteneur de notifications
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; max-width: 400px;';
                document.body.appendChild(container);
            }
            
            // Cr√©er la notification
            const notification = document.createElement('div');
            
            // Couleurs selon le type
            const colors = {
                success: '#27AE60',
                error: '#E74C3C',
                warning: '#F39C12',
                info: '#3498DB'
            };
            
            const icons = {
                success: String.fromCodePoint(0x2713),
                error: String.fromCodePoint(0x274C),
                warning: String.fromCodePoint(0x26A0, 0xFE0F),
                info: String.fromCodePoint(0x2139, 0xFE0F)
            };
            
            const bgColor = colors[type] || colors.info;
            notification.style.cssText = 
                'background: ' + bgColor + ';' +
                'color: white;' +
                'padding: 15px 20px;' +
                'border-radius: 8px;' +
                'box-shadow: 0 4px 12px rgba(0,0,0,0.15);' +
                'font-weight: 600;' +
                'display: flex;' +
                'align-items: center;' +
                'gap: 10px;' +
                'animation: slideIn 0.3s ease;';
            
            // Cr√©er le contenu de mani√®re s√©curis√©e
            const iconSpan = document.createElement('span');
            iconSpan.style.fontSize = '1.2rem';
            iconSpan.textContent = icons[type] || icons.info;
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            
            notification.appendChild(iconSpan);
            notification.appendChild(messageSpan);
            
            // Ajouter au conteneur
            container.appendChild(notification);
            
            // Supprimer apr√®s 3 secondes
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                    if (container.children.length === 0) {
                        container.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // Alias pour compatibilit√©
        window.showToast = showNotification;
        
        // ==================== GOOGLE MAPS - VARIABLES D√âPLAC√âES DANS js/decouvrir.js ====================
        // Voir js/decouvrir.js pour: googleMap, allMarkers, googleGiteMarker, infoWindow,
        // directionsService, directionsRenderer, gitesCoordinates, categoryColors, etc.

        // ==================== √âV√âNEMENT: Changement de g√Æte ====================
        // L'√©v√©nement sera g√©r√© par la fonction selectGiteDecouvrir existante
        // qui sera modifi√©e pour recharger la carte Google Maps
        
    </script>
    
    <!-- Chargement dynamique des onglets -->
    <script>
    /* ‚ö†Ô∏è ANCIEN SYST√àME DE CHARGEMENT - D√âSACTIV√â car remplac√© par le nouveau syst√®me (ligne ~155)
    document.addEventListener('DOMContentLoaded', async function() {
        // üîê L'affichage utilisateur est maintenant g√©r√© par auth.js dans updateUI()
        // apr√®s le chargement des r√¥les depuis Supabase
        
        // üè† Initialiser GitesManager
        if (!window.gitesManager) {
            window.gitesManager = new GitesManager();
            console.log('‚úÖ GitesManager initialis√©');
        }
        
        const tabFiles = {
            'tab-dashboard': '/tabs/tab-dashboard.html?v=3.4',
            'tab-gestion': '/tabs/tab-gestion.html',
            'tab-reservations': '/tabs/tab-reservations.html',
            'tab-archives': '/tabs/tab-archives.html',
            'tab-statistiques': '/tabs/tab-statistiques.html',
            'tab-charges': '/tabs/tab-fiscalite-v2.html',
            'tab-menage': '/tabs/tab-menage.html?v=4.1',
            'tab-infos-gites': '/tabs/tab-infos-gites.html',
            'tab-checklists': '/tabs/tab-checklists.html',
            'tab-draps': '/tabs/tab-draps.html',
            'tab-decouvrir': '/tabs/tab-decouvrir.html'
        };
        
        // Charger tous les fragments d'onglets
        const loadPromises = Object.entries(tabFiles).map(([tabId, file]) => {
            return fetch(file)
                .then(r => r.text())
                .then(html => {
                    const container = document.getElementById(tabId);
                    if (container) window.SecurityUtils.setInnerHTML(container, html);
                })
                .catch(err => console.error(`Erreur chargement ${file}:`, err));
        });
        
        // Une fois tous les onglets charg√©s
        await Promise.all(loadPromises);
        
        // Synchronisation automatique au d√©marrage (si pas d√©j√† faite r√©cemment)
        const lastSync = localStorage.getItem('lastAutoSync');
        const now = Date.now();
        const SYNC_INTERVAL = 3600000; // 1 heure
        
        if (!lastSync || (now - parseInt(lastSync)) > SYNC_INTERVAL) {
            localStorage.setItem('lastAutoSync', now.toString());
            // Lancer en arri√®re-plan sans bloquer l'UI
            syncAllCalendars().catch(err => console.error('Erreur sync auto:', err));
        }
    });
    
    // Gestion du menu utilisateur dropdown
    window.toggleUserMenu = function() {
        const button = document.getElementById('userMenuButton');
        const dropdown = document.getElementById('userMenuDropdown');
        
        button.classList.toggle('open');
        dropdown.classList.toggle('open');
    }
    
    // Attacher les √©v√©nements aux boutons du menu utilisateur
    document.addEventListener('DOMContentLoaded', function() {
        // Boutons avec data-action
        const actionButtons = document.querySelectorAll('.user-menu-item[data-action]');
        actionButtons.forEach(button => {
            button.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                
                // Fermer le menu
                toggleUserMenu();
                
                // Ex√©cuter l'action
                if (action === 'gites') {
                    if (window.showGitesManager) {
                        window.showGitesManager();
                    } else {
                        console.error('‚ùå showGitesManager non disponible');
                    }
                } else {
                    handleQuickAction(action);
                }
            });
        });
        
        // Bouton logout
        const logoutBtn = document.getElementById('logoutButton');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                if (window.logout) {
                    window.logout();
                }
            });
        }
    });
    */ // FIN DU SYST√àME ANCIEN D√âSACTIV√â
    
    // üîÑ ATTACHER LES LISTENERS DES ONGLETS IMM√âDIATEMENT
    (function attachTabListeners() {
        const tabButtons = document.querySelectorAll('.nav-tab, .tab-neo');
        
        if (tabButtons.length === 0) {
            setTimeout(attachTabListeners, 100);
            return;
        }
        
        tabButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = btn.getAttribute('data-tab');
                if (tab && typeof window.switchTab === 'function') {
                    window.switchTab(tab);
                }
            });
        });
    })();
    </script>

    <!-- üé® Gestion du menu admin -->
    <script>
        function showAdminMenu() {
            const dropdown = document.getElementById('adminDropdown');
            dropdown.style.display = 'block';
            
            // Fermer au clic ext√©rieur
            setTimeout(() => {
                document.addEventListener('click', closeAdminOnClickOutside);
            }, 100);
        }
        
        function hideAdminMenu() {
            const dropdown = document.getElementById('adminDropdown');
            dropdown.style.display = 'none';
            document.removeEventListener('click', closeAdminOnClickOutside);
        }
        
        function closeAdminOnClickOutside(e) {
            const dropdown = document.getElementById('adminDropdown');
            const adminBtn = document.querySelector('.ctrl-btn-admin');
            
            if (!dropdown.contains(e.target) && !adminBtn.contains(e.target)) {
                hideAdminMenu();
            }
        }
        
        function handleLogout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                localStorage.removeItem('session');
                window.location.href = 'pages/connexion.html';
            }
        }
    </script>

    <!-- üé® Initialisation des th√®mes au chargement -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('icalou-theme') || 'dark';
            const savedStyle = localStorage.getItem('icalou-style') || 'sidebar';
            
            const html = document.documentElement;
            html.classList.add('theme-' + savedTheme);
            html.classList.add('style-' + savedStyle);
            
            // Synchroniser les boutons avec l'√©tat initial
            setTimeout(() => {
                const lightBtn = document.getElementById('t-light');
                const darkBtn = document.getElementById('t-dark');
                const appleBtn = document.getElementById('s-apple');
                const sidebarBtn = document.getElementById('s-sidebar');
                
                if (lightBtn && darkBtn) {
                    lightBtn.classList.toggle('active', savedTheme === 'light');
                    darkBtn.classList.toggle('active', savedTheme === 'dark');
                }
                
                if (appleBtn && sidebarBtn) {
                    appleBtn.classList.toggle('active', savedStyle === 'apple');
                    sidebarBtn.classList.toggle('active', savedStyle === 'sidebar');
                }
            }, 50);
        })();
    </script>
    
    <!-- üé® Pr√©servation des couleurs de g√Ætes -->
    <script src="js/preserve-gite-colors.js?v=3.1"></script>
    
    <!-- üîÑ Injection automatique des switches dans TOUTES les modals -->
    <!-- <script src="scripts/add-modal-switches.js?v=1.0"></script> -->
</body>
</html>
