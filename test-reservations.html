<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Rapide R√©servations</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        .output {
            background: #000;
            border: 2px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            font-size: 14px;
            white-space: pre-wrap;
            min-height: 400px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        button:hover {
            background: #00cc00;
        }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .warning { color: #ffff00; }
        .info { color: #00ccff; }
    </style>
</head>
<body>
    <h1>üîç TEST R√âSERVATIONS</h1>
    
    <button onclick="testReservations()">‚ñ∂Ô∏è LANCER LE TEST</button>
    <button onclick="clearOutput()">üóëÔ∏è EFFACER</button>
    
    <div class="output" id="output">Cliquer sur "LANCER LE TEST" pour commencer...</div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const output = document.getElementById('output');
        
        function log(msg, type = 'info') {
            const colors = {
                error: 'error',
                success: 'success',
                warning: 'warning',
                info: 'info'
            };
            const line = document.createElement('div');
            line.className = colors[type];
            line.textContent = msg;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        async function testReservations() {
            clearOutput();
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('üîç TEST R√âSERVATIONS SUPABASE', 'success');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('');
            
            try {
                // Connexion Supabase
                log('1Ô∏è‚É£ Connexion √† Supabase...', 'info');
                const supabaseUrl = 'https://fgqimtpjjhdqeyyaptoj.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZncWltdHBqamhkcWV5eWFwdG9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2MzY2MTQsImV4cCI6MjA1MTIxMjYxNH0.6k8VZPRwS3TU1H7fIYlJPcj99BWx9QkzNxGVtGX9Tdk';
                const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                log('   ‚úÖ Client Supabase cr√©√©', 'success');
                log('');
                
                // V√©rifier auth
                log('2Ô∏è‚É£ V√©rification authentification...', 'info');
                const { data: userData } = await supabase.auth.getUser();
                if (!userData?.user) {
                    log('   ‚ùå NON AUTHENTIFI√â - Aller sur index.html d\'abord', 'error');
                    return;
                }
                log(`   ‚úÖ Connect√©: ${userData.user.email}`, 'success');
                log(`   üìç User ID: ${userData.user.id}`, 'info');
                log('');
                
                // Compter r√©servations
                log('3Ô∏è‚É£ Lecture r√©servations...', 'info');
                const { data: reservations, error } = await supabase
                    .from('reservations')
                    .select('*')
                    .order('check_in', { ascending: true });
                
                if (error) {
                    log(`   ‚ùå ERREUR: ${error.message}`, 'error');
                    log(`   Code: ${error.code}`, 'error');
                    return;
                }
                
                log(`   ‚úÖ ${reservations.length} r√©servations en base`, 'success');
                log('');
                
                // Grouper par g√Æte
                log('4Ô∏è‚É£ R√©partition par g√Æte:', 'info');
                const byGite = {};
                reservations.forEach(r => {
                    const key = r.gite_id || 'unknown';
                    if (!byGite[key]) byGite[key] = [];
                    byGite[key].push(r);
                });
                
                for (const [giteId, resas] of Object.entries(byGite)) {
                    const giteName = giteId.substring(0, 8);
                    log(`   ${giteName}...: ${resas.length} r√©servations`, 'info');
                }
                log('');
                
                // Doublons
                log('5Ô∏è‚É£ D√©tection doublons...', 'info');
                const duplicates = {};
                reservations.forEach(r => {
                    const key = `${r.gite_id}_${r.check_in}_${r.check_out}_${r.platform}`;
                    if (!duplicates[key]) duplicates[key] = [];
                    duplicates[key].push(r);
                });
                
                const doublonSets = Object.values(duplicates).filter(arr => arr.length > 1);
                const totalDoublons = doublonSets.reduce((sum, arr) => sum + (arr.length - 1), 0);
                
                if (totalDoublons > 0) {
                    log(`   ‚ö†Ô∏è ${totalDoublons} doublons d√©tect√©s`, 'warning');
                    log(`   üí° Ex√©cuter: sql/SUPPRIMER_DOUBLONS_RESERVATIONS.sql`, 'warning');
                } else {
                    log(`   ‚úÖ Aucun doublon`, 'success');
                }
                log('');
                
                // Exemples
                log('6Ô∏è‚É£ Exemples de r√©servations:', 'info');
                const recent = reservations
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 5);
                
                recent.forEach(r => {
                    log(`   ‚Ä¢ ${r.client_name} (${r.platform})`, 'info');
                    log(`     ${r.check_in} ‚Üí ${r.check_out}`, 'info');
                });
                log('');
                
                // R√©sum√© final
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('üìä R√âSUM√â:', 'success');
                log(`   ‚Ä¢ ${reservations.length} r√©servations totales`, 'info');
                log(`   ‚Ä¢ ${Object.keys(byGite).length} g√Æte(s)`, 'info');
                log(`   ‚Ä¢ ${totalDoublons} doublon(s)`, totalDoublons > 0 ? 'warning' : 'success');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                
                if (reservations.length === 0) {
                    log('');
                    log('‚ùå AUCUNE R√âSERVATION !', 'error');
                    log('   ‚Üí V√©rifier import iCal', 'warning');
                    log('   ‚Üí V√©rifier RLS policies', 'warning');
                } else if (totalDoublons > 0) {
                    log('');
                    log('‚ö†Ô∏è ACTION REQUISE:', 'warning');
                    log('   Ex√©cuter dans Supabase:', 'warning');
                    log('   sql/SUPPRIMER_DOUBLONS_RESERVATIONS.sql', 'warning');
                } else {
                    log('');
                    log('‚úÖ TOUT EST OK !', 'success');
                }
                
            } catch (err) {
                log('', 'error');
                log(`‚ùå ERREUR FATALE: ${err.message}`, 'error');
                console.error(err);
            }
        }
    </script>
</body>
</html>
