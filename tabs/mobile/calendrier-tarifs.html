<div class="cal-container">
    <!-- En-t√™te avec s√©lecteur de g√Æte -->
    <div class="cal-header">
        <div class="cal-header-inner">
            <h2 class="cal-title">üìÖ Tarifs</h2>
            <button id="btnRefreshTarifs" class="btn-refresh">
                üîÑ
            </button>
        </div>
        
        <select id="giteSelectTarifs" class="cal-select">
            <option value="">Chargement...</option>
        </select>
    </div>

    <!-- Navigation mois -->
    <div class="cal-nav">
        <button id="prevMonthTarifs" class="btn-nav">
            ‚óÄ
        </button>
        <div id="currentMonthTarifs" class="cal-current-month"></div>
        <button id="nextMonthTarifs" class="btn-nav">
            ‚ñ∂
        </button>
    </div>

    <!-- Calendrier -->
    <div id="calendrierTarifsMobile" class="cal-grid">
        <!-- G√©n√©r√© dynamiquement -->
    </div>

    <!-- Boutons analyse IA (toujours visibles) -->
    <div class="ai-cal-actions" id="ai-cal-actions">
        <button id="btnAIVoirDemande" class="btn-ai-cal">
            üîç Voir la demande
        </button>
        <button id="btnAIProposerPrix" class="btn-ai-cal btn-ai-cal-green">
            üí∞ Proposer des prix
        </button>
    </div>

    <!-- L√©gende IA demande (affich√©e apr√®s analyse) -->
    <div id="ai-demande-legende" class="ai-demande-legende" style="display:none;">
        <div class="ai-leg-item"><span class="ai-leg-dot haute"></span>Forte demande</div>
        <div class="ai-leg-item"><span class="ai-leg-dot normale"></span>P√©riode normale</div>
        <div class="ai-leg-item"><span class="ai-leg-dot faible"></span>Faible demande</div>
        <button id="btnAIQuitterAnalyse" class="btn-ai-quitter">‚úï Quitter</button>
    </div>

    <!-- L√©gende plateformes -->
    <div id="legendePlatformes" class="cal-legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #FF5A5F;"></div>
            <span class="legend-label">Airbnb</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #003580;"></div>
            <span class="legend-label">Booking</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #F5A623;"></div>
            <span class="legend-label">Abritel</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #27ae60;"></div>
            <span class="legend-label">G√Ætes de France</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #95a5a6;"></div>
            <span class="legend-label">Autre</span>
        </div>
    </div>

    <!-- Section R√®gles de tarification -->
    <div class="cal-section">
        <h3 class="cal-section-title">‚öôÔ∏è R√®gles de tarification</h3>
        
        <!-- Dur√©e minimale -->
        <div class="form-field">
            <label class="form-label">
                üõèÔ∏è Dur√©e min. de s√©jour (nuits) :
            </label>
            <input type="number" id="dureeMinMobile" min="1" value="2" class="form-input">
        </div>

        <!-- Promotions -->
        <div class="promo-divider">
            <h4 class="promo-title">üéâ Promotions automatiques</h4>
            
            <!-- Long s√©jour -->
            <div class="promo-box">
                <label class="promo-label">
                    <input type="checkbox" id="promoLongSejour" class="promo-checkbox">
                    üìÜ R√©duction long s√©jour
                </label>
                <div class="promo-inputs">
                    <input type="number" id="longSejourNuits" placeholder="Nuits" min="3" class="promo-input">
                    <input type="number" id="longSejourPct" placeholder="%" min="1" max="50" class="promo-input">
                </div>
            </div>

            <!-- Last minute -->
            <div class="promo-box">
                <label class="promo-label">
                    <input type="checkbox" id="promoLastMinute" class="promo-checkbox">
                    ‚ö° Last Minute
                </label>
                <div class="promo-inputs">
                    <input type="number" id="lastMinuteJours" placeholder="Jours" min="1" max="30" class="promo-input">
                    <input type="number" id="lastMinutePct" placeholder="%" min="1" max="50" class="promo-input">
                </div>
            </div>

            <!-- Early booking -->
            <div class="promo-box">
                <label class="promo-label">
                    <input type="checkbox" id="promoEarlyBooking" class="promo-checkbox">
                    üéØ Early Booking
                </label>
                <div class="promo-inputs">
                    <input type="number" id="earlyBookingJours" placeholder="Jours" min="30" max="365" class="promo-input">
                    <input type="number" id="earlyBookingPct" placeholder="%" min="1" max="50" class="promo-input">
                </div>
            </div>
        </div>

        <button id="btnSaveReglesMobile" class="btn-save">
            üíæ Enregistrer les r√®gles
        </button>
    </div>

    <!-- Remplissage automatique -->
    <div class="cal-section">
        <h3 class="cal-section-title">‚ö° Remplissage automatique</h3>
        
        <div class="form-field">
            <label class="form-label">
                üí∞ Prix de base par nuit :
            </label>
            <input type="number" id="prixAutoMobile" placeholder="Ex: 150" min="0" step="1" class="form-input">
        </div>

        <div class="form-field">
            <label class="form-label">
                üìÖ P√©riode :
            </label>
            <div class="auto-inputs">
                <input type="date" id="dateDebutAutoMobile" class="form-input">
                <input type="date" id="dateFinAutoMobile" class="form-input">
            </div>
        </div>

        <button id="btnRemplirAutoMobile" class="btn-save">
            üöÄ Remplir automatiquement
        </button>
    </div>

    <!-- Panneau propositions de prix IA -->
    <div id="ai-prix-panel" class="ai-prix-panel" style="display:none;">
        <div class="ai-prix-panel-header">
            <span class="ai-prix-panel-title">üí∞ Propositions de prix IA</span>
            <button id="btnAIFermerPrix" class="btn-ai-quitter">‚úï</button>
        </div>

        <!-- Param√®tres compacts -->
        <div class="ai-prix-settings">
            <div class="ai-settings-row">
                <label>üè´ Zone</label>
                <select id="aiZoneScolaire" class="form-input-sm" style="width:auto; flex:1;">
                    <option value="B" selected>B</option>
                    <option value="A">A</option>
                    <option value="C">C</option>
                </select>
                <label>üí∞ Base</label>
                <input type="number" id="aiPrixBase" class="form-input-sm" placeholder="‚Ç¨/nuit" min="0" step="1" style="width:70px;">
            </div>
            <div class="ai-settings-row" style="margin-top:6px;">
                <label>üéâ F√©ri√©s</label>
                <input type="number" id="multFeries" class="form-input-sm" value="1.5" step="0.1" min="1" max="5" style="width:55px;">
                <span class="ai-mult-unit">√ó</span>
                <label>üè´ Vac.</label>
                <input type="number" id="multVacances" class="form-input-sm" value="1.3" step="0.1" min="1" max="5" style="width:55px;">
                <span class="ai-mult-unit">√ó</span>
                <label>‚≠ê Evt</label>
                <input type="number" id="multEvents" class="form-input-sm" value="1.2" step="0.1" min="1" max="5" style="width:55px;">
                <span class="ai-mult-unit">√ó</span>
            </div>
            <div class="ai-settings-row" style="margin-top:6px;">
                <label>üìç R√©gion</label>
                <input type="text" id="aiRegionInput" class="form-input" placeholder="Lot (46), Quercy‚Ä¶" value="Lot (46), Quercy" style="flex:1;">
            </div>
        </div>

        <!-- Boutons g√©n√©rer -->
        <div class="ai-buttons-row" style="margin-top:10px;">
            <button id="btnAIAnalyseHolidays" class="btn-save btn-ai-secondary">
                üìÖ F√©ri√©s &amp; vacances
            </button>
            <button id="btnAIAnalyseEvents" class="btn-save btn-ai-primary">
                ‚ú® + √âv√©nements IA
            </button>
        </div>

        <!-- Loading -->
        <div id="ai-loading" style="display:none; text-align:center; padding:16px;">
            <div class="ai-spinner"></div>
            <p style="color:var(--text-secondary); font-size:0.8rem; margin-top:8px;">Analyse en cours‚Ä¶</p>
        </div>

        <!-- R√©sultats -->
        <div id="ai-suggestions-container" style="display:none; margin-top:12px;">
            <div class="ai-results-header">
                <span id="ai-suggestions-count" class="ai-results-count"></span>
                <button id="btnAIAppliquerTout" class="btn-ai-apply-all">‚úÖ Tout appliquer</button>
            </div>
            <div id="ai-suggestions-list"></div>
        </div>
    </div>

    <!-- Champs cach√©s (zone scolaire pour analyse demande) -->
    <input type="hidden" id="aiDateDebutAnalyse">
    <input type="hidden" id="aiDateFinAnalyse">
</div>

<!-- Modal pour √©diter un tarif -->
<div id="modalTarifMobile" class="cal-modal">
    <div class="modal-content-cal">
        <div class="modal-header-cal">
            <h3 class="modal-title-cal">üí∞ Tarif</h3>
            <button id="closeModalTarifMobile" class="btn-close-cal">‚úï</button>
        </div>
        
        <div id="dateInfoModal" class="modal-date-info"></div>
        
        <label class="modal-input-label">
            üíµ Prix par nuit (‚Ç¨) :
        </label>
        <input type="number" id="prixNuitModal" placeholder="Ex: 150" min="0" step="1" class="modal-input">
        
        <div class="modal-actions">
            <button id="btnSaveTarifModal" class="btn-modal">
                üíæ Enregistrer
            </button>
            <button id="btnDeleteTarifModal" class="btn-modal">
                üóëÔ∏è Supprimer
            </button>
        </div>
    </div>
</div>

<script>
// console.log('üéØ ========================================');
// console.log('üéØ FICHIER MOBILE CALENDRIER-TARIFS.HTML CHARG√â');
// console.log('üéØ ========================================');

let currentGiteIdMobile = null;
let currentMonthMobile = new Date().getMonth();
let currentYearMobile = new Date().getFullYear();
let tarifsCacheMobile = [];
let reservationsCacheMobile = [];
let reglesCacheMobile = null;
let selectedDateMobile = null;

// Couleurs des plateformes (comme desktop)
function getPlateformeColorMobile(plateforme) {
    const colors = {
        'Airbnb': '#FF5A5F',
        'Booking': '#003580',
        'Abritel': '#F5A623',
        'Gites de France': '#27ae60',
        'Direct': '#27ae60',
        'Autre': '#95a5a6'
    };
    return colors[plateforme] || colors['Autre'];
}

async function loadGitesSelectorMobile() {
    // console.log('üìÖ Chargement s√©lecteur g√Ætes mobile...');
    try {
        if (!window.gitesManager) {
            console.error('‚ùå gitesManager non disponible');
            showToast('Erreur: gitesManager non disponible', 'error');
            return;
        }
        
        const gites = await window.gitesManager.getAll();
        // console.log('‚úÖ G√Ætes charg√©s:', gites.length);
        
        const selector = document.getElementById('giteSelectTarifs');
        if (!selector) {
            console.error('‚ùå Select #giteSelectTarifs non trouv√©');
            return;
        }
        
        if (gites.length === 0) {
            selector.innerHTML = '<option value="">Aucun g√Æte disponible</option>';
            return;
        }
        
        selector.innerHTML = '<option value="">S√©lectionner un g√Æte</option>';
        gites.forEach(gite => {
            selector.innerHTML += `<option value="${gite.id}">${gite.name}</option>`;
        });
        
        // S√©lectionner le premier g√Æte par d√©faut
        if (gites.length > 0) {
            selector.value = gites[0].id;
            currentGiteIdMobile = gites[0].id;
            // console.log('‚úÖ G√Æte s√©lectionn√©:', gites[0].name);
            await loadTarifsMobile();
        }
    } catch (error) {
        console.error('Erreur chargement g√Ætes:', error);
        showToast('Erreur chargement g√Ætes', 'error');
    }
}

async function loadTarifsMobile() {
    // console.log('üìÖ Chargement tarifs pour g√Æte:', currentGiteIdMobile);
    if (!currentGiteIdMobile) {
        console.warn('‚ö†Ô∏è Pas de g√Æte s√©lectionn√©');
        return;
    }
    
    try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (!user) {
            console.error('‚ùå Utilisateur non connect√©');
            return;
        }
        
        // console.log('‚úÖ Utilisateur connect√©, chargement des donn√©es...');
        
        // Charger les tarifs depuis le champ JSON tarifs_calendrier de la table gites
        const { data: giteData, error: errorTarifs } = await window.supabaseClient
            .from('gites')
            .select('tarifs_calendrier, regles_tarifs, adresse, name')
            .eq('id', currentGiteIdMobile)
            .single();
        
        if (errorTarifs) throw errorTarifs;
        
        // Convertir le JSON en tableau
        const tarifData = giteData?.tarifs_calendrier;
        if (Array.isArray(tarifData)) {
            tarifsCacheMobile = tarifData;
        // console.log('‚úÖ Tarifs charg√©s:', tarifsCacheMobile.length);
        
        } else if (tarifData && typeof tarifData === 'object') {
            tarifsCacheMobile = Object.entries(tarifData).map(([date, prix]) => ({
                date: date,
                prix_nuit: parseFloat(prix)
            }));
        } else {
            tarifsCacheMobile = [];
        }
        
        // Charger les r√©servations
        if (typeof getAllReservations === 'function') {
            reservationsCacheMobile = await getAllReservations(true);
            // console.log('üìã R√©servations totales charg√©es:', reservationsCacheMobile.length);
            // ‚úÖ Comparer directement les UUID strings (pas de parseInt!)
            reservationsCacheMobile = reservationsCacheMobile.filter(r => r.gite_id === currentGiteIdMobile);
            // console.log('üìã R√©servations pour gite_id', currentGiteIdMobile, ':', reservationsCacheMobile.length);
            if (reservationsCacheMobile.length > 0) {
                // console.log('üìã Premi√®re r√©servation:', reservationsCacheMobile[0]);
            }
        } else {
            console.warn('‚ö†Ô∏è getAllReservations non disponible');
        }
        
        // Charger les r√®gles depuis le JSON regles_tarifs
        if (giteData?.regles_tarifs) {
            reglesCacheMobile = giteData.regles_tarifs;
            loadReglesIntoFormMobile();
        }

        // Pr√©-remplir la r√©gion IA depuis l'adresse du g√Æte
        if (giteData?.adresse) {
            const regionField = document.getElementById('aiRegionInput');
            if (regionField) {
                // Extraire code postal et ville de l'adresse (ex: "lieu-dit, 46300 Calvignac")
                const matchCP = giteData.adresse.match(/(\d{5})\s+([\w\s-]+)/i);
                if (matchCP) {
                    const dept = matchCP[1].substring(0, 2);
                    const ville = matchCP[2].trim();
                    // Construire un label utile pour l'IA (dept + ville + nom du g√Æte si disponible)
                    regionField.value = `${ville} (${dept})`;
                } else {
                    regionField.value = giteData.adresse;
                }
            }
        }
        
        // console.log('‚úÖ Render du calendrier...');
        renderCalendrierMobile();
    } catch (error) {
        console.error('Erreur chargement tarifs:', error);
        showToast('Erreur chargement donn√©es', 'error');
    }
}

function loadReglesIntoFormMobile() {
    if (!reglesCacheMobile) return;
    
    const dureeMin = document.getElementById('dureeMinMobile');
    if (dureeMin) dureeMin.value = reglesCacheMobile.duree_min_defaut || 2;
    
    const promos = reglesCacheMobile.promotions || {};
    
    if (promos.long_sejour) {
        document.getElementById('promoLongSejour').checked = promos.long_sejour.actif;
        document.getElementById('longSejourNuits').value = promos.long_sejour.a_partir_de || 7;
        document.getElementById('longSejourPct').value = promos.long_sejour.pourcentage || 10;
    }
    
    if (promos.last_minute) {
        document.getElementById('promoLastMinute').checked = promos.last_minute.actif;
        document.getElementById('lastMinuteJours').value = promos.last_minute.jours_avant || 7;
        document.getElementById('lastMinutePct').value = promos.last_minute.pourcentage || 15;
    }
    
    if (promos.early_booking) {
        document.getElementById('promoEarlyBooking').checked = promos.early_booking.actif;
        document.getElementById('earlyBookingJours').value = promos.early_booking.jours_avant || 60;
        document.getElementById('earlyBookingPct').value = promos.early_booking.pourcentage || 10;
    }
}

function renderCalendrierMobile() {
    // console.log('üé® renderCalendrierMobile() appel√©e');
    const container = document.getElementById('calendrierTarifsMobile');
    if (!container) {
        console.error('‚ùå Container #calendrierTarifsMobile non trouv√© !');
        return;
    }
    
    // console.log('‚úÖ Container trouv√©, g√©n√©ration du calendrier...');
    
    // Afficher le mois actuel
    const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    const monthDisplay = document.getElementById('currentMonthTarifs');
    if (monthDisplay) {
        monthDisplay.textContent = `${monthNames[currentMonthMobile]} ${currentYearMobile}`;
    }
    
    container.innerHTML = '';
    
    // En-t√™tes des jours
    const jours = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
    jours.forEach(jour => {
        const header = document.createElement('div');
        header.className = 'day-header-mobile';
        header.textContent = jour;
        container.appendChild(header);
    });
    
    // Premier jour du mois
    const firstDay = new Date(currentYearMobile, currentMonthMobile, 1);
    let dayOfWeek = firstDay.getDay();
    dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    
    // Jours du mois pr√©c√©dent
    for (let i = 0; i < dayOfWeek; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'day-card-mobile other-month';
        container.appendChild(emptyDiv);
    }
    
    // Jours du mois
    const lastDay = new Date(currentYearMobile, currentMonthMobile + 1, 0).getDate();
    
    for (let day = 1; day <= lastDay; day++) {
        const dateObj = new Date(currentYearMobile, currentMonthMobile, day);
        const dateStr = dateObj.toISOString().split('T')[0];
        
        const tarif = tarifsCacheMobile.find(t => t.date === dateStr);
        
        // V√©rifier si r√©serv√© et r√©cup√©rer les infos de r√©servation
        let reservationInfo = null;
        const currentReservation = reservationsCacheMobile.find(resa => {
            const checkIn = new Date(resa.date_arrivee || resa.check_in);
            const checkOut = new Date(resa.date_depart || resa.check_out);
            return dateObj >= checkIn && dateObj < checkOut;
        });
        
        const isReserved = !!currentReservation;
        if (isReserved) {
            reservationInfo = {
                plateforme: currentReservation.origine_reservation || currentReservation.plateforme || 'Direct',
                client: currentReservation.nom_client
            };
        }
        
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card-mobile';
        dayCard.dataset.date = dateStr;

        if (isReserved) {
            dayCard.classList.add('reserved');
            // Remplir toute la case avec la couleur de plateforme
            const plateformeColor = getPlateformeColorMobile(reservationInfo.plateforme);
            dayCard.style.background = plateformeColor;
            dayCard.style.border = '2px solid #2D3436';
        } else if (tarif) {
            dayCard.classList.add('has-tarif');
        }

        // Mode demande : colorer les cases selon le niveau de demande
        if (aiModeActif === 'demande' && !isReserved && aiDemandeCache[dateStr]) {
            dayCard.classList.add(`ai-demande-${aiDemandeCache[dateStr]}`);
        }

        // Badge IA : v√©rifier si la date a une suggestion
        const aiSugg = aiSuggestionsCache.find(s => s.date === dateStr);
        if (aiSugg && !isReserved) {
            dayCard.classList.add(`ai-${aiSugg.type}`);
            dayCard.title = aiSugg.label;
        }

        const demandeLabel = (aiModeActif === 'demande' && aiDemandeCache[dateStr] === 'haute') ? 'üî•' :
                             (aiModeActif === 'demande' && aiDemandeCache[dateStr] === 'faible') ? 'üí§' : '';

        dayCard.innerHTML = `
            <div class="day-number-mobile" style="${isReserved ? 'color: white; font-weight: 700;' : ''}">${day}</div>
            ${isReserved ? `<div style="font-size: 0.55rem; color: rgba(255,255,255,0.9); font-weight: 600;">üîí</div>` : 
              tarif ? `<div class="day-price-mobile">${tarif.prix_nuit}‚Ç¨</div>` : 
              '<div style="font-size: 0.65rem; color: var(--text-secondary);">‚Äî</div>'}
            ${demandeLabel ? `<span class="ai-badge">${demandeLabel}</span>` : (aiSugg && !isReserved ? `<span class="ai-badge">${aiSugg.icon}</span>` : '')}
        `;
        
        if (!isReserved) {
            dayCard.addEventListener('click', () => openTarifModalMobile(dateStr));
        }
        
        container.appendChild(dayCard);
    }
    
    // console.log(`‚úÖ Calendrier g√©n√©r√©: ${lastDay} jours cr√©√©s`);
}

function openTarifModalMobile(dateStr) {
    selectedDateMobile = dateStr;
    const modal = document.getElementById('modalTarifMobile');
    const tarif = tarifsCacheMobile.find(t => t.date === dateStr);
    
    const date = new Date(dateStr);
    const dateFormatted = date.toLocaleDateString('fr-FR', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
    });
    
    document.getElementById('dateInfoModal').textContent = dateFormatted;
    document.getElementById('prixNuitModal').value = tarif ? tarif.prix_nuit : '';
    
    modal.style.display = 'block';
}

function closeModalTarifMobile() {
    document.getElementById('modalTarifMobile').style.display = 'none';
    selectedDateMobile = null;
}

async function saveTarifModalMobile() {
    if (!selectedDateMobile || !currentGiteIdMobile) return;
    
    const prix = parseFloat(document.getElementById('prixNuitModal').value);
    if (!prix || prix <= 0) {
        showToast('Veuillez saisir un prix valide', 'error');
        return;
    }
    
    try {
        // Mettre √† jour le cache local
        const existingIndex = tarifsCacheMobile.findIndex(t => t.date === selectedDateMobile);
        if (existingIndex > -1) {
            tarifsCacheMobile[existingIndex].prix_nuit = prix;
        } else {
            tarifsCacheMobile.push({ date: selectedDateMobile, prix_nuit: prix });
        }
        
        // Sauvegarder dans le JSON tarifs_calendrier
        const { error } = await window.supabaseClient
            .from('gites')
            .update({ tarifs_calendrier: tarifsCacheMobile })
            .eq('id', currentGiteIdMobile);
        
        if (error) throw error;
        
        showToast('‚úÖ Tarif enregistr√©', 'success');
        closeModalTarifMobile();
        renderCalendrierMobile();
    } catch (error) {
        console.error('Erreur sauvegarde:', error);
        showToast('Erreur sauvegarde', 'error');
    }
}

async function deleteTarifModalMobile() {
    if (!selectedDateMobile || !currentGiteIdMobile) return;
    
    try {
        // Supprimer du cache local
        tarifsCacheMobile = tarifsCacheMobile.filter(t => t.date !== selectedDateMobile);
        
        // Sauvegarder dans le JSON tarifs_calendrier
        const { error } = await window.supabaseClient
            .from('gites')
            .update({ tarifs_calendrier: tarifsCacheMobile })
            .eq('id', currentGiteIdMobile);
        
        if (error) throw error;
        
        showToast('‚úÖ Tarif supprim√©', 'success');
        closeModalTarifMobile();
        renderCalendrierMobile();
    } catch (error) {
        console.error('Erreur suppression:', error);
        showToast('Erreur suppression', 'error');
    }
}

async function saveReglesMobile() {
    if (!currentGiteIdMobile) return;
    
    try {
        const regles = {
            duree_min_defaut: parseInt(document.getElementById('dureeMinMobile').value) || 2,
            promotions: {
                long_sejour: {
                    actif: document.getElementById('promoLongSejour').checked,
                    a_partir_de: parseInt(document.getElementById('longSejourNuits').value) || 7,
                    pourcentage: parseInt(document.getElementById('longSejourPct').value) || 10
                },
                last_minute: {
                    actif: document.getElementById('promoLastMinute').checked,
                    jours_avant: parseInt(document.getElementById('lastMinuteJours').value) || 7,
                    pourcentage: parseInt(document.getElementById('lastMinutePct').value) || 15
                },
                early_booking: {
                    actif: document.getElementById('promoEarlyBooking').checked,
                    jours_avant: parseInt(document.getElementById('earlyBookingJours').value) || 60,
                    pourcentage: parseInt(document.getElementById('earlyBookingPct').value) || 10
                }
            }
        };
        
        // Sauvegarder dans le JSON regles_tarifs
        const { error } = await window.supabaseClient
            .from('gites')
            .update({ regles_tarifs: regles })
            .eq('id', currentGiteIdMobile);
        
        if (error) throw error;
        
        showToast('‚úÖ R√®gles enregistr√©es', 'success');
        reglesCacheMobile = regles;
    } catch (error) {
        console.error('Erreur sauvegarde r√®gles:', error);
        showToast('Erreur sauvegarde r√®gles', 'error');
    }
}

async function remplirAutoMobile() {
    const prix = parseFloat(document.getElementById('prixAutoMobile').value);
    const dateDebut = document.getElementById('dateDebutAutoMobile').value;
    const dateFin = document.getElementById('dateFinAutoMobile').value;
    
    if (!prix || prix <= 0) {
        showToast('Veuillez saisir un prix valide', 'error');
        return;
    }
    
    if (!dateDebut || !dateFin) {
        showToast('Veuillez s√©lectionner une p√©riode', 'error');
        return;
    }
    
    if (new Date(dateDebut) > new Date(dateFin)) {
        showToast('La date de d√©but doit √™tre avant la date de fin', 'error');
        return;
    }
    
    if (!currentGiteIdMobile) {
        showToast('Veuillez s√©lectionner un g√Æte', 'error');
        return;
    }
    
    try {
        // G√©n√©rer toutes les dates de la p√©riode
        const current = new Date(dateDebut);
        const end = new Date(dateFin);
        let count = 0;
        
        while (current <= end) {
            const dateStr = current.toISOString().split('T')[0];
            
            // Ajouter ou mettre √† jour dans le cache
            const existingIndex = tarifsCacheMobile.findIndex(t => t.date === dateStr);
            if (existingIndex > -1) {
                tarifsCacheMobile[existingIndex].prix_nuit = prix;
            } else {
                tarifsCacheMobile.push({ date: dateStr, prix_nuit: prix });
            }
            
            count++;
            current.setDate(current.getDate() + 1);
        }
        
        // Sauvegarder dans le JSON tarifs_calendrier
        const { error } = await window.supabaseClient
            .from('gites')
            .update({ tarifs_calendrier: tarifsCacheMobile })
            .eq('id', currentGiteIdMobile);
        
        if (error) throw error;
        
        showToast(`‚úÖ ${count} tarifs cr√©√©s`, 'success');
        
        // Reset des champs
        document.getElementById('prixAutoMobile').value = '';
        document.getElementById('dateDebutAutoMobile').value = '';
        document.getElementById('dateFinAutoMobile').value = '';
        
        renderCalendrierMobile();
    } catch (error) {
        console.error('Erreur remplissage auto:', error);
        showToast('Erreur remplissage auto', 'error');
    }
}

// ==========================================
// ü§ñ SUGGESTIONS INTELLIGENTES IA TARIFS
// ==========================================

// Cache des suggestions IA pour les badges calendrier
let aiSuggestionsCache = [];
// Mode actif : null | 'demande'
let aiModeActif = null;
// Cache des niveaux de demande par date : { 'YYYY-MM-DD': 'haute'|'normale'|'faible', ... }
let aiDemandeCache = {};

/**
 * Retourne le niveau de demande d'une date : 'haute', 'normale', ou 'faible'
 */
function getDemandePourDate(dateStr, zone) {
    const annee = new Date(dateStr).getFullYear();
    const feriesByDate = {};
    getFeriesNationaux(annee).forEach(f => { feriesByDate[f.date] = true; });

    // F√©ri√© ‚Üí haute demande
    if (feriesByDate[dateStr]) return 'haute';

    // Vacances scolaires ‚Üí haute demande
    const vacances = getVacancesScolaires(zone || 'B');
    if (getVacanceForDate(dateStr, vacances)) return 'haute';

    // Juillet et ao√ªt ‚Üí haute demande
    const mois = new Date(dateStr).getMonth(); // 0-indexed
    if (mois === 6 || mois === 7) return 'haute';

    // Weekends en juin / septembre ‚Üí normale
    const jourSemaine = new Date(dateStr).getDay();
    if ((mois === 5 || mois === 8) && (jourSemaine === 0 || jourSemaine === 6)) return 'haute';

    // Novembre, janvier, f√©vrier, d√©cembre (hors f√™tes) ‚Üí faible
    if ([0, 1, 10].includes(mois)) return 'faible';

    return 'normale';
}

/**
 * Analyse le mois affich√© et colorie le calendrier selon la demande
 */
function voirDemandeMois() {
    const zone = document.getElementById('aiZoneScolaire')?.value || 'B';
    aiDemandeCache = {};

    const lastDay = new Date(currentYearMobile, currentMonthMobile + 1, 0).getDate();
    for (let day = 1; day <= lastDay; day++) {
        const dateObj = new Date(currentYearMobile, currentMonthMobile, day);
        const dateStr = dateObj.toISOString().split('T')[0];
        aiDemandeCache[dateStr] = getDemandePourDate(dateStr, zone);
    }

    aiModeActif = 'demande';
    document.getElementById('ai-demande-legende').style.display = 'flex';
    document.getElementById('btnAIVoirDemande').classList.add('actif');
    renderCalendrierMobile();
}

/**
 * Quitte le mode analyse demande
 */
function quitterModeIA() {
    aiModeActif = null;
    aiDemandeCache = {};
    document.getElementById('ai-demande-legende').style.display = 'none';
    document.getElementById('btnAIVoirDemande').classList.remove('actif');
    renderCalendrierMobile();
}

/**
 * Calcule le dimanche de P√¢ques (algorithme de Oudin/Tondering)
 */
function getPaques(year) {
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
    const day = ((h + l - 7 * m + 114) % 31) + 1;
    return new Date(year, month, day);
}

/**
 * Retourne tous les jours f√©ri√©s nationaux en France pour une ann√©e donn√©e
 */
function getFeriesNationaux(year) {
    const paques = getPaques(year);
    const addDays = (date, n) => {
        const d = new Date(date);
        d.setDate(d.getDate() + n);
        return d;
    };
    const fmt = (d) => d.toISOString().split('T')[0];

    return [
        { date: fmt(new Date(year, 0, 1)),  label: "Jour de l'An" },
        { date: fmt(addDays(paques, 1)),     label: "Lundi de P√¢ques" },
        { date: fmt(new Date(year, 4, 1)),   label: "F√™te du Travail" },
        { date: fmt(new Date(year, 4, 8)),   label: "Victoire 1945" },
        { date: fmt(addDays(paques, 39)),    label: "Ascension" },
        { date: fmt(addDays(paques, 50)),    label: "Lundi de Pentec√¥te" },
        { date: fmt(new Date(year, 6, 14)),  label: "F√™te Nationale" },
        { date: fmt(new Date(year, 7, 15)),  label: "Assomption" },
        { date: fmt(new Date(year, 10, 1)),  label: "Toussaint" },
        { date: fmt(new Date(year, 10, 11)), label: "Armistice" },
        { date: fmt(new Date(year, 11, 25)), label: "No√´l" }
    ];
}

/**
 * Retourne les p√©riodes de vacances scolaires par zone (2025-2027)
 * Source: calendrier √âducation Nationale
 */
function getVacancesScolaires(zone) {
    const periodes = {
        A: [
            // 2025-2026
            { debut: '2025-10-18', fin: '2025-11-03', label: 'Toussaint 25' },
            { debut: '2025-12-20', fin: '2026-01-05', label: 'No√´l 25-26' },
            { debut: '2026-02-14', fin: '2026-03-02', label: 'Hiver 26' },
            { debut: '2026-04-18', fin: '2026-05-04', label: 'Printemps 26' },
            { debut: '2026-07-05', fin: '2026-09-01', label: '√ât√© 26' },
            // 2026-2027
            { debut: '2026-10-17', fin: '2026-11-02', label: 'Toussaint 26' },
            { debut: '2026-12-19', fin: '2027-01-04', label: 'No√´l 26-27' },
            { debut: '2027-02-13', fin: '2027-03-01', label: 'Hiver 27' },
            { debut: '2027-04-10', fin: '2027-04-26', label: 'Printemps 27' },
            { debut: '2027-07-03', fin: '2027-09-01', label: '√ât√© 27' }
        ],
        B: [
            // 2025-2026
            { debut: '2025-10-18', fin: '2025-11-03', label: 'Toussaint 25' },
            { debut: '2025-12-20', fin: '2026-01-05', label: 'No√´l 25-26' },
            { debut: '2026-02-07', fin: '2026-02-23', label: 'Hiver 26' },
            { debut: '2026-04-11', fin: '2026-04-27', label: 'Printemps 26' },
            { debut: '2026-07-05', fin: '2026-09-01', label: '√ât√© 26' },
            // 2026-2027
            { debut: '2026-10-17', fin: '2026-11-02', label: 'Toussaint 26' },
            { debut: '2026-12-19', fin: '2027-01-04', label: 'No√´l 26-27' },
            { debut: '2027-02-06', fin: '2027-02-22', label: 'Hiver 27' },
            { debut: '2027-04-03', fin: '2027-04-19', label: 'Printemps 27' },
            { debut: '2027-07-03', fin: '2027-09-01', label: '√ât√© 27' }
        ],
        C: [
            // 2025-2026
            { debut: '2025-10-18', fin: '2025-11-03', label: 'Toussaint 25' },
            { debut: '2025-12-20', fin: '2026-01-05', label: 'No√´l 25-26' },
            { debut: '2026-02-21', fin: '2026-03-09', label: 'Hiver 26' },
            { debut: '2026-04-25', fin: '2026-05-11', label: 'Printemps 26' },
            { debut: '2026-07-05', fin: '2026-09-01', label: '√ât√© 26' },
            // 2026-2027
            { debut: '2026-10-17', fin: '2026-11-02', label: 'Toussaint 26' },
            { debut: '2026-12-19', fin: '2027-01-04', label: 'No√´l 26-27' },
            { debut: '2027-02-20', fin: '2027-03-08', label: 'Hiver 27' },
            { debut: '2027-04-17', fin: '2027-05-03', label: 'Printemps 27' },
            { debut: '2027-07-03', fin: '2027-09-01', label: '√ât√© 27' }
        ]
    };
    return periodes[zone] || periodes['B'];
}

/**
 * V√©rifie si une date tombe dans une p√©riode de vacances scolaires
 */
function getVacanceForDate(dateStr, vacances) {
    for (const v of vacances) {
        if (dateStr >= v.debut && dateStr < v.fin) {
            return v.label;
        }
    }
    return null;
}

/**
 * Analyse les dates de la p√©riode s√©lectionn√©e et g√©n√®re des suggestions
 * @param {boolean} withAI - inclure les √©v√©nements locaux via OpenAI
 */
async function analyserDatesIA(withAI = false) {
    // Utiliser le mois affich√© si aucune date n'est fournie
    const premierJourMois = new Date(currentYearMobile, currentMonthMobile, 1).toISOString().split('T')[0];
    const dernierJourMois = new Date(currentYearMobile, currentMonthMobile + 1, 0).toISOString().split('T')[0];
    const dateDebut = premierJourMois;
    const dateFin = dernierJourMois;
    const prixBase = parseFloat(document.getElementById('aiPrixBase').value);
    const zone = document.getElementById('aiZoneScolaire').value;
    const region = document.getElementById('aiRegionInput').value.trim();
        showToast('Veuillez saisir un prix de base', 'error');
        return;
    }

    const multFeries = parseFloat(document.getElementById('multFeries').value) || 1.5;
    const multVacances = parseFloat(document.getElementById('multVacances').value) || 1.3;
    const multEvents = parseFloat(document.getElementById('multEvents').value) || 1.2;

    // Afficher le spinner
    const loadingEl = document.getElementById('ai-loading');
    const container = document.getElementById('ai-suggestions-container');
    loadingEl.style.display = 'block';
    container.style.display = 'none';

    try {
        // 1. Collecter les f√©ri√©s et vacances
        const suggestions = [];
        const anneeDebut = new Date(dateDebut).getFullYear();
        const anneeFin = new Date(dateFin).getFullYear();

        // Construire la liste des f√©ri√©s pour toutes les ann√©es concern√©es
        const feriesByDate = {};
        for (let y = anneeDebut; y <= anneeFin; y++) {
            getFeriesNationaux(y).forEach(f => {
                feriesByDate[f.date] = f.label;
            });
        }

        // P√©riodes de vacances pour la zone
        const vacances = getVacancesScolaires(zone);

        // Parcourir chaque date de la p√©riode
        const current = new Date(dateDebut);
        const end = new Date(dateFin);

        while (current <= end) {
            const dateStr = current.toISOString().split('T')[0];

            // V√©rifier si f√©ri√©
            if (feriesByDate[dateStr]) {
                const prixSuggere = Math.round(prixBase * multFeries);
                suggestions.push({
                    date: dateStr,
                    label: feriesByDate[dateStr],
                    type: 'ferie',
                    icon: 'üéâ',
                    prixBase,
                    prixSuggere,
                    multiplicateur: multFeries
                });
            } else {
                // V√©rifier si vacances scolaires
                const vacLabel = getVacanceForDate(dateStr, vacances);
                if (vacLabel) {
                    const prixSuggere = Math.round(prixBase * multVacances);
                    suggestions.push({
                        date: dateStr,
                        label: `Vacances ‚Äî ${vacLabel} (Zone ${zone})`,
                        type: 'vacances',
                        icon: 'üè´',
                        prixBase,
                        prixSuggere,
                        multiplicateur: multVacances
                    });
                }
            }

            current.setDate(current.getDate() + 1);
        }

        // 2. Si withAI ‚Üí appeler OpenAI pour les √©v√©nements locaux
        if (withAI && region) {
            const eventsIA = await fetchEvenementsIA(region, dateDebut, dateFin);
            eventsIA.forEach(ev => {
                // √âviter les doublons avec les f√©ri√©s/vacances d√©j√† d√©tect√©s
                const existeDeja = suggestions.find(s => s.date === ev.date);
                if (!existeDeja) {
                    const prixSuggere = Math.round(prixBase * multEvents);
                    suggestions.push({
                        date: ev.date,
                        label: ev.label,
                        type: 'event',
                        icon: '‚≠ê',
                        prixBase,
                        prixSuggere,
                        multiplicateur: multEvents
                    });
                }
            });
        }

        // Trier par date
        suggestions.sort((a, b) => a.date.localeCompare(b.date));

        // Filtrer uniquement les dates non encore tarif√©es ou avec un tarif inf√©rieur
        const suggestionsUtiles = suggestions.filter(s => {
            const tarifExistant = tarifsCacheMobile.find(t => t.date === s.date);
            return !tarifExistant || tarifExistant.prix_nuit < s.prixSuggere;
        });

        // Mettre en cache pour les badges du calendrier
        aiSuggestionsCache = suggestions;
        renderCalendrierMobile(); // Rafra√Æchir pour afficher les badges

        afficherSuggestionsIA(suggestionsUtiles);

    } catch (err) {
        console.error('Erreur analyse IA:', err);
        showToast('Erreur lors de l\'analyse', 'error');
    } finally {
        loadingEl.style.display = 'none';
    }
}

/**
 * Appelle l'API OpenAI pour obtenir les √©v√©nements locaux/touristiques
 */
async function fetchEvenementsIA(region, dateDebut, dateFin) {
    try {
        const prompt = `Tu es un expert du tourisme rural en France. Le g√Æte se situe √† "${region}". Liste les principaux √©v√©nements touristiques, festivals, march√©s importants et p√©riodes de forte affluence dans ce secteur entre le ${dateDebut} et le ${dateFin}. 
R√©ponds UNIQUEMENT avec un tableau JSON valide, sans texte avant ou apr√®s. Format: [{"date":"YYYY-MM-DD","label":"Nom de l'√©v√©nement"},...] 
Si un √©v√©nement dure plusieurs jours, liste chaque jour s√©par√©ment. Maximum 30 entr√©es. Si tu n'es pas s√ªr d'une date exacte, n'inclus pas l'√©v√©nement. R√©ponds uniquement en JSON.`;

        const response = await fetch('/api/openai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, maxTokens: 800, model: 'gpt-4o-mini' })
        });

        if (!response.ok) {
            console.warn('‚ö†Ô∏è OpenAI API non disponible, √©v√©nements locaux ignor√©s');
            return [];
        }

        const data = await response.json();
        const content = data.choices?.[0]?.message?.content || '';

        // Extraire le JSON de la r√©ponse
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (!jsonMatch) return [];

        const events = JSON.parse(jsonMatch[0]);
        if (!Array.isArray(events)) return [];

        // Valider le format de chaque √©v√©nement
        return events.filter(e => e.date && e.label && /^\d{4}-\d{2}-\d{2}$/.test(e.date));

    } catch (err) {
        console.warn('‚ö†Ô∏è Erreur r√©cup√©ration √©v√©nements IA:', err.message);
        return [];
    }
}

/**
 * Affiche la liste des suggestions IA dans l'interface
 */
function afficherSuggestionsIA(suggestions) {
    const container = document.getElementById('ai-suggestions-container');
    const list = document.getElementById('ai-suggestions-list');
    const countEl = document.getElementById('ai-suggestions-count');

    if (suggestions.length === 0) {
        countEl.textContent = 'Aucune suggestion ‚Äî les tarifs sont d√©j√† optimaux pour cette p√©riode.';
        list.innerHTML = '';
        container.style.display = 'block';
        return;
    }

    countEl.textContent = `${suggestions.length} suggestion${suggestions.length > 1 ? 's' : ''} de tarifs`;

    list.innerHTML = suggestions.map((s, idx) => {
        const dateObj = new Date(s.date + 'T12:00:00');
        const dateFr = dateObj.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
        return `
        <div class="ai-suggestion-card" id="ai-card-${idx}" data-date="${s.date}" data-prix="${s.prixSuggere}">
            <span class="ai-suggestion-icon">${s.icon}</span>
            <div class="ai-suggestion-info">
                <div class="ai-suggestion-date">${dateFr}</div>
                <div class="ai-suggestion-label">${s.label}</div>
            </div>
            <div class="ai-suggestion-price">
                <span class="ai-suggestion-price-amount">${s.prixSuggere}‚Ç¨</span>
                <span class="ai-suggestion-price-base">${s.prixBase}‚Ç¨</span>
            </div>
            <button class="btn-ai-apply" onclick="accepterSuggestionIA('${s.date}', ${s.prixSuggere}, 'ai-card-${idx}')">
                ‚úì
            </button>
        </div>`;
    }).join('');

    container.style.display = 'block';
}

/**
 * Applique une suggestion IA au cache des tarifs et sauvegarde
 */
async function accepterSuggestionIA(dateStr, prixSuggere, cardId) {
    if (!currentGiteIdMobile) return;

    try {
        // Mettre √† jour le cache local
        const existingIndex = tarifsCacheMobile.findIndex(t => t.date === dateStr);
        if (existingIndex > -1) {
            tarifsCacheMobile[existingIndex].prix_nuit = prixSuggere;
        } else {
            tarifsCacheMobile.push({ date: dateStr, prix_nuit: prixSuggere });
        }

        // Sauvegarder en base
        const { error } = await window.supabaseClient
            .from('gites')
            .update({ tarifs_calendrier: tarifsCacheMobile })
            .eq('id', currentGiteIdMobile);

        if (error) throw error;

        // Marquer la carte comme appliqu√©e
        const card = document.getElementById(cardId);
        if (card) {
            card.classList.add('applied');
            const btn = card.querySelector('.btn-ai-apply');
            if (btn) {
                btn.textContent = '‚úì';
                btn.classList.add('btn-ai-applied');
                btn.disabled = true;
            }
        }

        renderCalendrierMobile();
    } catch (err) {
        console.error('Erreur application suggestion:', err);
        showToast('Erreur lors de l\'application', 'error');
    }
}

/**
 * Applique toutes les suggestions d'un coup
 */
async function appliquerToutesSuggestions() {
    const cards = document.querySelectorAll('.ai-suggestion-card:not(.applied)');
    if (cards.length === 0) return;

    const btn = document.getElementById('btnAIAppliquerTout');
    if (btn) btn.disabled = true;

    let count = 0;
    for (const card of cards) {
        const dateStr = card.dataset.date;
        const prix = parseFloat(card.dataset.prix);
        if (dateStr && prix) {
            const existingIndex = tarifsCacheMobile.findIndex(t => t.date === dateStr);
            if (existingIndex > -1) {
                tarifsCacheMobile[existingIndex].prix_nuit = prix;
            } else {
                tarifsCacheMobile.push({ date: dateStr, prix_nuit: prix });
            }
            card.classList.add('applied');
            const applyBtn = card.querySelector('.btn-ai-apply');
            if (applyBtn) {
                applyBtn.textContent = '‚úì';
                applyBtn.classList.add('btn-ai-applied');
                applyBtn.disabled = true;
            }
            count++;
        }
    }

    try {
        const { error } = await window.supabaseClient
            .from('gites')
            .update({ tarifs_calendrier: tarifsCacheMobile })
            .eq('id', currentGiteIdMobile);

        if (error) throw error;

        showToast(`‚úÖ ${count} tarif${count > 1 ? 's' : ''} appliqu√©${count > 1 ? 's' : ''}`, 'success');
        renderCalendrierMobile();
    } catch (err) {
        console.error('Erreur application group√©e:', err);
        showToast('Erreur lors de l\'application', 'error');
        if (btn) btn.disabled = false;
    }
}

// Event listeners
setTimeout(() => {
    loadGitesSelectorMobile();
    
    document.getElementById('giteSelectTarifs')?.addEventListener('change', (e) => {
        currentGiteIdMobile = e.target.value;
        loadTarifsMobile();
    });
    
    document.getElementById('btnRefreshTarifs')?.addEventListener('click', loadTarifsMobile);
    
    document.getElementById('prevMonthTarifs')?.addEventListener('click', () => {
        if (currentMonthMobile === 0) {
            currentMonthMobile = 11;
            currentYearMobile--;
        } else {
            currentMonthMobile--;
        }
        renderCalendrierMobile();
        if (aiModeActif === 'demande') voirDemandeMois();
    });

    document.getElementById('nextMonthTarifs')?.addEventListener('click', () => {
        if (currentMonthMobile === 11) {
            currentMonthMobile = 0;
            currentYearMobile++;
        } else {
            currentMonthMobile++;
        }
        renderCalendrierMobile();
        if (aiModeActif === 'demande') voirDemandeMois();
    // ---- Boutons IA calendrier ----
    document.getElementById('btnAIVoirDemande')?.addEventListener('click', voirDemandeMois);
    document.getElementById('btnAIQuitterAnalyse')?.addEventListener('click', quitterModeIA);

    document.getElementById('btnAIProposerPrix')?.addEventListener('click', () => {
        const panel = document.getElementById('ai-prix-panel');
        const estOuvert = panel.style.display !== 'none';
        panel.style.display = estOuvert ? 'none' : 'block';
        document.getElementById('btnAIProposerPrix').classList.toggle('actif', !estOuvert);
        // Pr√©-remplir le prix de base depuis le champ remplissage auto si vide
        if (!estOuvert && !document.getElementById('aiPrixBase').value) {
            const prixAutoVal = document.getElementById('prixAutoMobile')?.value;
            if (prixAutoVal) document.getElementById('aiPrixBase').value = prixAutoVal;
        }
    });

    document.getElementById('btnAIFermerPrix')?.addEventListener('click', () => {
        document.getElementById('ai-prix-panel').style.display = 'none';
        document.getElementById('btnAIProposerPrix').classList.remove('actif');
    });

    document.getElementById('btnAIAnalyseHolidays')?.addEventListener('click', () => analyserDatesIA(false));
    document.getElementById('btnAIAnalyseEvents')?.addEventListener('click', () => analyserDatesIA(true));
    document.getElementById('btnAIAppliquerTout')?.addEventListener('click', appliquerToutesSuggestions);
    
    // Fermer modal en cliquant sur le fond
    document.getElementById('modalTarifMobile')?.addEventListener('click', (e) => {
        if (e.target.id === 'modalTarifMobile') {
            closeModalTarifMobile();
        }
    });
}, 500);
</script>
