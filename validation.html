<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation Planning M√©nage - Soci√©t√©</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .week-title {
            font-size: 1.4rem;
            color: #2c3e50;
            font-weight: bold;
        }

        .menage-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #f39c12;
            transition: all 0.3s;
        }

        .menage-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .menage-item.valide {
            border-left-color: #27ae60;
            background: #d5f4e6;
        }

        .menage-item.refuse {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }

        .menage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .menage-date {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .menage-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-attente {
            background: #fff3cd;
            color: #856404;
        }

        .status-valide {
            background: #d4edda;
            color: #155724;
        }

        .status-refuse {
            background: #f8d7da;
            color: #721c24;
        }

        .menage-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-icon {
            font-size: 1.3rem;
        }

        .detail-text {
            color: #555;
        }

        .detail-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Validation Planning M√©nage</h1>
            <p>Espace r√©serv√© √† la soci√©t√© de m√©nage</p>
        </div>

        <div id="planningContainer">
            <!-- Le planning sera charg√© ici -->
        </div>
    </div>

    <div id="toast" class="toast">
        <span id="toastIcon" style="font-size: 1.5rem;">‚úì</span>
        <span id="toastMessage"></span>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Fonction pour afficher un toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');

            icon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
            messageEl.textContent = message;
            
            toast.style.display = 'flex';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Charger le planning depuis Supabase
        async function loadPlanning() {
            const container = document.getElementById('planningContainer');
            
            try {
                // R√©cup√©rer les r√©servations depuis Supabase
                const { data: reservations, error } = await supabaseClient
                    .from('reservations')
                    .select('*')
                    .order('date_debut', { ascending: true });
                
                if (error) {
                    console.error('Erreur chargement r√©servations:', error);
                    container.innerHTML = `
                        <div class="card">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ùå</div>
                                <h2>Erreur de chargement</h2>
                                <p>${error.message}</p>
                            </div>
                        </div>
                    `;
                    return;
                }
            
                if (!reservations || reservations.length === 0) {
                    container.innerHTML = `
                        <div class="card">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <h2>Aucune r√©servation</h2>
                                <p>Le planning de m√©nage appara√Ætra ici d√®s qu'il y aura des r√©servations.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                // G√©n√©rer le planning de m√©nage
                const menages = generateCleaningSchedule(reservations);
            
                if (menages.length === 0) {
                    container.innerHTML = `
                        <div class="card">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ú®</div>
                                <h2>Aucun m√©nage √† planifier</h2>
                                <p>Tous les m√©nages sont √† jour.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                // Grouper par semaine
                const menagesParSemaine = groupByWeek(menages);
            
            let html = '';
            Object.keys(menagesParSemaine).sort().forEach(weekKey => {
                const weekMenages = menagesParSemaine[weekKey];
                html += `
                    <div class="card">
                        <div class="week-header">
                            <div class="week-title">üìÖ ${weekKey}</div>
                            <div style="color: #7f8c8d;">${weekMenages.length} m√©nage(s)</div>
                        </div>
                        ${weekMenages.map(m => createMenageItem(m)).join('')}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            } catch (error) {
                console.error('Erreur globale:', error);
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ùå</div>
                            <h2>Erreur</h2>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // G√©n√©rer le planning de m√©nage
        function generateCleaningSchedule(reservations) {
            const menages = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            reservations.forEach(res => {
                // Convertir les dates au format Supabase (YYYY-MM-DD) en objets Date
                const dateFin = new Date(res.date_fin);
                
                // Ne pas inclure les m√©nages pass√©s
                if (dateFin < today) return;

                const menageDate = new Date(dateFin);
                const status = res.cleaning_status || 'attente';
                const comments = res.cleaning_comments || '';

                menages.push({
                    id: res.id,
                    date: menageDate,
                    gite: res.gite,
                    nomClient: res.nom,
                    timeOfDay: res.cleaning_time || 'afternoon',
                    status: status,
                    comments: comments
                });
            });

            return menages.sort((a, b) => a.date - b.date);
        }

        // Grouper par semaine
        function groupByWeek(menages) {
            const groups = {};
            
            menages.forEach(m => {
                const weekKey = getWeekKey(m.date);
                if (!groups[weekKey]) {
                    groups[weekKey] = [];
                }
                groups[weekKey].push(m);
            });
            
            return groups;
        }

        // Obtenir la cl√© de semaine
        function getWeekKey(date) {
            const d = new Date(date);
            const day = d.getDate();
            const month = d.toLocaleDateString('fr-FR', { month: 'long' });
            const year = d.getFullYear();
            
            return `${month} ${year}`;
        }

        // Cr√©er un √©l√©ment de m√©nage
        function createMenageItem(menage) {
            const dateStr = menage.date.toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long' 
            });
            
            const timeStr = menage.timeOfDay === 'morning' ? 'üåÖ Matin (8h-12h)' : 'üåá Apr√®s-midi (14h-18h)';
            
            let statusClass = 'status-attente';
            let statusText = '‚è≥ En attente';
            let itemClass = '';
            
            if (menage.status === 'valide') {
                statusClass = 'status-valide';
                statusText = '‚úÖ Valid√©';
                itemClass = 'valide';
            } else if (menage.status === 'refuse') {
                statusClass = 'status-refuse';
                statusText = '‚ùå Refus√©';
                itemClass = 'refuse';
            }

            const actionsHtml = menage.status === 'attente' ? `
                <div class="actions">
                    <button class="btn btn-success" onclick="validerMenage('${menage.id}')">
                        <span>‚úÖ</span> Valider
                    </button>
                    <button class="btn btn-danger" onclick="refuserMenage('${menage.id}')">
                        <span>‚ùå</span> Refuser
                    </button>
                    <button class="btn btn-warning" onclick="proposerModification('${menage.id}')">
                        <span>üìù</span> Proposer modification
                    </button>
                </div>
            ` : menage.status === 'valide' ? `
                <div class="actions">
                    <button class="btn btn-danger" onclick="annulerValidation('${menage.id}')">
                        <span>‚Ü©Ô∏è</span> Annuler validation
                    </button>
                </div>
            ` : `
                <div class="actions">
                    <button class="btn btn-success" onclick="validerMenage('${menage.id}')">
                        <span>‚úÖ</span> Valider quand m√™me
                    </button>
                </div>
            `;

            const commentsHtml = menage.comments ? `
                <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px;">
                    <strong>üí¨ Commentaires :</strong> ${menage.comments}
                </div>
            ` : '';

            return `
                <div class="menage-item ${itemClass}">
                    <div class="menage-header">
                        <div class="menage-date">${dateStr}</div>
                        <div class="menage-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="menage-details">
                        <div class="detail-item">
                            <span class="detail-icon">üè†</span>
                            <div class="detail-text">
                                <div class="detail-label">G√Æte</div>
                                ${menage.gite}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">üë§</span>
                            <div class="detail-text">
                                <div class="detail-label">Client</div>
                                ${menage.nomClient}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">‚è∞</span>
                            <div class="detail-text">
                                <div class="detail-label">Horaire</div>
                                ${timeStr}
                            </div>
                        </div>
                    </div>
                    ${commentsHtml}
                    ${actionsHtml}
                </div>
            `;
        }

        // Valider un m√©nage
        function validerMenage(id) {
            updateMenageStatus(id, 'valide', '');
            showToast('‚úÖ M√©nage valid√©', 'success');
            loadPlanning();
        }

        // Refuser un m√©nage
        function refuserMenage(id) {
            const reason = prompt('Raison du refus (optionnel) :');
            updateMenageStatus(id, 'refuse', reason || 'Refus√© par la soci√©t√©');
            showToast('‚ùå M√©nage refus√©', 'error');
            loadPlanning();
        }

        // Proposer une modification
        function proposerModification(id) {
            const modification = prompt('Proposition de modification :');
            if (modification) {
                updateMenageStatus(id, 'attente', `Modification propos√©e : ${modification}`);
                showToast('üìù Modification propos√©e', 'info');
                loadPlanning();
            }
        }

        // Annuler une validation
        function annulerValidation(id) {
            if (confirm('√ätes-vous s√ªr de vouloir annuler cette validation ?')) {
                updateMenageStatus(id, 'attente', '');
                showToast('‚Ü©Ô∏è Validation annul√©e', 'info');
                loadPlanning();
            }
        }

        // Mettre √† jour le statut d'un m√©nage dans Supabase
        async function updateMenageStatus(id, status, comments) {
            try {
                const { error } = await supabaseClient
                    .from('reservations')
                    .update({
                        cleaning_status: status,
                        cleaning_comments: comments
                    })
                    .eq('id', id);
                
                if (error) {
                    console.error('Erreur mise √† jour:', error);
                    showToast('‚ùå Erreur de mise √† jour', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showToast('‚ùå Erreur', 'error');
            }
        }

        // Charger au d√©marrage
        loadPlanning();

        // Recharger toutes les 30 secondes
        setInterval(loadPlanning, 30000);
    </script>
</body>
</html>
