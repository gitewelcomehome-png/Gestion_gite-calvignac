<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>V√©rification Donn√©es Fiscales</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #3498db; }
        .section h3 { margin-top: 0; color: #3498db; }
        pre { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .btn { background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; }
        .btn:hover { background: #2980b9; }
        .alert { padding: 12px; border-radius: 5px; margin: 10px 0; }
        .alert-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .alert-warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .alert-danger { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üîç V√©rification Donn√©es Fiscales</h2>
        
        <div class="section">
            <h3>1. Statut Connexion</h3>
            <div id="auth-status"></div>
        </div>
        
        <div class="section">
            <h3>2. LocalStorage</h3>
            <div id="localstorage-status"></div>
            <button class="btn" onclick="checkLocalStorage()">üîÑ Actualiser</button>
        </div>
        
        <div class="section">
            <h3>3. Base de Donn√©es Supabase</h3>
            <div id="db-status"></div>
            <button class="btn" onclick="checkDatabase()">üîÑ V√©rifier BDD</button>
            <button class="btn" onclick="saveFromLocalStorage()" style="background: #28a745;">üíæ Sauvegarder vers BDD</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://fgqimtpjjhdqeyyaptoj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZncWltdHBqamhkcWV5eWFwdG9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNTU0MjQsImV4cCI6MjA4MzczMTQyNH0.fOuYg0COYts7XXWxgB7AM01Fg6P86f8oz8XVpGdIaNM';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        
        // V√©rifier la connexion
        async function checkAuth() {
            const authDiv = document.getElementById('auth-status');
            
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    currentUser = user;
                    authDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Connect√©</strong><br>
                            Email: ${user.email}<br>
                            User ID: ${user.id}
                        </div>
                    `;
                } else {
                    authDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå Non connect√©</strong><br>
                            Vous devez √™tre connect√© pour sauvegarder vos donn√©es.
                        </div>
                    `;
                }
            } catch (error) {
                authDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Erreur de connexion</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        // V√©rifier le localStorage
        function checkLocalStorage() {
            const localDiv = document.getElementById('localstorage-status');
            
            // Rechercher toutes les cl√©s fiscales
            const fiscalKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('fiscal') || key.includes('ca') || key.includes('charge') || 
                    key.includes('residence') || key.includes('vehicule') || key.includes('salaire')) {
                    fiscalKeys.push(key);
                }
            }
            
            if (fiscalKeys.length === 0) {
                localDiv.innerHTML = `
                    <div class="alert alert-warning">
                        ‚ö†Ô∏è Aucune donn√©e fiscale trouv√©e dans le navigateur (localStorage vide)
                    </div>
                `;
            } else {
                let html = `<div class="alert alert-success">‚úÖ ${fiscalKeys.length} cl√©(s) trouv√©e(s) :</div>`;
                fiscalKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    html += `<div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                        <strong>${key}</strong><br>
                        <pre style="max-height: 150px; overflow-y: auto; font-size: 12px;">${value}</pre>
                    </div>`;
                });
                localDiv.innerHTML = html;
            }
        }
        
        // V√©rifier la base de donn√©es
        async function checkDatabase() {
            const dbDiv = document.getElementById('db-status');
            dbDiv.innerHTML = '<div class="alert alert-info">üîÑ V√©rification en cours...</div>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('fiscal_history')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    dbDiv.innerHTML = `
                        <div class="alert alert-warning">
                            ‚ö†Ô∏è Aucune donn√©e fiscale trouv√©e en base de donn√©es
                        </div>
                    `;
                } else {
                    let html = `<div class="alert alert-success">‚úÖ ${data.length} enregistrement(s) trouv√©(s) :</div>`;
                    data.forEach((record, i) => {
                        const details = record.donnees_detaillees || {};
                        html += `<div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                            <strong>Ann√©e ${record.year}</strong> (ID: ${record.id})<br>
                            CA: ${details.chiffre_affaires || record.revenus || 'N/A'} ‚Ç¨<br>
                            B√©n√©fice: ${details.benefice_imposable || 'N/A'} ‚Ç¨<br>
                            Cr√©√© le: ${new Date(record.created_at).toLocaleString('fr-FR')}
                        </div>`;
                    });
                    dbDiv.innerHTML = html;
                }
            } catch (error) {
                dbDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Erreur</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        // Sauvegarder depuis localStorage vers BDD
        async function saveFromLocalStorage() {
            if (!currentUser) {
                alert('Vous devez √™tre connect√© pour sauvegarder');
                return;
            }
            
            alert('Cette fonction n\'est pas encore impl√©ment√©e. Veuillez retourner sur l\'onglet Fiscalit√© et cliquer sur le bouton "üíæ Sauvegarder".');
        }
        
        // Initialisation
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            checkLocalStorage();
            checkDatabase();
        });
    </script>
</body>
</html>
