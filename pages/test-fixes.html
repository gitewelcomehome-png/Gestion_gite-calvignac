<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tests Correctifs - Support IA & Stabilit√©</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 24px; background: #f5f7fb; color: #1f2937; }
    h1 { margin: 0 0 8px; }
    .muted { color: #6b7280; margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
    .card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
    .card h2 { margin: 0 0 10px; font-size: 1.05rem; }
    button { border: 0; border-radius: 8px; padding: 10px 12px; font-weight: 600; cursor: pointer; }
    .btn { background: #2563eb; color: #fff; }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .ok { color: #047857; }
    .warn { color: #b45309; }
    .ko { color: #b91c1c; }
    pre { background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 8px; overflow: auto; font-size: 12px; }
    .log { font-size: 13px; line-height: 1.5; max-height: 260px; overflow: auto; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; }
    .pill { display: inline-block; font-size: 12px; border-radius: 999px; padding: 4px 8px; background: #eef2ff; color: #3730a3; }
  </style>
</head>
<body>
  <h1>üîß Validation des correctifs (3 erreurs)</h1>
  <p class="muted">Phase 1: tests imm√©diats ‚Ä¢ Phase 2: monitoring 24h avec auto-r√©solution si aucune r√©apparition.</p>

  <div class="row" style="margin-bottom:16px;">
    <button class="btn" id="runAll">Lancer Phase 1 (Tous les tests)</button>
    <button class="btn-secondary" id="start24h">D√©marrer Monitoring 24h</button>
    <span class="pill" id="monitorState">Monitoring: inactif</span>
  </div>

  <div class="grid">
    <section class="card">
      <h2>Test 1 ‚Äî `/api/ai-health?section=support` (403)</h2>
      <p>Objectif: √©viter les 403 depuis le domaine courant.</p>
      <div class="row"><button class="btn" id="test1">Ex√©cuter test UI</button></div>
      <p id="r1" class="muted">En attente</p>
      <pre id="c1"></pre>
    </section>

    <section class="card">
      <h2>Test 2 ‚Äî Draps (utilisateur non connect√©)</h2>
      <p>Objectif: plus de `console.error` critique si user absent.</p>
      <div class="row"><button class="btn" id="test2">Ex√©cuter test UI</button></div>
      <p id="r2" class="muted">En attente</p>
      <pre id="c2"></pre>
    </section>

    <section class="card">
      <h2>Test 3 ‚Äî Subscription manager (`null.id`)</h2>
      <p>Objectif: pas de TypeError si utilisateur absent.</p>
      <div class="row"><button class="btn" id="test3">Ex√©cuter test UI</button></div>
      <p id="r3" class="muted">En attente</p>
      <pre id="c3"></pre>
    </section>

    <section class="card" style="grid-column:1 / -1;">
      <h2>Scripts console g√©n√©r√©s</h2>
      <p>Copier-coller dans DevTools Console si besoin.</p>
      <pre id="consoleScripts"></pre>
    </section>

    <section class="card" style="grid-column:1 / -1;">
      <h2>Journal validation</h2>
      <div id="log" class="log"></div>
    </section>
  </div>

  <script>
    const ERRORS = [
      {
        id: 'ae820e03-415c-4726-8203-e3ae6eeae878',
        title: 'HTTP 403 /api/ai-health?section=support'
      },
      {
        id: '087cc6ed-82b7-4dd9-8ad2-0dfec722f54f',
        title: 'Erreur analyse r√©servations: Utilisateur non connect√©'
      },
      {
        id: 'f8950439-cb38-4759-b1fd-bdc7d9f08f6a',
        title: "Cannot read properties of null (reading 'id')"
      }
    ];

    const correctionsPayload = [
      {
        errorId: 'ae820e03-415c-4726-8203-e3ae6eeae878',
        filePath: '/workspaces/Gestion_gite-calvignac/api/ai-health.js',
        oldCode: 'const isAllowed = requestOrigin ? allowedOrigins.has(requestOrigin) : false;',
        newCode: 'Ajout origine dynamique de requ√™te (host courant) dans allowedOrigins',
        description: '√âvite les 403 sur domaine d√©ploy√© courant sans ouvrir globalement les origines.'
      },
      {
        errorId: '087cc6ed-82b7-4dd9-8ad2-0dfec722f54f',
        filePath: '/workspaces/Gestion_gite-calvignac/js/draps.js',
        oldCode: "if (!user) throw new Error('Utilisateur non connect√©');",
        newCode: 'if (!user) return;',
        description: 'Sortie silencieuse quand non connect√© pour √©viter une erreur critique au chargement.'
      },
      {
        errorId: 'f8950439-cb38-4759-b1fd-bdc7d9f08f6a',
        filePath: '/workspaces/Gestion_gite-calvignac/js/subscription-manager.js',
        oldCode: ".eq('owner_user_id', user.id)",
        newCode: 'Guard user null + try/catch dans controlGitesLimit',
        description: '√âvite le TypeError sur user null et capture les erreurs async.'
      }
    ];

    const monitorKey = 'fixes_monitor_24h_v1';

    function log(msg, level = 'info') {
      const el = document.getElementById('log');
      const line = document.createElement('div');
      const cls = level === 'ok' ? 'ok' : level === 'warn' ? 'warn' : level === 'ko' ? 'ko' : '';
      line.className = cls;
      line.textContent = `[${new Date().toLocaleTimeString('fr-FR')}] ${msg}`;
      el.prepend(line);
    }

    function setResult(id, ok, message) {
      const el = document.getElementById(id);
      el.className = ok ? 'ok' : 'ko';
      el.textContent = `${ok ? '‚úÖ' : '‚ùå'} ${message}`;
    }

    function setCode(id, text) {
      document.getElementById(id).textContent = text;
    }

    async function test1() {
      try {
        const response = await fetch('/api/ai-health?section=support', { method: 'GET', cache: 'no-store' });
        const ok = response.status !== 403;
        setResult('r1', ok, `Statut HTTP: ${response.status}`);
        setCode('c1', `fetch('/api/ai-health?section=support') => ${response.status}`);
        log(`Test 1 termin√© avec statut ${response.status}`, ok ? 'ok' : 'ko');
        return ok;
      } catch (error) {
        setResult('r1', false, error.message || 'Erreur r√©seau');
        setCode('c1', String(error));
        log(`Test 1 erreur: ${error.message || error}`, 'ko');
        return false;
      }
    }

    async function test2() {
      try {
        const script = await fetch('/js/draps.js?v=' + Date.now()).then(r => r.text());
        const hasGuard = script.includes('if (!user) {') && script.includes('return;');
        const removedThrow = !script.includes("throw new Error('Utilisateur non connect√©')");
        const ok = hasGuard && removedThrow;

        setResult('r2', ok, ok ? 'Guard non-connect√© pr√©sent' : 'Guard/throw √† v√©rifier');
        setCode('c2', `hasGuard=${hasGuard}, removedThrow=${removedThrow}`);
        log(`Test 2 pattern check: hasGuard=${hasGuard}, removedThrow=${removedThrow}`, ok ? 'ok' : 'ko');
        return ok;
      } catch (error) {
        setResult('r2', false, error.message || 'Erreur lecture script');
        setCode('c2', String(error));
        log(`Test 2 erreur: ${error.message || error}`, 'ko');
        return false;
      }
    }

    async function test3() {
      try {
        const script = await fetch('/js/subscription-manager.js?v=' + Date.now()).then(r => r.text());
        const hasUserGuard = script.includes('if (!user) {') && script.includes('canAdd: false');
        const hasControlTryCatch = script.includes('try {') && script.includes('Erreur contr√¥le limite g√Ætes:');
        const ok = hasUserGuard && hasControlTryCatch;

        setResult('r3', ok, ok ? 'Guards null + try/catch pr√©sents' : 'Guards √† v√©rifier');
        setCode('c3', `hasUserGuard=${hasUserGuard}, hasControlTryCatch=${hasControlTryCatch}`);
        log(`Test 3 pattern check: hasUserGuard=${hasUserGuard}, hasControlTryCatch=${hasControlTryCatch}`, ok ? 'ok' : 'ko');
        return ok;
      } catch (error) {
        setResult('r3', false, error.message || 'Erreur lecture script');
        setCode('c3', String(error));
        log(`Test 3 erreur: ${error.message || error}`, 'ko');
        return false;
      }
    }

    async function validateImmediately(errorId, passed) {
      const testConfig = { source: 'pages/test-fixes.html', passed, checkedAt: new Date().toISOString() };

      if (window.autoValidatorInstance?.validateImmediately) {
        try {
          await window.autoValidatorInstance.validateImmediately(errorId, testConfig);
          log(`Validator imm√©diat ex√©cut√© pour ${errorId}`, 'ok');
        } catch (e) {
          log(`Validator imm√©diat en √©chec pour ${errorId}: ${e.message || e}`, 'warn');
        }
      } else {
        log(`autoValidatorInstance indisponible (skip) pour ${errorId}`, 'warn');
      }
    }

    async function runAllImmediate() {
      log('Phase 1 d√©marr√©e: tests imm√©diats');
      const results = [await test1(), await test2(), await test3()];

      for (let i = 0; i < ERRORS.length; i++) {
        await validateImmediately(ERRORS[i].id, results[i]);
      }

      const okCount = results.filter(Boolean).length;
      log(`Phase 1 termin√©e: ${okCount}/3 tests OK`, okCount === 3 ? 'ok' : 'warn');

      if (window.logAllCorrections) {
        try {
          const logged = await window.logAllCorrections(correctionsPayload);
          log(`Tra√ßabilit√© corrections: ${JSON.stringify(logged)}`, 'ok');
        } catch (e) {
          log(`logAllCorrections a √©chou√©: ${e.message || e}`, 'warn');
        }
      } else {
        log('logAllCorrections indisponible (skip)', 'warn');
      }

      return results;
    }

    function startMonitoring24h() {
      const state = {
        startedAt: Date.now(),
        endsAt: Date.now() + (24 * 60 * 60 * 1000),
        checks: 0,
        failures: []
      };
      localStorage.setItem(monitorKey, JSON.stringify(state));
      updateMonitorState();
      log('Phase 2 d√©marr√©e: monitoring 24h activ√©', 'ok');
    }

    function stopMonitoring24h(reason) {
      localStorage.removeItem(monitorKey);
      updateMonitorState();
      log(`Monitoring arr√™t√©: ${reason}`, 'warn');
    }

    async function monitorTick() {
      const raw = localStorage.getItem(monitorKey);
      if (!raw) return;

      const state = JSON.parse(raw);
      if (Date.now() >= state.endsAt) {
        if ((state.failures || []).length === 0) {
          log('Monitoring 24h termin√© sans r√©apparition: auto-r√©solution possible', 'ok');
        } else {
          log(`Monitoring 24h termin√© avec ${state.failures.length} √©chec(s)`, 'warn');
        }
        localStorage.removeItem(monitorKey);
        updateMonitorState();
        return;
      }

      const results = [await test1(), await test2(), await test3()];
      state.checks += 1;
      results.forEach((ok, idx) => {
        if (!ok) {
          state.failures.push({ errorId: ERRORS[idx].id, at: new Date().toISOString() });
        }
      });

      localStorage.setItem(monitorKey, JSON.stringify(state));
      updateMonitorState();
    }

    function updateMonitorState() {
      const raw = localStorage.getItem(monitorKey);
      const el = document.getElementById('monitorState');

      if (!raw) {
        el.textContent = 'Monitoring: inactif';
        return;
      }

      const state = JSON.parse(raw);
      const remainingMs = Math.max(0, state.endsAt - Date.now());
      const remainingH = Math.floor(remainingMs / (1000 * 60 * 60));
      el.textContent = `Monitoring: actif (${remainingH}h restantes, checks=${state.checks}, fails=${state.failures.length})`;
    }

    document.getElementById('test1').addEventListener('click', test1);
    document.getElementById('test2').addEventListener('click', test2);
    document.getElementById('test3').addEventListener('click', test3);
    document.getElementById('runAll').addEventListener('click', runAllImmediate);
    document.getElementById('start24h').addEventListener('click', startMonitoring24h);

    const consoleTestScripts = `// TEST CONSOLE 1: endpoint support metrics ne doit plus retourner 403\n(async () => {\n  const r = await fetch('/api/ai-health?section=support', { cache: 'no-store' });\n  console.log('Status:', r.status, 'OK:', r.status !== 403);\n})();\n\n// TEST CONSOLE 2: v√©rifier garde draps non-connect√©\n(async () => {\n  const js = await fetch('/js/draps.js?v=' + Date.now()).then(r => r.text());\n  console.log('Guard user present:', js.includes('if (!user) {') && js.includes('return;'));\n  console.log('Old throw removed:', !js.includes(\"throw new Error('Utilisateur non connect√©')\"));\n})();\n\n// TEST CONSOLE 3: v√©rifier garde null + try/catch subscription\n(async () => {\n  const js = await fetch('/js/subscription-manager.js?v=' + Date.now()).then(r => r.text());\n  console.log('User guard:', js.includes('if (!user) {') && js.includes('canAdd: false'));\n  console.log('controlGitesLimit try/catch:', js.includes('Erreur contr√¥le limite g√Ætes:'));\n})();`;

    document.getElementById('consoleScripts').textContent = consoleTestScripts;

    updateMonitorState();
    setInterval(monitorTick, 5 * 60 * 1000);
  </script>
</body>
</html>
