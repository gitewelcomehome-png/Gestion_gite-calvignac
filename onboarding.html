<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenue - Gestion G√Ætes</title>
    <link rel="stylesheet" href="css/icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            padding: 30px 40px;
            background: #f8f9fa;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .progress-step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .progress-step:first-child::before {
            display: none;
        }

        .progress-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 2;
            margin-bottom: 10px;
        }

        .progress-step.active .progress-number {
            background: #667eea;
            color: white;
        }

        .progress-step.completed .progress-number {
            background: #4caf50;
            color: white;
        }

        .progress-step.completed .progress-number::after {
            content: '‚úì';
        }

        .progress-label {
            font-size: 12px;
            color: #666;
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .gite-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .gite-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .icon-picker {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .icon-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-option svg {
            width: 40px;
            height: 40px;
            stroke: #2D3436;
            stroke-width: 2.2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .icon-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .icon-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .color-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
        }

        .add-gite-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed #667eea;
            background: transparent;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .add-gite-btn:hover {
            background: #f0f4ff;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            margin: 0 auto 20px;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }

        .alert-info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1976d2;
        }

        .remove-gite {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè° Bienvenue</h1>
            <p>Configurez votre espace de gestion en quelques √©tapes</p>
        </div>

        <div class="progress-bar">
            <div class="progress-step active" data-step="1">
                <div class="progress-number">1</div>
                <div class="progress-label">Inscription</div>
            </div>
            <div class="progress-step" data-step="2">
                <div class="progress-number">2</div>
                <div class="progress-label">Organisation</div>
            </div>
            <div class="progress-step" data-step="3">
                <div class="progress-number">3</div>
                <div class="progress-label">Vos g√Ætes</div>
            </div>
            <div class="progress-step" data-step="4">
                <div class="progress-number">4</div>
                <div class="progress-label">Termin√©</div>
            </div>
        </div>

        <div class="content">
            <!-- √âTAPE 1: Inscription -->
            <div class="step active" data-step="1">
                <h2 style="margin-bottom: 20px;">Cr√©er votre compte</h2>
                
                <div id="signup-error" class="alert alert-error" style="display: none;"></div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="votre@email.com" required>
                </div>

                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="password" placeholder="Min. 8 caract√®res" required>
                </div>

                <div class="form-group">
                    <label>Confirmer le mot de passe</label>
                    <input type="password" id="password-confirm" placeholder="R√©p√©tez le mot de passe" required>
                </div>

                <div class="buttons">
                    <button class="btn btn-primary" onclick="nextStep()" style="margin-left: auto;">
                        Continuer ‚Üí
                    </button>
                </div>
            </div>

            <!-- √âTAPE 2: Organization -->
            <div class="step" data-step="2">
                <h2 style="margin-bottom: 20px;">Votre organisation</h2>
                
                <div class="form-group">
                    <label>Nom de votre organisation</label>
                    <input type="text" id="org-name" placeholder="Ex: G√Ætes du Val de Loire" required>
                    <small style="color: #666;">Ce nom sera visible dans l'application</small>
                </div>

                <div class="form-group">
                    <label>Email de contact</label>
                    <input type="email" id="org-email" placeholder="contact@mesgites.com">
                </div>

                <div class="form-group">
                    <label>T√©l√©phone</label>
                    <input type="tel" id="org-phone" placeholder="+33 6 12 34 56 78">
                </div>

                <div class="buttons">
                    <button class="btn btn-secondary" onclick="prevStep()">
                        ‚Üê Retour
                    </button>
                    <button class="btn btn-primary" onclick="nextStep()">
                        Continuer ‚Üí
                    </button>
                </div>
            </div>

            <!-- √âTAPE 3: G√Ætes -->
            <div class="step" data-step="3">
                <h2 style="margin-bottom: 20px;">Ajoutez vos g√Ætes</h2>
                
                <div id="gites-container"></div>

                <button class="add-gite-btn" onclick="addGiteCard()">
                    + Ajouter un g√Æte
                </button>

                <div class="buttons">
                    <button class="btn btn-secondary" onclick="prevStep()">
                        ‚Üê Retour
                    </button>
                    <button class="btn btn-success" onclick="finishSetup()">
                        Terminer la configuration
                    </button>
                </div>
            </div>

            <!-- √âTAPE 4: Succ√®s -->
            <div class="step" data-step="4">
                <div style="text-align: center;">
                    <div class="success-icon">‚úì</div>
                    <h2 style="margin-bottom: 15px;">Tout est pr√™t !</h2>
                    <p style="color: #666; margin-bottom: 30px;">
                        Votre espace de gestion est configur√© et op√©rationnel.
                    </p>
                    
                    <div class="alert alert-info">
                        <strong>Prochaines √©tapes :</strong><br>
                        ‚Ä¢ Synchronisez vos calendriers (Airbnb, Booking)<br>
                        ‚Ä¢ Invitez votre √©quipe de m√©nage<br>
                        ‚Ä¢ Configurez vos informations pratiques
                    </div>

                    <button class="btn btn-success" onclick="goToDashboard()" style="margin-top: 20px;">
                        Acc√©der au tableau de bord ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.local.js" onerror="console.log('config.local.js non trouv√©')"></script>
    <script src="js/shared-config.js"></script>
    <script src="js/icons.js"></script>
    
    <script>
        let currentStep = 1;
        let gitesData = [];
        let userSession = null;

        // Le client Supabase est d√©j√† disponible via window.supabase (shared-config.js)
        
        // V√©rifier si l'utilisateur a d√©j√† termin√© l'onboarding
        async function checkAuth() {
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                
                if (session && session.user) {
                    // V√©rifier si l'utilisateur a une organization
                    const { data, error } = await window.supabaseClient
                        .from('organization_members')
                        .select('organization_id')
                        .eq('user_id', session.user.id)
                        .limit(1);
                    
                    if (!error && data && data.length > 0) {
                        // Onboarding d√©j√† termin√©, rediriger vers dashboard
                        console.log('‚úÖ Onboarding d√©j√† termin√©, redirection vers dashboard');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    // Utilisateur connect√© mais onboarding incomplet
                    console.log('‚ÑπÔ∏è Utilisateur connect√©, onboarding √† terminer');
                    // Passer directement √† l'√©tape 2
                    userSession = session;
                    showStep(2);
                }
            } catch (error) {
                console.error('Erreur v√©rification auth:', error);
            }
        }
        checkAuth();

        function updateProgressBar() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNum = index + 1;
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });
        }

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            currentStep = step;
            updateProgressBar();
        }

        async function nextStep() {
            if (currentStep === 1) {
                // Valider et cr√©er le compte
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const passwordConfirm = document.getElementById('password-confirm').value;

                if (!email || !password) {
                    showError('Veuillez remplir tous les champs');
                    return;
                }

                if (password !== passwordConfirm) {
                    showError('Les mots de passe ne correspondent pas');
                    return;
                }

                if (password.length < 8) {
                    showError('Le mot de passe doit contenir au moins 8 caract√®res');
                    return;
                }

                // Cr√©er le compte
                const { data, error } = await window.supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    showError(error.message);
                    return;
                }

                // Sauvegarder session OU user (selon config email)
                userSession = data.session || { user: data.user };
                
                console.log('‚úÖ Compte cr√©√©:', { hasSession: !!data.session, hasUser: !!data.user });
                
                if (!data.user) {
                    showError('Erreur lors de la cr√©ation du compte');
                    return;
                }
                
                showStep(2);

            } else if (currentStep === 2) {
                const orgName = document.getElementById('org-name').value;
                if (!orgName) {
                    alert('Veuillez entrer le nom de votre organisation');
                    return;
                }
                // Ajouter le premier g√Æte par d√©faut
                addGiteCard();
                showStep(3);

            } else if (currentStep === 3) {
                showStep(4);
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('signup-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        let giteCounter = 0;

        function addGiteCard() {
            giteCounter++;
            const container = document.getElementById('gites-container');
            
            const card = document.createElement('div');
            card.className = 'gite-card';
            card.dataset.giteId = giteCounter;
            card.innerHTML = `
                ${giteCounter > 1 ? '<button class="remove-gite" onclick="removeGite(this)">√ó</button>' : ''}
                <div class="form-group">
                    <label>Nom du g√Æte</label>
                    <input type="text" class="gite-name" placeholder="Ex: G√Æte du Ch√¢teau" required>
                </div>

                <div class="form-group">
                    <label>Ic√¥ne</label>
                    <div class="icon-picker">
                        <div class="icon-option" onclick="selectIcon(this, ${giteCounter})" data-icon="maison">
                            ${getIcon('gite', 'maison')}
                        </div>
                        <div class="icon-option selected" onclick="selectIcon(this, ${giteCounter})" data-icon="chalet">
                            ${getIcon('gite', 'chalet')}
                        </div>
                        <div class="icon-option" onclick="selectIcon(this, ${giteCounter})" data-icon="appartement">
                            ${getIcon('gite', 'appartement')}
                        </div>
                        <div class="icon-option" onclick="selectIcon(this, ${giteCounter})" data-icon="villa">
                            ${getIcon('gite', 'villa')}
                        </div>
                        <div class="icon-option" onclick="selectIcon(this, ${giteCounter})" data-icon="manoir">
                            ${getIcon('gite', 'manoir')}
                        </div>
                        <div class="icon-option" onclick="selectIcon(this, ${giteCounter})" data-icon="grange">
                            ${getIcon('gite', 'grange')}
                        </div>
                        <div class="icon-option" onclick="selectIcon(this, ${giteCounter})" data-icon="tiny-house">
                            ${getIcon('gite', 'tiny-house')}
                        </div>
                        <div class="icon-option" onclick="selectIcon(this, ${giteCounter})" data-icon="dome">
                            ${getIcon('gite', 'dome')}
                        </div>
                    </div>
                    <input type="hidden" class="gite-icon" value="chalet">
                </div>

                <div class="form-group">
                    <label>Couleur</label>
                    <div class="color-picker">
                        <div class="color-option selected" style="background: #667eea;" onclick="selectColor(this, ${giteCounter})" data-color="#667eea"></div>
                        <div class="color-option" style="background: #f093fb;" onclick="selectColor(this, ${giteCounter})" data-color="#f093fb"></div>
                        <div class="color-option" style="background: #4caf50;" onclick="selectColor(this, ${giteCounter})" data-color="#4caf50"></div>
                        <div class="color-option" style="background: #ff9800;" onclick="selectColor(this, ${giteCounter})" data-color="#ff9800"></div>
                        <div class="color-option" style="background: #2196f3;" onclick="selectColor(this, ${giteCounter})" data-color="#2196f3"></div>
                        <div class="color-option" style="background: #e91e63;" onclick="selectColor(this, ${giteCounter})" data-color="#e91e63"></div>
                    </div>
                    <input type="hidden" class="gite-color" value="#667eea">
                </div>

                <div class="form-group">
                    <label>Capacit√© (personnes)</label>
                    <input type="number" class="gite-capacity" min="1" value="4">
                </div>

                <div class="form-group">
                    <label>Adresse</label>
                    <input type="text" class="gite-address" placeholder="123 Rue du Village, 01234 Ville">
                </div>
            `;
            
            container.appendChild(card);
        }

        function removeGite(button) {
            button.closest('.gite-card').remove();
        }

        function selectIcon(element, giteId) {
            const card = element.closest('.gite-card');
            card.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            // R√©cup√©rer le nom de l'ic√¥ne depuis data-icon
            const iconName = element.dataset.icon || 'chalet';
            card.querySelector('.gite-icon').value = iconName;
        }

        function selectColor(element, giteId) {
            const card = element.closest('.gite-card');
            card.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            card.querySelector('.gite-color').value = element.dataset.color;
        }

        async function finishSetup() {
            try {
                if (!userSession) {
                    throw new Error('Session expir√©e. Veuillez recommencer.');
                }

                const orgName = document.getElementById('org-name').value;
                const orgEmail = document.getElementById('org-email').value;
                const orgPhone = document.getElementById('org-phone').value;

                let baseSlug = orgName.toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
                const slug = `${baseSlug}-${Math.random().toString(36).substring(2, 8)}`;

                // Pr√©parer les donn√©es des g√Ætes
                const gitesCards = document.querySelectorAll('.gite-card');
                const gitesData = [];
                
                for (const card of gitesCards) {
                    const name = card.querySelector('.gite-name').value;
                    if (!name) continue;

                    let baseGiteSlug = name.toLowerCase()
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/(^-|-$)/g, '');
                    
                    gitesData.push({
                        name: name,
                        slug: `${baseGiteSlug}-${Math.random().toString(36).substring(2, 8)}`,
                        icon: card.querySelector('.gite-icon').value || 'chalet',
                        color: card.querySelector('.gite-color').value || '#667eea',
                        capacity: parseInt(card.querySelector('.gite-capacity').value) || 4,
                        address: card.querySelector('.gite-address').value || null
                    });
                }

                console.log('üì§ Envoi des donn√©es via RPC...');

                // APPEL RPC FUNCTION (BYPASS RLS COMPL√àTEMENT)
                const { data, error } = await window.supabaseClient.rpc('insert_onboarding_data', {
                    p_user_id: userSession.user.id,
                    p_org_name: orgName,
                    p_org_slug: slug,
                    p_org_email: orgEmail || null,
                    p_org_phone: orgPhone || null,
                    p_gites: gitesData
                });

                if (error) {
                    console.error('‚ùå Erreur RPC:', error);
                    throw new Error(`Erreur serveur: ${error.message}`);
                }

                if (!data || !data.success) {
                    console.error('‚ùå Fonction a √©chou√©:', data);
                    throw new Error(data?.error || 'Erreur inconnue');
                }

                console.log('‚úÖ Onboarding termin√© - Organization ID:', data.organization_id);
                showStep(4);
                setTimeout(() => window.location.href = 'index.html', 2000);

            } catch (error) {
                console.error('‚ùå Erreur finale:', error);
                alert('Erreur: ' + error.message);
            }
        }

        function goToDashboard() {
            // Redirection imm√©diate
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
