<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß GESTION G√éTES - VERSION CORRIG√âE 17 D√âC 14H45</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Scripts modulaires de l'application -->
    <script src="js/shared-config.js"></script>
    <script src="js/shared-utils.js"></script>
    <script src="js/supabase-operations.js"></script>
    
    <!-- Leaflet pour la carte interactive -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 300;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Variables CSS */
        :root {
            --primary: #2C5F7D;
            --primary-dark: #1a3a4d;
            --accent: #E8A87C;
            --danger: #E74C3C;
            --success: #27AE60;
            --warning: #F39C12;
            --trevoux: #667eea;
            --couzon: #f093fb;
            --text-dark: #2C3E50;
            --border: #e2e8f0;
            --bg-light: #f8f9fa;
        }
        
        .nav-tab {
            padding: 15px 30px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Work Sans', sans-serif;
            font-size: 1rem;
        }
        
        .nav-tab:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .nav-tab.active {
            background: white;
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Reste du CSS compact√© conserv√© tel quel pour ne pas casser */
        .main-grid{display:grid;grid-template-columns:400px 1fr;gap:30px;margin-bottom:30px;}@media (max-width:1200px){.main-grid{grid-template-columns:1fr;}}.card{background:white;border-radius:20px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,0.15);}.card-header{display:flex;align-items:center;gap:15px;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid var(--border);}.card-icon{font-size:2.5rem;}.card-title{font-family:'Playfair Display',serif;font-size:1.8rem;color:var(--primary);}.form-group{margin-bottom:20px;}label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-dark);font-size:0.95rem;}input,select,textarea{width:100%;padding:14px 18px;border:2px solid #e2e8f0;border-radius:12px;font-size:1rem;font-family:'Work Sans',sans-serif;transition:all 0.3s ease;background:#fafafa;box-shadow:0 1px 3px rgba(0,0,0,0.05);}input:disabled{background:#f0f0f0;cursor:not-allowed;}input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);background:white;box-shadow:0 0 0 4px rgba(102,126,234,0.1),0 2px 8px rgba(0,0,0,0.08);}input::placeholder,textarea::placeholder{color:#94a3b8;font-style:italic;}.form-control{border-radius:12px;}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;}.btn{width:100%;padding:15px;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;font-family:'Work Sans',sans-serif;display:flex;align-items:center;justify-content:center;gap:10px;}.btn:disabled{opacity:0.5;cursor:not-allowed;}.btn-primary{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;}.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(44,95,125,0.4);}.btn-secondary{background:linear-gradient(135deg,var(--accent) 0%,#D89968 100%);color:white;margin-top:10px;}.btn-sync{background:linear-gradient(135deg,#3498DB 0%,#2874A6 100%);color:white;margin-top:10px;}.btn-sync:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(52,152,219,0.4);}.btn-danger{background:linear-gradient(135deg,var(--danger) 0%,#C0392B 100%);color:white;}.btn-warning{background:linear-gradient(135deg,var(--warning) 0%,#E67E22 100%);color:white;}.btn-menage{background:linear-gradient(135deg,#27AE60 0%,#229954 100%);color:white;margin-top:10px;}.btn-menage:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(39,174,96,0.4);}.menage-item{background:#f0f8ff;padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid #27AE60;}.menage-date{font-weight:700;color:var(--primary);margin-bottom:5px;}.menage-detail{font-size:0.95rem;color:#666;}.charges-list{margin-top:20px;}.charge-item{background:var(--bg-light);padding:15px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}.charge-info{flex:1;}.charge-name{font-weight:600;color:var(--primary);}.charge-amount{font-size:1.2rem;font-weight:700;color:var(--danger);}.btn-small{padding:8px 15px;font-size:0.9rem;width:auto;}.stats-section{background:white;border-radius:20px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,0.15);margin-bottom:30px;}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}.stat-item{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:25px;border-radius:15px;text-align:center;color:white;}.stat-value{font-size:2.5rem;font-weight:700;margin-bottom:5px;}.stat-label{font-size:0.9rem;opacity:0.95;}.chart-container{margin-top:30px;height:350px;}.gite-section{margin-bottom:30px;}.gite-header{font-family:'Playfair Display',serif;font-size:1.5rem;padding:15px 20px;border-radius:12px;margin-bottom:15px;color:white;display:flex;align-items:center;gap:10px;}.gite-header.trevoux{background:linear-gradient(135deg,var(--trevoux) 0%,#667eea 100%);}.gite-header.couzon{background:linear-gradient(135deg,var(--couzon) 0%,#f5576c 100%);}.planning-container{width:100%;padding:20px;}.planning-weeks{display:flex;flex-direction:column;gap:30px;}.week-block{background:white;border-radius:15px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);}.week-header-unique{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);padding:12px;text-align:center;color:white;}.week-number-big{font-weight:700;font-size:1.2rem;font-family:'Playfair Display',serif;margin-bottom:3px;}.week-dates-small{font-size:0.85rem;opacity:0.95;}.week-content-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:3px solid var(--primary);}@media (max-width:1024px){.week-content-grid{grid-template-columns:1fr;}}.gite-column-inline{padding:0;border-right:2px solid var(--border);}.gite-column-inline:last-child{border-right:none;}.gite-label{padding:15px;text-align:center;font-weight:700;font-size:1.1rem;color:white;}.gite-label.trevoux-label{background:linear-gradient(135deg,var(--trevoux) 0%,#667eea 100%);}.gite-label.couzon-label{background:linear-gradient(135deg,var(--couzon) 0%,#f5576c 100%);}.week-reservation{padding:15px;border-bottom:1px solid var(--border);}.week-reservation:last-child{border-bottom:none;}.week-reservation.trevoux{background:rgba(102,126,234,0.05);}.week-reservation.couzon{background:rgba(240,147,251,0.05);}.week-empty{padding:40px 20px;text-align:center;color:#999;font-style:italic;background:var(--bg-light);}.gite-column{background:var(--bg-light);border-radius:15px;overflow:hidden;}.gite-header.trevoux-header{background:linear-gradient(135deg,var(--trevoux) 0%,#667eea 100%);padding:20px;text-align:center;color:white;}.gite-header.couzon-header{background:linear-gradient(135deg,var(--couzon) 0%,#f5576c 100%);padding:20px;text-align:center;color:white;}.gite-header h3{margin:0;font-size:1.5rem;font-family:'Playfair Display',serif;}.week-reservation-name{font-weight:600;color:var(--primary);margin-bottom:5px;}.week-reservation-details{font-size:0.85rem;color:#666;}.month-group{margin-bottom:20px;}.month-title{font-weight:700;font-size:1.1rem;color:var(--primary);margin-bottom:10px;padding:10px 15px;background:var(--bg-light);border-radius:8px;text-transform:uppercase;}.cleaning-week-table{width:100%;margin-bottom:30px;border-radius:15px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);}.cleaning-week-header{background:linear-gradient(135deg,#0f172a 0%,#1f2937 100%);color:white;padding:15px;text-align:center;font-weight:700;font-size:1.1rem;}.cleaning-week-body{display:grid;grid-template-columns:1fr 1fr;gap:0;border:1px solid #e5e7eb;}.cleaning-column{padding:0;}.cleaning-column-header{padding:15px;text-align:center;font-weight:700;font-size:1rem;color:white;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}.cleaning-column-header.couzon{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);}.cleaning-item{padding:15px;border-bottom:1px solid #e5e7eb;min-height:80px;display:flex;flex-direction:column;gap:8px;}
        
        /* Styles additionnels pour modals, toast, etc. */
        .modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;}.modal.show{display:flex;}.modal-content{background:white;border-radius:20px;padding:40px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;}.toast{position:fixed;bottom:30px;right:30px;background:var(--success);color:white;padding:20px 30px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:10000;display:none;align-items:center;gap:15px;font-weight:600;}.toast.show{display:flex;animation:slideIn 0.3s ease;}.validation-status{display:inline-block;width:24px;height:24px;border-radius:50%;text-align:center;line-height:24px;font-size:0.9rem;}.validation-status.validated{background:#27ae60;color:white;}.validation-status.pending{background:#ff9800;color:white;}.validation-status.notvalidated{background:#e74c3c;color:white;}
    </style>
</head>
<body>
    <!-- Cadre bouton commit info -->
    <div style="position: fixed; top: 10px; left: 10px; z-index: 1000;">
        <div style="display: inline-block; position: relative;">
            <button id="commitInfoBtn" style="padding: 8px 16px; border-radius: 8px; background: #1976d2; color: white; border: none; cursor: pointer; font-weight: bold;">
                üìù Dernier commit
            </button>
            <div id="commitInfoTooltip" style="display: none; position: absolute; top: 110%; left: 0; background: #fff; color: #222; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 12px; min-width: 320px; font-size: 0.95em;">
                <div style="text-align: center; color: #999;">Chargement...</div>
            </div>
        </div>
    </div>
    <script>
    const btn = document.getElementById('commitInfoBtn');
    const tooltip = document.getElementById('commitInfoTooltip');
    
    // Afficher/masquer au survol
    btn.addEventListener('mouseenter', () => { tooltip.style.display = 'block'; });
    btn.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });
    
    // Charger le dernier commit depuis Supabase
    async function loadLastCommit() {
        try {
            // Attendre que Supabase soit charg√©
            if (typeof window.supabase === 'undefined') {
                await new Promise(resolve => {
                    const checkSupabase = setInterval(() => {
                        if (typeof window.supabaseClient !== 'undefined') {
                            clearInterval(checkSupabase);
                            resolve();
                        }
                    }, 100);
                });
            }
            
            const supabase = window.supabaseClient;
            
            const { data, error } = await supabase
                .from('commits_log')
                .select('*')
                .order('commit_date', { ascending: false })
                .limit(1);
            
            if (error) {
                console.error('Erreur chargement commit:', error);
                tooltip.innerHTML = '<div style="color: #e74c3c;">‚ùå Erreur de chargement</div>';
                return;
            }
            
            if (data && data.length > 0) {
                const commit = data[0];
                const date = new Date(commit.commit_date);
                const dateStr = date.toLocaleString('fr-FR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                tooltip.innerHTML = `
                    <strong>üìå Commit :</strong> ${commit.commit_ref}<br>
                    <strong>üìÖ Date :</strong> ${dateStr}<br>
                    <strong>üí¨ R√©sum√© :</strong><br>
                    <div style="margin-top: 6px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 0.9em;">
                        ${commit.resume}
                    </div>
                `;
            } else {
                tooltip.innerHTML = '<div style="color: #999;">Aucun commit enregistr√©</div>';
            }
        } catch (err) {
            console.error('Erreur:', err);
            tooltip.innerHTML = '<div style="color: #e74c3c;">‚ùå Erreur</div>';
        }
    }
    
    // Charger au d√©marrage
    loadLastCommit();
    // Chargement dynamique des onglets
    document.addEventListener('DOMContentLoaded', function() {
        const tabFiles = {
            'tab-gestion': 'tabs/tab-gestion.html',
            'tab-reservations': 'tabs/tab-reservations.html',
            'tab-archives': 'tabs/tab-archives.html',
            'tab-statistiques': 'tabs/tab-statistiques.html',
            'tab-charges': 'tabs/tab-charges.html',
            'tab-menage': 'tabs/tab-menage.html',
            'tab-infos-gites': 'tabs/tab-infos-gites.html',
            'tab-decouvrir': 'tabs/tab-decouvrir.html',
            'tab-sauvegarde': 'tabs/tab-sauvegarde.html',
        };
        for (const [tabId, file] of Object.entries(tabFiles)) {
            fetch(file)
                .then(r => r.text())
                .then(html => {
                    document.getElementById(tabId).innerHTML = html;
                });
        }
    });
    </script>
    </body>
    <div class="container">
        <header style="position: relative;">
            <!-- Menu Actions en haut √† droite -->
            <div style="position: absolute; top: 0; right: 0;">
                <select onchange="handleQuickAction(this.value); this.value='';" style="padding: 12px 16px; border-radius: 10px; background: rgba(255,255,255,0.25); color: white; border: 2px solid rgba(255,255,255,0.4); font-weight: 600; cursor: pointer; font-size: 0.95rem; font-family: 'Work Sans', sans-serif; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <option value="" style="background: #1f2937; color: white;">‚öôÔ∏è Actions</option>
                    <option value="import" style="background: #1f2937; color: white;">üìÇ Importer donn√©es</option>
                    <option value="backup" style="background: #1f2937; color: white;">üíæ Sauvegarder</option>
                    <option value="archives" style="background: #1f2937; color: white;">üì¶ Archives</option>
                    <option value="ical" style="background: #1f2937; color: white;">‚öôÔ∏è Config iCal</option>
                </select>
            </div>
            
            <!-- Input file cach√© pour import rapide -->
            <input type="file" id="importFileQuick" accept=".json" style="display: none;" onchange="importAllData(event)">
            
            <h1>üèòÔ∏è Gestion G√Ætes PRO</h1>
            <p class="subtitle">Tr√©voux & Couzon - Synchronisation iCal automatique</p>
        </header>
        
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab" data-tab="gestion">‚öôÔ∏è Gestion iCal</button>
            <button class="nav-tab" data-tab="reservations">üìù R√©servations</button>
            <button class="nav-tab" data-tab="archives">üì¶ Archives</button>
            <button class="nav-tab" data-tab="statistiques">üìä Statistiques</button>
            <button class="nav-tab" data-tab="charges">üí∂ Charges & Rentabilit√©</button>
            <button class="nav-tab" data-tab="menage">
                üßπ Planning M√©nage
                <span id="cleaning-notif-badge" style="display:none; background:#e74c3c; color:white; border-radius:50%; padding:2px 6px; margin-left:5px; font-size:0.8em; font-weight:bold;">0</span>
            </button>
            <button class="nav-tab" data-tab="infos-gites">üìù Infos Pratiques</button>
            <button class="nav-tab" data-tab="decouvrir">üó∫Ô∏è √Ä D√©couvrir</button>
            <button class="nav-tab" data-tab="sauvegarde">üíæ Sauvegarde</button>
        </div>
        

        <!-- Conteneurs dynamiques pour chaque onglet -->
        <div id="tab-gestion" class="tab-content"></div>
        <div id="tab-reservations" class="tab-content"></div>
        <div id="tab-archives" class="tab-content"></div>
        <div id="tab-statistiques" class="tab-content"></div>
        <div id="tab-charges" class="tab-content"></div>
        <div id="tab-menage" class="tab-content"></div>
        <div id="tab-infos-gites" class="tab-content"></div>
        <div id="tab-decouvrir" class="tab-content"></div>
        <div id="tab-sauvegarde" class="tab-content"></div>
    </div>
    
        </div>
    </div>
    
    <!-- Modal √âdition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="card-header">
                <span class="card-icon">‚úèÔ∏è</span>
                <h2 class="card-title">Modifier R√©servation</h2>
            </div>
            
            <form id="editForm">
                <input type="hidden" id="editId">
                
                <div class="form-group">
                    <label>Nom <span class="required">*</span></label>
                    <input type="text" id="editNom">
                </div>
                
                <div class="form-group">
                    <label>üì± T√©l√©phone</label>
                    <input type="tel" id="editTelephone" placeholder="+33 6 12 34 56 78">
                </div>
                
                <div class="form-group">
                    <label>Provenance</label>
                    <input type="text" id="editProvenance">
                </div>
                
                <div class="form-group">
                    <label>Nb Personnes</label>
                    <input type="number" id="editNbPersonnes" min="1">
                </div>
                
                <div class="form-group">
                    <label>Montant (‚Ç¨) <span class="required">*</span></label>
                    <input type="number" id="editMontant" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Acompte (‚Ç¨)</label>
                    <input type="number" id="editAcompte" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Statut paiement</label>
                    <select id="editPaiement">
                        <option value="En attente">En attente</option>
                        <option value="Partiellement pay√©">Partiellement pay√©</option>
                        <option value="Pay√©">Pay√©</option>
                        <option value="Annul√©">Annul√©</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span>‚úì</span> Enregistrer
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <span style="font-size: 1.5rem;">‚úì</span>
        <span id="toastMessage"></span>
    </div>
    
    <script>
        // Les configurations et fonctions de base sont maintenant dans js/shared-config.js et js/shared-utils.js
        // Utiliser window.supabaseClient pour acc√©der au client Supabase
        // Note: On utilise var pour √©viter les conflits de scope avec d'autres scripts
        var supabase = window.supabaseClient;
        
        // Variables globales
        let caChartInstance, gitesChartInstance, platformsChartInstance, profitChartInstance;
        let ICAL_CONFIGS = window.DEFAULT_ICAL_CONFIGS;
        
        // ==========================================
        // ‚ö†Ô∏è SECTION SYNCHRONISATION iCAL - NE PAS MODIFIER SANS DEMANDE EXPLICITE ‚ö†Ô∏è
        // ==========================================
        
        // Fonction pour obtenir les URLs iCal (depuis localStorage ou d√©faut)
        function getIcalConfigs() {
            const stored = localStorage.getItem('icalUrls');
            if (stored) {
                return JSON.parse(stored);
            }
            return window.DEFAULT_ICAL_CONFIGS;
        }
        
        // Charger les URLs dans les champs du formulaire
        function chargerUrlsIcal() {
            const configs = getIcalConfigs();
            document.getElementById('icalAirbnbCouzon').value = configs.couzon.airbnb;
            document.getElementById('icalAbritelCouzon').value = configs.couzon.abritel;
            document.getElementById('icalGitesCouzon').value = configs.couzon.gitesDeFrance;
            document.getElementById('icalAirbnbTrevoux').value = configs.trevoux.airbnb;
            document.getElementById('icalAbritelTrevoux').value = configs.trevoux.abritel;
            document.getElementById('icalGitesTrevoux').value = configs.trevoux.gitesDeFrance;
        }
        
        // Sauvegarder les URLs depuis le formulaire
        function sauvegarderUrlsIcal() {
            const configs = {
                couzon: {
                    airbnb: document.getElementById('icalAirbnbCouzon').value.trim(),
                    abritel: document.getElementById('icalAbritelCouzon').value.trim(),
                    gitesDeFrance: document.getElementById('icalGitesCouzon').value.trim()
                },
                trevoux: {
                    airbnb: document.getElementById('icalAirbnbTrevoux').value.trim(),
                    abritel: document.getElementById('icalAbritelTrevoux').value.trim(),
                    gitesDeFrance: document.getElementById('icalGitesTrevoux').value.trim()
                }
            };
            localStorage.setItem('icalUrls', JSON.stringify(configs));
            showToast('‚úì URLs iCal sauvegard√©es');
        }
        
        // Variable globale pour les configs (charger depuis localStorage)
        ICAL_CONFIGS = getIcalConfigs();
        
        // ==========================================
        // üîç RECHERCHE R√âSERVATIONS
        // ==========================================
        
        async function filterReservations(searchTerm) {
            const reservations = await getAllReservations();
            
            if (!searchTerm || searchTerm.trim() === '') {
                // Pas de recherche, afficher tout
                updateReservationsList();
                return;
            }
            
            const term = searchTerm.toLowerCase().trim();
            const filtered = reservations.filter(r => {
                return (
                    (r.nom && r.nom.toLowerCase().includes(term)) ||
                    (r.telephone && r.telephone.includes(term)) ||
                    (r.gite && r.gite.toLowerCase().includes(term)) ||
                    (r.site && r.site.toLowerCase().includes(term)) ||
                    (r.provenance && r.provenance.toLowerCase().includes(term))
                );
            });
            
            // Afficher r√©sultats
            displayFilteredReservations(filtered);
        }
        
        function displayFilteredReservations(reservations) {
            const container = document.getElementById('planning-container');
            
            if (reservations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun r√©sultat</p>';
                return;
            }
            
            let html = '<div class="planning-weeks"><h3 style="margin-bottom: 20px;">üîç R√©sultats de recherche (' + reservations.length + ')</h3>';
            
            reservations.forEach(r => {
                const platformLogo = getPlatformLogo(r.site);
                const messageEnvoye = r.messageEnvoye ? ' <span style="color: #27ae60; font-weight: 600;">‚úì</span>' : '';
                const telephoneDisplay = r.telephone ? `<br><span style="font-size: 0.9rem;">üì± ${r.telephone}</span>` : '';
                
                const isIncomplete = !r.nom || r.nom.includes('‚ö†Ô∏è') || r.nom.includes('√Ä COMPL√âTER') || r.nom.includes('Client');
                const incompleteBadge = isIncomplete ? 
                    '<span style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; margin-left: 8px;">‚ö†Ô∏è √Ä COMPL√âTER</span>' : 
                    '';
                
                html += `
                    <div class="week-reservation" style="margin-bottom: 15px; padding: 12px; border-radius: 12px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); ${isIncomplete ? 'border-left: 4px solid #ff6b6b;' : ''}">
                        <div style="position: relative;">
                            <div style="position: absolute; top: 0; right: 0; display: flex; gap: 4px;">
                                <button onclick="openEditModal(${r.id})" style="background: #e3f2fd; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem;" title="Modifier">‚úèÔ∏è</button>
                                <button onclick="genererPageClient(${r.id})" style="background: #e8f5e9; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem;" title="Page Client">üìÑ</button>
                                <button onclick="deleteReservationById(${r.id})" style="background: #ffebee; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem;" title="Supprimer">üóëÔ∏è</button>
                            </div>
                            
                            <div style="font-weight: 700; font-size: 1.15rem; color: #0f172a; margin-bottom: 8px;">
                                ${r.nom}${messageEnvoye}${incompleteBadge}
                            </div>
                            
                            <div style="font-size: 1.05rem; color: #334155; margin-bottom: 8px;">
                                üìÖ <strong>${formatDate(r.dateDebut)} ‚Üí ${formatDate(r.dateFin)}</strong>${telephoneDisplay}<br>
                                üí∞ <strong>${r.montant.toFixed(2)} ‚Ç¨</strong> ‚Ä¢ ${platformLogo}
                            </div>
                            
                            <div style="font-size: 0.9rem; color: #64748b;">
                                üè† ${r.gite}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ==========================================
        // üìä COMPTEURS PAR PLATEFORME
        // ==========================================
        
        function updatePlatformCounters(reservations) {
            // Compter par plateforme
            let countAirbnb = 0;
            let countAbritel = 0;
            let countGites = 0;
            let countAutres = 0;
            
            reservations.forEach(r => {
                const site = (r.site || '').toLowerCase();
                if (site.includes('airbnb')) {
                    countAirbnb++;
                } else if (site.includes('abritel') || site.includes('homeaway')) {
                    countAbritel++;
                } else if (site.includes('g√Ætes') || site.includes('gites')) {
                    countGites++;
                } else {
                    countAutres++;
                }
            });
            
            // Mettre √† jour les compteurs
            document.getElementById('countAirbnb').textContent = countAirbnb;
            document.getElementById('countAbritel').textContent = countAbritel;
            document.getElementById('countGites').textContent = countGites;
            document.getElementById('countAutres').textContent = countAutres;
        }
        
        // ==========================================
        // üìà STATISTIQUES AVANC√âES
        // ==========================================
        
        async function updateAdvancedStats(reservations) {
            // Utiliser directement les r√©servations pass√©es (d√©j√† filtr√©es si n√©cessaire)
            console.log('updateAdvancedStats - Nombre de r√©servations:', reservations.length);
            
            // Taux d'occupation
            const trevoux = reservations.filter(r => isTrevoux(r.gite));
            const couzon = reservations.filter(r => isCouzon(r.gite));
            
            const joursOccupesTrevoux = trevoux.reduce((sum, r) => {
                const debut = parseLocalDate(r.dateDebut);
                const fin = parseLocalDate(r.dateFin);
                return sum + Math.round((fin - debut) / (1000 * 60 * 60 * 24));
            }, 0);
            
            const joursOccupesCouzon = couzon.reduce((sum, r) => {
                const debut = parseLocalDate(r.dateDebut);
                const fin = parseLocalDate(r.dateFin);
                return sum + Math.round((fin - debut) / (1000 * 60 * 60 * 24));
            }, 0);
            
            const joursAnnee = 365;
            const tauxTrevoux = ((joursOccupesTrevoux / joursAnnee) * 100).toFixed(1);
            const tauxCouzon = ((joursOccupesCouzon / joursAnnee) * 100).toFixed(1);
            
            document.getElementById('tauxTrevoux').textContent = tauxTrevoux + '%';
            document.getElementById('tauxCouzon').textContent = tauxCouzon + '%';
            
            // Prix moyen par nuit
            let totalMontant = 0;
            let totalNuits = 0;
            
            reservations.forEach(r => {
                const debut = parseLocalDate(r.dateDebut);
                const fin = parseLocalDate(r.dateFin);
                // Calcul pr√©cis : diff√©rence en millisecondes divis√©e par 1 jour
                const nuits = Math.round((fin - debut) / (1000 * 60 * 60 * 24));
                totalMontant += r.montant;
                totalNuits += nuits;
            });
            
            const prixMoyen = totalNuits > 0 ? (totalMontant / totalNuits).toFixed(0) : 0;
            document.getElementById('prixMoyen').textContent = prixMoyen + ' ‚Ç¨';
            
            // Dur√©e moyenne
            const dureeMoyenne = reservations.length > 0 ? (totalNuits / reservations.length).toFixed(1) : 0;
            document.getElementById('dureeMoyenne').textContent = dureeMoyenne + ' nuits';
            
            // Meilleur mois - utiliser les donn√©es historiques si disponibles
            const moisCA = Array(12).fill(0);
            const nomsMois = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            
            // V√©rifier s'il y a des donn√©es historiques pour l'ann√©e en cours
            const selectedYear = parseInt(document.getElementById('yearFilterStats')?.value || new Date().getFullYear());
            const historicalData = await getAllHistoricalData();
            const histTotal = historicalData.find(d => d.year === selectedYear && d.gite === 'Total');
            
            if (histTotal) {
                // Utiliser les donn√©es historiques
                const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                months.forEach((m, idx) => {
                    moisCA[idx] = histTotal.months[m] || 0;
                });
                console.log('Meilleur mois - Donn√©es historiques utilis√©es');
            } else {
                // Utiliser les r√©servations
                reservations.forEach(r => {
                    const date = parseLocalDate(r.dateDebut);
                    const monthIndex = date.getMonth();
                    moisCA[monthIndex] += r.montant;
                });
            }
            
            let meilleurMoisIndex = 0;
            let meilleurCA = 0;
            
            moisCA.forEach((ca, idx) => {
                if (ca > meilleurCA) {
                    meilleurCA = ca;
                    meilleurMoisIndex = idx;
                }
            });
            
            const meilleurMois = meilleurCA > 0 ? nomsMois[meilleurMoisIndex] : '-';
            
            document.getElementById('meilleurMois').textContent = meilleurMois;
            document.getElementById('meilleurMoisCA').textContent = meilleurCA > 0 ? meilleurCA.toFixed(0) + ' ‚Ç¨' : '-';
        }
        
        // ==========================================
        // üìÖ FILTRE PAR ANN√âE POUR LES STATS
        // ==========================================
        
        async function populateYearFilter() {
            const reservations = await getAllReservations();
            const years = new Set();
            
            reservations.forEach(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                years.add(year);
            });
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            const currentYear = new Date().getFullYear();
            
            const select = document.getElementById('yearFilterStats');
            if (!select) return; // √âl√©ment pas encore charg√©
            select.innerHTML = '';
            
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Initialiser aussi le champ historicalYear pour la gestion des donn√©es
            if (document.getElementById('historicalYear')) {
                document.getElementById('historicalYear').value = currentYear;
            }
        }
        
        async function filterStatsByYear() {
            const selectedYear = parseInt(document.getElementById('yearFilterStats').value);
            const reservations = await getAllReservations();
            
            // Filtrer les r√©servations par ann√©e
            const filteredReservations = reservations.filter(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                return year === selectedYear;
            });
            
            // Mettre √† jour tous les compteurs et stats avec les r√©servations filtr√©es
            updatePlatformCounters(filteredReservations);
            updateAdvancedStats(filteredReservations);
            
            // Mettre √† jour aussi les stats du bas (R√©servations totales, Tr√©voux, Couzon, CA)
            // IMPORTANT: Ne compter QUE les r√©servations avec un g√Æte valide
            const trevoux = filteredReservations.filter(r => isTrevoux(r.gite));
            const couzon = filteredReservations.filter(r => isCouzon(r.gite));
            
            const caTrevoux = trevoux.reduce((sum, r) => sum + r.montant, 0);
            const caCouzon = couzon.reduce((sum, r) => sum + r.montant, 0);
            const caTotal = caTrevoux + caCouzon;
            
            // Le total = Tr√©voux + Couzon (ignore les r√©servations sans g√Æte valide)
            const totalReservations = trevoux.length + couzon.length;
            
            document.getElementById('statTotal').textContent = totalReservations;
            document.getElementById('statTrevoux').textContent = trevoux.length;
            document.getElementById('statCouzon').textContent = couzon.length;
            document.getElementById('statCA').textContent = caTotal.toFixed(0) + ' ‚Ç¨';
            
            // Mettre √† jour aussi les graphiques si on est dans l'onglet statistiques
            await updateAllCharts(filteredReservations);
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            const tabElement = document.getElementById('tab-' + tabName);
            if (tabElement) tabElement.classList.add('active');
            
            // Marquer le bouton comme actif
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Initialiser les fonctionnalit√©s sp√©cifiques √† chaque onglet
            if (tabName === 'statistiques') {
                if (typeof populateYearFilter === 'function') populateYearFilter();
                if (typeof updateAllCharts === 'function') updateAllCharts();
            }
            if (tabName === 'archives' && typeof updateArchivesDisplay === 'function') {
                updateArchivesDisplay();
            }
            if (tabName === 'charges' && typeof updateChargesDisplay === 'function') {
                updateChargesDisplay();
                if (typeof initChargeForm === 'function') initChargeForm();
            }
            if (tabName === 'menage' && typeof afficherPlanningParSemaine === 'function') {
                afficherPlanningParSemaine();
            }
        }
        
        function showRulesModal() {
            const modal = document.getElementById('rulesModal');
            if (modal) modal.style.display = 'flex';
        }
        
        function closeRulesModal() {
            const modal = document.getElementById('rulesModal');
            if (modal) modal.style.display = 'none';
        }
        
        function autoSetDateFin() {
            const dateDebut = document.getElementById('dateDebut').value;
            if (dateDebut) {
                const date = new Date(dateDebut);
                date.setDate(date.getDate() + 2);
                document.getElementById('dateFin').value = date.toISOString().split('T')[0];
            }
        }
        
        async function updateBlockedDates() {
            const gite = document.getElementById('gite').value;
            if (!gite) return;
            const reservations = await getAllReservations();
            const blockedDates = reservations
                .filter(r => r.gite === gite && new Date(r.dateFin) >= new Date())
                .map(r => `${formatDate(r.dateDebut)} - ${formatDate(r.dateFin)}`)
                .join(', ');
            if (blockedDates) {
                document.getElementById('blockedDatesList').textContent = blockedDates;
                document.getElementById('blockedDatesInfo').style.display = 'block';
            } else {
                document.getElementById('blockedDatesInfo').style.display = 'none';
            }
        }
        
        async function checkDateOverlap(gite, dateDebut, dateFin, excludeId = null) {
            const reservations = await getAllReservations();
            const debut = parseLocalDate(dateDebut);
            const fin = parseLocalDate(dateFin);
            for (const r of reservations) {
                if (r.id === excludeId) continue;
                if (r.gite !== gite) continue;
                const rDebut = parseLocalDate(r.dateDebut);
                const rFin = parseLocalDate(r.dateFin);
                if ((debut >= rDebut && debut < rFin) || (fin > rDebut && fin <= rFin) || (debut <= rDebut && fin >= rFin)) {
                    return true;
                }
            }
            return false;
        }
        
        function getPlatformBadgeClass(site) {
            if (site.toLowerCase().includes('airbnb')) return 'badge-airbnb';
            if (site.toLowerCase().includes('abritel') || site.toLowerCase().includes('homelidays')) return 'badge-abritel';
            if (site.toLowerCase().includes('g√Ætes') || site.toLowerCase().includes('gites')) return 'badge-gites';
            return 'badge-airbnb';
        }
        
        async function syncAllCalendars() {
            // Recharger les configs depuis localStorage
            ICAL_CONFIGS = getIcalConfigs();
            
            const syncBtn = document.getElementById('syncBtn');
            const syncProgress = document.getElementById('syncProgress');
            const syncMessages = document.getElementById('syncMessages');
            const syncStatus = document.getElementById('syncStatus');
            const syncStatusIcon = document.getElementById('syncStatusIcon');
            const syncStatusText = document.getElementById('syncStatusText');
            
            // Afficher le statut
            if (syncStatus) {
                syncStatus.style.display = 'block';
                syncStatus.style.background = '#fff3cd';
                syncStatusIcon.textContent = 'üîÑ';
                syncStatusText.textContent = 'Synchronisation en cours...';
            }
            
            if (syncBtn) syncBtn.disabled = true;
            if (syncProgress) {
                syncProgress.style.display = 'block';
                syncMessages.innerHTML = '';
            }
            
            let totalAdded = 0;
            let totalSkipped = 0;
            let totalErrors = 0;
            
            function addMessage(text, type = 'info') {
                if (!syncMessages) return;
                const msg = document.createElement('div');
                msg.className = `progress-item ${type}`;
                msg.innerHTML = type === 'info' ? `<span class="spinner"></span> ${text}` : `‚úì ${text}`;
                syncMessages.appendChild(msg);
            }
            
            try {
                addMessage('Synchronisation Couzon...', 'info');
                for (const [platform, url] of Object.entries(ICAL_CONFIGS.couzon)) {
                    if (!url) continue;
                    try {
                        addMessage(`  ‚Ä¢ ${platform}...`, 'info');
                        const result = await syncCalendar('Couzon', platform, url);
                        totalAdded += result.added;
                        totalSkipped += result.skipped;
                        addMessage(`  ‚úì ${platform}: ${result.added} ajout√©es, ${result.skipped} ignor√©es`, 'success');
                    } catch (error) {
                        totalErrors++;
                        addMessage(`  ‚úó ${platform}: Erreur`, 'error');
                    }
                }
                
                addMessage('Synchronisation Tr√©voux...', 'info');
                for (const [platform, url] of Object.entries(ICAL_CONFIGS.trevoux)) {
                    if (!url) continue;
                    try {
                        addMessage(`  ‚Ä¢ ${platform}...`, 'info');
                        const result = await syncCalendar('Tr√©voux', platform, url);
                        totalAdded += result.added;
                        totalSkipped += result.skipped;
                        addMessage(`  ‚úì ${platform}: ${result.added} ajout√©es, ${result.skipped} ignor√©es`, 'success');
                    } catch (error) {
                        totalErrors++;
                        addMessage(`  ‚úó ${platform}: Erreur`, 'error');
                    }
                }
                
                addMessage('', 'info');
                addMessage(`‚úì Synchronisation termin√©e !`, 'success');
                addMessage(`üìä Total: ${totalAdded} ajout√©es, ${totalSkipped} ignor√©es, ${totalErrors} erreurs`, 'success');
                
                if (totalAdded > 0) {
                    addMessage('', 'info');
                    addMessage(`‚ö†Ô∏è IMPORTANT: Les iCal publics ne contiennent PAS les noms des clients (RGPD)`, 'info');
                    addMessage(`üí° Allez dans "R√©servations" et cliquez "‚ö†Ô∏è Compl√©ter" pour ajouter les noms`, 'info');
                }
                
                await updateReservationsList();
                await updateStats();
                
                // Mettre √† jour le statut en haut
                if (syncStatus) {
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    if (totalErrors > 0) {
                        syncStatus.style.background = '#fff3cd';
                        syncStatusIcon.textContent = '‚ö†Ô∏è';
                        syncStatusText.textContent = `Synchronisation effectu√©e avec ${totalErrors} erreur(s) - ${dateStr} √† ${timeStr}`;
                    } else {
                        syncStatus.style.background = '#d4edda';
                        syncStatusIcon.textContent = '‚úì';
                        syncStatusText.textContent = `Derni√®re synchronisation r√©ussie : ${dateStr} √† ${timeStr} (${totalAdded} r√©servations ajout√©es)`;
                    }
                    
                    // Sauvegarder le statut
                    localStorage.setItem('lastSyncStatus', JSON.stringify({
                        date: now.toISOString(),
                        added: totalAdded,
                        errors: totalErrors
                    }));
                }
                
                showToast(`‚úì Sync termin√©e : ${totalAdded} r√©servations ajout√©es`);
                
            } catch (error) {
                addMessage('‚úó Erreur g√©n√©rale', 'error');
                if (syncStatus) {
                    syncStatus.style.background = '#f8d7da';
                    syncStatusIcon.textContent = '‚ùå';
                    syncStatusText.textContent = 'Erreur lors de la synchronisation';
                }
                showToast('‚ùå Erreur sync', 'error');
                console.error(error);
            }
            
            if (syncBtn) syncBtn.disabled = false;
        }
        
        async function syncCalendar(gite, platform, url) {
            // Utiliser corsproxy.io au lieu de allorigins (plus fiable)
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
            
            try {
                const response = await fetch(proxyUrl);
                const text = await response.text();
                const jcalData = ICAL.parse(text);
                const comp = new ICAL.Component(jcalData);
                const vevents = comp.getAllSubcomponents('vevent');
                
                let added = 0;
                let skipped = 0;
                
                for (const vevent of vevents) {
                    const event = new ICAL.Event(vevent);
                    
                    const summary = event.summary || '';
                    const description = event.description || '';
                    
                    // üá´üá∑ CORRECTION TIMEZONE : Ne pas utiliser toISOString() qui convertit en UTC !
                    // Utiliser dateToLocalString pour garder l'heure locale fran√ßaise
                    const dateDebut = dateToLocalString(event.startDate.toJSDate());
                    const dateFin = dateToLocalString(event.endDate.toJSDate());
                    
                    // Nom du client (rarement disponible dans les iCal publics pour confidentialit√©)
                    let nom = '√Ä COMPL√âTER';
                    
                    // V√©rifier si le summary contient un vrai nom (pas juste "R√©serv√©", "Busy", etc.)
                    const genericTerms = ['r√©serv√©', 'reserved', 'busy', 'occup√©', 'not available', 'indisponible', 'blocked', 'bloqu√©'];
                    const isGeneric = genericTerms.some(term => summary.toLowerCase().includes(term));
                    
                    if (summary && !isGeneric && summary.length > 3) {
                        // Semble √™tre un vrai nom
                        nom = summary;
                    } else {
                        // Nom g√©n√©rique selon plateforme
                        if (platform.toLowerCase().includes('airbnb')) {
                            nom = '‚ö†Ô∏è Client Airbnb';
                        } else if (platform.toLowerCase().includes('abritel') || platform.toLowerCase().includes('homelidays')) {
                            nom = '‚ö†Ô∏è Client Abritel';
                        } else if (platform.toLowerCase().includes('gites')) {
                            nom = '‚ö†Ô∏è Client G√Ætes de France';
                        }
                    }
                    
                    // Extraction du tarif depuis la description
                    let montant = 0;
                    
                    // Patterns de recherche de prix
                    const pricePatterns = [
                        /(?:total|montant|price|amount)[:\s]*(\d+[,.]?\d*)\s*‚Ç¨/i,
                        /‚Ç¨\s*(\d+[,.]?\d*)/,
                        /(\d+[,.]?\d*)\s*‚Ç¨/,
                        /(\d{2,4}[,.]?\d{0,2})\s*EUR/i
                    ];
                    
                    for (const pattern of pricePatterns) {
                        const match = description.match(pattern);
                        if (match) {
                            const price = match[1].replace(',', '.');
                            montant = parseFloat(price);
                            if (montant > 0 && montant < 10000) break; // Prix raisonnable trouv√©
                        }
                    }
                    
                    // Si toujours pas de tarif, chercher dans le summary aussi
                    if (montant === 0) {
                        const summaryMatch = summary.match(/(\d{2,4}[,.]?\d{0,2})\s*‚Ç¨/);
                        if (summaryMatch) {
                            montant = parseFloat(summaryMatch[1].replace(',', '.'));
                        }
                    }
                    
                    // V√©rifier doublon
                    if (await checkDateOverlap(gite, dateDebut, dateFin)) {
                        skipped++;
                        continue;
                    }
                    
                    // D√©terminer site
                    let site;
                    if (platform.toLowerCase().includes('airbnb')) site = 'Airbnb';
                    else if (platform.toLowerCase().includes('abritel') || platform.toLowerCase().includes('homelidays')) site = 'Abritel';
                    else if (platform.toLowerCase().includes('gites')) site = 'G√Ætes de France (centrale)';
                    else site = platform;
                    
                    const reservation = {
                        gite: gite,
                        nom: nom,
                        telephone: '', // T√©l√©phone vide, √† remplir manuellement
                        provenance: '',
                        dateDebut: dateDebut,
                        dateFin: dateFin,
                        nuits: calculateNights(dateDebut, dateFin),
                        nbPersonnes: 0,
                        montant: montant,
                        acompte: 0,
                        restant: montant,
                        paiement: 'En attente',
                        site: site,
                        timestamp: new Date().toISOString(),
                        syncedFrom: platform
                    };
                    
                    await addReservation(reservation);
                    added++;
                }
                
                return { added, skipped };
                
            } catch (error) {
                console.error(`Erreur sync ${gite} ${platform}:`, error);
                throw error;
            }
        }
        
        // ==========================================
        // ‚ö†Ô∏è FIN SECTION SYNCHRONISATION iCAL ‚ö†Ô∏è
        // ==========================================
        
        async function autoSaveJSON() {
            const reservations = await getAllReservations();
            const backup = {
                version: '1.0',
                date: new Date().toISOString(),
                reservations: reservations
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AutoSave_Gites_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        
        function openEditModal(id) {
            getAllReservations().then(reservations => {
                const reservation = reservations.find(r => r.id === id);
                if (!reservation) return;
                
                document.getElementById('editId').value = reservation.id;
                document.getElementById('editNom').value = reservation.nom;
                document.getElementById('editTelephone').value = reservation.telephone || '';
                document.getElementById('editProvenance').value = reservation.provenance || '';
                document.getElementById('editNbPersonnes').value = reservation.nbPersonnes || '';
                document.getElementById('editMontant').value = reservation.montant;
                document.getElementById('editAcompte').value = reservation.acompte || 0;
                document.getElementById('editPaiement').value = reservation.paiement;
                
                document.getElementById('editModal').classList.add('show');
            });
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }
        
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('editId').value);
            const montant = parseFloat(document.getElementById('editMontant').value);
            const acompte = parseFloat(document.getElementById('editAcompte').value) || 0;
            
            const updates = {
                nom: document.getElementById('editNom').value,
                telephone: document.getElementById('editTelephone').value,
                provenance: document.getElementById('editProvenance').value,
                nbPersonnes: parseInt(document.getElementById('editNbPersonnes').value) || 0,
                montant: montant,
                acompte: acompte,
                restant: montant - acompte,
                paiement: document.getElementById('editPaiement').value
            };
            
            await updateReservation(id, updates);
            await updateReservationsList();
            await updateStats();
            await autoSaveJSON();
            closeEditModal();
            showToast('‚úì R√©servation mise √† jour');
        });
        
        async function updatePaiementStatus(id, newStatus) {
            await updateReservation(id, { paiement: newStatus });
            await updateReservationsList();
            await autoSaveJSON();
            showToast('‚úì Statut mis √† jour');
        }
        
        async function deleteReservationById(id) {
            if (confirm('Supprimer cette r√©servation ?')) {
                await deleteReservation(id);
                await updateReservationsList();
                await updateStats();
                await updateArchivesDisplay();
                await autoSaveJSON();
                showToast('‚úì R√©servation supprim√©e');
            }
        }
        
        // ==========================================
        // ‚ö†Ô∏è SECTION AFFICHAGE R√âSERVATIONS - NE PAS MODIFIER SANS APPROBATION ‚ö†Ô∏è
        // ==========================================
        
        async function updateReservationsList() {
            const reservations = await getAllReservations();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // R√©cup√©rer les validations de la soci√©t√© de m√©nage
            const { data: cleaningSchedules } = await supabase
                .from('cleaning_schedule')
                .select('*');
            
            const validationMap = {};
            if (cleaningSchedules) {
                cleaningSchedules.forEach(cs => {
                    validationMap[cs.reservation_id] = cs;
                });
            }
            
            const active = reservations.filter(r => parseLocalDate(r.dateFin) >= today);
            
            const container = document.getElementById('planning-container');
            if (!container) return; // Conteneur pas encore charg√©
            
            if (active.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune r√©servation</p>';
                return;
            }
            
            // Organiser par g√Æte
            const byGite = {
                'Tr√©voux': active.filter(r => r.gite === 'Tr√©voux'),
                'Couzon': active.filter(r => r.gite === 'Couzon')
            };
            
            // Trier par date
            byGite['Tr√©voux'].sort((a, b) => parseLocalDate(a.dateDebut) - parseLocalDate(b.dateDebut));
            byGite['Couzon'].sort((a, b) => parseLocalDate(a.dateDebut) - parseLocalDate(b.dateDebut));
            
            // Obtenir toutes les semaines √† afficher (bas√© sur la date de D√âBUT uniquement)
            const allWeeks = new Set();
            active.forEach(r => {
                const start = parseLocalDate(r.dateDebut);
                allWeeks.add(getWeekNumber(start));
            });
            
            const sortedWeeks = Array.from(allWeeks).sort((a, b) => {
                // getWeekNumber retourne un nombre, pas une cha√Æne avec '-W'
                return a - b;
            });
            
            // G√©n√©rer le HTML avec en-t√™tes sticky par g√Æte
            let html = '<div class="planning-weeks">';
            
            // En-t√™tes sticky
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; position: sticky; top: 0; z-index: 100; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="gite-label trevoux-label" style="margin: 0; border-radius: 0;">üè† Tr√©voux</div>
                    <div class="gite-label couzon-label" style="margin: 0; border-radius: 0;">üè† Couzon</div>
                </div>
            `;
            
            sortedWeeks.forEach(weekNum => {
                // weekNum est d√©j√† un nombre (r√©sultat de getWeekNumber)
                const year = new Date().getFullYear(); // Ann√©e courante
                const weekDates = getWeekDates(year, weekNum);
                
                // En-t√™te de semaine
                html += `
                    <div class="week-block">
                        <div class="week-header-unique">
                            <div class="week-number-big">Semaine ${weekNum}</div>
                            <div class="week-dates-small">${formatDateShort(weekDates.start)} - ${formatDateShort(weekDates.end)}</div>
                        </div>
                        
                        <div class="week-content-grid" style="border-top: none;">
                            <div class="gite-column-inline">
                                ${generateWeekReservations(byGite['Tr√©voux'], weekNum, 'trevoux', active, validationMap)}
                            </div>
                            
                            <div class="gite-column-inline">
                                ${generateWeekReservations(byGite['Couzon'], weekNum, 'couzon', active, validationMap)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Scroller automatiquement vers la premi√®re semaine (semaine actuelle)
            setTimeout(() => {
                const firstWeek = container.querySelector('.week-block');
                if (firstWeek) {
                    firstWeek.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }
        
        function generateWeekReservations(reservations, weekKey, cssClass, toutesReservations, validationMap = {}) {
            // Trouver les r√©servations dont la date de D√âBUT est dans cette semaine
            const weekReservations = reservations.filter(r => {
                const start = parseLocalDate(r.dateDebut);
                return getWeekNumber(start) === weekKey;
            });
            
            if (weekReservations.length === 0) {
                return '<div class="week-empty">Disponible</div>';
            }
            
            let html = '';
            weekReservations.forEach(r => {
                const platformLogo = getPlatformLogo(r.site);
                const dateMenage = calculerDateMenage(r, toutesReservations);
                const messageEnvoye = r.messageEnvoye ? ' <span style="color: #27ae60; font-weight: 600;">‚úì</span>' : '';
                const telephoneDisplay = r.telephone ? `<br><span style="font-size: 0.9rem;">üì± ${r.telephone}</span>` : '';
                
                // R√©cup√©rer l'√©tat de validation du m√©nage
                const validation = validationMap[r.id];
                let statusBadge = '';
                if (validation) {
                    if (validation.validated_by_company) {
                        // VERT = Valid√©
                        statusBadge = '<span class="validation-status validated" title="Valid√© par soci√©t√©" style="margin-left: 8px;">‚úì</span>';
                    } else if (validation.status === 'proposed') {
                        // ORANGE = En attente de validation
                        statusBadge = '<span class="validation-status pending" title="En attente validation" style="margin-left: 8px;">‚è≥</span>';
                    } else {
                        // ROUGE = √Ä valider
                        statusBadge = '<span class="validation-status notvalidated" title="√Ä valider" style="margin-left: 8px;">‚úó</span>';
                    }
                } else {
                    // Pas de validation enregistr√©e = ROUGE = √Ä valider
                    statusBadge = '<span class="validation-status notvalidated" title="√Ä valider" style="margin-left: 8px;">‚úó</span>';
                }
                
                html += `
                    <div class="week-reservation ${cssClass}" style="position: relative; padding: 12px; padding-top: 40px;">
                        <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                            <button onclick="openEditModal(${r.id})" style="background: #e3f2fd; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s;" title="Modifier">‚úèÔ∏è</button>
                            <button onclick="genererPageClient(${r.id})" style="background: #e8f5e9; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s;" title="Page Client">üìÑ</button>
                            <button onclick="deleteReservationById(${r.id})" style="background: #ffebee; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s;" title="Supprimer">üóëÔ∏è</button>
                        </div>
                        
                        <!-- Nom en haut -->
                        <div style="font-weight: 700; font-size: 1.15rem; color: #0f172a; margin-bottom: 8px; line-height: 1.3;">
                            ${r.nom}${messageEnvoye}
                        </div>
                        
                        <!-- Dates et tarif -->
                        <div style="font-size: 1.05rem; color: #334155; margin-bottom: 8px; line-height: 1.5;">
                            üìÖ <strong>${formatDate(r.dateDebut)} ‚Üí ${formatDate(r.dateFin)}</strong>${telephoneDisplay}<br>
                            üí∞ <strong>${r.montant.toFixed(2)} ‚Ç¨</strong>
                        </div>
                        
                        <!-- Pied : M√©nage avec pastille √† gauche, Plateforme √† droite -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                            <div style="font-size: 0.85rem; color: #64748b; display: flex; align-items: center;">
                                üßπ ${dateMenage}${statusBadge}
                            </div>
                            <div>
                                ${platformLogo}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // ==========================================
        // ‚ö†Ô∏è FIN SECTION AFFICHAGE R√âSERVATIONS ‚ö†Ô∏è
        // ==========================================
        
        function getPlatformLogo(platform) {
            const normalizedPlatform = platform.toLowerCase();
            
            if (normalizedPlatform.includes('airbnb')) {
                return '<span style="display: inline-flex; align-items: center; padding: 3px 10px; background: #FF5A5F; color: white; border-radius: 6px; font-weight: 600; font-size: 0.75rem; letter-spacing: 0.5px;">airbnb</span>';
            } else if (normalizedPlatform.includes('abritel') || normalizedPlatform.includes('homeaway') || normalizedPlatform.includes('homelidays')) {
                return '<span style="display: inline-flex; align-items: center; padding: 3px 10px; background: #0D4F8B; color: white; border-radius: 6px; font-weight: 600; font-size: 0.75rem; letter-spacing: 0.5px;">abritel</span>';
            } else if (normalizedPlatform.includes('g√Ætes') || normalizedPlatform.includes('gites')) {
                return '<span style="display: inline-flex; align-items: center; padding: 3px 10px; background: #27AE60; color: white; border-radius: 6px; font-weight: 600; font-size: 0.75rem; letter-spacing: 0.5px;">g√Ætes de france</span>';
            } else {
                return `<span style="display: inline-flex; align-items: center; padding: 3px 10px; background: #95a5a6; color: white; border-radius: 6px; font-weight: 600; font-size: 0.75rem;">${platform}</span>`;
            }
        }
        
        function calculerDateMenage(reservation, toutesReservations) {
            const departDate = parseLocalDate(reservation.dateFin);
            const departDay = departDate.getDay(); // 0=dimanche, 6=samedi
            
            let menageDate = new Date(departDate);
            let heure = '12h00'; // Par d√©faut apr√®s-midi
            
            // V√©rifier s'il y a une arriv√©e le jour du d√©part
            const arriveeMemejour = toutesReservations.find(r => 
                r.gite === reservation.gite && 
                r.id !== reservation.id &&
                parseLocalDate(r.dateDebut).toDateString() === departDate.toDateString()
            );
            
            // R√àGLE 1: Dimanche - Reporter au lundi (sauf enchainement)
            if (departDay === 0) {
                if (arriveeMemejour) {
                    // Exception: enchainement dimanche
                    heure = '13h00';
                } else {
                    // Reporter au lundi
                    menageDate.setDate(menageDate.getDate() + 1);
                    
                    const arriveeLundi = toutesReservations.find(r => 
                        r.gite === reservation.gite && 
                        r.id !== reservation.id &&
                        parseLocalDate(r.dateDebut).toDateString() === menageDate.toDateString()
                    );
                    
                    heure = arriveeLundi ? '07h00' : '12h00';
                }
            }
            // R√àGLE 2: Samedi - V√©rifier r√©servation samedi/dimanche avant de d√©cider
            else if (departDay === 6) {
                if (arriveeMemejour) {
                    heure = '12h00'; // Apr√®s-midi m√™me si enchainement
                } else {
                    // V√©rifier s'il y a une r√©servation samedi soir ou dimanche soir
                    const samediDate = new Date(departDate);
                    const dimancheDate = new Date(departDate);
                    dimancheDate.setDate(dimancheDate.getDate() + 1);
                    
                    const resaSamediOuDimanche = toutesReservations.find(r =>
                        r.gite === reservation.gite &&
                        r.id !== reservation.id &&
                        (parseLocalDate(r.dateDebut).toDateString() === samediDate.toDateString() ||
                         parseLocalDate(r.dateDebut).toDateString() === dimancheDate.toDateString())
                    );
                    
                    if (resaSamediOuDimanche) {
                        // Il y a une r√©servation samedi ou dimanche ‚Üí m√©nage le samedi
                        heure = '12h00';
                    } else {
                        // Pas de r√©servation samedi/dimanche ‚Üí reporter au lundi
                        menageDate.setDate(menageDate.getDate() + 2);
                        
                        const arriveeLundi = toutesReservations.find(r => 
                            r.gite === reservation.gite && 
                            r.id !== reservation.id &&
                            parseLocalDate(r.dateDebut).toDateString() === menageDate.toDateString()
                        );
                        
                        heure = arriveeLundi ? '07h00' : '12h00';
                    }
                }
            }
            // R√àGLE 3: Mercredi ou Jeudi - V√©rifier r√©servation avant vendredi
            else if (departDay === 3 || departDay === 4) { // 3=mercredi, 4=jeudi
                if (arriveeMemejour) {
                    // Il y a un enchainement ‚Üí m√©nage le jour m√™me
                    heure = '12h00';
                } else {
                    // V√©rifier s'il y a une r√©servation jeudi ou vendredi (avant le vendredi)
                    const jeudiDate = new Date(departDate);
                    if (departDay === 3) {
                        jeudiDate.setDate(jeudiDate.getDate() + 1); // Si d√©part mercredi, v√©rifier jeudi
                    }
                    const vendrediDate = new Date(departDate);
                    const joursAajouter = departDay === 3 ? 2 : 1; // Mercredi +2 = vendredi, Jeudi +1 = vendredi
                    vendrediDate.setDate(vendrediDate.getDate() + joursAajouter);
                    
                    const resaAvantVendredi = toutesReservations.find(r =>
                        r.gite === reservation.gite &&
                        r.id !== reservation.id &&
                        (parseLocalDate(r.dateDebut) < vendrediDate)
                    );
                    
                    if (resaAvantVendredi) {
                        // Il y a une r√©servation avant vendredi ‚Üí m√©nage le jour du d√©part
                        heure = '12h00';
                    } else {
                        // Pas de r√©servation avant vendredi ‚Üí reporter au vendredi
                        menageDate.setDate(menageDate.getDate() + joursAajouter);
                        
                        const arriveeVendredi = toutesReservations.find(r =>
                            r.gite === reservation.gite &&
                            r.id !== reservation.id &&
                            parseLocalDate(r.dateDebut).toDateString() === menageDate.toDateString()
                        );
                        
                        heure = arriveeVendredi ? '07h00' : '12h00';
                    }
                }
            }
            // R√àGLE 4: Autres jours semaine (Lun, Mar, Ven) - Apr√®s-midi TOUJOURS
            else {
                heure = '12h00'; // TOUJOURS apr√®s-midi en semaine
            }
            
            // V√©rifier jour f√©ri√© (sauf enchainement m√™me jour)
            if (!arriveeMemejour && isJourFerie(menageDate)) {
                do {
                    menageDate.setDate(menageDate.getDate() + 1);
                } while (isJourFerie(menageDate) || menageDate.getDay() === 0);
            }
            
            const joursComplets = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            return `${joursComplets[menageDate.getDay()]} ${formatDateShort(menageDate)} √† ${heure}`;
        }
        
        function isJourFerie(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            const feriesFixes = [
                `${year}-01-01`, `${year}-05-01`, `${year}-05-08`, `${year}-07-14`,
                `${year}-08-15`, `${year}-11-01`, `${year}-11-11`, `${year}-12-25`
            ];
            
            const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            if (feriesFixes.includes(dateKey)) return true;
            
            // P√¢ques mobiles
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const paquesMois = Math.floor((h + l - 7 * m + 114) / 31);
            const paquesJour = ((h + l - 7 * m + 114) % 31) + 1;
            
            const paques = new Date(year, paquesMois - 1, paquesJour);
            const lundiPaques = new Date(paques);
            lundiPaques.setDate(lundiPaques.getDate() + 1);
            const ascension = new Date(paques);
            ascension.setDate(ascension.getDate() + 39);
            const lundiPentecote = new Date(paques);
            lundiPentecote.setDate(lundiPentecote.getDate() + 50);
            
            const dateStr = date.toDateString();
            return dateStr === lundiPaques.toDateString() || 
                   dateStr === ascension.toDateString() || 
                   dateStr === lundiPentecote.toDateString();
        }
        
        function formatDateShort(date) {
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }
        
        function getWeekDates(year, weekNum) {
            const simple = new Date(year, 0, 1 + (weekNum - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            
            const start = new Date(ISOweekStart);
            const end = new Date(ISOweekStart);
            end.setDate(end.getDate() + 6);
            
            return { start, end };
        }
        
        async function updateArchivesDisplay() {
            const reservations = await getAllReservations();
            const section = document.getElementById('archivesSection');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const archives = reservations.filter(r => parseLocalDate(r.dateFin) < today);
            archives.sort((a, b) => parseLocalDate(b.dateFin) - parseLocalDate(a.dateFin));
            
            if (archives.length === 0) {
                section.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune archive</p>';
                return;
            }
            
            let html = '<div class="gite-section">';
            
            archives.forEach(r => {
                const badgeClass = getPlatformBadgeClass(r.site);
                html += `
                    <div class="reservation-item ${r.gite.toLowerCase()}">
                        <div class="reservation-header">
                            <span class="reservation-name">${r.nom} - ${r.gite}</span>
                            <span class="badge-platform ${badgeClass}">
                                ${r.site}
                            </span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem; color: #666;">
                            üìÖ ${formatDate(r.dateDebut)} ‚Üí ${formatDate(r.dateFin)} (${r.nuits} nuits)
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem;">
                            üí∞ ${r.montant.toFixed(2)} ‚Ç¨ | Statut: ${r.paiement}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            section.innerHTML = html;
        }
        
        async function updateStats() {
            const reservations = await getAllReservations();
            const historicalData = await getAllHistoricalData();
            
            // Filtrer par l'ann√©e s√©lectionn√©e
            const selectedYear = parseInt(document.getElementById('yearFilterStats')?.value || new Date().getFullYear());
            
            // V√©rifier si des donn√©es historiques "Total" existent pour cette ann√©e
            const histTotal = historicalData.find(d => d.year === selectedYear && d.gite === 'Total');
            
            let caTotal = 0;
            let totalReservations = 0;
            
            if (histTotal) {
                // Utiliser UNIQUEMENT les donn√©es historiques (pas les r√©servations)
                console.log('‚úì Utilisation des donn√©es historiques pour', selectedYear);
                const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                months.forEach(m => {
                    caTotal += histTotal.months[m] || 0;
                });
                // Pour les donn√©es historiques, on ne peut pas compter les r√©servations individuelles
                totalReservations = '-';
                document.getElementById('statTotal').textContent = totalReservations;
                document.getElementById('statTrevoux').textContent = '-';
                document.getElementById('statCouzon').textContent = '-';
            } else {
                // Utiliser les r√©servations automatiques
                console.log('‚úì Utilisation des r√©servations automatiques pour', selectedYear);
                const filteredReservations = reservations.filter(r => {
                    const year = parseLocalDate(r.dateDebut).getFullYear();
                    return year === selectedYear;
                });
                
                const trevoux = filteredReservations.filter(r => isTrevoux(r.gite));
                const couzon = filteredReservations.filter(r => isCouzon(r.gite));
                
                const caTrevoux = trevoux.reduce((sum, r) => sum + r.montant, 0);
                const caCouzon = couzon.reduce((sum, r) => sum + r.montant, 0);
                caTotal = caTrevoux + caCouzon;
                
                totalReservations = trevoux.length + couzon.length;
                
                document.getElementById('statTotal').textContent = totalReservations;
                document.getElementById('statTrevoux').textContent = trevoux.length;
                document.getElementById('statCouzon').textContent = couzon.length;
                
                // Mettre √† jour les compteurs par plateforme et statistiques avanc√©es
                updatePlatformCounters(filteredReservations);
                updateAdvancedStats(filteredReservations);
            }
            
            document.getElementById('statCA').textContent = caTotal.toFixed(0) + ' ‚Ç¨';
            
            // G√©n√©rer les checkboxes de comparaison d'ann√©es
            generateYearComparisonCheckboxes(reservations, historicalData);
            
            // Mettre √† jour les graphiques avec les donn√©es filtr√©es
            const filteredReservations = reservations.filter(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                return year === selectedYear;
            });
            updateAllCharts(filteredReservations);
        }
        
        function generateYearComparisonCheckboxes(reservations, historicalData) {
            const container = document.getElementById('yearComparisonCheckboxes');
            if (!container) return; // Conteneur pas encore charg√©
            const allYears = new Set();
            const yearsWithReservations = new Set();
            const yearsWithTotal = new Set();
            
            // Ann√©es des r√©servations
            reservations.forEach(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                allYears.add(year);
                yearsWithReservations.add(year);
            });
            
            // Ann√©es historiques
            historicalData.forEach(d => {
                allYears.add(d.year);
                if (d.gite === 'Total') {
                    yearsWithTotal.add(d.year);
                }
            });
            
            const sortedYears = Array.from(allYears).sort((a, b) => b - a);
            const currentYear = new Date().getFullYear();
            
            let html = '';
            sortedYears.forEach(year => {
                const isCurrentYear = year === currentYear;
                // Badge "Auto" UNIQUEMENT pour l'ann√©e en cours ET qui a des r√©servations ET pas de Total manuel
                const isAuto = isCurrentYear && yearsWithReservations.has(year) && !yearsWithTotal.has(year);
                // Ne cocher automatiquement QUE l'ann√©e en cours
                const checked = isCurrentYear ? 'checked' : '';
                const badge = isAuto ? '<span style="background: #27AE60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 5px;">Auto ‚ö°</span>' : '';
                const bgColor = isAuto ? '#e8f5e9' : 'white';
                const borderColor = isAuto ? '#27AE60' : 'var(--border)';
                const textColor = isAuto ? '#27AE60' : 'var(--primary)';
                
                html += `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" value="${year}" ${checked} onchange="updateAllCharts()" 
                            style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: ${textColor};">${year}${badge}</span>
                    </label>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function updateAllCharts(filteredReservations = null) {
            const reservations = filteredReservations || await getAllReservations();
            const historicalData = await getAllHistoricalData();
            
            // Filtrer selon l'ann√©e s√©lectionn√©e dans le dropdown (si pas d√©j√† filtr√©)
            let reservationsForStats = reservations;
            if (!filteredReservations) {
                const selectedYear = parseInt(document.getElementById('yearFilterStats')?.value || new Date().getFullYear());
                reservationsForStats = reservations.filter(r => {
                    const year = parseLocalDate(r.dateDebut).getFullYear();
                    return year === selectedYear;
                });
            }
            
            // Mettre √† jour les compteurs et stats avanc√©es
            updatePlatformCounters(reservationsForStats);
            updateAdvancedStats(reservationsForStats);
            
            // R√©cup√©rer les ann√©es s√©lectionn√©es via les checkboxes
            const checkboxes = document.querySelectorAll('#yearComparisonCheckboxes input[type="checkbox"]:checked');
            const selectedYears = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort();
            
            if (selectedYears.length === 0) {
                // Pas d'ann√©es s√©lectionn√©es, afficher un message
                const ctx1 = document.getElementById('caChart').getContext('2d');
                if (caChartInstance) caChartInstance.destroy();
                return;
            }
            
            // Pr√©parer les couleurs pour chaque ann√©e
            const colors = [
                { border: '#667eea', bg: 'rgba(102, 126, 234, 0.1)' },
                { border: '#f093fb', bg: 'rgba(240, 147, 251, 0.1)' },
                { border: '#27AE60', bg: 'rgba(39, 174, 96, 0.1)' },
                { border: '#FF5A5F', bg: 'rgba(255, 90, 95, 0.1)' },
                { border: '#3498DB', bg: 'rgba(52, 152, 219, 0.1)' },
                { border: '#F39C12', bg: 'rgba(243, 156, 18, 0.1)' }
            ];
            
            // Pr√©parer les donn√©es par ann√©e
            const dataByYear = {};
            
            selectedYears.forEach(year => {
                dataByYear[year] = {
                    trevoux: Array(12).fill(0),
                    couzon: Array(12).fill(0),
                    total: Array(12).fill(0)
                };
                
                // V√©rifier si des donn√©es historiques existent pour cette ann√©e
                const histTotal = historicalData.find(d => d.year === year && d.gite === 'Total');
                
                if (histTotal) {
                    // Si donn√©es historiques existent, utiliser UNIQUEMENT celles-ci
                    console.log(`üìä Graphique ${year}: Utilisation des donn√©es historiques`);
                    const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    months.forEach((m, idx) => {
                        const value = histTotal.months[m] || 0;
                        dataByYear[year].total[idx] = value;
                    });
                } else {
                    // Sinon, utiliser les donn√©es des r√©servations
                    console.log(`üìä Graphique ${year}: Utilisation des r√©servations`);
                    reservations.filter(r => parseLocalDate(r.dateDebut).getFullYear() === year).forEach(r => {
                        const month = parseLocalDate(r.dateDebut).getMonth();
                        // Normaliser le nom du g√Æte (enlever accents et mettre en minuscule)
                        const giteNormalized = r.gite.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                        if (dataByYear[year][giteNormalized]) {
                            dataByYear[year][giteNormalized][month] += r.montant;
                            dataByYear[year].total[month] += r.montant;
                        }
                    });
                }
            });
            
            // Labels des mois
            const monthLabels = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
            
            // Cr√©er les datasets pour chaque ann√©e
            const datasets = [];
            selectedYears.forEach((year, idx) => {
                const color = colors[idx % colors.length];
                datasets.push({
                    label: `${year} - Total`,
                    data: dataByYear[year].total,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                });
            });
            
            // Graphique CA mensuel
            const ctx1 = document.getElementById('caChart').getContext('2d');
            if (caChartInstance) caChartInstance.destroy();
            
            caChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { 
                            display: true, 
                            text: 'Comparaison CA mensuel (‚Ç¨)', 
                            font: { size: 16, weight: 'bold' } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => value + ' ‚Ç¨' }
                        }
                    }
                }
            });
            
            // Graphique r√©partition par g√Æte (ann√©e s√©lectionn√©e)
            const ctx2 = document.getElementById('gitesChart').getContext('2d');
            if (gitesChartInstance) gitesChartInstance.destroy();
            
            const selectedYear = parseInt(document.getElementById('yearFilterStats')?.value || new Date().getFullYear());
            const currentReservations = reservationsForStats; // Utiliser les r√©servations d√©j√† filtr√©es
            const trevoux = currentReservations.filter(r => isTrevoux(r.gite));
            const couzon = currentReservations.filter(r => isCouzon(r.gite));
            
            gitesChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Tr√©voux', 'Couzon'],
                    datasets: [{
                        data: [trevoux.length, couzon.length],
                        backgroundColor: ['#667eea', '#f093fb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        title: { 
                            display: true, 
                            text: `R√©partition par g√Æte (${selectedYear})`, 
                            font: { size: 16, weight: 'bold' } 
                        }
                    }
                }
            });
            
            // Graphique plateformes (ann√©e courante uniquement)
            const ctx3 = document.getElementById('platformsChart').getContext('2d');
            if (platformsChartInstance) platformsChartInstance.destroy();
            
            const platforms = {};
            currentReservations.forEach(r => {
                platforms[r.site] = (platforms[r.site] || 0) + 1;
            });
            
            platformsChartInstance = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: Object.keys(platforms),
                    datasets: [{
                        label: 'R√©servations',
                        data: Object.values(platforms),
                        backgroundColor: ['#3498DB', '#FF5A5F', '#27AE60', '#E8A87C'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { 
                            display: true, 
                            text: `R√©partition par plateforme (${selectedYear})`, 
                            font: { size: 16, weight: 'bold' } 
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Graphique CA vs Charges vs B√©n√©fice (ann√©e s√©lectionn√©e)
            const ctx4 = document.getElementById('profitChart').getContext('2d');
            if (profitChartInstance) profitChartInstance.destroy();
            
            // Calculer CA mensuel pour l'ann√©e s√©lectionn√©e
            const caParMois = Array(12).fill(0);
            currentReservations.forEach(r => {
                const month = parseLocalDate(r.dateDebut).getMonth();
                caParMois[month] += r.montant;
            });
            
            // R√©cup√©rer les charges
            const charges = await getAllCharges();
            const chargesParMois = Array(12).fill(0);
            
            charges.forEach(c => {
                const chargeDate = new Date(c.date);
                if (chargeDate.getFullYear() === selectedYear) {
                    if (c.type === 'mensuelle') {
                        // Charge mensuelle : r√©partir sur tous les mois
                        for (let i = 0; i < 12; i++) {
                            chargesParMois[i] += c.montant;
                        }
                    } else if (c.type === 'annuelle') {
                        // Charge annuelle : r√©partir sur tous les mois
                        const montantMensuel = c.montant / 12;
                        for (let i = 0; i < 12; i++) {
                            chargesParMois[i] += montantMensuel;
                        }
                    } else {
                        // Charge ponctuelle : ajouter au mois concern√©
                        const month = chargeDate.getMonth();
                        chargesParMois[month] += c.montant;
                    }
                }
            });
            
            // Calculer le b√©n√©fice mensuel (CA - Charges)
            const beneficeParMois = caParMois.map((ca, idx) => ca - chargesParMois[idx]);
            
            profitChartInstance = new Chart(ctx4, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'Chiffre d\'affaires',
                            data: caParMois,
                            borderColor: '#27AE60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: 'Charges',
                            data: chargesParMois,
                            borderColor: '#E74C3C',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: 'B√©n√©fice',
                            data: beneficeParMois,
                            borderColor: '#3498DB',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { 
                            display: true, 
                            text: `CA vs Charges vs B√©n√©fice (${selectedYear})`, 
                            font: { size: 16, weight: 'bold' } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => value + ' ‚Ç¨' }
                        }
                    }
                }
            });
        }
        
        async function exportToExcel() {
            const reservations = await getAllReservations();
            if (reservations.length === 0) {
                showToast('‚ö†Ô∏è Aucune r√©servation', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const trevoux = reservations.filter(r => r.gite === 'Tr√©voux').map(r => ({
                'Noms': r.nom, 'Provenance': r.provenance, 'Date d√©but': r.dateDebut,
                'Date fin': r.dateFin, 'Nbr Nuits': r.nuits, 'Nbr Personnes': r.nbPersonnes,
                'Montant total': r.montant, 'Acompte': r.acompte, 'Montant restant': r.restant,
                'Paiement': r.paiement, 'Site': r.site
            }));
            const couzon = reservations.filter(r => r.gite === 'Couzon').map(r => ({
                'Noms': r.nom, 'Provenance': r.provenance, 'Date d√©but': r.dateDebut,
                'Date fin': r.dateFin, 'Nbr Nuits': r.nuits, 'Nbr Personnes': r.nbPersonnes,
                'Montant total': r.montant, 'Acompte': r.acompte, 'Montant restant': r.restant,
                'Paiement': r.paiement, 'Site': r.site
            }));
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(trevoux), 'Tr√©voux');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(couzon), 'Couzon');
            XLSX.writeFile(wb, `Reservations_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('‚úì Excel t√©l√©charg√© !');
        }
        
        async function sauvegarderTout() {
            try {
                await exportAllData();
                await exportToExcel();
                showToast('‚úì JSON + Excel sauvegard√©s !');
            } catch (error) {
                showToast('‚ùå Erreur lors de la sauvegarde');
                console.error(error);
            }
        }
        
        async function exportAllData() {
            const reservations = await getAllReservations();
            const backup = {
                version: '1.0',
                date: new Date().toISOString(),
                reservations: reservations
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Sauvegarde_Gites_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('‚úì Sauvegarde t√©l√©charg√©e !');
        }
        
        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('‚ö†Ô∏è L\'import va REMPLACER toutes vos donn√©es. Continuer ?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    const transaction = db.transaction(['reservations'], 'readwrite');
                    transaction.objectStore('reservations').clear();
                    
                    for (const r of backup.reservations) {
                        delete r.id;
                        await addReservation(r);
                    }
                    
                    await updateReservationsList();
                    await updateStats();
                    await updateArchivesDisplay();
                    showToast('‚úì Donn√©es import√©es !');
                    event.target.value = '';
                } catch (error) {
                    showToast('‚ùå Erreur import', 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }
        
        // Gestionnaire formulaire charges - sera appel√© apr√®s chargement de l'onglet
        window.initChargeForm = function() {
            const chargeForm = document.getElementById('chargeForm');
            if (!chargeForm || chargeForm._initialized) return;
            
            chargeForm._initialized = true;
            chargeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const charge = {
                    gite: document.getElementById('chargeGite').value,
                    nom: document.getElementById('chargeNom').value,
                    montant: parseFloat(document.getElementById('chargeMontant').value),
                    type: document.getElementById('chargeType').value,
                    date: document.getElementById('chargeDate').value || new Date().toISOString().split('T')[0],
                    notes: document.getElementById('chargeNotes').value,
                    timestamp: new Date().toISOString()
                };
                
                await addCharge(charge);
                this.reset();
                await updateChargesDisplay();
                await updateStats(); // Mettre √† jour le graphique CA vs Charges
                showToast('‚úì Charge ajout√©e');
            });
        };
        
        async function updateChargesDisplay() {
            const reservations = await getAllReservations();
            const charges = await getAllCharges();
            
            // Calcul recettes
            const totalRecettes = reservations.reduce((sum, r) => sum + r.montant, 0);
            
            // Calcul charges
            let totalCharges = 0;
            charges.forEach(c => {
                if (c.type === 'mensuelle') {
                    totalCharges += c.montant * 12;
                } else if (c.type === 'annuelle') {
                    totalCharges += c.montant;
                } else {
                    totalCharges += c.montant;
                }
            });
            
            // Calcul URSSAF (22% des recettes)
            const provisionUrssaf = totalRecettes * 0.22;
            
            // R√©sultat net
            const resultatNet = totalRecettes - totalCharges - provisionUrssaf;
            
            document.getElementById('totalRecettes').textContent = totalRecettes.toFixed(0) + ' ‚Ç¨';
            document.getElementById('totalCharges').textContent = totalCharges.toFixed(0) + ' ‚Ç¨';
            document.getElementById('provisionUrssaf').textContent = provisionUrssaf.toFixed(0) + ' ‚Ç¨';
            document.getElementById('resultatNet').textContent = resultatNet.toFixed(0) + ' ‚Ç¨';
            
            // Liste des charges
            const chargesList = document.getElementById('chargesList');
            if (charges.length === 0) {
                chargesList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucune charge enregistr√©e</p>';
                return;
            }
            
            let html = '';
            charges.forEach(c => {
                html += `
                    <div class="charge-item">
                        <div class="charge-info">
                            <div class="charge-name">${c.nom} - ${c.gite}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${c.type.charAt(0).toUpperCase() + c.type.slice(1)} | ${formatDate(c.date)}
                                ${c.notes ? '<br>' + c.notes : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="charge-amount">${c.montant.toFixed(2)} ‚Ç¨</div>
                            <button class="btn btn-danger btn-small" onclick="deleteChargeById(${c.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            chargesList.innerHTML = html;
        }
        
        async function deleteChargeById(id) {
            if (confirm('Supprimer cette charge ?')) {
                await deleteCharge(id);
                await updateChargesDisplay();
                await updateStats(); // Mettre √† jour le graphique CA vs Charges
                showToast('‚úì Charge supprim√©e');
            }
        }
        
        // ==========================================
        // üìä GESTION DONN√âES HISTORIQUES
        // ==========================================
        
        function toggleHistoricalDataForm() {
            const form = document.getElementById('historicalDataForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                displayHistoricalYearsList();
            } else {
                form.style.display = 'none';
            }
        }
        
        async function saveHistoricalData() {
            const year = parseInt(document.getElementById('historicalYear').value);
            const gite = document.getElementById('historicalGite').value;
            const currentYear = new Date().getFullYear();
            
            if (!year || year < 2000 || year >= currentYear) {
                showToast(`‚ö†Ô∏è Saisissez une ann√©e pr√©c√©dente (max: ${currentYear - 1})`, 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            const data = {
                year: year,
                gite: gite,
                months: {}
            };
            
            months.forEach(m => {
                const value = parseFloat(document.getElementById(`hist_${m}`).value) || 0;
                data.months[m] = value;
            });
            
            try {
                // Supprimer l'ancien si existe
                const existing = await getHistoricalData(year, gite);
                if (existing) {
                    await deleteHistoricalDataById(existing.id);
                }
                
                // Ajouter le nouveau avec Promise
                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(['historicalData'], 'readwrite');
                    const request = transaction.objectStore('historicalData').add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Erreur ajout');
                });
                
                showToast(`‚úì Donn√©es ${year} - ${gite} sauvegard√©es`);
                displayHistoricalYearsList();
                clearHistoricalForm();
                updateStats(); // Rafra√Æchir les graphiques
            } catch (error) {
                showToast('‚ùå Erreur sauvegarde', 'error');
                console.error(error);
            }
        }
        
        // ==========================================
        // üî• FONCTIONS HISTORICAL DATA - SUPABASE
        // ==========================================
        
        async function getHistoricalData(year, gite) {
            try {
                const { data, error } = await supabase
                    .from('historical_data')
                    .select('*')
                    .eq('year', year)
                    .eq('gite', gite)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                return data;
            } catch (error) {
                console.error('Erreur getHistoricalData:', error);
                return null;
            }
        }
        
        async function getAllHistoricalData() {
            try {
                const { data, error } = await supabase
                    .from('historical_data')
                    .select('*')
                    .order('year', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erreur getAllHistoricalData:', error);
                return [];
            }
        }
        
        async function deleteHistoricalDataById(id) {
            try {
                const { error } = await supabase
                    .from('historical_data')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
            } catch (error) {
                console.error('Erreur deleteHistoricalDataById:', error);
                throw error;
            }
        }
        
        async function saveHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year || year < 2000 || year > 2030) {
                showToast('‚ö†Ô∏è Ann√©e invalide (entre 2000 et 2030)', 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            
            const monthsData = {};
            months.forEach(m => {
                const value = parseFloat(document.getElementById(`hist_total_${m}`).value) || 0;
                monthsData[m] = value;
            });
            
            try {
                const existing = await getHistoricalData(year, 'Total');
                
                if (existing) {
                    const { error } = await supabase
                        .from('historical_data')
                        .update({ months: monthsData })
                        .eq('id', existing.id);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('historical_data')
                        .insert({ year: year, gite: 'Total', months: monthsData });
                    
                    if (error) throw error;
                }
                
                showToast(`‚úì Donn√©es ${year} sauvegard√©es`);
                displayHistoricalYearsList();
                clearHistoricalFormTotal();
                updateStats();
            } catch (error) {
                console.error('Erreur saveHistoricalDataTotal:', error);
                showToast('‚ùå Erreur sauvegarde: ' + error.message, 'error');
            }
        }
        
        async function loadHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year) {
                showToast('‚ö†Ô∏è S√©lectionnez une ann√©e', 'error');
                return;
            }
            
            const dataTotal = await getHistoricalData(year, 'Total');
            
            if (!dataTotal) {
                showToast(`‚ÑπÔ∏è Aucune donn√©e pour ${year}`, 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            months.forEach(m => {
                document.getElementById(`hist_total_${m}`).value = dataTotal.months[m] || 0;
            });
            
            showToast(`‚úì Donn√©es ${year} charg√©es`);
        }
        
        async function deleteHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year) {
                showToast('‚ö†Ô∏è S√©lectionnez une ann√©e', 'error');
                return;
            }
            
            if (!confirm(`Supprimer toutes les donn√©es ${year} ?`)) {
                return;
            }
            
            const dataTotal = await getHistoricalData(year, 'Total');
            
            if (dataTotal) {
                await deleteHistoricalDataById(dataTotal.id);
            }
            
            showToast(`‚úì Donn√©es ${year} supprim√©es`);
            clearHistoricalFormTotal();
            displayHistoricalYearsList();
            updateStats();
        }
        
        function clearHistoricalFormTotal() {
            document.getElementById('historicalYear').value = '';
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            months.forEach(m => {
                document.getElementById(`hist_total_${m}`).value = '';
            });
        }
        
        // Fonctions anciennes - d√©sactiv√©es
        async function loadHistoricalData() {
            showToast('‚ö†Ô∏è Utilisez le formulaire Total', 'error');
        }
        
        async function deleteHistoricalData() {
            showToast('‚ö†Ô∏è Utilisez le formulaire Total', 'error');
        }
        
        function clearHistoricalForm() {
            clearHistoricalFormTotal();
        }
        
        async function displayHistoricalYearsList() {
            const data = await getAllHistoricalData();
            const container = document.getElementById('historicalYearsList');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic;">Aucune donn√©e historique enregistr√©e</p>';
                return;
            }
            
            // Grouper par ann√©e
            const byYear = {};
            data.forEach(d => {
                if (!byYear[d.year]) byYear[d.year] = {};
                byYear[d.year][d.gite] = d;
            });
            
            let html = '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
            Object.keys(byYear).sort().reverse().forEach(year => {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid var(--border); min-width: 200px;">
                        <div style="font-weight: 700; color: var(--primary); margin-bottom: 10px; font-size: 1.1rem;">üìÖ ${year}</div>
                `;
                
                if (byYear[year]['Total']) {
                    const total = Object.values(byYear[year]['Total'].months).reduce((a, b) => a + b, 0);
                    html += `
                        <div style="margin-bottom: 5px;">
                            <span style="font-weight: 600;">Total:</span> ${total.toFixed(2)} ‚Ç¨
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // FIN GESTION DONN√âES HISTORIQUES
        // ==========================================
        
        // ==========================================
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SECTION PLANNING M√âNAGE - VERROUILL√âE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // ‚õî NE PAS MODIFIER SANS APPROBATION EXPLICITE DU CLIENT ‚õî
        // Cette section contient la logique m√©tier critique des r√®gles de m√©nage
        // Toute modification peut impacter la coh√©rence des dates dans :
        // - L'affichage des r√©servations
        // - Le planning m√©nage
        // - L'export Excel
        // ==========================================
        
        // G√©n√©ration planning m√©nage
        async function genererPlanningMenage() {
            const reservations = await getAllReservations();
            
            // Fonction pour v√©rifier si c'est un jour f√©ri√©
            function isJourFerie(date) {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                // Jours f√©ri√©s fixes
                const feriesFixes = [
                    `${year}-01-01`, // Nouvel An
                    `${year}-05-01`, // F√™te du travail
                    `${year}-05-08`, // Victoire 1945
                    `${year}-07-14`, // F√™te nationale
                    `${year}-08-15`, // Assomption
                    `${year}-11-01`, // Toussaint
                    `${year}-11-11`, // Armistice 1918
                    `${year}-12-25`, // No√´l
                ];
                
                const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (feriesFixes.includes(dateKey)) return true;
                
                // P√¢ques et jours mobiles (formule de Meeus/Jones/Butcher)
                const a = year % 19;
                const b = Math.floor(year / 100);
                const c = year % 100;
                const d = Math.floor(b / 4);
                const e = b % 4;
                const f = Math.floor((b + 8) / 25);
                const g = Math.floor((b - f + 1) / 3);
                const h = (19 * a + b - d - g + 15) % 30;
                const i = Math.floor(c / 4);
                const k = c % 4;
                const l = (32 + 2 * e + 2 * i - h - k) % 7;
                const m = Math.floor((a + 11 * h + 22 * l) / 451);
                const paquesMois = Math.floor((h + l - 7 * m + 114) / 31);
                const paquesJour = ((h + l - 7 * m + 114) % 31) + 1;
                
                const paques = new Date(year, paquesMois - 1, paquesJour);
                const lundiPaques = new Date(paques);
                lundiPaques.setDate(lundiPaques.getDate() + 1);
                const ascension = new Date(paques);
                ascension.setDate(ascension.getDate() + 39);
                const lundiPentecote = new Date(paques);
                lundiPentecote.setDate(lundiPentecote.getDate() + 50);
                
                const dateStr = date.toDateString();
                if (dateStr === lundiPaques.toDateString()) return true;
                if (dateStr === ascension.toDateString()) return true;
                if (dateStr === lundiPentecote.toDateString()) return true;
                
                return false;
            }
            
            // Filtrer mois en cours + prochain
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
            const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;
            
            const relevant = reservations.filter(r => {
                const date = parseLocalDate(r.dateFin);
                const month = date.getMonth();
                const year = date.getFullYear();
                return (year === currentYear && month === currentMonth) || 
                       (year === nextYear && month === nextMonth);
            });
            
            relevant.sort((a, b) => parseLocalDate(a.dateFin) - parseLocalDate(b.dateFin));
            
            const planning = [];
            const menagesPrevus = {}; // Pour suivre les m√©nages d√©j√† pr√©vus par g√Æte/date
            
            relevant.forEach(r => {
                const departDate = parseLocalDate(r.dateFin);
                
                // Utiliser la fonction calculerDateMenage pour garantir la coh√©rence
                const dateMenageFormatted = calculerDateMenage(r, relevant);
                
                // Parser le r√©sultat pour extraire la date et l'heure
                // Format: "Lundi 23 d√©c. √† 12h00"
                const match = dateMenageFormatted.match(/(\w+) (\d+) (\w+)\. √† (\d+h\d+)/);
                if (!match) return;
                
                const [_, jourNom, jour, mois, heure] = match;
                
                // Reconstruire la date du m√©nage
                const moisMap = {
                    'janv': 0, 'f√©vr': 1, 'mars': 2, 'avr': 3, 'mai': 4, 'juin': 5,
                    'juil': 6, 'ao√ªt': 7, 'sept': 8, 'oct': 9, 'nov': 10, 'd√©c': 11
                };
                
                const menageDate = new Date(departDate);
                menageDate.setMonth(moisMap[mois]);
                menageDate.setDate(parseInt(jour));
                
                // Si le mois du m√©nage est < mois du d√©part, c'est l'ann√©e suivante
                if (menageDate < departDate) {
                    menageDate.setFullYear(menageDate.getFullYear() + 1);
                }
                
                // V√©rifier enchainement
                const arriveeMemejour = relevant.find(resa => 
                    resa.gite === r.gite && 
                    resa.id !== r.id &&
                    parseLocalDate(resa.dateDebut).toDateString() === departDate.toDateString()
                );
                
                planning.push({
                    date: menageDate,
                    heure: heure,
                    gite: r.gite,
                    clientName: r.nom,
                    departDate: departDate,
                    enchainement: arriveeMemejour ? true : false
                });
            });
            
            if (planning.length === 0) {
                showToast('Aucun m√©nage √† planifier', 'error');
                return;
            }
            
            // Afficher
            const menageDiv = document.getElementById('menagePlanning');
            let html = '<div class="card" style="margin-top: 20px;"><h3 style="margin-bottom: 20px;">Planning g√©n√©r√© (mois en cours + prochain)</h3>';
            
            planning.forEach(p => {
                const enchainementBadge = p.enchainement ? ' <span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem;">‚ö° Enchainement</span>' : '';
                html += `
                    <div class="menage-item">
                        <div class="menage-date">
                            üìÖ ${p.date.toLocaleDateString('fr-FR')} - ${['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'][p.date.getDay()]}
                            √† ${p.heure}${enchainementBadge}
                        </div>
                        <div class="menage-detail">
                            üèòÔ∏è <strong>${p.gite}</strong> - Client: ${p.clientName} (d√©part le ${p.departDate.toLocaleDateString('fr-FR')})
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="telechargerPlanningMenage()" style="max-width: 400px;">
                        <span>üì•</span> T√©l√©charger le planning Excel
                    </button>
                </div>
            </div>`;
            menageDiv.innerHTML = html;
            
            // Pr√©parer les donn√©es Excel mais ne pas t√©l√©charger automatiquement
            window.planningMenageData = planning.map(p => ({
                'üìÖ Date': p.date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }),
                '‚è∞ Heure': p.heure,
                'üè† G√Æte': p.gite,
                'üë§ Client': p.clientName,
                'üö™ D√©part': p.departDate.toLocaleDateString('fr-FR', { weekday: 'short', day: '2-digit', month: 'short' }),
                '‚ö° Enchainement': p.enchainement ? 'OUI' : 'Non'
            }));
            
            showToast(`‚úì Planning g√©n√©r√© ! ${planning.length} m√©nages planifi√©s`);
            
            // Afficher le planning par semaine avec colonnes
            await afficherPlanningParSemaine();
        }
        
        // Fonction pour calculer le num√©ro de semaine ISO (S1 = premi√®re semaine de l'ann√©e)
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        // Nouvelle fonction pour afficher le planning par semaine avec colonnes Tr√©voux/Couzon
        async function afficherPlanningParSemaine() {
            const reservations = await getAllReservations();
            
            // R√©cup√©rer les validations de la soci√©t√© de m√©nage
            const { data: cleaningSchedules } = await supabase
                .from('cleaning_schedule')
                .select('*');
            
            const validationMap = {};
            let pendingModifications = 0;
            if (cleaningSchedules) {
                cleaningSchedules.forEach(cs => {
                    validationMap[cs.reservation_id] = cs;
                    if (cs.status === 'proposed') {
                        pendingModifications++;
                    }
                });
            }
            
            // Afficher le badge de notification si modifications en attente
            const notifBadge = document.getElementById('cleaning-notif-badge');
            if (notifBadge) {
                if (pendingModifications > 0) {
                    notifBadge.textContent = pendingModifications;
                    notifBadge.style.display = 'inline-block';
                } else {
                    notifBadge.style.display = 'none';
                }
            }
            
            // Filtrer √† partir de la date actuelle
            const now = new Date();
            now.setHours(0, 0, 0, 0); // D√©but de journ√©e
            const twoMonthsLater = new Date(now);
            twoMonthsLater.setMonth(now.getMonth() + 12);
            
            const relevant = reservations.filter(r => {
                const dateFin = parseLocalDate(r.dateFin);
                return dateFin >= now && dateFin <= twoMonthsLater;
            });
            
            // Organiser par semaine
            const weeks = {};
            const weekStarts = new Set();
            
            relevant.forEach(r => {
                const dateFin = parseLocalDate(r.dateFin);
                // Date m√©nage = g√©n√©ralement le jour du d√©part ou lendemain si dimanche
                let dateMenage = new Date(dateFin);
                if (dateFin.getDay() === 0) { // Dimanche
                    dateMenage.setDate(dateMenage.getDate() + 1);
                }
                
                // Trouver le lundi de cette semaine
                const dayOfWeek = dateMenage.getDay();
                const monday = new Date(dateMenage);
                monday.setDate(dateMenage.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                monday.setHours(0, 0, 0, 0);
                
                const weekKey = monday.toISOString().split('T')[0];
                weekStarts.add(weekKey);
                
                if (!weeks[weekKey]) {
                    weeks[weekKey] = {
                        monday: monday,
                        trevoux: [],
                        couzon: []
                    };
                }
                
                const validation = validationMap[r.id];
                const menageInfo = {
                    reservation: r,
                    dateMenage: dateMenage,
                    validated: validation ? validation.validated_by_company : false,
                    proposedDate: validation ? validation.proposed_date : null,
                    status: validation ? validation.status : 'pending',
                    timeOfDay: validation ? validation.time_of_day : 'afternoon',
                    reservationEndBefore: dateFin,
                    reservationStartAfter: null // √Ä calculer
                };
                
                // Chercher la r√©servation suivante pour ce g√Æte
                const nextReservation = reservations
                    .filter(next => next.gite === r.gite && parseLocalDate(next.dateDebut) > dateFin)
                    .sort((a, b) => parseLocalDate(a.dateDebut) - parseLocalDate(b.dateDebut))[0];
                
                if (nextReservation) {
                    menageInfo.reservationStartAfter = parseLocalDate(nextReservation.dateDebut);
                }
                
                // Ajouter dans la bonne colonne
                if (r.gite.toLowerCase().includes('tr√©voux') || r.gite.toLowerCase().includes('trevoux')) {
                    weeks[weekKey].trevoux.push(menageInfo);
                } else {
                    weeks[weekKey].couzon.push(menageInfo);
                }
            });
            
            // Trier les semaines
            const sortedWeeks = Array.from(weekStarts).sort();
            
            // G√©n√©rer le HTML
            let html = '<div style="margin-top: 20px;">';
            
            sortedWeeks.forEach((weekKey, index) => {
                const week = weeks[weekKey];
                const monday = week.monday;
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                
                // Calculer le vrai num√©ro de semaine de l'ann√©e
                const weekNumber = `S${getWeekNumber(monday)}`;
                const weekDisplay = `${monday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })} - ${sunday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}`;
                
                html += `
                    <div class="cleaning-week-table">
                        <div class="cleaning-week-header">
                            <div class="week-number-big">${weekNumber}</div>
                            <div class="week-dates-small">${weekDisplay}</div>
                        </div>
                        <div class="cleaning-week-body">
                            <div class="cleaning-column">
                                <div class="cleaning-column-header">üè° Tr√©voux</div>
                                ${week.trevoux.length > 0 ? 
                                    week.trevoux.map(m => generateCleaningItemHTML(m)).join('') :
                                    '<div class="cleaning-item empty">Aucun m√©nage pr√©vu</div>'
                                }
                            </div>
                            <div class="cleaning-column">
                                <div class="cleaning-column-header couzon">‚õ∞Ô∏è Couzon</div>
                                ${week.couzon.length > 0 ? 
                                    week.couzon.map(m => generateCleaningItemHTML(m)).join('') :
                                    '<div class="cleaning-item empty">Aucun m√©nage pr√©vu</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('menagePlanning').innerHTML = html;
        }
        
        function generateCleaningItemHTML(menageInfo) {
            const { reservation, dateMenage, validated, proposedDate, reservationEndBefore, reservationStartAfter, status, timeOfDay } = menageInfo;
            const displayDate = proposedDate ? new Date(proposedDate) : dateMenage;
            
            // Ic√¥ne et badge de statut - 3 √©tats uniquement :
            // Rouge = √† valider, Orange = en attente, Vert = valid√©
            let statusIcon = '';
            if (validated) {
                // VERT = Valid√©
                statusIcon = '<span class="validation-status validated" title="Valid√© par soci√©t√©">‚úì</span>';
            } else if (status === 'proposed') {
                // ORANGE = En attente de validation
                statusIcon = '<span class="validation-status pending" title="En attente validation">‚è≥</span>';
            } else {
                // ROUGE = √Ä valider
                statusIcon = '<span class="validation-status notvalidated" title="√Ä valider">‚úó</span>';
            }
            
            const dateStr = displayDate.toLocaleDateString('fr-FR', { 
                weekday: 'short', 
                day: '2-digit', 
                month: 'short' 
            });
            
            // R√©cup√©rer le moment sauvegard√©
            const savedTime = timeOfDay || localStorage.getItem(`cleaning_time_${reservation.id}`) || 'afternoon';
            
            // Afficher une alerte si modification propos√©e par la soci√©t√©
            const proposalAlert = status === 'proposed' ? `
                <div style="background: #fff3cd; border-left: 4px solid #ff9800; padding: 10px; margin: 10px 0; border-radius: 6px;">
                    <strong>‚ö†Ô∏è Modification propos√©e par la soci√©t√© de m√©nage</strong><br>
                    Nouvelle date: ${displayDate.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' })} - ${savedTime === 'morning' ? 'üåÖ Matin' : '‚òÄÔ∏è Apr√®s-midi'}
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn-small" onclick="approveModification(${reservation.id})" style="flex: 1; background: #27ae60;">
                            ‚úì Approuver
                        </button>
                        <button class="btn-small" onclick="rejectModification(${reservation.id})" style="flex: 1; background: #e74c3c;">
                            ‚úó Refuser
                        </button>
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="cleaning-item ${status === 'proposed' ? 'pending-approval' : ''}" style="${status === 'proposed' ? 'border: 2px solid #ff9800;' : ''}">
                    <div class="cleaning-date-row">
                        <span class="cleaning-date">üìÖ ${dateStr}</span>
                        ${statusIcon}
                    </div>
                    <div class="cleaning-details">
                        üö™ D√©part: ${reservationEndBefore.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}
                        ${reservationStartAfter ? `<br>üîë Arriv√©e suivante: ${reservationStartAfter.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}` : ''}
                    </div>
                    ${proposalAlert}
                    <div style="margin-top: 10px; display: flex; gap: 8px; align-items: center;">
                        <input type="date" id="date-${reservation.id}" value="${displayDate.toISOString().split('T')[0]}" style="flex: 1; padding: 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.9rem;">
                        <select id="time-${reservation.id}" style="padding: 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.9rem;">
                            <option value="morning" ${savedTime === 'morning' ? 'selected' : ''}>üåÖ Matin</option>
                            <option value="afternoon" ${savedTime === 'afternoon' ? 'selected' : ''}>‚òÄÔ∏è Apr√®s-midi</option>
                        </select>
                    </div>
                    <div class="cleaning-actions">
                        <button class="btn-small" onclick="modifierDateMenage(${reservation.id})" style="width: 100%;">
                            ‚úèÔ∏è Enregistrer
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function modifierDateMenage(reservationId) {
            const newDate = document.getElementById(`date-${reservationId}`).value;
            const timeOfDay = document.getElementById(`time-${reservationId}`).value;
            
            if (!newDate) {
                showToast('Veuillez s√©lectionner une date', 'error');
                return;
            }
            
            const reservation = (await getAllReservations()).find(r => r.id === reservationId);
            if (!reservation) {
                showToast('R√©servation non trouv√©e', 'error');
                return;
            }
            
            // Sauvegarder le moment dans localStorage
            localStorage.setItem(`cleaning_time_${reservationId}`, timeOfDay);
            
            // Sauvegarder dans cleaning_schedule avec le moment
            const { error } = await supabase
                .from('cleaning_schedule')
                .upsert({
                    reservation_id: reservationId,
                    gite: reservation.gite,
                    scheduled_date: newDate,
                    time_of_day: timeOfDay,
                    status: 'modified',
                    validated_by_company: false,
                    reservation_end: reservation.dateFin,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'reservation_id' });
            
            if (error) {
                showToast('Erreur: ' + error.message, 'error');
            } else {
                showToast('Date et horaire de m√©nage enregistr√©s avec succ√®s');
                afficherPlanningParSemaine();
            }
        }
        
        async function approveModification(reservationId) {
            const { error } = await supabase
                .from('cleaning_schedule')
                .update({
                    status: 'validated',
                    validated_by_company: true,
                    updated_at: new Date().toISOString()
                })
                .eq('reservation_id', reservationId);
            
            if (error) {
                showToast('Erreur lors de l\'approbation: ' + error.message, 'error');
            } else {
                showToast('‚úì Modification approuv√©e');
                afficherPlanningParSemaine();
            }
        }
        
        async function rejectModification(reservationId) {
            // Remettre la date d'origine (jour du d√©part) et supprimer la proposition
            const reservation = (await getAllReservations()).find(r => r.id === reservationId);
            if (!reservation) return;
            
            const { error } = await supabase
                .from('cleaning_schedule')
                .update({
                    scheduled_date: reservation.dateFin,
                    proposed_date: null,
                    status: 'pending',
                    validated_by_company: false,
                    updated_at: new Date().toISOString()
                })
                .eq('reservation_id', reservationId);
            
            if (error) {
                showToast('Erreur lors du refus: ' + error.message, 'error');
            } else {
                showToast('‚úó Modification refus√©e - Date d\'origine restaur√©e');
                afficherPlanningParSemaine();
            }
        }

        function telechargerPlanningMenage() {
            if (!window.planningMenageData || window.planningMenageData.length === 0) {
                showToast('Aucun planning √† t√©l√©charger. G√©n√©rez d\'abord le planning.', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(window.planningMenageData);
            
            // D√©finir les largeurs de colonnes
            ws['!cols'] = [
                { wch: 35 }, // Date compl√®te
                { wch: 10 }, // Heure
                { wch: 12 }, // G√Æte
                { wch: 20 }, // Client
                { wch: 15 }, // D√©part
                { wch: 15 }  // Enchainement
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Planning M√©nages');
            const dateToday = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `MenageCalvignac_${dateToday}.xlsx`);
            
            showToast('‚úì Planning Excel t√©l√©charg√©');
        }
        
        // ==========================================
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FIN SECTION PLANNING M√âNAGE - VERROUILL√âE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // ==========================================
        
        async function exportPlanningMenageMois() {
            const monthInput = document.getElementById('menageExportMonth').value;
            if (!monthInput) {
                showToast('S√©lectionnez un mois √† exporter', 'error');
                return;
            }

            const [yearStr, monthStr] = monthInput.split('-');
            const targetYear = parseInt(yearStr, 10);
            const targetMonth = parseInt(monthStr, 10) - 1;

            const reservations = await getAllReservations();
            if (!reservations || reservations.length === 0) {
                showToast('Aucune r√©servation enregistr√©e', 'error');
                return;
            }

            // On calcule un planning global puis on filtre sur le mois demand√©
            const relevant = [...reservations].sort((a, b) => parseLocalDate(a.dateFin) - parseLocalDate(b.dateFin));

            const planning = [];
            const occupiedSlots = {};

            relevant.forEach(r => {
                const departDate = parseLocalDate(r.dateFin);
                if (isNaN(departDate)) return;

                const departDay = departDate.getDay();

                const arriveeMemejour = relevant.find(resa =>
                    resa.gite === r.gite &&
                    parseLocalDate(resa.dateDebut).toDateString() === departDate.toDateString()
                );

                let menageDate = new Date(departDate);
                let heure = '12h00';

                // R√àGLE 1: D√©part dimanche
                if (departDay === 0) {
                    if (!arriveeMemejour) {
                        menageDate.setDate(menageDate.getDate() + 1);
                        const arriveeLundi = relevant.find(resa =>
                            resa.gite === r.gite &&
                            parseLocalDate(resa.dateDebut).toDateString() === menageDate.toDateString()
                        );
                        heure = arriveeLundi ? '07h00' : '12h00';
                    } else {
                        heure = '12h00';
                    }
                }
                // R√àGLE 2: Samedi
                else if (departDay === 6) {
                    if (arriveeMemejour) {
                        heure = '12h00';
                    } else {
                        menageDate.setDate(menageDate.getDate() + 2);
                        heure = '12h00';
                    }
                }
                // R√àGLE 3: Lundi-Vendredi
                else {
                    heure = '12h00';
                }

                const dateKey = menageDate.toISOString().split('T')[0];
                const period = heure === '07h00' ? 'matin' : 'apr√®s-midi';

                if (!occupiedSlots[dateKey]) {
                    occupiedSlots[dateKey] = { matin: null, 'apr√®s-midi': null };
                }

                if (!occupiedSlots[dateKey][period]) {
                    occupiedSlots[dateKey][period] = r.gite;
                    planning.push({
                        date: menageDate,
                        heure: heure,
                        period: period,
                        gite: r.gite,
                        clientName: r.nom,
                        departDate: departDate
                    });
                } else {
                    const autreCreneau = period === 'matin' ? 'apr√®s-midi' : 'matin';
                    const autreHeure = period === 'matin' ? '12h00' : '07h00';

                    if (!occupiedSlots[dateKey][autreCreneau]) {
                        occupiedSlots[dateKey][autreCreneau] = r.gite;
                        planning.push({
                            date: menageDate,
                            heure: autreHeure,
                            period: autreCreneau,
                            gite: r.gite,
                            clientName: r.nom,
                            departDate: departDate
                        });
                    }
                }
            });

            const planningForMonth = planning.filter(p =>
                p.date.getFullYear() === targetYear && p.date.getMonth() === targetMonth
            );

            if (planningForMonth.length === 0) {
                showToast('Aucun m√©nage √† planifier pour ce mois', 'error');
                return;
            }

            // Cr√©er le workbook avec style
            const wb = XLSX.utils.book_new();
            
            // Pr√©parer les donn√©es avec formatage
            const data = planningForMonth.map(p => ({
                'üìÖ Date': p.date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }),
                '‚è∞ Heure': p.heure,
                'üè† G√Æte': p.gite,
                'üë§ Client': p.clientName,
                'üö™ D√©part': p.departDate.toLocaleDateString('fr-FR'),
                '‚ö° Enchainement': p.period === 'matin' ? 'Oui' : 'Non'
            }));

            // Cr√©er la feuille
            const ws = XLSX.utils.json_to_sheet(data);
            
            // D√©finir les largeurs de colonnes
            ws['!cols'] = [
                { wch: 35 }, // Date
                { wch: 10 }, // Heure
                { wch: 12 }, // G√Æte
                { wch: 20 }, // Client
                { wch: 12 }, // D√©part
                { wch: 15 }  // Enchainement
            ];
            
            const sheetName = `M√©nages ${monthInput}`;
            XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31));
            const dateToday = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `MenageCalvignac_${dateToday}.xlsx`);

            showToast(`‚úì Export Excel t√©l√©charg√© ! (${planningForMonth.length} m√©nages)`);
        }

        
        
        // ========== GESTION INFOS G√éTES - VOIR SECTION INFOS PRATIQUES ==========
        
        // Fonction de compatibilit√© pour charger les infos du nouveau syst√®me
        function loadInfosGites(gite) {
            const allData = JSON.parse(localStorage.getItem('gites_infos_pratiques_complet') || '{}');
            const data = allData[gite] || {};
            
            // Transformer au format attendu par l'ancien syst√®me (compatibilit√©)
            return {
                wifi: data.wifiPassword || '',
                codeCle: data.codeAcces || '',
                adresse: data.adresse || '',
                instructionsArrivee: data.instructionsCles || '',
                instructionsDepart: data.checklistDepart || '',
                infosComplementaires: ''
            };
        }
        
        // G√©n√©rer page client HTML
        async function genererPageClient(reservationId) {
            const reservations = await getAllReservations();
            const reservation = reservations.find(r => r.id === reservationId);
            
            if (!reservation) {
                showToast('R√©servation introuvable', 'error');
                return;
            }
            
            // V√©rifier si le t√©l√©phone est renseign√©
            if (!reservation.telephone || reservation.telephone.trim() === '') {
                if (confirm('‚ö†Ô∏è Aucun num√©ro de t√©l√©phone renseign√©.\n\nVoulez-vous ajouter un t√©l√©phone maintenant ?')) {
                    openEditModal(reservationId);
                }
                return;
            }
            
            // Cr√©er un modal de choix personnalis√©
            const choixModal = document.createElement('div');
            choixModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            choixModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 20px; max-width: 550px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <h2 style="margin-bottom: 20px; color: #667eea;">üì± Envoyer les infos au client</h2>
                    <p style="margin-bottom: 10px; font-size: 1.1rem;"><strong>${reservation.nom}</strong></p>
                    <p style="margin-bottom: 25px; color: #666;">üì± ${reservation.telephone}</p>
                    
                    <div style="background: #E8F5E9; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; font-size: 0.9rem;">
                        <strong style="color: #25D366;">üí° Conseil WhatsApp Business :</strong><br>
                        <span style="color: #555;">
                        ‚Ä¢ Installez "WhatsApp Business" (app s√©par√©e)<br>
                        ‚Ä¢ Utilisez votre num√©ro professionnel<br>
                        ‚Ä¢ Gardez votre WhatsApp perso s√©par√©
                        </span>
                    </div>
                    
                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <button onclick="aper√ßuFicheClient(${reservationId})" style="padding: 15px; border: none; border-radius: 12px; background: linear-gradient(135deg, #FF6B6B 0%, #EE5A52 100%); color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(255,107,107,0.3);">
                            <span style="font-size: 1.5rem;">üìã</span> <span>Aper√ßu Fiche Client</span>
                        </button>
                        
                        <button onclick="envoyerViaWhatsApp(${reservationId})" style="padding: 15px; border: none; border-radius: 12px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(37,211,102,0.3);">
                            <span style="font-size: 1.5rem;">üíº</span> <span>WhatsApp Business</span>
                        </button>
                        
                        <button onclick="envoyerViaSMS(${reservationId})" style="padding: 15px; border: none; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(102,126,234,0.3);">
                            <span style="font-size: 1.5rem;">üí¨</span> <span>SMS</span>
                        </button>
                        
                        <button onclick="telechargerSeulementHTML(${reservationId})" style="padding: 12px; border: none; border-radius: 10px; background: #f0f0f0; color: #666; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="font-size: 1.3rem;">üìÑ</span> <span>T√©l√©charger HTML seulement</span>
                        </button>
                    </div>
                    
                    <button onclick="this.closest('div').parentElement.remove()" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; background: white; color: #666; cursor: pointer; font-size: 0.95rem;">
                        Annuler
                    </button>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #FFF3E0; border-radius: 10px; text-align: left; font-size: 0.85rem;">
                        <strong style="color: #F57C00;">‚ö†Ô∏è Premi√®re utilisation :</strong><br>
                        <span style="color: #666;">
                        1. T√©l√©chargez "WhatsApp Business" depuis Play Store/App Store<br>
                        2. Configurez avec votre num√©ro professionnel des g√Ætes<br>
                        3. Cr√©ez un profil avec nom "G√Ætes Calvignac" + adresse<br>
                        4. Cliquez sur "WhatsApp Business" ci-dessus
                        </span>
                    </div>
                </div>
            `;
            document.body.appendChild(choixModal);
        }
        
        async function envoyerViaWhatsApp(reservationId) {
            // Fermer le modal
            document.querySelectorAll('div[style*="z-index: 10000"]').forEach(el => el.remove());
            
            const reservations = await getAllReservations();
            const reservation = reservations.find(r => r.id === reservationId);
            const infosGite = loadInfosGites(reservation.gite);
            
            // Nettoyer le num√©ro de t√©l√©phone pour WhatsApp
            let telephone = reservation.telephone.replace(/\s/g, '').replace(/\+/g, '');
            
            // Si commence par 0, remplacer par 33
            if (telephone.startsWith('0')) {
                telephone = '33' + telephone.substring(1);
            } else if (!telephone.startsWith('33')) {
                telephone = '33' + telephone;
            }
            
            // Construire le message
            let message = `Bonjour ${reservation.nom},\n\n`;
            message += `Bienvenue au G√Æte de ${reservation.gite} ! üè°\n\n`;
            message += `üìÖ *Votre s√©jour*\n`;
            message += `Arriv√©e: ${formatDate(reservation.dateDebut)}\n`;
            message += `D√©part: ${formatDate(reservation.dateFin)}\n`;
            message += `Dur√©e: ${reservation.nuits} nuit${reservation.nuits > 1 ? 's' : ''}\n\n`;
            
            if (infosGite.adresse) {
                message += `üìç *Adresse*\n${infosGite.adresse}\n\n`;
            }
            
            message += `üîë *Acc√®s au g√Æte*\n`;
            if (infosGite.codeCle) {
                message += `Code bo√Æte √† cl√©s: *${infosGite.codeCle}*\n`;
            }
            if (infosGite.wifi) {
                message += `WiFi: *${infosGite.wifi}*\n`;
            }
            
            message += `\nNous vous souhaitons un excellent s√©jour ! üåü`;
            
            // Ouvrir WhatsApp
            const whatsappLink = `https://wa.me/${telephone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappLink, '_blank');
            
            // Marquer comme envoy√©
            await updateReservation(reservationId, { messageEnvoye: true });
            await updateReservationsList();
            
            // Aussi t√©l√©charger la page HTML
            setTimeout(() => {
                telechargerPageHTML(reservation);
            }, 1000);
            
            showToast(`‚úì WhatsApp ouvert pour ${reservation.nom}`);
        }
        
        async function envoyerViaSMS(reservationId) {
            // Fermer le modal
            document.querySelectorAll('div[style*="z-index: 10000"]').forEach(el => el.remove());
            
            const reservations = await getAllReservations();
            const reservation = reservations.find(r => r.id === reservationId);
            const infosGite = loadInfosGites(reservation.gite);
            
            // Nettoyer le num√©ro de t√©l√©phone
            let telephone = reservation.telephone.replace(/\s/g, '');
            
            // Si le num√©ro ne commence pas par +, ajouter +33
            if (!telephone.startsWith('+')) {
                if (telephone.startsWith('0')) {
                    telephone = '+33' + telephone.substring(1);
                } else if (!telephone.startsWith('33')) {
                    telephone = '+33' + telephone;
                }
            }
            
            // Construire le message SMS
            let message = `Bonjour ${reservation.nom},\n\n`;
            message += `Bienvenue au G√Æte de ${reservation.gite} !\n\n`;
            message += `üìÖ S√©jour du ${formatDate(reservation.dateDebut)} au ${formatDate(reservation.dateFin)}\n\n`;
            
            if (infosGite.adresse) {
                message += `üìç ${infosGite.adresse}\n\n`;
            }
            
            if (infosGite.codeCle) {
                message += `üîë Code: ${infosGite.codeCle}\n`;
            }
            
            if (infosGite.wifi) {
                message += `üì∂ WiFi: ${infosGite.wifi}\n`;
            }
            
            message += `\nBon s√©jour ! üåü`;
            
            // Cr√©er le lien SMS
            const smsLink = `sms:${telephone}?body=${encodeURIComponent(message)}`;
            window.location.href = smsLink;
            
            // Marquer comme envoy√©
            await updateReservation(reservationId, { messageEnvoye: true });
            await updateReservationsList();
            
            // Aussi t√©l√©charger la page HTML
            setTimeout(() => {
                telechargerPageHTML(reservation);
            }, 500);
            
            showToast(`‚úì SMS pr√©par√© pour ${reservation.nom}`);
        }
        
        async function telechargerSeulementHTML(reservationId) {
            // Fermer le modal
            document.querySelectorAll('div[style*="z-index: 10000"]').forEach(el => el.remove());
            
            // Utiliser la nouvelle fonction de g√©n√©ration compl√®te
            await aper√ßuFicheClient(reservationId);
        }
        
        function telechargerPageHTML(reservation) {
            const infosGite = loadInfosGites(reservation.gite);
            
            const htmlContent = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenue ${reservation.nom} - G√Æte ${reservation.gite}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Work+Sans:wght@300;400;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #2C3E50;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 30px;
            font-weight: 300;
        }
        
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        
        .info-box h2 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-item {
            margin: 10px 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .info-item strong {
            color: #2C3E50;
            display: inline-block;
            min-width: 150px;
        }
        
        .code {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.3rem;
            display: inline-block;
            margin-left: 10px;
        }
        
        .section {
            margin: 30px 0;
        }
        
        ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            color: #666;
        }
        
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
        }
    <\/style>
<\/head>
<body>
    <div class="container">
        <h1>üè° Bienvenue ${reservation.nom} !</h1>
        <div class="subtitle">G√Æte de ${reservation.gite}</div>
        
        <div class="info-box">
            <h2>üìÖ Votre S√©jour</h2>
            <div class="info-item"><strong>Arriv√©e :</strong> ${formatDate(reservation.dateDebut)}</div>
            <div class="info-item"><strong>D√©part :</strong> ${formatDate(reservation.dateFin)}</div>
            <div class="info-item"><strong>Dur√©e :</strong> ${reservation.nuits} nuit${reservation.nuits > 1 ? 's' : ''}</div>
            ${infosGite.adresse ? `<div class="info-item"><strong>üìç Adresse :</strong> ${infosGite.adresse}</div>` : ''}
        </div>
        
        <div class="info-box">
            <h2>üîë Acc√®s au G√Æte</h2>
            ${infosGite.codeCle ? `<div class="info-item"><strong>Code bo√Æte √† cl√©s :</strong><span class="code">${infosGite.codeCle}</span></div>` : '<div class="info-item">Le code vous sera communiqu√© s√©par√©ment.</div>'}
            ${infosGite.wifi ? `<div class="info-item"><strong>üì∂ WiFi :</strong><span class="code">${infosGite.wifi}</span></div>` : ''}
        </div>
        
        ${infosGite.instructionsArrivee ? `
        <div class="section">
            <h2 style="color: #27AE60; margin-bottom: 15px;">‚úÖ Instructions d'Arriv√©e</h2>
            <div style="background: #f0f9f4; padding: 20px; border-radius: 10px; white-space: pre-wrap;">${infosGite.instructionsArrivee}</div>
        </div>
        ` : ''}
        
        ${infosGite.instructionsDepart ? `
        <div class="section">
            <h2 style="color: #E74C3C; margin-bottom: 15px;">üö™ Instructions de D√©part</h2>
            <div style="background: #fef5f5; padding: 20px; border-radius: 10px; white-space: pre-wrap;">${infosGite.instructionsDepart}</div>
        </div>
        ` : ''}
        
        ${infosGite.infosComplementaires ? `
        <div class="section">
            <h2 style="color: #667eea; margin-bottom: 15px;">‚ÑπÔ∏è Informations Compl√©mentaires</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; white-space: pre-wrap;">${infosGite.infosComplementaires}</div>
        </div>
        ` : ''}
        
        ${(() => {
            // Charger les activit√©s selon le g√Æte
            const restaurants = JSON.parse(localStorage.getItem('restaurants') || '{}');
            const activites = JSON.parse(localStorage.getItem('activites') || '{}');
            const restaurantsGite = reservation.gite === 'Tr√©voux' ? restaurants.trevoux : restaurants.couzon;
            const activitesGite = reservation.gite === 'Tr√©voux' ? activites.trevoux : activites.couzon;
            const lyon = localStorage.getItem('activitesLyon') || '';
            const dombes = localStorage.getItem('activitesDombes') || '';
            const parcsZoo = localStorage.getItem('parcsZoo') || '';
            
            let sectionsHTML = '';
            
            // Restaurants
            if (restaurantsGite) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #f5576c; margin-bottom: 15px;">üçΩÔ∏è Nos Restaurants Recommand√©s</h2>
                    <div style="background: #fff5f7; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${restaurantsGite}</div>
                </div>`;
            }
            
            // Activit√©s locales
            if (activitesGite) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #4facfe; margin-bottom: 15px;">üéØ Activit√©s √† Proximit√©</h2>
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${activitesGite}</div>
                </div>`;
            }
            
            // Lyon
            if (lyon) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #fa709a; margin-bottom: 15px;">üèõÔ∏è D√©couvrir Lyon (30-40 min)</h2>
                    <div style="background: #fff8f0; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${lyon}</div>
                </div>`;
            }
            
            // Dombes
            if (dombes) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #a8edea; margin-bottom: 15px;">ü¶Ü Les Dombes (15-30 min)</h2>
                    <div style="background: #f0fffe; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${dombes}</div>
                </div>`;
            }
            
            // Parcs Zoo
            if (parcsZoo) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #fcb69f; margin-bottom: 15px;">ü¶Å Parcs Animaliers du Secteur</h2>
                    <div style="background: #fff8f0; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${parcsZoo}</div>
                </div>`;
            }
            
            return sectionsHTML;
        })()}
        
        <div class="footer">
            <p>Nous vous souhaitons un excellent s√©jour ! üåü</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">Pour toute question, n'h√©sitez pas √† nous contacter.</p>
        </div>
    </div>
</body>
</html>`;
            
            // T√©l√©charger le fichier HTML
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateToday = new Date().toISOString().split('T')[0];
            a.download = `Bienvenue_${reservation.nom.replace(/[^a-zA-Z0-9]/g, '_')}_${dateToday}.html`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`‚úì Page client g√©n√©r√©e pour ${reservation.nom}`);
        }
        
        
        // ========== GESTION ACTIVIT√âS & SORTIES ==========
        
        function sauvegarderRestaurants() {
            const data = {
                trevoux: document.getElementById('restaurantsTrevoux').value,
                couzon: document.getElementById('restaurantsCouzon').value
            };
            localStorage.setItem('restaurants', JSON.stringify(data));
            showToast('‚úì Restaurants sauvegard√©s');
        }
        
        function sauvegarderActivites() {
            const data = {
                trevoux: document.getElementById('activitesTrevoux').value,
                couzon: document.getElementById('activitesCouzon').value
            };
            localStorage.setItem('activites', JSON.stringify(data));
            showToast('‚úì Activit√©s sauvegard√©es');
        }
        
        function sauvegarderLyon() {
            localStorage.setItem('activitesLyon', document.getElementById('activitesLyon').value);
            showToast('‚úì Activit√©s Lyon sauvegard√©es');
        }
        
        function sauvegarderDombes() {
            localStorage.setItem('activitesDombes', document.getElementById('activitesDombes').value);
            showToast('‚úì Activit√©s Dombes sauvegard√©es');
        }
        
        function sauvegarderParcsZoo() {
            localStorage.setItem('parcsZoo', document.getElementById('parcsZoo').value);
            showToast('‚úì Parcs Zoo sauvegard√©s');
        }
        
        function chargerActivitesEtSorties() {
            // Restaurants
            const restaurants = localStorage.getItem('restaurants');
            if (restaurants) {
                const data = JSON.parse(restaurants);
                document.getElementById('restaurantsTrevoux').value = data.trevoux || '';
                document.getElementById('restaurantsCouzon').value = data.couzon || '';
            }
            
            // Activit√©s
            const activites = localStorage.getItem('activites');
            if (activites) {
                const data = JSON.parse(activites);
                document.getElementById('activitesTrevoux').value = data.trevoux || '';
                document.getElementById('activitesCouzon').value = data.couzon || '';
            }
            
            // Lyon
            const lyon = localStorage.getItem('activitesLyon');
            if (lyon) document.getElementById('activitesLyon').value = lyon;
            
            // Dombes
            const dombes = localStorage.getItem('activitesDombes');
            if (dombes) document.getElementById('activitesDombes').value = dombes;
            
            // Parcs Zoo
            const parcsZoo = localStorage.getItem('parcsZoo');
            if (parcsZoo) document.getElementById('parcsZoo').value = parcsZoo;
        }
        
        // Recherche d'√©v√©nements saisonniers
        async function rechercherEvenements() {
            const btnRecherche = event.target;
            const resultatsDiv = document.getElementById('evenementsResultats');
            const contentDiv = document.getElementById('evenementsContent');
            
            btnRecherche.disabled = true;
            btnRecherche.innerHTML = '<span>‚è≥</span> Recherche en cours...';
            
            try {
                // Recherche web pour √©v√©nements locaux
                const queries = [
                    '√©v√©nements Tr√©voux agenda',
                    '√©v√©nements Ain sorties ce week-end',
                    'festivals Dombes 2024 2025',
                    'agenda sorties Lyon m√©tropole'
                ];
                
                let htmlContent = '<h3 style="color: #667eea; margin-bottom: 20px;">üéâ √âv√©nements du secteur</h3>';
                htmlContent += '<div style="display: grid; gap: 15px;">';
                
                // On pourrait utiliser web_search ici mais pour l'instant on affiche un guide
                htmlContent += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìÖ Sources recommand√©es :</h4>
                        <ul style="margin-left: 20px; line-height: 2;">
                            <li><a href="https://www.ain-tourisme.com/agenda/" target="_blank" style="color: #667eea;">Ain Tourisme - Agenda</a></li>
                            <li><a href="https://www.trevoux.fr/agenda/" target="_blank" style="color: #667eea;">Mairie de Tr√©voux - √âv√©nements</a></li>
                            <li><a href="https://www.lyoncitycard.com/agenda/" target="_blank" style="color: #667eea;">Lyon City Card - Agenda</a></li>
                            <li><a href="https://www.dombes-tourisme.com/" target="_blank" style="color: #667eea;">Office de Tourisme Dombes</a></li>
                            <li><a href="https://www.sortiralyon.fr/" target="_blank" style="color: #667eea;">Sortir √† Lyon</a></li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üí° √âv√©nements saisonniers r√©currents :</h4>
                        <ul style="margin-left: 20px; line-height: 2; color: #856404;">
                            <li><strong>Janvier-F√©vrier :</strong> Carnaval de Lyon, F√™te des Lumi√®res (d√©cembre)</li>
                            <li><strong>Mars-Avril :</strong> Printemps des Dombes, march√©s de printemps</li>
                            <li><strong>Mai-Juin :</strong> F√™te de la Nature, randonn√©es d√©couverte</li>
                            <li><strong>Juillet-Ao√ªt :</strong> Festivals d'√©t√©, Nuits de Fourvi√®re Lyon</li>
                            <li><strong>Septembre-Octobre :</strong> Journ√©es du Patrimoine, vendanges Beaujolais</li>
                            <li><strong>Novembre-D√©cembre :</strong> F√™te des Lumi√®res Lyon (8 d√©c), march√©s de No√´l</li>
                        </ul>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3;">
                        <h4 style="color: #1976d2; margin-bottom: 10px;">üé≠ Lieux culturels permanents :</h4>
                        <ul style="margin-left: 20px; line-height: 2; color: #1976d2;">
                            <li><strong>Op√©ra de Lyon</strong> - Spectacles toute l'ann√©e</li>
                            <li><strong>Th√©√¢tre des C√©lestins</strong> - Lyon</li>
                            <li><strong>Mus√©e des Confluences</strong> - Expositions temporaires</li>
                            <li><strong>Auditorium Maurice Ravel</strong> - Concerts classiques</li>
                            <li><strong>Transbordeur</strong> - Concerts rock/√©lectro</li>
                        </ul>
                    </div>
                `;
                
                htmlContent += '</div>';
                
                contentDiv.innerHTML = htmlContent;
                resultatsDiv.style.display = 'block';
                
                // Sauvegarder la date de derni√®re recherche
                localStorage.setItem('derniereRechercheEvenements', new Date().toISOString());
                
                showToast('‚úì √âv√©nements mis √† jour');
                
            } catch (error) {
                contentDiv.innerHTML = '<div style="color: #e74c3c; padding: 20px;">‚ùå Erreur lors de la recherche. R√©essayez plus tard.</div>';
            } finally {
                btnRecherche.disabled = false;
                btnRecherche.innerHTML = '<span>üîç</span> Rechercher les √©v√©nements actuels';
            }
        }
        
        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION ! Supprimer TOUTES les donn√©es ? Cette action est IRR√âVERSIBLE.')) return;
            if (!confirm('√ätes-vous VRAIMENT s√ªr ? Toutes les r√©servations seront perdues !')) return;
            
            const transaction = db.transaction(['reservations'], 'readwrite');
            transaction.objectStore('reservations').clear();
            
            await updateReservationsList();
            await updateStats();
            await updateArchivesDisplay();
            showToast('‚úì Toutes les donn√©es supprim√©es');
        }
        
        // Click en dehors de la modal pour fermer
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
        
        // Initialisation
        (async () => {
            await initDB();
            
            // Peupler la liste d√©roulante des ann√©es
            await populateYearFilter();
            
            await updateReservationsList();
            await updateStats();
            chargerActivites(); // Charger les activit√©s depuis Supabase üéØ
            chargerActivitesEtSorties(); // Charger les activit√©s
            chargerUrlsIcal(); // Charger les URLs iCal
            
            // Afficher le dernier statut de synchronisation
            const lastSync = localStorage.getItem('lastSyncStatus');
            if (lastSync) {
                const status = JSON.parse(lastSync);
                const syncStatus = document.getElementById('syncStatus');
                const syncStatusIcon = document.getElementById('syncStatusIcon');
                const syncStatusText = document.getElementById('syncStatusText');
                
                if (syncStatus) {
                    const date = new Date(status.date);
                    const dateStr = date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    syncStatus.style.display = 'block';
                    if (status.errors > 0) {
                        syncStatus.style.background = '#fff3cd';
                        syncStatusIcon.textContent = '‚ö†Ô∏è';
                        syncStatusText.textContent = `Derni√®re synchronisation avec ${status.errors} erreur(s) - ${dateStr} √† ${timeStr}`;
                    } else {
                        syncStatus.style.background = '#d4edda';
                        syncStatusIcon.textContent = '‚úì';
                        syncStatusText.textContent = `Derni√®re synchronisation : ${dateStr} √† ${timeStr} (${status.added} r√©servations)`;
                    }
                }
            }
            
            // Synchronisation automatique au chargement
            setTimeout(async () => {
                try {
                    await syncAllCalendars();
                } catch (error) {
                    console.error('Erreur sync auto:', error);
                }
            }, 1000); // Attendre 1 seconde apr√®s le chargement
        })();
        
        // ==========================================
        // üìã GESTION INFOS PRATIQUES ULTRA-COMPLET
        // ==========================================
        
        (function() {
            let currentGiteInfos = 'Tr√©voux';
            const DB_KEY_INFOS = 'gites_infos_pratiques_complet';
            
            // ==========================================
            // üíæ SAUVEGARDE EN BASE DE DONN√âES SUPABASE
            // ==========================================
            
            async function saveInfosGiteToSupabase(gite, formData) {
                try {
                    // Convertir formData en format snake_case pour correspondre aux colonnes SQL
                    const dataToSave = {
                        gite: gite.toLowerCase(),
                        // Section 1: Base
                        adresse: formData.adresse || null,
                        telephone: formData.telephone || null,
                        gps_lat: formData.gpsLat || null,
                        gps_lon: formData.gpsLon || null,
                        email: formData.email || null,
                        adresse_en: formData.adresse_en || null,
                        telephone_en: formData.telephone_en || null,
                        email_en: formData.email_en || null,
                        // Section 2: WiFi
                        wifi_ssid: formData.wifiSSID || null,
                        wifi_password: formData.wifiPassword || null,
                        wifi_debit: formData.wifiDebit || null,
                        wifi_localisation: formData.wifiLocalisation || null,
                        wifi_zones: formData.wifiZones || null,
                        wifi_ssid_en: formData.wifiSSID_en || null,
                        wifi_password_en: formData.wifiPassword_en || null,
                        wifi_debit_en: formData.wifiDebit_en || null,
                        wifi_localisation_en: formData.wifiLocalisation_en || null,
                        wifi_zones_en: formData.wifiZones_en || null,
                        // Section 3: Arriv√©e
                        heure_arrivee: formData.heureArrivee || null,
                        arrivee_tardive: formData.arriveeTardive || null,
                        parking_dispo: formData.parkingDispo || null,
                        parking_places: formData.parkingPlaces || null,
                        parking_details: formData.parkingDetails || null,
                        type_acces: formData.typeAcces || null,
                        code_acces: formData.codeAcces || null,
                        instructions_cles: formData.instructionsCles || null,
                        etage: formData.etage || null,
                        ascenseur: formData.ascenseur || null,
                        itineraire_logement: formData.itineraireLogement || null,
                        premiere_visite: formData.premiereVisite || null,
                        heure_arrivee_en: formData.heureArrivee_en || null,
                        arrivee_tardive_en: formData.arriveeTardive_en || null,
                        parking_dispo_en: formData.parkingDispo_en || null,
                        parking_places_en: formData.parkingPlaces_en || null,
                        parking_details_en: formData.parkingDetails_en || null,
                        type_acces_en: formData.typeAcces_en || null,
                        code_acces_en: formData.codeAcces_en || null,
                        instructions_cles_en: formData.instructionsCles_en || null,
                        etage_en: formData.etage_en || null,
                        ascenseur_en: formData.ascenseur_en || null,
                        itineraire_logement_en: formData.itineraireLogement_en || null,
                        premiere_visite_en: formData.premiereVisite_en || null,
                        // Section 4: Logement
                        type_chauffage: formData.typeChauffage || null,
                        climatisation: formData.climatisation || null,
                        instructions_chauffage: formData.instructionsChauffage || null,
                        equipements_cuisine: formData.equipementsCuisine || null,
                        instructions_four: formData.instructionsFour || null,
                        instructions_plaques: formData.instructionsPlaques || null,
                        instructions_lave_vaisselle: formData.instructionsLaveVaisselle || null,
                        instructions_lave_linge: formData.instructionsLaveLinge || null,
                        seche_linge: formData.secheLinge || null,
                        fer_repasser: formData.ferRepasser || null,
                        linge_fourni: formData.lingeFourni || null,
                        configuration_chambres: formData.configurationChambres || null,
                        type_chauffage_en: formData.typeChauffage_en || null,
                        climatisation_en: formData.climatisation_en || null,
                        instructions_chauffage_en: formData.instructionsChauffage_en || null,
                        equipements_cuisine_en: formData.equipementsCuisine_en || null,
                        instructions_four_en: formData.instructionsFour_en || null,
                        instructions_plaques_en: formData.instructionsPlaques_en || null,
                        instructions_lave_vaisselle_en: formData.instructionsLaveVaisselle_en || null,
                        instructions_lave_linge_en: formData.instructionsLaveLinge_en || null,
                        seche_linge_en: formData.secheLinge_en || null,
                        fer_repasser_en: formData.ferRepasser_en || null,
                        linge_fourni_en: formData.lingeFourni_en || null,
                        configuration_chambres_en: formData.configurationChambres_en || null,
                        // Section 5: D√©chets
                        instructions_tri: formData.instructionsTri || null,
                        jours_collecte: formData.joursCollecte || null,
                        decheterie: formData.decheterie || null,
                        instructions_tri_en: formData.instructionsTri_en || null,
                        jours_collecte_en: formData.joursCollecte_en || null,
                        decheterie_en: formData.decheterie_en || null,
                        // Section 6: S√©curit√©
                        detecteur_fumee: formData.detecteurFumee || null,
                        extincteur: formData.extincteur || null,
                        coupure_eau: formData.coupureEau || null,
                        disjoncteur: formData.disjoncteur || null,
                        consignes_urgence: formData.consignesUrgence || null,
                        detecteur_fumee_en: formData.detecteurFumee_en || null,
                        extincteur_en: formData.extincteur_en || null,
                        coupure_eau_en: formData.coupureEau_en || null,
                        disjoncteur_en: formData.disjoncteur_en || null,
                        consignes_urgence_en: formData.consignesUrgence_en || null,
                        // Section 7: D√©part
                        heure_depart: formData.heureDepart || null,
                        depart_tardif: formData.departTardif || null,
                        checklist_depart: formData.checklistDepart || null,
                        restitution_cles: formData.restitutionCles || null,
                        heure_depart_en: formData.heureDepart_en || null,
                        depart_tardif_en: formData.departTardif_en || null,
                        checklist_depart_en: formData.checklistDepart_en || null,
                        restitution_cles_en: formData.restitutionCles_en || null,
                        // Section 8: R√®glement
                        tabac: formData.tabac || null,
                        animaux: formData.animaux || null,
                        nb_max_personnes: formData.nbMaxPersonnes || null,
                        caution: formData.caution || null,
                        tabac_en: formData.tabac_en || null,
                        animaux_en: formData.animaux_en || null,
                        nb_max_personnes_en: formData.nbMaxPersonnes_en || null,
                        caution_en: formData.caution_en || null,
                        date_modification: new Date().toISOString()
                    };
                    
                    // UPSERT avec gite comme cl√© unique
                    const { error } = await supabase
                        .from('infos_gites')
                        .upsert(dataToSave, { onConflict: 'gite' });
                    
                    if (error) throw error;
                    
                    console.log(`‚úÖ Infos ${gite} sauvegard√©es en base de donn√©es`);
                    return true;
                } catch (error) {
                    console.error('Erreur sauvegarde Supabase:', error);
                    showNotification('‚ö†Ô∏è Sauvegarde locale OK, mais erreur sync cloud', 'warning');
                    return false;
                }
            }
            
            async function loadInfosGiteFromSupabase(gite) {
                try {
                    const { data, error } = await supabase
                        .from('infos_gites')
                        .select('*')
                        .eq('gite', gite.toLowerCase())
                        .single();
                    
                    if (error) {
                        if (error.code === 'PGRST116') {
                            // Pas de donn√©es, c'est normal pour la premi√®re fois
                            console.log(`‚ÑπÔ∏è Pas encore de donn√©es pour ${gite} en base`);
                            return null;
                        }
                        throw error;
                    }
                    
                    // Convertir de snake_case SQL vers camelCase JavaScript
                    const formData = {
                        // Section 1: Base
                        adresse: data.adresse || '',
                        telephone: data.telephone || '',
                        gpsLat: data.gps_lat || '',
                        gpsLon: data.gps_lon || '',
                        email: data.email || '',
                        adresse_en: data.adresse_en || '',
                        telephone_en: data.telephone_en || '',
                        email_en: data.email_en || '',
                        // Section 2: WiFi
                        wifiSSID: data.wifi_ssid || '',
                        wifiPassword: data.wifi_password || '',
                        wifiDebit: data.wifi_debit || '',
                        wifiLocalisation: data.wifi_localisation || '',
                        wifiZones: data.wifi_zones || '',
                        wifiSSID_en: data.wifi_ssid_en || '',
                        wifiPassword_en: data.wifi_password_en || '',
                        wifiDebit_en: data.wifi_debit_en || '',
                        wifiLocalisation_en: data.wifi_localisation_en || '',
                        wifiZones_en: data.wifi_zones_en || '',
                        // Section 3: Arriv√©e
                        heureArrivee: data.heure_arrivee || '',
                        arriveeTardive: data.arrivee_tardive || '',
                        parkingDispo: data.parking_dispo || '',
                        parkingPlaces: data.parking_places || '',
                        parkingDetails: data.parking_details || '',
                        typeAcces: data.type_acces || '',
                        codeAcces: data.code_acces || '',
                        instructionsCles: data.instructions_cles || '',
                        etage: data.etage || '',
                        ascenseur: data.ascenseur || '',
                        itineraireLogement: data.itineraire_logement || '',
                        premiereVisite: data.premiere_visite || '',
                        heureArrivee_en: data.heure_arrivee_en || '',
                        arriveeTardive_en: data.arrivee_tardive_en || '',
                        parkingDispo_en: data.parking_dispo_en || '',
                        parkingPlaces_en: data.parking_places_en || '',
                        parkingDetails_en: data.parking_details_en || '',
                        typeAcces_en: data.type_acces_en || '',
                        codeAcces_en: data.code_acces_en || '',
                        instructionsCles_en: data.instructions_cles_en || '',
                        etage_en: data.etage_en || '',
                        ascenseur_en: data.ascenseur_en || '',
                        itineraireLogement_en: data.itineraire_logement_en || '',
                        premiereVisite_en: data.premiere_visite_en || '',
                        // Section 4: Logement
                        typeChauffage: data.type_chauffage || '',
                        climatisation: data.climatisation || '',
                        instructionsChauffage: data.instructions_chauffage || '',
                        equipementsCuisine: data.equipements_cuisine || '',
                        instructionsFour: data.instructions_four || '',
                        instructionsPlaques: data.instructions_plaques || '',
                        instructionsLaveVaisselle: data.instructions_lave_vaisselle || '',
                        instructionsLaveLinge: data.instructions_lave_linge || '',
                        secheLinge: data.seche_linge || '',
                        ferRepasser: data.fer_repasser || '',
                        lingeFourni: data.linge_fourni || '',
                        configurationChambres: data.configuration_chambres || '',
                        typeChauffage_en: data.type_chauffage_en || '',
                        climatisation_en: data.climatisation_en || '',
                        instructionsChauffage_en: data.instructions_chauffage_en || '',
                        equipementsCuisine_en: data.equipements_cuisine_en || '',
                        instructionsFour_en: data.instructions_four_en || '',
                        instructionsPlaques_en: data.instructions_plaques_en || '',
                        instructionsLaveVaisselle_en: data.instructions_lave_vaisselle_en || '',
                        instructionsLaveLinge_en: data.instructions_lave_linge_en || '',
                        secheLinge_en: data.seche_linge_en || '',
                        ferRepasser_en: data.fer_repasser_en || '',
                        lingeFourni_en: data.linge_fourni_en || '',
                        configurationChambres_en: data.configuration_chambres_en || '',
                        // Section 5: D√©chets
                        instructionsTri: data.instructions_tri || '',
                        joursCollecte: data.jours_collecte || '',
                        decheterie: data.decheterie || '',
                        instructionsTri_en: data.instructions_tri_en || '',
                        joursCollecte_en: data.jours_collecte_en || '',
                        decheterie_en: data.decheterie_en || '',
                        // Section 6: S√©curit√©
                        detecteurFumee: data.detecteur_fumee || '',
                        extincteur: data.extincteur || '',
                        coupureEau: data.coupure_eau || '',
                        disjoncteur: data.disjoncteur || '',
                        consignesUrgence: data.consignes_urgence || '',
                        detecteurFumee_en: data.detecteur_fumee_en || '',
                        extincteur_en: data.extincteur_en || '',
                        coupureEau_en: data.coupure_eau_en || '',
                        disjoncteur_en: data.disjoncteur_en || '',
                        consignesUrgence_en: data.consignes_urgence_en || '',
                        // Section 7: D√©part
                        heureDepart: data.heure_depart || '',
                        departTardif: data.depart_tardif || '',
                        checklistDepart: data.checklist_depart || '',
                        restitutionCles: data.restitution_cles || '',
                        heureDepart_en: data.heure_depart_en || '',
                        departTardif_en: data.depart_tardif_en || '',
                        checklistDepart_en: data.checklist_depart_en || '',
                        restitutionCles_en: data.restitution_cles_en || '',
                        // Section 8: R√®glement
                        tabac: data.tabac || '',
                        animaux: data.animaux || '',
                        nbMaxPersonnes: data.nb_max_personnes || '',
                        caution: data.caution || '',
                        tabac_en: data.tabac_en || '',
                        animaux_en: data.animaux_en || '',
                        nbMaxPersonnes_en: data.nb_max_personnes_en || '',
                        caution_en: data.caution_en || '',
                        dateModification: data.date_modification
                    };
                    
                    console.log(`‚úÖ Infos ${gite} charg√©es depuis la base de donn√©es`);
                    return formData;
                } catch (error) {
                    console.error('Erreur chargement Supabase:', error);
                    showNotification('‚ö†Ô∏è Chargement depuis sauvegarde locale', 'info');
                    return null;
                }
            }
            
            // S√©lection du g√Æte
            window.selectGiteInfos = async function(gite) {
                // Sauvegarder les donn√©es actuelles
                sauvegarderDonneesInfos();
                
                // Changer le g√Æte
                currentGiteInfos = gite;
                
                // Mettre √† jour l'UI des boutons
                document.getElementById('btnTrevoux').style.background = gite === 'Tr√©voux' ? 'white' : 'rgba(255,255,255,0.2)';
                document.getElementById('btnTrevoux').style.color = gite === 'Tr√©voux' ? '#667eea' : 'white';
                document.getElementById('btnCouzon').style.background = gite === 'Couzon' ? 'white' : 'rgba(255,255,255,0.2)';
                document.getElementById('btnCouzon').style.color = gite === 'Couzon' ? '#667eea' : 'white';
                
                // Charger les donn√©es du nouveau g√Æte
                await chargerDonneesInfos();
                
                showNotification(`G√Æte ${gite} s√©lectionn√©`, 'success');
            };
            
            function sauvegarderDonneesInfos() {
                const formData = {
                    // Section 1: Base (FR)
                    adresse: document.getElementById('infos_adresse')?.value || '',
                    telephone: document.getElementById('infos_telephone')?.value || '',
                    gpsLat: document.getElementById('infos_gpsLat')?.value || '',
                    gpsLon: document.getElementById('infos_gpsLon')?.value || '',
                    email: document.getElementById('infos_email')?.value || '',
                    // Section 1: Base (EN)
                    adresse_en: document.getElementById('infos_adresse_en')?.value || '',
                    telephone_en: document.getElementById('infos_telephone_en')?.value || '',
                    email_en: document.getElementById('infos_email_en')?.value || '',
                    
                    // Section 2: WiFi (FR)
                    wifiSSID: document.getElementById('infos_wifiSSID')?.value || '',
                    wifiPassword: document.getElementById('infos_wifiPassword')?.value || '',
                    wifiDebit: document.getElementById('infos_wifiDebit')?.value || '',
                    wifiLocalisation: document.getElementById('infos_wifiLocalisation')?.value || '',
                    wifiZones: document.getElementById('infos_wifiZones')?.value || '',
                    // Section 2: WiFi (EN)
                    wifiSSID_en: document.getElementById('infos_wifiSSID_en')?.value || '',
                    wifiPassword_en: document.getElementById('infos_wifiPassword_en')?.value || '',
                    wifiDebit_en: document.getElementById('infos_wifiDebit_en')?.value || '',
                    wifiLocalisation_en: document.getElementById('infos_wifiLocalisation_en')?.value || '',
                    wifiZones_en: document.getElementById('infos_wifiZones_en')?.value || '',
                    
                    // Section 3: Arriv√©e (FR)
                    heureArrivee: document.getElementById('infos_heureArrivee')?.value || '',
                    arriveeTardive: document.getElementById('infos_arriveeTardive')?.value || '',
                    parkingDispo: document.getElementById('infos_parkingDispo')?.value || '',
                    parkingPlaces: document.getElementById('infos_parkingPlaces')?.value || '',
                    parkingDetails: document.getElementById('infos_parkingDetails')?.value || '',
                    typeAcces: document.getElementById('infos_typeAcces')?.value || '',
                    codeAcces: document.getElementById('infos_codeAcces')?.value || '',
                    instructionsCles: document.getElementById('infos_instructionsCles')?.value || '',
                    etage: document.getElementById('infos_etage')?.value || '',
                    ascenseur: document.getElementById('infos_ascenseur')?.value || '',
                    itineraireLogement: document.getElementById('infos_itineraireLogement')?.value || '',
                    premiereVisite: document.getElementById('infos_premiereVisite')?.value || '',
                    // Section 3: Arriv√©e (EN)
                    heureArrivee_en: document.getElementById('infos_heureArrivee_en')?.value || '',
                    arriveeTardive_en: document.getElementById('infos_arriveeTardive_en')?.value || '',
                    parkingDispo_en: document.getElementById('infos_parkingDispo_en')?.value || '',
                    parkingPlaces_en: document.getElementById('infos_parkingPlaces_en')?.value || '',
                    parkingDetails_en: document.getElementById('infos_parkingDetails_en')?.value || '',
                    typeAcces_en: document.getElementById('infos_typeAcces_en')?.value || '',
                    codeAcces_en: document.getElementById('infos_codeAcces_en')?.value || '',
                    instructionsCles_en: document.getElementById('infos_instructionsCles_en')?.value || '',
                    etage_en: document.getElementById('infos_etage_en')?.value || '',
                    ascenseur_en: document.getElementById('infos_ascenseur_en')?.value || '',
                    itineraireLogement_en: document.getElementById('infos_itineraireLogement_en')?.value || '',
                    premiereVisite_en: document.getElementById('infos_premiereVisite_en')?.value || '',
                    
                    // Section 4: Logement (FR)
                    typeChauffage: document.getElementById('infos_typeChauffage')?.value || '',
                    climatisation: document.getElementById('infos_climatisation')?.value || '',
                    instructionsChauffage: document.getElementById('infos_instructionsChauffage')?.value || '',
                    equipementsCuisine: document.getElementById('infos_equipementsCuisine')?.value || '',
                    instructionsFour: document.getElementById('infos_instructionsFour')?.value || '',
                    instructionsPlaques: document.getElementById('infos_instructionsPlaques')?.value || '',
                    instructionsLaveVaisselle: document.getElementById('infos_instructionsLaveVaisselle')?.value || '',
                    instructionsLaveLinge: document.getElementById('infos_instructionsLaveLinge')?.value || '',
                    secheLinge: document.getElementById('infos_secheLinge')?.value || '',
                    ferRepasser: document.getElementById('infos_ferRepasser')?.value || '',
                    lingeFourni: document.getElementById('infos_lingeFourni')?.value || '',
                    configurationChambres: document.getElementById('infos_configurationChambres')?.value || '',
                    // Section 4: Logement (EN)
                    typeChauffage_en: document.getElementById('infos_typeChauffage_en')?.value || '',
                    climatisation_en: document.getElementById('infos_climatisation_en')?.value || '',
                    instructionsChauffage_en: document.getElementById('infos_instructionsChauffage_en')?.value || '',
                    equipementsCuisine_en: document.getElementById('infos_equipementsCuisine_en')?.value || '',
                    instructionsFour_en: document.getElementById('infos_instructionsFour_en')?.value || '',
                    instructionsPlaques_en: document.getElementById('infos_instructionsPlaques_en')?.value || '',
                    instructionsLaveVaisselle_en: document.getElementById('infos_instructionsLaveVaisselle_en')?.value || '',
                    instructionsLaveLinge_en: document.getElementById('infos_instructionsLaveLinge_en')?.value || '',
                    secheLinge_en: document.getElementById('infos_secheLinge_en')?.value || '',
                    ferRepasser_en: document.getElementById('infos_ferRepasser_en')?.value || '',
                    lingeFourni_en: document.getElementById('infos_lingeFourni_en')?.value || '',
                    configurationChambres_en: document.getElementById('infos_configurationChambres_en')?.value || '',
                    
                    // Section 5: D√©chets (FR)
                    instructionsTri: document.getElementById('infos_instructionsTri')?.value || '',
                    joursCollecte: document.getElementById('infos_joursCollecte')?.value || '',
                    decheterie: document.getElementById('infos_decheterie')?.value || '',
                    // Section 5: D√©chets (EN)
                    instructionsTri_en: document.getElementById('infos_instructionsTri_en')?.value || '',
                    joursCollecte_en: document.getElementById('infos_joursCollecte_en')?.value || '',
                    decheterie_en: document.getElementById('infos_decheterie_en')?.value || '',
                    
                    // Section 6: S√©curit√© (FR)
                    detecteurFumee: document.getElementById('infos_detecteurFumee')?.value || '',
                    extincteur: document.getElementById('infos_extincteur')?.value || '',
                    coupureEau: document.getElementById('infos_coupureEau')?.value || '',
                    disjoncteur: document.getElementById('infos_disjoncteur')?.value || '',
                    consignesUrgence: document.getElementById('infos_consignesUrgence')?.value || '',
                    // Section 6: S√©curit√© (EN)
                    detecteurFumee_en: document.getElementById('infos_detecteurFumee_en')?.value || '',
                    extincteur_en: document.getElementById('infos_extincteur_en')?.value || '',
                    coupureEau_en: document.getElementById('infos_coupureEau_en')?.value || '',
                    disjoncteur_en: document.getElementById('infos_disjoncteur_en')?.value || '',
                    consignesUrgence_en: document.getElementById('infos_consignesUrgence_en')?.value || '',
                    
                    // Section 7: D√©part (FR)
                    heureDepart: document.getElementById('infos_heureDepart')?.value || '',
                    departTardif: document.getElementById('infos_departTardif')?.value || '',
                    checklistDepart: document.getElementById('infos_checklistDepart')?.value || '',
                    restitutionCles: document.getElementById('infos_restitutionCles')?.value || '',
                    // Section 7: D√©part (EN)
                    heureDepart_en: document.getElementById('infos_heureDepart_en')?.value || '',
                    departTardif_en: document.getElementById('infos_departTardif_en')?.value || '',
                    checklistDepart_en: document.getElementById('infos_checklistDepart_en')?.value || '',
                    restitutionCles_en: document.getElementById('infos_restitutionCles_en')?.value || '',
                    
                    // Section 8: R√®glement (FR)
                    tabac: document.getElementById('infos_tabac')?.value || '',
                    animaux: document.getElementById('infos_animaux')?.value || '',
                    nbMaxPersonnes: document.getElementById('infos_nbMaxPersonnes')?.value || '',
                    caution: document.getElementById('infos_caution')?.value || '',
                    // Section 8: R√®glement (EN)
                    tabac_en: document.getElementById('infos_tabac_en')?.value || '',
                    animaux_en: document.getElementById('infos_animaux_en')?.value || '',
                    nbMaxPersonnes_en: document.getElementById('infos_nbMaxPersonnes_en')?.value || '',
                    caution_en: document.getElementById('infos_caution_en')?.value || '',
                    
                    dateModification: new Date().toISOString()
                };
                
                // Sauvegarder dans localStorage (backup local)
                const allData = JSON.parse(localStorage.getItem(DB_KEY_INFOS) || '{}');
                allData[currentGiteInfos] = formData;
                localStorage.setItem(DB_KEY_INFOS, JSON.stringify(allData));
                
                // Sauvegarder en base de donn√©es Supabase (async)
                saveInfosGiteToSupabase(currentGiteInfos, formData);
                
                updateProgressInfos();
            }
            
            async function chargerDonneesInfos() {
                // Essayer de charger depuis Supabase d'abord
                const dataFromSupabase = await loadInfosGiteFromSupabase(currentGiteInfos);
                
                let data;
                if (dataFromSupabase) {
                    // Donn√©es depuis Supabase
                    data = dataFromSupabase;
                    
                    // Mettre √† jour le localStorage aussi
                    const allData = JSON.parse(localStorage.getItem(DB_KEY_INFOS) || '{}');
                    allData[currentGiteInfos] = data;
                    localStorage.setItem(DB_KEY_INFOS, JSON.stringify(allData));
                } else {
                    // Fallback sur localStorage
                    const allData = JSON.parse(localStorage.getItem(DB_KEY_INFOS) || '{}');
                    data = allData[currentGiteInfos] || {};
                }
                
                // Remplir tous les champs
                Object.keys(data).forEach(key => {
                    const element = document.getElementById('infos_' + key);
                    if (element) {
                        element.value = data[key] || '';
                    }
                });
                
                // Mettre √† jour les champs conditionnels
                toggleParkingInfos();
                updateProgressInfos();
                
                // G√©n√©rer le QR code WiFi si les donn√©es sont pr√©sentes
                setTimeout(() => {
                    if (typeof updateQRCodeWifi === 'function') {
                        updateQRCodeWifi();
                    }
                }, 100);
            }
            
            window.toggleParkingInfos = function() {
                const parking = document.getElementById('infos_parkingDispo')?.value || '';
                const showFields = parking && parking !== 'Non';
                const placesDiv = document.getElementById('parkingPlacesDiv');
                const detailsDiv = document.getElementById('parkingDetailsDiv');
                if (placesDiv) placesDiv.style.display = showFields ? 'block' : 'none';
                if (detailsDiv) detailsDiv.style.display = showFields ? 'block' : 'none';
            };
            
            function updateProgressInfos() {
                const fields = document.querySelectorAll('#infosGiteForm [required]');
                let filled = 0;
                fields.forEach(field => {
                    if (field.value && field.value.trim()) filled++;
                });
                const percent = (filled / fields.length) * 100;
                const progressBar = document.getElementById('progressBarInfos');
                const progressText = document.getElementById('progressText');
                if (progressBar) progressBar.style.width = percent + '%';
                if (progressText) progressText.textContent = Math.round(percent) + '%';
            }
            
            window.sauvegarderInfosGiteComplet = function(event) {
                event.preventDefault();
                sauvegarderDonneesInfos();
                showNotification('‚úì Informations sauvegard√©es pour ' + currentGiteInfos, 'success');
            };
            
            window.resetGiteInfosQuick = async function() {
                if (!confirm(`‚ö†Ô∏è ATTENTION !\n\nVoulez-vous vraiment effacer TOUTES les informations du g√Æte ${currentGiteInfos} ?\n\n‚úì Ceci supprimera :\n- Adresse et coordonn√©es\n- Informations WiFi\n- Instructions d'arriv√©e\n- √âquipements\n- Toutes les autres donn√©es\n\n‚ùå Cette action est IRR√âVERSIBLE !\n\nCliquez sur OK pour confirmer la suppression.`)) {
                    return;
                }
                
                // Supprimer de localStorage
                const data = JSON.parse(localStorage.getItem(DB_KEY_INFOS) || '{}');
                delete data[currentGiteInfos];
                localStorage.setItem(DB_KEY_INFOS, JSON.stringify(data));
                
                // Supprimer de Supabase
                try {
                    await supabase
                        .from('infos_gites')
                        .delete()
                        .eq('gite', currentGiteInfos.toLowerCase());
                    
                    showNotification(`‚úì Toutes les donn√©es de ${currentGiteInfos} ont √©t√© effac√©es`, 'success');
                    
                    // Vider tous les champs du formulaire
                    const form = document.getElementById('infosGiteForm');
                    if (form) {
                        const inputs = form.querySelectorAll('input, textarea, select');
                        inputs.forEach(input => {
                            input.value = '';
                        });
                    }
                    
                    // Recharger les champs vides
                    await chargerDonneesInfos();
                } catch (error) {
                    console.error('Erreur suppression:', error);
                    showNotification('‚ùå Erreur lors de la suppression', 'error');
                }
            };
            
            // Fonction pour basculer entre FR et EN
            // Variable pour suivre la langue actuelle
            let currentLang = 'fr';
            let translationDone = false; // Pour ne traduire qu'une fois automatiquement
            
            // Nouvelle fonction toggle avec un seul bouton
            window.toggleLanguage = function() {
                // Basculer vers l'autre langue
                const newLang = currentLang === 'fr' ? 'en' : 'fr';
                console.log('üåç Toggle language from', currentLang, 'to', newLang);
                
                const btn = document.getElementById('btnToggleLang');
                
                // Liste de tous les champs √† basculer
                const fieldsToSwitch = [
                    'adresse', 'telephone', 'email',
                    'wifiSSID', 'wifiPassword', 'wifiDebit', 'wifiLocalisation', 'wifiZones',
                    'heureArrivee', 'arriveeTardive', 'parkingDispo', 'parkingPlaces', 'parkingDetails',
                    'typeAcces', 'codeAcces', 'instructionsCles', 'etage', 'ascenseur',
                    'itineraireLogement', 'premiereVisite',
                    'typeChauffage', 'climatisation', 'instructionsChauffage',
                    'equipementsCuisine', 'instructionsFour', 'instructionsPlaques',
                    'instructionsLaveVaisselle', 'instructionsLaveLinge', 'secheLinge',
                    'ferRepasser', 'lingeFourni', 'configurationChambres',
                    'instructionsTri', 'joursCollecte', 'decheterie',
                    'detecteurFumee', 'extincteur', 'coupureEau', 'disjoncteur', 'consignesUrgence',
                    'heureDepart', 'departTardif', 'checklistDepart', 'restitutionCles',
                    'supermarche', 'boulangerie', 'pharmacie', 'medecin', 'hopital', 'restaurants',
                    'transportsCommuns', 'tourisme', 'activites', 'activitesEnfants', 'randonnees', 'plages',
                    'reglesAnimaux', 'reglesFumeur', 'reglesCalme', 'reglesEvenements', 'autresRegles',
                    'autresInfos', 'contactsLocaux', 'recommandations', 'messageClient'
                ];
                
                // SWAP des valeurs entre les champs FR et EN
                fieldsToSwitch.forEach(field => {
                    const frField = document.getElementById(`infos_${field}`);
                    const enField = document.getElementById(`infos_${field}_en`);
                    
                    if (frField && enField) {
                        // √âchanger les valeurs
                        const temp = frField.value;
                        frField.value = enField.value;
                        enField.value = temp;
                    }
                });
                
                // Mettre √† jour la langue actuelle
                currentLang = newLang;
                
                // Mettre √† jour le bouton pour afficher le drapeau de la langue ACTIVE
                const flagIcon = document.getElementById('flagIcon');
                if (btn && flagIcon) {
                    if (currentLang === 'fr') {
                        // On est en fran√ßais, on affiche le drapeau FR
                        flagIcon.src = 'https://flagcdn.com/w80/fr.png';
                        flagIcon.alt = 'FR';
                        btn.title = 'Switch to English';
                        showNotification('üá´üá∑ Mode fran√ßais activ√©', 'info');
                    } else {
                        // On est en anglais, on affiche le drapeau UK
                        flagIcon.src = 'https://flagcdn.com/w80/gb.png';
                        flagIcon.alt = 'EN';
                        btn.title = 'Passer en fran√ßais';
                        showNotification('üá¨üáß English mode activated', 'info');
                    }
                }
                
                // V√©rifier si une traduction automatique est n√©cessaire apr√®s le swap
                // On v√©rifie si les champs FR (actuellement cach√©s) ont du contenu √† traduire
                setTimeout(() => {
                    const hasFieldsToTranslate = fieldsToSwitch.some(field => {
                        const enField = document.getElementById(`infos_${field}_en`);
                        const frField = document.getElementById(`infos_${field}`);
                        // Si le champ FR a du contenu, on traduit (m√™me si EN existe d√©j√†)
                        return enField && frField && frField.value.trim();
                    });
                    
                    if (hasFieldsToTranslate) {
                        console.log('üîÑ Traduction automatique d√©clench√©e apr√®s swap');
                        autoTranslateSilent();
                    }
                }, 500)
            };
            
            // Ancienne fonction pour compatibilit√© (au cas o√π elle est appel√©e ailleurs)
            window.switchLanguage = function(lang) {
                if (lang !== currentLang) {
                    toggleLanguage();
                }
            };
            
            // Traduction automatique silencieuse (sans popup)
            async function autoTranslateSilent() {
                const fieldsToTranslate = [
                    'adresse', 'telephone', 'email',
                    'wifiSSID', 'wifiPassword', 'wifiLocalisation', 'wifiZones',
                    'heureArrivee', 'arriveeTardive', 'parkingDispo', 'parkingPlaces', 'parkingDetails',
                    'typeAcces', 'codeAcces', 'instructionsCles', 'etage', 'ascenseur',
                    'itineraireLogement', 'premiereVisite',
                    'typeChauffage', 'climatisation', 'instructionsChauffage',
                    'equipementsCuisine', 'instructionsFour', 'instructionsPlaques',
                    'instructionsLaveVaisselle', 'instructionsLaveLinge', 'secheLinge',
                    'ferRepasser', 'lingeFourni', 'configurationChambres',
                    'instructionsTri', 'joursCollecte', 'decheterie',
                    'detecteurFumee', 'extincteur', 'coupureEau', 'disjoncteur', 'consignesUrgence',
                    'heureDepart', 'departTardif', 'checklistDepart', 'restitutionCles',
                    'supermarche', 'boulangerie', 'pharmacie', 'medecin', 'hopital', 'restaurants',
                    'transportsCommuns', 'tourisme', 'activites', 'activitesEnfants', 'randonnees', 'plages',
                    'reglesAnimaux', 'reglesFumeur', 'reglesCalme', 'reglesEvenements', 'autresRegles',
                    'autresInfos', 'contactsLocaux', 'recommandations', 'messageClient'
                ];
                
                let translated = 0;
                
                for (const field of fieldsToTranslate) {
                    const frField = document.getElementById(`infos_${field}`);
                    const enField = document.getElementById(`infos_${field}_en`);
                    
                    // Traduire si le champ FR a du contenu (√©crase l'EN existant)
                    if (frField && enField && frField.value.trim()) {
                        try {
                            const originalText = frField.value.trim();
                            const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(originalText)}&langpair=fr|en`);
                            const data = await response.json();
                            
                            if (data.responseData && data.responseData.translatedText) {
                                let translatedText = data.responseData.translatedText;
                                
                                // V√©rifier si la traduction contient des balises suspectes AVANT de nettoyer
                                const hasSuspiciousTags = /<(sg|g|lsg)\s+id=/i.test(translatedText) || translatedText.includes('</>');
                                
                                if (hasSuspiciousTags) {
                                    console.log('‚ö†Ô∏è Traduction avec balises suspectes ignor√©e pour', field, translatedText.substring(0, 100));
                                    continue;
                                }
                                
                                // Nettoyer les balises XML/HTML bizarres restantes
                                translatedText = translatedText.replace(/<[^>]+>/g, '').trim();
                                
                                // V√©rifier que la traduction est valide
                                const originalLength = originalText.length;
                                const translatedLength = translatedText.length;
                                
                                // Si la traduction est 3x plus longue OU moins de 20% de l'original, c'est suspect
                                if (translatedLength > originalLength * 3 || translatedLength < originalLength * 0.2) {
                                    console.log('‚ö†Ô∏è Traduction avec longueur suspecte ignor√©e pour', field, `(${originalLength} -> ${translatedLength})`);
                                    continue;
                                }
                                
                                // V√©rifier que ce n'est pas juste des espaces ou vide
                                if (!translatedText || translatedText.length < 2) {
                                    console.log('‚ö†Ô∏è Traduction vide ignor√©e pour', field);
                                    continue;
                                }
                                
                                enField.value = translatedText;
                                translated++;
                                console.log('‚úÖ Traduit:', field, originalText.substring(0, 30), '->', translatedText.substring(0, 30));
                            }
                            // Petite pause entre les requ√™tes pour √©viter le rate limiting
                            await new Promise(resolve => setTimeout(resolve, 300));
                        } catch (error) {
                            console.log('Translation error for', field, error);
                        }
                    }
                }
                
                if (translated > 0) {
                    translationDone = true;
                    showNotification(`üåç ${translated} champs traduits automatiquement`, 'success');
                }
            }
            
            // Fonction de traduction automatique FR ‚Üí EN (avec interface)
            window.autoTranslateFRtoEN = async function() {
                if (!confirm('üåç Voulez-vous traduire automatiquement tous les champs fran√ßais vers l\'anglais ?\n\n‚ö†Ô∏è Cela peut prendre quelques minutes.\n\nLes champs anglais d√©j√† remplis ne seront PAS √©cras√©s.')) {
                    return;
                }
                
                // Cr√©er une barre de progression visible
                const progressDiv = document.createElement('div');
                progressDiv.id = 'translationProgress';
                progressDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
                    z-index: 10000;
                    min-width: 400px;
                    text-align: center;
                `;
                progressDiv.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: #667eea;">üåç Traduction en cours...</h3>
                    <div style="background: #f0f0f0; border-radius: 10px; height: 30px; overflow: hidden; margin-bottom: 15px;">
                        <div id="progressBar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="progressText" style="color: #555; font-size: 0.95rem;">Pr√©paration...</p>
                `;
                document.body.appendChild(progressDiv);
                
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                
                // Liste de TOUS les champs √† traduire (sans le pr√©fixe infos_)
                const fieldsToTranslate = [
                    'adresse', 'telephone', 'email',
                    'wifiSSID', 'wifiPassword', 'wifiLocalisation', 'wifiZones',
                    'heureArrivee', 'arriveeTardive', 'parkingDispo', 'parkingPlaces', 'parkingDetails',
                    'typeAcces', 'codeAcces', 'instructionsCles', 'etage', 'ascenseur',
                    'itineraireLogement', 'premiereVisite',
                    'typeChauffage', 'climatisation', 'instructionsChauffage',
                    'equipementsCuisine', 'instructionsFour', 'instructionsPlaques',
                    'instructionsLaveVaisselle', 'instructionsLaveLinge', 'secheLinge',
                    'ferRepasser', 'lingeFourni', 'configurationChambres',
                    'instructionsTri', 'joursCollecte', 'decheterie',
                    'detecteurFumee', 'extincteur', 'coupureEau', 'disjoncteur', 'consignesUrgence',
                    'heureDepart', 'departTardif', 'checklistDepart', 'restitutionCles',
                    'tabac', 'animaux', 'nbMaxPersonnes', 'caution'
                ];
                
                let translated = 0;
                let skipped = 0;
                let notFound = 0;
                let total = fieldsToTranslate.length;
                
                try {
                    for (let i = 0; i < fieldsToTranslate.length; i++) {
                        const field = fieldsToTranslate[i];
                        const frInput = document.getElementById(`infos_${field}`);
                        const enInput = document.getElementById(`infos_${field}_en`);
                        
                        // Mettre √† jour la progression
                        const percent = ((i + 1) / total) * 100;
                        progressBar.style.width = percent + '%';
                        progressText.textContent = `Traduction: ${i + 1}/${total} champs (${translated} traduits)`;
                        
                        // V√©rifier si les deux champs existent
                        if (!frInput || !enInput) {
                            console.log(`‚ùå Champs non trouv√©s: infos_${field} ou infos_${field}_en`);
                            notFound++;
                            continue;
                        }
                        
                        const frValue = frInput.value.trim();
                        const enValue = enInput.value.trim();
                        
                        // Ne traduire que si FR est rempli ET EN est vide
                        if (frValue && !enValue) {
                            try {
                                // API gratuite MyMemory (limite: 1000 caract√®res par requ√™te)
                                const textToTranslate = frValue.substring(0, 1000);
                                progressText.textContent = `Traduction: "${textToTranslate.substring(0, 30)}..."`;
                                
                                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=fr|en`);
                                const data = await response.json();
                                
                                if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                                    let translatedText = data.responseData.translatedText;
                                    
                                    // V√©rifier si la traduction contient des balises suspectes AVANT de nettoyer
                                    const hasSuspiciousTags = /<(sg|g|lsg)\s+id=/i.test(translatedText) || translatedText.includes('</>');
                                    
                                    if (hasSuspiciousTags) {
                                        console.warn(`‚ö†Ô∏è Traduction avec balises suspectes ignor√©e pour ${field}`);
                                        await new Promise(resolve => setTimeout(resolve, 600));
                                        continue;
                                    }
                                    
                                    // Nettoyer les balises XML/HTML bizarres restantes
                                    translatedText = translatedText.replace(/<[^>]+>/g, '').trim();
                                    
                                    // V√©rifier que la traduction est valide
                                    const originalLength = textToTranslate.length;
                                    const translatedLength = translatedText.length;
                                    
                                    if (translatedLength > originalLength * 3 || translatedLength < originalLength * 0.2 || !translatedText || translatedLength < 2) {
                                        console.warn(`‚ö†Ô∏è Traduction suspecte ignor√©e pour ${field} (${originalLength} -> ${translatedLength})`);
                                        await new Promise(resolve => setTimeout(resolve, 600));
                                        continue;
                                    }
                                    
                                    enInput.value = translatedText;
                                    translated++;
                                    console.log(`‚úÖ Traduit: ${field} ‚Üí "${translatedText.substring(0, 50)}..."`);
                                } else {
                                    console.warn(`‚ö†Ô∏è √âchec traduction pour ${field}:`, data);
                                }
                                
                                // Pause pour √©viter rate limit (max 10 req/sec)
                                await new Promise(resolve => setTimeout(resolve, 600));
                                
                            } catch (error) {
                                console.error(`‚ùå Erreur traduction ${field}:`, error);
                            }
                        } else if (enValue) {
                            skipped++;
                            console.log(`‚è≠Ô∏è Ignor√© (d√©j√† rempli): ${field}`);
                        }
                    }
                    
                    progressText.textContent = 'üíæ Sauvegarde en cours...';
                    
                    // Sauvegarder automatiquement
                    sauvegarderDonneesInfos();
                    
                    // Supprimer la barre de progression
                    document.body.removeChild(progressDiv);
                    
                    showNotification(`‚úì Traduction termin√©e ! ${translated} champs traduits, ${skipped} d√©j√† remplis, ${notFound} champs non trouv√©s`, 'success');
                    
                    console.log(`üìä R√©sum√©: ${translated} traduits, ${skipped} ignor√©s, ${notFound} non trouv√©s sur ${total} total`);
                    
                } catch (error) {
                    console.error('Erreur globale traduction:', error);
                    if (document.body.contains(progressDiv)) {
                        document.body.removeChild(progressDiv);
                    }
                    showNotification('‚ùå Erreur lors de la traduction automatique', 'error');
                }
            };

            window.importerInfosGites = function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        try {
                            const imported = JSON.parse(event.target.result);
                            
                            // Sauvegarder en localStorage
                            localStorage.setItem(DB_KEY_INFOS, JSON.stringify(imported));
                            
                            // Sauvegarder en Supabase pour chaque g√Æte
                            for (const gite in imported) {
                                await saveInfosGiteToSupabase(gite, imported[gite]);
                            }
                            
                            // Recharger les donn√©es affich√©es
                            chargerDonneesInfos();
                            
                            showNotification('‚úì Donn√©es import√©es et synchronis√©es !', 'success');
                        } catch (error) {
                            console.error('Erreur import:', error);
                            showNotification('‚ùå Erreur lors de l\'import', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };
            
            // Auto-save toutes les 30 secondes
            setInterval(() => {
                if (document.getElementById('tab-infos-gites')?.classList.contains('active')) {
                    sauvegarderDonneesInfos();
                }
            }, 30000);
            
            // Update progress on input
            setTimeout(() => {
                const form = document.getElementById('infosGiteForm');
                if (form) {
                    form.querySelectorAll('input, textarea, select').forEach(el => {
                        el.addEventListener('input', updateProgressInfos);
                        el.addEventListener('change', updateProgressInfos);
                    });
                }
                
                // Charger les donn√©es au d√©marrage
                chargerDonneesInfos();
            }, 500);
        })();
        
        // ==========================================
        // üì± G√âN√âRATION QR CODE WIFI (100% API)
        // ==========================================
        
        window.updateQRCodeWifi = function() {
            console.log('üîÑ updateQRCodeWifi appel√©e');
            
            const ssid = document.getElementById('infos_wifiSSID')?.value || '';
            const password = document.getElementById('infos_wifiPassword')?.value || '';
            const section = document.getElementById('qrCodeWifiSection');
            const canvas = document.getElementById('qrCodeWifiCanvas');
            
            console.log('SSID:', ssid, 'Password:', password);
            
            if (!section || !canvas) {
                console.error('‚ùå √âl√©ments QR code non trouv√©s');
                return;
            }
            
            // Afficher la section seulement si SSID et password sont remplis
            if (ssid && password) {
                section.style.display = 'block';
                
                // Format du QR code WiFi selon la sp√©cification
                const wifiString = `WIFI:T:WPA;S:${ssid};P:${password};;`;
                console.log('üì∂ G√©n√©ration QR code pour:', wifiString);
                
                // G√©n√©rer directement avec l'API
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    // Effacer le canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // Dessiner l'image
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    console.log('‚úÖ QR code g√©n√©r√© avec succ√®s');
                };
                
                img.onerror = function(e) {
                    console.error('‚ùå Erreur chargement QR code:', e);
                    // Afficher un message d'erreur
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#ff0000';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Erreur de', canvas.width/2, canvas.height/2 - 6);
                    ctx.fillText('g√©n√©ration', canvas.width/2, canvas.height/2 + 6);
                };
                
                // Encoder le texte pour l'URL
                const encodedText = encodeURIComponent(wifiString);
                img.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodedText}`;
                
            } else {
                console.log('‚ÑπÔ∏è SSID ou password manquant, masquage de la section');
                section.style.display = 'none';
            }
        };
        
        window.telechargerQRCodeWifi = function() {
            const canvas = document.getElementById('qrCodeWifiCanvas');
            const ssid = document.getElementById('infos_wifiSSID')?.value || 'wifi';
            
            if (!canvas) {
                showNotification('‚ùå Canvas non trouv√©', 'error');
                return;
            }
            
            // Cr√©er un canvas plus grand pour meilleure qualit√©
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 600;
            tempCanvas.height = 700;
            const ctx = tempCanvas.getContext('2d');
            
            // Fond blanc
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Titre
            ctx.fillStyle = '#2C5F7D';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('WiFi Gratuit', tempCanvas.width / 2, 60);
            
            // SSID
            ctx.font = '28px Arial';
            ctx.fillStyle = '#555';
            ctx.fillText(`R√©seau: ${ssid}`, tempCanvas.width / 2, 110);
            
            // QR Code (centr√© et agrandi)
            ctx.drawImage(canvas, 50, 140, 500, 500);
            
            // Instructions
            ctx.font = '20px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Scannez avec votre smartphone', tempCanvas.width / 2, 670);
            
            // T√©l√©charger
            tempCanvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `QR-WiFi-${ssid}.png`;
                link.click();
                URL.revokeObjectURL(url);
                showNotification('‚úì QR Code t√©l√©charg√© !', 'success');
            });
        };
        
        window.imprimerQRCodeWifi = function() {
            const canvas = document.getElementById('qrCodeWifiCanvas');
            const ssid = document.getElementById('infos_wifiSSID')?.value || 'wifi';
            const password = document.getElementById('infos_wifiPassword')?.value || '';
            
            if (!canvas) {
                showNotification('‚ùå Canvas non trouv√©', 'error');
                return;
            }
            
            // Cr√©er une fen√™tre d'impression
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Code WiFi - ${ssid}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 2cm;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            text-align: center;
                            padding: 20px;
                        }
                        .container {
                            max-width: 600px;
                            margin: 0 auto;
                            border: 3px solid #2C5F7D;
                            padding: 30px;
                            border-radius: 20px;
                        }
                        h1 {
                            color: #2C5F7D;
                            font-size: 48px;
                            margin-bottom: 10px;
                        }
                        .ssid {
                            font-size: 32px;
                            color: #555;
                            margin-bottom: 30px;
                            font-weight: bold;
                        }
                        .qr-code {
                            margin: 30px 0;
                        }
                        .instructions {
                            font-size: 24px;
                            color: #666;
                            margin-top: 20px;
                        }
                        .password {
                            font-size: 18px;
                            color: #999;
                            margin-top: 20px;
                            font-style: italic;
                        }
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>üì∂ WiFi Gratuit</h1>
                        <div class="ssid">R√©seau: ${ssid}</div>
                        <div class="qr-code">
                            <img src="${canvas.toDataURL()}" style="width: 400px; height: 400px;">
                        </div>
                        <div class="instructions">
                            üì± Scannez ce QR code avec votre smartphone<br>
                            pour vous connecter automatiquement
                        </div>
                        <div class="password">
                            Mot de passe (si besoin): ${password}
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        };
        // ==========================================
        // üó∫Ô∏è GESTION "√Ä D√âCOUVRIR"
        // ==========================================
        
        // Coordonn√©es GPS des g√Ætes
        const GITES_COORDS = {
            'Tr√©voux': { lat: 45.93638229370117, lng: 4.791853904724121 },
            'Couzon': { lat: 45.84257125854492, lng: 4.831059455871582 }
        };
        
        // Informations compl√®tes des g√Ætes
        const GITES_INFOS = {
            'Tr√©voux': {
                nom: 'G√Æte de Tr√©voux',
                emoji: 'üè∞',
                couleur_principale: '#667eea',
                couleur_secondaire: '#764ba2',
                adresse: '2 Grande Rue, 01600 Tr√©voux',
                code_acces: '1234A',
                wifi_nom: 'Gite_Trevoux',
                wifi_mdp: 'BienvenueTrevoux2024',
                parking: 'Parking gratuit rue de la R√©publique (2min √† pied)',
                contact_email: 'gite.trevoux@example.com',
                contact_telephone: '06 12 34 56 78',
                check_in: '16h00',
                check_out: '10h00',
                infos_pratiques: [
                    {
                        titre: 'üîë Acc√®s au Logement',
                        contenu: `
                            <p><strong>Adresse :</strong> 2 Grande Rue, 01600 Tr√©voux</p>
                            <p><strong>Code d'acc√®s :</strong></p>
                            <div class="highlight">1234A</div>
                            <p>Le bo√Ætier √† code est situ√© √† gauche de la porte d'entr√©e.</p>
                        `
                    },
                    {
                        titre: 'üì∂ WiFi',
                        contenu: `
                            <p><strong>R√©seau :</strong> Gite_Trevoux</p>
                            <div class="highlight">Mot de passe : BienvenueTrevoux2024</div>
                        `
                    },
                    {
                        titre: 'üöó Parking',
                        contenu: `
                            <p>Parking public gratuit rue de la R√©publique (2 minutes √† pied)</p>
                            <p>Places limit√©es, arrivez t√¥t le week-end.</p>
                        `
                    },
                    {
                        titre: 'üïê Horaires',
                        contenu: `
                            <p><strong>Arriv√©e :</strong> √† partir de 16h00</p>
                            <p><strong>D√©part :</strong> avant 10h00</p>
                            <p>Merci de respecter ces horaires pour permettre le m√©nage.</p>
                        `
                    },
                    {
                        titre: '‚ôªÔ∏è Tri des D√©chets',
                        contenu: `
                            <p><strong>Poubelle jaune :</strong> Recyclables (plastique, carton, m√©tal)</p>
                            <p><strong>Poubelle noire :</strong> Ordures m√©nag√®res</p>
                            <p><strong>Poubelle verte :</strong> Verre</p>
                            <p>Conteneurs situ√©s rue de la Mairie (50m)</p>
                        `
                    },
                    {
                        titre: 'üèõÔ∏è √Ä Proximit√© Imm√©diate',
                        contenu: `
                            <p>‚Ä¢ Boulangerie Chazelle (100m)</p>
                            <p>‚Ä¢ Supermarch√© Carrefour City (200m)</p>
                            <p>‚Ä¢ Pharmacie (150m)</p>
                            <p>‚Ä¢ Ch√¢teau-Fort de Tr√©voux (400m)</p>
                        `
                    },
                    {
                        titre: 'üö® Urgences',
                        contenu: `
                            <p><strong>Pompiers :</strong> 18</p>
                            <p><strong>SAMU :</strong> 15</p>
                            <p><strong>Police :</strong> 17</p>
                            <p><strong>H√¥pital le plus proche :</strong> Centre Hospitalier de Tr√©voux (1km)</p>
                        `
                    }
                ]
            },
            'Couzon': {
                nom: 'G√Æte de Couzon-au-Mont-d\'Or',
                emoji: '‚õ∞Ô∏è',
                couleur_principale: '#f093fb',
                couleur_secondaire: '#f5576c',
                adresse: '14 rue de la R√©publique, 69270 Couzon-au-Mont-d\'Or',
                code_acces: '5678B',
                wifi_nom: 'Gite_Couzon',
                wifi_mdp: 'BienvenueCouzon2024',
                parking: 'Parking priv√© derri√®re le g√Æte',
                contact_email: 'gite.couzon@example.com',
                contact_telephone: '06 98 76 54 32',
                check_in: '16h00',
                check_out: '10h00',
                infos_pratiques: [
                    {
                        titre: 'üîë Acc√®s au Logement',
                        contenu: `
                            <p><strong>Adresse :</strong> 14 rue de la R√©publique, 69270 Couzon-au-Mont-d'Or</p>
                            <p><strong>Code d'acc√®s :</strong></p>
                            <div class="highlight">5678B</div>
                            <p>Le bo√Ætier √† code est situ√© √† droite de la porte d'entr√©e.</p>
                        `
                    },
                    {
                        titre: 'üì∂ WiFi',
                        contenu: `
                            <p><strong>R√©seau :</strong> Gite_Couzon</p>
                            <div class="highlight">Mot de passe : BienvenueCouzon2024</div>
                        `
                    },
                    {
                        titre: 'üöó Parking',
                        contenu: `
                            <p><strong>Parking priv√©</strong> derri√®re le g√Æte</p>
                            <p>Acc√®s par le portail, code identique √† l'entr√©e du g√Æte.</p>
                            <p>2 places disponibles.</p>
                        `
                    },
                    {
                        titre: 'üïê Horaires',
                        contenu: `
                            <p><strong>Arriv√©e :</strong> √† partir de 16h00</p>
                            <p><strong>D√©part :</strong> avant 10h00</p>
                            <p>Merci de respecter ces horaires pour permettre le m√©nage.</p>
                        `
                    },
                    {
                        titre: '‚ôªÔ∏è Tri des D√©chets',
                        contenu: `
                            <p><strong>Poubelle jaune :</strong> Recyclables (plastique, carton, m√©tal)</p>
                            <p><strong>Poubelle noire :</strong> Ordures m√©nag√®res</p>
                            <p><strong>Poubelle verte :</strong> Verre</p>
                            <p>Conteneurs au fond de l'impasse</p>
                        `
                    },
                    {
                        titre: 'üèõÔ∏è √Ä Proximit√© Imm√©diate',
                        contenu: `
                            <p>‚Ä¢ Boulangerie (200m)</p>
                            <p>‚Ä¢ Supermarch√© Intermarch√© √† Albigny (2km)</p>
                            <p>‚Ä¢ Pharmacie √† Albigny (2km)</p>
                            <p>‚Ä¢ Sentiers de randonn√©e Mont d'Or (500m)</p>
                        `
                    },
                    {
                        titre: 'üö® Urgences',
                        contenu: `
                            <p><strong>Pompiers :</strong> 18</p>
                            <p><strong>SAMU :</strong> 15</p>
                            <p><strong>Police :</strong> 17</p>
                            <p><strong>H√¥pital le plus proche :</strong> H√¥pital Lyon Nord (8km)</p>
                        `
                    }
                ]
            }
        };
        
        // Stocker les activit√©s par g√Æte
        let activitesParGite = {
            'Tr√©voux': [],
            'Couzon': []
        };
        
        // Ouvrir la modale d'activit√©
        function ouvrirModalActivite(isModification = false, positionY = null) {
            const modal = document.getElementById('modalActivite');
            const overlay = document.getElementById('modalOverlay');
            
            modal.style.display = 'block';
            overlay.style.display = 'block';
            
            // Si une position est fournie, la modale s'affiche √† cet endroit
            if (positionY !== null) {
                modal.style.top = positionY + 'px';
                modal.style.transform = 'translate(-50%, -50%)';
            } else {
                // Sinon, centr√©e au milieu de l'√©cran
                modal.style.top = '50%';
                modal.style.transform = 'translate(-50%, -50%)';
            }
            
            const modalTitle = document.getElementById('modalTitle');
            const btnSave = document.getElementById('btnSaveActivite');
            
            if (isModification) {
                modalTitle.textContent = '‚úèÔ∏è Modifier l\'Activit√©';
                btnSave.textContent = '‚úèÔ∏è Modifier cette activit√©';
                btnSave.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else {
                modalTitle.textContent = '‚ûï Ajouter une Activit√©';
                btnSave.textContent = '‚ûï Ajouter cette activit√©';
                btnSave.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)';
            }
        }
        
        // Fermer la modale d'activit√©
        function fermerModalActivite() {
            document.getElementById('modalActivite').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            // R√©initialiser le formulaire
            document.getElementById('activite_nom').value = '';
            document.getElementById('activite_categorie').value = '';
            document.getElementById('activite_description').value = '';
            document.getElementById('activite_adresse').value = '';
            document.getElementById('activite_distance').value = '';
            document.getElementById('activite_note').value = '';
            document.getElementById('activite_avis').value = '';
            document.getElementById('activite_prix').value = '';
            document.getElementById('activite_telephone').value = '';
            document.getElementById('activite_website').value = '';
            document.getElementById('activite_type_resto').value = '';
            document.getElementById('typeRestoDiv').style.display = 'none';
            delete window.activiteEnCoursDeModification;
        }
        
        // Charger les activit√©s depuis Supabase
        // Afficher/cacher le champ type de restaurant selon la cat√©gorie
        function afficherTypeRestoSiRestaurant() {
            const categorie = document.getElementById('activite_categorie').value;
            const typeRestoDiv = document.getElementById('typeRestoDiv');
            if (categorie === 'Restaurant') {
                typeRestoDiv.style.display = 'block';
            } else {
                typeRestoDiv.style.display = 'none';
            }
        }
        
        async function chargerActivites() {
            try {
                const { data, error } = await supabase
                    .from('activites_gites')
                    .select('*')
                    .order('categorie', { ascending: true });
                
                if (error) throw error;
                
                if (data) {
                    activitesParGite = { 'Tr√©voux': [], 'Couzon': [] };
                    data.forEach(act => {
                        if (activitesParGite[act.gite]) {
                            activitesParGite[act.gite].push(act);
                        }
                    });
                    console.log('Activit√©s charg√©es:', activitesParGite);
                }
                
                // Afficher si un g√Æte est s√©lectionn√©
                const giteSelectionne = document.getElementById('decouvrir_gite')?.value;
                if (giteSelectionne) {
                    afficherActivites(giteSelectionne);
                }
            } catch (error) {
                console.error('Erreur chargement activit√©s:', error);
            }
        }
        
        // S√©lectionner un g√Æte pour "√Ä D√©couvrir"
        function selectGiteDecouvrir(gite) {
            document.getElementById('decouvrir_gite').value = gite;
            document.getElementById('selectedGiteDecouvrir').textContent = gite;
            document.getElementById('formDecouvrir').style.display = 'block';
            
            // Charger et afficher les activit√©s
            chargerActivites();
            
            // Charger automatiquement les √©v√©nements et afficher TOUT sur la carte
            setTimeout(() => {
                chargerToutSurCarte();
            }, 500);
        }
        
        // Fonction pour g√©ocoder une adresse (convertir adresse ‚Üí coordonn√©es GPS)
        async function geocodeAddress(address, gite) {
            try {
                // Si l'adresse est vide, utiliser les coordonn√©es du g√Æte
                if (!address || address.trim() === '') {
                    return gite === 'Tr√©voux' 
                        ? { lat: 45.9394, lng: 4.7728 }
                        : { lat: 45.8442, lng: 4.8365 };
                }
                
                // Utiliser Nominatim (OpenStreetMap) pour le g√©ocodage
                const encodedAddress = encodeURIComponent(address + ', France');
                
                // Ajouter un d√©lai pour respecter la politique de Nominatim (1 req/sec max)
                await new Promise(resolve => setTimeout(resolve, 1100));
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`, {
                    headers: {
                        'User-Agent': 'GestionGite/1.0 (gite.welcomehome@gmail.com)'
                    }
                });
                
                if (!response.ok) {
                    console.warn('Erreur HTTP:', response.status, 'pour', address);
                    // Utiliser coordonn√©es par d√©faut
                    return gite === 'Tr√©voux' 
                        ? { lat: 45.9394, lng: 4.7728 }
                        : { lat: 45.8442, lng: 4.8365 };
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                
                // Si le g√©ocodage √©choue, coordonn√©es par d√©faut du g√Æte
                return gite === 'Tr√©voux' 
                    ? { lat: 45.9394, lng: 4.7728 }
                    : { lat: 45.8442, lng: 4.8365 };
            } catch (error) {
                console.error('Erreur g√©ocodage:', address, error);
                return gite === 'Tr√©voux' 
                    ? { lat: 45.9394, lng: 4.7728 }
                    : { lat: 45.8442, lng: 4.8365 };
            }
        }
        
        // Fonction pour charger et afficher TOUTES les donn√©es sur la carte
        async function chargerToutSurCarte() {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) return;
            
            showNotification('üó∫Ô∏è Chargement de la carte...', 'info');
            
            // 1. Charger UNIQUEMENT les √©v√©nements
            await rechercherEvenements();
            
            // 2. Charger les activit√©s Supabase S√âPAR√âMENT pour la carte
            try {
                const { data, error } = await supabase
                    .from('activites_gites')
                    .select('*')
                    .eq('gite', gite);
                
                console.log('üìä Activit√©s charg√©es:', data ? data.length : 0);
                
                if (!error && data && data.length > 0) {
                    // Cr√©er tableau s√©par√© pour les activit√©s (pas m√©lang√© avec √©v√©nements)
                    window.allActivites = data.map(act => ({
                        titre: act.nom,
                        nom: act.nom,
                        date: null,
                        lieu: act.adresse,
                        adresse: act.adresse,
                        description: act.description,
                        lien: act.website,
                        icone: 'üìç',
                        distance: act.distance || 0,
                        lat: parseFloat(act.latitude),
                        lng: parseFloat(act.longitude),
                        note: act.note,
                        categorie: act.categorie,
                        isActivite: true  // Marqueur pour diff√©rencier des √©v√©nements
                    })).filter(a => a.lat && a.lng);  // Garder seulement ceux avec coordonn√©es
                    
                    console.log('‚úÖ Activit√©s charg√©es pour carte:', window.allActivites.length);
                }
            } catch (error) {
                console.error('Erreur chargement activit√©s:', error);
            }
            
            // 3. Afficher activit√©s dans la section d√©di√©e
            afficherActivites(gite);
            
            // R√©initialiser le filtre de distance √† 50km pour tout voir
            document.getElementById('distanceFilter').value = 50;
            updateDistanceLabel();
            
            // Afficher TOUT sur la carte (√©v√©nements + activit√©s)
            const toutSurCarte = [...window.allEvenements, ...(window.allActivites || [])];
            afficherCarteEvenements(toutSurCarte);
            filtrerEvenements();
            
            showNotification(`‚úì Carte et activit√©s charg√©es`, 'success');
        }
        
        // Rechercher automatiquement via Google Places API (simulation sans cl√© API)
        async function rechercherAutomatique(type) {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîç Filtrage en cours...', 'info');
            
            // Mapper les types de recherche vers les cat√©gories
            const typeToCategorie = {
                'restaurants': 'üçΩÔ∏è Restaurant',
                'tourist_attraction': 'üèõÔ∏è Site Touristique',
                'shopping_mall': 'üõçÔ∏è Commerce',
                'park': 'üå≥ Nature & Randonn√©e'
            };
            
            const categorieRecherchee = typeToCategorie[type];
            
            if (!categorieRecherchee) {
                showNotification('‚ö†Ô∏è Type de recherche non reconnu', 'warning');
                return;
            }
            
            // R√©cup√©rer la distance max actuelle
            const maxDistance = parseInt(document.getElementById('distanceFilter').value);
            
            // Filtrer tous les points (√©v√©nements + activit√©s) selon la cat√©gorie ET la distance
            if (window.allEvenements) {
                const pointsFiltres = window.allEvenements.filter(item => {
                    return item.categorie === categorieRecherchee && item.distance <= maxDistance;
                });
                
                console.log(`üîç Filtrage ${categorieRecherchee}:`, pointsFiltres.length, 'r√©sultats');
                
                // Mettre √† jour la carte avec les points filtr√©s
                if (pointsFiltres.length > 0) {
                    afficherCarteEvenements(pointsFiltres);
                    showNotification(`‚úì ${pointsFiltres.length} point(s) de type "${categorieRecherchee}" (‚â§${maxDistance}km)`, 'success');
                } else {
                    showNotification(`‚ÑπÔ∏è Aucun point de type "${categorieRecherchee}" √† ‚â§${maxDistance}km`, 'info');
                }
            }
            
            // R√©cup√©rer les activit√©s du g√Æte s√©lectionn√©
            const activites = activitesParGite[gite] || [];
            
            // Filtrer par cat√©gorie
            const activitesFiltrees = activites.filter(act => act.categorie === categorieRecherchee);
            
            // Afficher les r√©sultats dans la liste
            const container = document.getElementById('activitesParCategorie');
            
            if (activitesFiltrees.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <h3 style="color: #856404; margin-bottom: 10px;">Aucun r√©sultat pour "${categorieRecherchee}"</h3>
                        <p style="color: #666;">Essayez d'ajouter des activit√©s de cette cat√©gorie manuellement ci-dessous.</p>
                    </div>
                `;
                return;
                return;
            }
            
            // Afficher uniquement cette cat√©gorie
            let html = `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--primary); font-size: 1.3rem; border-bottom: 2px solid var(--border); padding-bottom: 10px; flex: 1;">
                            ${categorieRecherchee} (${activitesFiltrees.length})
                        </h3>
                        <button onclick="afficherActivites('${gite}')" class="btn" style="background: #6c757d; color: white; padding: 8px 16px; font-size: 0.9rem;">
                            üîÑ Tout Afficher
                        </button>
                    </div>
                    <div style="display: grid; gap: 15px;">
            `;
            
            activitesFiltrees.forEach(act => {
                const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) : '';
                const distanceText = act.distance ? `üìç ${act.distance} km` : '';
                const prixText = act.prix || '';
                
                html += `
                    <div style="background: #f8f9fa; border-left: 4px solid var(--primary); padding: 20px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h4 style="margin: 0; font-size: 1.1rem; color: #2C5F7D;">${act.nom}</h4>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="modifierActivite(${act.id})" title="Modifier" style="background: transparent; border: none; cursor: pointer; font-size: 1.4rem; padding: 4px 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="supprimerActivite(${act.id})" title="Supprimer" style="background: transparent; border: none; cursor: pointer; font-size: 1.4rem; padding: 4px 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        ${act.description ? `<p style="margin: 10px 0; color: #555;">${act.description}</p>` : ''}
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; font-size: 0.9rem; color: #666;">
                            ${distanceText ? `<span>${distanceText}</span>` : ''}
                            ${noteStars ? `<span>${noteStars} ${act.note}/5 ${act.avis ? `(${act.avis} avis)` : ''}</span>` : ''}
                            ${prixText ? `<span>üí∞ ${prixText}</span>` : ''}
                        </div>
                        
                        ${act.adresse ? `<p style="margin: 10px 0 5px 0; color: #666; font-size: 0.9rem;">üìç ${act.adresse}</p>` : ''}
                        ${act.telephone ? `<p style="margin: 5px 0; color: #666; font-size: 0.9rem;">üìû ${act.telephone}</p>` : ''}
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            ${act.google_maps_link ? `
                                <a href="${act.google_maps_link}" target="_blank" title="Itin√©raire Google Maps" style="background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; padding: 10px 16px; text-decoration: none; font-size: 1.2rem; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#dc2626'; this.style.color='#dc2626'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.borderColor='#ef4444'; this.style.color='#ef4444'; this.style.transform='translateY(0)'">
                                    <img src="./images/location-pin.svg" alt="Localisation" style="width: 20px; height: 20px; object-fit: contain;">
                                </a>
                            ` : ''}
                            ${act.website ? `
                                <a href="${act.website}" target="_blank" title="Site web" style="background: white; color: #3b82f6; border: 2px solid #3b82f6; border-radius: 8px; padding: 10px 16px; text-decoration: none; font-size: 1.2rem; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);" onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#1e40af'; this.style.color='#1e40af'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'; this.style.transform='translateY(0)'">
                                    <img src="./images/web-redirect.svg" alt="Web" style="width: 20px; height: 20px; object-fit: contain;">
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            container.innerHTML = html;
            
            showNotification(`‚úì ${activitesFiltrees.length} activit√©(s) trouv√©e(s) pour "${categorieRecherchee}"`, 'success');
        }
        
        // Rechercher les √©v√©nements de la semaine
        async function rechercherEvenements() {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîç Recherche d\'√©v√©nements...', 'info');
            
            const evenementsDiv = document.getElementById('evenementsListe');
            const mapDiv = document.getElementById('mapEvenements');
            
            // Obtenir la date d'ouverture de la page (aujourd'hui)
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Lundi de cette semaine
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Dimanche
            
            const dateRangeStr = `${startOfWeek.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })} au ${endOfWeek.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}`;
            document.getElementById('dateEvenements').textContent = dateRangeStr;
            
            // √âv√©nements avec coordonn√©es pour la carte
            const evenementsParGite = {
                'Tr√©voux': [
                    {
                        titre: 'March√© de Tr√©voux',
                        date: 'Tous les samedis matin',
                        lieu: 'Place de la Terrasse, Tr√©voux',
                        description: 'March√© hebdomadaire avec produits locaux, fromages, fruits et l√©gumes frais',
                        lien: 'https://www.ville-trevoux.fr',
                        icone: 'üõí',
                        distance: 0.5,
                        lat: 45.9394,
                        lng: 4.7728
                    },
                    {
                        titre: 'Visite du Ch√¢teau-Fort',
                        date: 'Du mercredi au dimanche',
                        lieu: 'Mont√©e du Ch√¢teau, Tr√©voux',
                        description: 'Monument Historique class√© en 1913. D√©couvrez l\'histoire du Parlement de Dombes',
                        lien: 'https://www.ain-tourisme.com',
                        icone: 'üè∞',
                        distance: 1,
                        lat: 45.9404,
                        lng: 4.7738
                    },
                    {
                        titre: 'Festival des Lumi√®res',
                        date: '8-12 D√©cembre 2024',
                        lieu: 'Lyon Centre (24km)',
                        description: 'Festival international de la lumi√®re - Illuminations spectaculaires dans tout Lyon',
                        lien: 'https://www.fetedeslumieres.lyon.fr',
                        icone: 'üí°',
                        distance: 24,
                        lat: 45.7640,
                        lng: 4.8357
                    },
                    {
                        titre: 'March√© de No√´l',
                        date: 'D√©cembre 2024',
                        lieu: 'Place Bellecour, Lyon (24km)',
                        description: 'L\'un des plus grands march√©s de No√´l de France avec plus de 130 chalets',
                        lien: 'https://www.lyon.fr',
                        icone: 'üéÑ',
                        distance: 24,
                        lat: 45.7578,
                        lng: 4.8320
                    }
                ],
                'Couzon': [
                    {
                        titre: 'Randonn√©es Mont d\'Or',
                        date: 'Toute l\'ann√©e',
                        lieu: 'Couzon-au-Mont-d\'Or',
                        description: 'Sentiers balis√©s avec vue panoramique sur la vall√©e de la Sa√¥ne',
                        lien: 'https://www.monts-dor.com',
                        icone: 'ü•æ',
                        distance: 0.5,
                        lat: 45.8442,
                        lng: 4.8365
                    },
                    {
                        titre: 'March√© de Couzon',
                        date: 'Tous les dimanches matin',
                        lieu: 'Place du village, Couzon',
                        description: 'March√© local avec producteurs de la r√©gion',
                        lien: 'https://www.couzon-au-mont-dor.fr',
                        icone: 'üõí',
                        distance: 0.3,
                        lat: 45.8452,
                        lng: 4.8375
                    },
                    {
                        titre: 'Festival des Lumi√®res',
                        date: '8-12 D√©cembre 2024',
                        lieu: 'Lyon Centre (15km)',
                        description: 'Festival international de la lumi√®re - Illuminations spectaculaires dans tout Lyon',
                        lien: 'https://www.fetedeslumieres.lyon.fr',
                        icone: 'üí°',
                        distance: 15,
                        lat: 45.7640,
                        lng: 4.8357
                    },
                    {
                        titre: 'Croisi√®res sur Sa√¥ne',
                        date: 'Avril √† Octobre',
                        lieu: 'Port de Couzon',
                        description: 'D√©couvrez les Monts d\'Or depuis la Sa√¥ne en bateau',
                        lien: 'https://www.navigation-saone.fr',
                        icone: '‚õµ',
                        distance: 1,
                        lat: 45.8462,
                        lng: 4.8385
                    }
                ]
            };
            
            window.allEvenements = evenementsParGite[gite] || [];
            
            if (window.allEvenements.length === 0) {
                evenementsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun √©v√©nement trouv√© pour ce g√Æte</p>';
                showNotification('‚ö†Ô∏è Aucun √©v√©nement trouv√©', 'warning');
                mapDiv.style.display = 'none';
                return;
            }
            
            // Afficher la carte
            mapDiv.style.display = 'block';
            afficherCarteEvenements(window.allEvenements);
            
            // Appliquer le filtre de distance
            filtrerEvenements();
            
            showNotification(`‚úì ${window.allEvenements.length} √©v√©nement(s) trouv√©(s)`, 'success');
        }
        
        // Fonction pour filtrer les √©v√©nements selon la distance
        function filtrerEvenements() {
            const maxDistance = parseInt(document.getElementById('distanceFilter').value);
            const evenementsFiltres = window.allEvenements.filter(e => e.distance <= maxDistance);
            
            const evenementsDiv = document.getElementById('evenementsListe');
            const gite = document.getElementById('decouvrir_gite').value;
            
            if (evenementsFiltres.length === 0) {
                evenementsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun √©v√©nement trouv√© dans ce rayon</p>';
                return;
            }
            
            let html = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <strong>üìÖ ${evenementsFiltres.length} √©v√©nement(s) autour de ${gite}</strong> (‚â§ ${maxDistance} km)<br>
                    <small style="color: #666;">Mis √† jour le ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</small>
                </div>
            `;
            
            evenementsFiltres.forEach(event => {
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">${event.icone}</span> ${event.titre}
                        </h3>
                        <p style="margin: 5px 0; opacity: 0.95; font-size: 0.95rem;"><strong>üìç</strong> ${event.lieu} <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; margin-left: 8px;">${event.distance} km</span></p>
                        <p style="margin: 5px 0; opacity: 0.95; font-size: 0.95rem;"><strong>üóìÔ∏è</strong> ${event.date}</p>
                        <p style="margin: 15px 0; line-height: 1.5;">${event.description}</p>
                        <a href="${event.lien}" target="_blank" style="background: white; color: #667eea; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            üîó Plus d'infos
                        </a>
                    </div>
                `;
            });
            
            evenementsDiv.innerHTML = html;
        }
        
        // Variables globales pour la carte
        let mapInstance = null;
        let markersLayer = null;
        let giteMarker = null;
        let filtreCategorieActive = null; // Variable pour stocker le filtre de cat√©gorie actif
        
        // Coordonn√©es des g√Ætes
        const giteCoords = {
            'Tr√©voux': { lat: 45.9396, lng: 4.7733 },
            'Couzon': { lat: 45.8439, lng: 4.8288 }
        };
        
        // Fonction pour afficher tout (r√©initialise les filtres)
        function afficherTout() {
            if (window.allEvenements && window.allEvenements.length > 0) {
                // R√©initialiser le filtre de distance
                const maxDistance = parseInt(document.getElementById('distanceFilter').value);
                const pointsFiltres = window.allEvenements.filter(e => e.distance <= maxDistance);
                
                afficherCarteEvenements(pointsFiltres);
                showNotification(`‚úì ${pointsFiltres.length} points affich√©s (‚â§${maxDistance}km)`, 'success');
            }
        }
        
        // Fonction pour afficher la carte avec les √©v√©nements
        // üé® Fonction pour obtenir l'ic√¥ne du marqueur selon la cat√©gorie
        function getMarkerIcon(item) {
            let markerUrl = './images/location-pin.svg';
            let markerColor = '#667eea';
            
            if (item.isActivite && item.categorie) {
                switch(item.categorie) {
                    case 'Restaurant':
                        markerUrl = './images/marker-restaurant.svg';
                        markerColor = '#10b981';
                        break;
                    case 'Mus√©e':
                        markerUrl = './images/marker-musee.svg';
                        markerColor = '#3b82f6';
                        break;
                    case 'Caf√©':
                        markerUrl = './images/marker-cafe.svg';
                        markerColor = '#f59e0b';
                        break;
                    case 'Parc':
                        markerUrl = './images/marker-parc.svg';
                        markerColor = '#8b5cf6';
                        break;
                    case 'H√¥tel':
                        markerUrl = './images/marker-hotel.svg';
                        markerColor = '#ec4899';
                        break;
                }
            }
            
            // Cr√©er une ic√¥ne avec l'image SVG
            const iconHtml = `<img src="${markerUrl}" alt="${item.categorie || 'Marqueur'}" style="width: 40px; height: 40px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">`;
            
            return L.divIcon({
                html: iconHtml,
                className: 'custom-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }
        
        function afficherCarteEvenements(evenements) {
            const mapContainer = document.getElementById('mapEvenements');
            
            // Filtrer les points avec des coordonn√©es valides
            let evenementsValides = evenements.filter(e => {
                const isValid = e.lat && e.lng && !isNaN(e.lat) && !isNaN(e.lng) && 
                               isFinite(e.lat) && isFinite(e.lng);
                if (!isValid) {
                    console.warn('‚ö†Ô∏è Coordonn√©es invalides pour:', e.nom || e.titre, e.lat, e.lng);
                }
                return isValid;
            });
            
            // üîç Appliquer le filtre de cat√©gorie s'il est actif
            if (filtreCategorieActive) {
                evenementsValides = evenementsValides.filter(e => 
                    e.categorie && e.categorie.toLowerCase().includes(filtreCategorieActive.toLowerCase())
                );
                console.log(`üìå Carte filtr√©e: ${evenementsValides.length} points pour "${filtreCategorieActive}"`);
            }
            
            if (evenementsValides.length === 0) {
                console.error('‚ùå Aucun point avec coordonn√©es valides');
                mapContainer.style.display = 'none';
                return;
            }
            
            console.log(`üó∫Ô∏è Affichage de ${evenementsValides.length} points sur la carte`);
            mapContainer.style.display = 'block';
            
            // V√©rifier si la carte existe d√©j√† (via l'attribut Leaflet)
            const carteExiste = mapContainer._leaflet_id !== undefined;
            
            // Si la carte n'existe pas encore, la cr√©er
            if (!carteExiste && !mapInstance) {
                try {
                    console.log('üó∫Ô∏è Cr√©ation de la carte...');
                    
                    // Cr√©er la carte Leaflet
                    mapInstance = L.map('mapEvenements', {
                        center: [46.2276, 2.2137],
                        zoom: 6
                    });
                    
                    // Ajouter les tuiles OpenStreetMap
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 18
                    }).addTo(mapInstance);
                    
                    // Cr√©er un layer group pour les marqueurs
                    markersLayer = L.layerGroup().addTo(mapInstance);
                    
                    console.log('‚úÖ Carte cr√©√©e avec succ√®s');
                } catch (error) {
                    console.error('‚ùå Erreur cr√©ation carte:', error);
                    mapContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Erreur lors du chargement de la carte</p>';
                    return;
                }
            }
            
            // Si la carte existe mais les layers pas, les recr√©er
            if (mapInstance && !markersLayer) {
                markersLayer = L.layerGroup().addTo(mapInstance);
            }
            
            if (!mapInstance || !markersLayer) {
                console.error('‚ùå Carte ou layer non disponibles');
                return;
            }
            
            // Effacer tous les marqueurs existants
            markersLayer.clearLayers();
            
            // Ajouter un marqueur pour le g√Æte s√©lectionn√©
            const giteSelectionne = document.getElementById('decouvrir_gite').value;
            if (giteSelectionne && giteCoords[giteSelectionne]) {
                const coords = giteCoords[giteSelectionne];
                const giteIconHtml = `
                    <div style="background: #ff5a5f; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 12px rgba(255,90,95,0.5); border: 4px solid white;">
                        üè†
                    </div>
                `;
                const giteIcon = L.divIcon({
                    html: giteIconHtml,
                    className: 'gite-marker',
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                });
                
                giteMarker = L.marker([coords.lat, coords.lng], { icon: giteIcon });
                giteMarker.bindPopup(`
                    <div style="text-align: center; padding: 10px;">
                        <h3 style="margin: 0; color: #ff5a5f;">üè† G√Æte ${giteSelectionne}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 0.9rem;">Point de r√©f√©rence</p>
                    </div>
                `);
                giteMarker.addTo(markersLayer);
            }
            
            // Ajouter les nouveaux marqueurs
            evenementsValides.forEach(item => {
                // Utiliser la fonction pour obtenir l'ic√¥ne appropri√©e
                const customIcon = getMarkerIcon(item);
                
                const marker = L.marker([item.lat, item.lng], { icon: customIcon });
                
                // Popup avec les informations
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #667eea; font-size: 1.1rem;">
                            ${item.titre || item.nom}
                        </h3>
                        ${item.categorie ? `<p style="margin: 5px 0; font-size: 0.85rem; display: inline-block; padding: 4px 10px; border-radius: 16px; background: #f0f4f8; color: #667eea; font-weight: 600;"><strong>üìÇ</strong> ${item.categorie}</p>` : ''}
                        <p style="margin: 8px 0; font-size: 0.9rem;"><strong>üìç</strong> ${item.lieu || item.adresse || 'Non sp√©cifi√©'}</p>
                        ${item.date ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>üóìÔ∏è</strong> ${item.date}</p>` : ''}
                        ${item.distance ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>üìè</strong> ${item.distance} km</p>` : ''}
                        ${item.description ? `<p style="margin: 10px 0; font-size: 0.85rem; line-height: 1.4;">${item.description}</p>` : ''}
                        ${item.note ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>‚≠ê</strong> ${item.note}/5</p>` : ''}
                        ${item.lien ? `<a href="${item.lien}" target="_blank" style="display: inline-block; margin-top: 10px; padding: 8px 15px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-size: 0.85rem;">üîó Plus d'infos</a>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.addTo(markersLayer);
            });
            
            // Ajuster la vue pour inclure tous les marqueurs
            if (evenementsValides.length > 0) {
                const bounds = L.latLngBounds(evenementsValides.map(e => [e.lat, e.lng]));
                mapInstance.fitBounds(bounds.pad(0.1));
            }
        }
        
        // Mettre √† jour le label de distance
        function updateDistanceLabel() {
            const distance = document.getElementById('distanceFilter').value;
            document.getElementById('distanceLabel').textContent = `‚â§ ${distance} km`;
            
            // Refiltrer les √©v√©nements et la carte si des √©v√©nements sont charg√©s
            if (window.allEvenements && window.allEvenements.length > 0) {
                const maxDistance = parseInt(distance);
                const pointsFiltres = window.allEvenements.filter(e => e.distance <= maxDistance);
                
                // Mettre √† jour la carte avec les points filtr√©s
                afficherCarteEvenements(pointsFiltres);
                
                // Mettre √† jour la liste
                filtrerEvenements();
            }
        }
        
        // Rafra√Æchir les √©v√©nements
        function refreshEvenements() {
            rechercherEvenements();
        }
        
        // Afficher tous les points sur la carte
        function afficherTout() {
            if (window.allEvenements && window.allEvenements.length > 0) {
                afficherCarteEvenements(window.allEvenements);
                filtrerEvenements();
                showNotification(`‚úì ${window.allEvenements.length} points affich√©s`, 'success');
                
                // R√©afficher toutes les activit√©s dans la liste
                const gite = document.getElementById('decouvrir_gite').value;
                if (gite) {
                    afficherActivites(gite);
                }
            } else {
                showNotification('‚ö†Ô∏è Chargez d\'abord les donn√©es en s√©lectionnant un g√Æte', 'warning');
            }
        }
        
        // Toggle du formulaire d'ajout d'activit√©
        function toggleFormAjout() {
            // Ouvrir la modale pour ajouter une activit√©
            ouvrirModalActivite(false);
        }
        
        // Ajouter une activit√© manuellement
        async function ajouterActivite() {
            const gite = document.getElementById('decouvrir_gite').value;
            const nom = document.getElementById('activite_nom').value.trim();
            const categorie = document.getElementById('activite_categorie').value;
            const description = document.getElementById('activite_description').value.trim();
            const adresse = document.getElementById('activite_adresse').value.trim();
            const distance = document.getElementById('activite_distance').value;
            const website = document.getElementById('activite_website').value.trim();
            const telephone = document.getElementById('activite_telephone').value.trim();
            const note = document.getElementById('activite_note').value;
            const avis = document.getElementById('activite_avis').value;
            const prixValue = document.getElementById('activite_prix').value;
            const typeRestaurant = document.getElementById('activite_type_resto').value.trim();
            
            if (!gite || !nom || !categorie || !adresse) {
                showNotification('‚ö†Ô∏è Remplissez les champs obligatoires (nom, cat√©gorie, adresse)', 'warning');
                return;
            }
            
            // G√©ocoder l'adresse pour obtenir les coordonn√©es GPS
            showNotification('üìç G√©ocodage de l\'adresse...', 'info');
            const coords = await geocodeAddress(adresse, gite);
            
            // Cr√©er le lien Google Maps
            const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(adresse)}`;
            
            const activite = {
                gite,
                nom,
                categorie,
                type_restaurant: typeRestaurant || null,
                description,
                adresse,
                distance: distance ? parseFloat(distance) : null,
                website,
                telephone,
                note: note ? parseFloat(note) : null,
                avis: avis ? parseInt(avis) : null,
                prix: prixValue || null,
                google_maps_link: googleMapsLink,
                latitude: coords.lat,
                longitude: coords.lng
            };
            
            try {
                // Mode MODIFICATION si un ID est stock√©
                if (window.activiteEnCoursDeModification) {
                    const { data, error } = await supabase
                        .from('activites_gites')
                        .update(activite)
                        .eq('id', window.activiteEnCoursDeModification)
                        .select();
                    
                    if (error) throw error;
                    
                    showNotification('‚úì Activit√© modifi√©e avec succ√®s !', 'success');
                    
                    // R√©initialiser le mode modification
                    delete window.activiteEnCoursDeModification;
                    
                    // Fermer la modale
                    fermerModalActivite();
                    
                    // Recharger les activit√©s
                    await chargerActivites();
                    
                } else {
                    // Mode AJOUT normal
                    activite.created_at = new Date().toISOString();
                    
                    const { data, error } = await supabase
                        .from('activites_gites')
                        .insert([activite])
                        .select();
                    
                    if (error) throw error;
                    
                    showNotification('‚úì Activit√© ajout√©e avec succ√®s !', 'success');
                    
                    // Fermer la modale apr√®s ajout
                    fermerModalActivite();
                    
                    // Recharger les activit√©s
                    await chargerActivites();
                }
                
            } catch (error) {
                console.error('Erreur activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // Afficher les activit√©s par cat√©gorie
        // Fonction d'aide pour obtenir les couleurs par cat√©gorie
        function getCategoryColor(categorie) {
            const colors = {
                'Restaurant': { badge: '#10b981', light: '#d1fae5' },
                'Mus√©e': { badge: '#3b82f6', light: '#dbeafe' },
                'Caf√©': { badge: '#f59e0b', light: '#fef3c7' },
                'Parc': { badge: '#8b5cf6', light: '#ede9fe' },
                'H√¥tel': { badge: '#ec4899', light: '#fce7f3' }
            };
            return colors[categorie] || { badge: '#667eea', light: '#e0e7ff' };
        }
        
        function afficherActivites(gite) {
            const activites = activitesParGite[gite] || [];
            const container = document.getElementById('activitesParCategorie');
            
            if (activites.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune activit√© enregistr√©e pour ce g√Æte</p>';
                return;
            }
            
            // Grouper par cat√©gorie
            const parCategorie = {};
            activites.forEach(act => {
                if (!parCategorie[act.categorie]) {
                    parCategorie[act.categorie] = [];
                }
                parCategorie[act.categorie].push(act);
            });
            
            let html = `<h3 style="color: white; font-size: 1.6rem; margin-bottom: 24px; text-align: center; padding: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">‚ú® Toutes les activit√©s √† ${gite} <span style="display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; margin-left: 8px;">${activites.length}</span></h3>`;
            
            Object.keys(parCategorie).sort().forEach(cat => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 15px; font-size: 1.1rem; padding: 12px 16px; border-radius: 8px;">
                            ${cat} (${parCategorie[cat].length})
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                `;
                
                parCategorie[cat].forEach(act => {
                    const colors = getCategoryColor(act.categorie);
                    const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) + ` ${act.note}/5` : '';
                    const avisText = act.avis ? `(${act.avis} avis)` : '';
                    const telText = act.telephone ? `üìû ${act.telephone}` : '';
                    const distanceText = act.distance ? `${act.distance} km` : '';
                    const prixText = act.prix ? `${act.prix}` : '';
                    const typeRestoText = act.type_restaurant ? `${act.type_restaurant}` : '';
                    
                    html += `
                        <div data-activite-id="${act.id}" style="background: white; border: none; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s ease; position: relative;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 10px 28px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                            <!-- Badge cat√©gorie -->
                            <div style="display: inline-block; background: ${colors.badge}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${act.categorie}
                            </div>
                            
                            <!-- Titre et boutons -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0; font-size: 1.15rem; font-weight: 700; color: #1f2937; word-wrap: break-word; font-family: 'Work Sans', sans-serif;">${act.nom}${distanceText ? ` <span style="font-size: 0.95rem; font-weight: 500; color: #6b7280;">‚Ä¢ ${distanceText}</span>` : ''}</h5>
                                </div>
                                <div style="display: flex; gap: 4px; margin-left: 12px;">
                                    <button type="button" onclick="event.preventDefault(); event.stopPropagation(); modifierActivite(${act.id});" title="Modifier" style="background: transparent; border: none; cursor: pointer; font-size: 1.3rem; transition: transform 0.2s, opacity 0.2s; opacity: 0.7; padding: 4px;" onmouseover="this.style.transform='scale(1.2)'; this.style.opacity='1'" onmouseout="this.style.transform='scale(1)'; this.style.opacity='0.7'">‚úèÔ∏è</button>
                                    <button type="button" onclick="event.preventDefault(); event.stopPropagation(); supprimerActivite(${act.id});" title="Supprimer" style="background: transparent; border: none; cursor: pointer; font-size: 1.3rem; transition: transform 0.2s, opacity 0.2s; opacity: 0.7; padding: 4px;" onmouseover="this.style.transform='scale(1.2)'; this.style.opacity='1'" onmouseout="this.style.transform='scale(1)'; this.style.opacity='0.7'">üóëÔ∏è</button>
                                </div>
                            </div>
                            
                            <!-- Adresse -->
                            ${act.adresse ? `<p style="margin: 8px 0; font-size: 0.9rem; color: #4b5563; display: flex; align-items: center; gap: 6px;"><span style="font-size: 1rem;">üìç</span> ${act.adresse}</p>` : ''}
                            
                            <!-- Description -->
                            ${act.description ? `<p style="margin: 10px 0; font-size: 0.9rem; color: #6b7280; font-style: italic; line-height: 1.5;">${act.description}</p>` : ''}
                            
                            <!-- Prix et Type Restaurant -->
                            <div style="display: flex; gap: 20px; margin: 12px 0; font-size: 0.9rem; color: #6b7280;">
                                ${prixText ? `<div><span style="font-weight: 600;">üíµ ${prixText}</span></div>` : ''}
                                ${typeRestoText ? `<div><span style="font-weight: 600;">üçΩÔ∏è ${typeRestoText}</span></div>` : ''}
                            </div>
                            
                            <!-- Note et avis -->
                            ${noteStars ? `<p style="margin: 10px 0; font-size: 0.9rem; color: #f59e0b; font-weight: 600;">${noteStars} ${avisText}</p>` : ''}
                            
                            <!-- T√©l√©phone -->
                            ${telText ? `<p style="margin: 8px 0; font-size: 0.85rem; color: #6b7280;">${telText}</p>` : ''}
                            
                            <!-- Liens d'action -->
                            <div style="display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap;">
                                ${act.google_maps_link ? `
                                    <a href="${act.google_maps_link}" target="_blank" title="Google Maps" style="background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; padding: 12px 18px; text-decoration: none; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#dc2626'; this.style.color='#dc2626'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.borderColor='#ef4444'; this.style.color='#ef4444'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.2)'; this.style.transform='translateY(0)'">
                                        <img src="./images/location-pin.svg" alt="Localisation" style="width: 24px; height: 24px; object-fit: contain;"> Itin√©raire
                                    </a>
                                ` : ''}
                                ${act.website ? `
                                    <a href="${act.website}" target="_blank" title="Site web" style="background: white; color: #3b82f6; border: 2px solid #3b82f6; border-radius: 8px; padding: 12px 18px; text-decoration: none; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);" onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#1e40af'; this.style.color='#1e40af'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.2)'; this.style.transform='translateY(0)'">
                                        <img src="./images/web-redirect.svg" alt="Web" style="width: 24px; height: 24px; object-fit: contain;"> Site
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
        }
        
        // Supprimer une activit√©
        async function supprimerActivite(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette activit√© ?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('activites_gites')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showNotification('‚úì Activit√© supprim√©e', 'success');
                await chargerActivites();
                
            } catch (error) {
                console.error('Erreur suppression activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // üéØ FILTRER LES ACTIVIT√âS PAR CAT√âGORIE
        function filtrerActivitesParCategorie(motCle) {
            const gite = document.getElementById('decouvrir_gite')?.value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionne d\'abord un g√Æte', 'warning');
                return;
            }
            
            const activites = activitesParGite[gite] || [];
            const container = document.getElementById('activitesParCategorie');
            
            // Filtrer par mot-cl√© dans la cat√©gorie
            const filtrees = activites.filter(act => 
                act.categorie.toLowerCase().includes(motCle.toLowerCase())
            );
            
            if (filtrees.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">Aucune activit√© "${motCle}" trouv√©e pour ${gite}</p>`;
                return;
            }
            
            // üó∫Ô∏è Mettre √† jour le filtre et la carte
            filtreCategorieActive = motCle;
            afficherActivitesFiltr√©es(filtrees, `${motCle} √† ${gite}`);
            
            // üìç Afficher uniquement les activit√©s filtr√©es sur la carte
            afficherCarteEvenements();
        }
        
        // üìã AFFICHER TOUTES LES ACTIVIT√âS
        function afficherToutesActivites() {
            const gite = document.getElementById('decouvrir_gite')?.value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionne d\'abord un g√Æte', 'warning');
                return;
            }
            
            const activites = activitesParGite[gite] || [];
            
            // üó∫Ô∏è R√©initialiser le filtre et afficher toutes les activit√©s
            filtreCategorieActive = null;
            afficherActivitesFiltr√©es(activites, `Toutes les activit√©s √† ${gite}`);
            
            // üìç Afficher tous les marqueurs sur la carte
            afficherCarteEvenements();
        }
        
        // üé® AFFICHER LES ACTIVIT√âS FILTR√âES
        function afficherActivitesFiltr√©es(activites, titre) {
            const container = document.getElementById('activitesParCategorie');
            
            // Grouper par cat√©gorie
            const parCategorie = {};
            activites.forEach(act => {
                if (!parCategorie[act.categorie]) {
                    parCategorie[act.categorie] = [];
                }
                parCategorie[act.categorie].push(act);
            });
            
            let html = `<h3 style="color: #2C5F7D; font-size: 1.5rem; margin-bottom: 20px; text-align: center; padding: 20px; background: #f0f4f8; border-radius: 12px;">üéØ ${titre} (${activites.length})</h3>`;
            
            Object.keys(parCategorie).sort().forEach(cat => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 15px; font-size: 1.1rem; padding: 12px 16px; border-radius: 8px;">
                            ${cat} (${parCategorie[cat].length})
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                `;
                
                parCategorie[cat].forEach(act => {
                    const colors = getCategoryColor(act.categorie);
                    const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) + ` ${act.note}/5` : '';
                    const avisText = act.avis ? `(${act.avis} avis)` : '';
                    const telText = act.telephone ? `üìû ${act.telephone}` : '';
                    const distanceText = act.distance ? `${act.distance} km` : '';
                    const prixText = act.prix ? `${act.prix}` : '';
                    const typeRestoText = act.type_restaurant ? `${act.type_restaurant}` : '';
                    
                    html += `
                        <div data-activite-id="${act.id}" style="background: white; border: none; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s ease; position: relative;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 10px 28px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                            <!-- Badge cat√©gorie -->
                            <div style="display: inline-block; background: ${colors.badge}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${act.categorie}
                            </div>
                            
                            <!-- Titre et boutons -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0; font-size: 1.15rem; font-weight: 700; color: #1f2937; word-wrap: break-word; font-family: 'Work Sans', sans-serif;">${act.nom}${distanceText ? ` <span style="font-size: 0.95rem; font-weight: 500; color: #6b7280;">‚Ä¢ ${distanceText}</span>` : ''}</h5>
                                </div>
                                <div style="display: flex; gap: 4px; margin-left: 12px;">
                                    <button type="button" onclick="event.preventDefault(); event.stopPropagation(); modifierActivite(${act.id});" title="Modifier" style="background: transparent; border: none; cursor: pointer; font-size: 1.3rem; transition: transform 0.2s, opacity 0.2s; opacity: 0.7; padding: 4px;" onmouseover="this.style.transform='scale(1.2)'; this.style.opacity='1'" onmouseout="this.style.transform='scale(1)'; this.style.opacity='0.7'">‚úèÔ∏è</button>
                                    <button type="button" onclick="event.preventDefault(); event.stopPropagation(); supprimerActivite(${act.id});" title="Supprimer" style="background: transparent; border: none; cursor: pointer; font-size: 1.3rem; transition: transform 0.2s, opacity 0.2s; opacity: 0.7; padding: 4px;" onmouseover="this.style.transform='scale(1.2)'; this.style.opacity='1'" onmouseout="this.style.transform='scale(1)'; this.style.opacity='0.7'">üóëÔ∏è</button>
                                </div>
                            </div>
                            
                            <!-- Adresse -->
                            ${act.adresse ? `<p style="margin: 8px 0; font-size: 0.9rem; color: #4b5563; display: flex; align-items: center; gap: 6px;"><span style="font-size: 1rem;">üìç</span> ${act.adresse}</p>` : ''}
                            
                            <!-- Description -->
                            ${act.description ? `<p style="margin: 10px 0; font-size: 0.9rem; color: #6b7280; font-style: italic; line-height: 1.5;">${act.description}</p>` : ''}
                            
                            <!-- Prix et Type Restaurant -->
                            <div style="display: flex; gap: 20px; margin: 12px 0; font-size: 0.9rem; color: #6b7280;">
                                ${prixText ? `<div><span style="font-weight: 600;">üíµ ${prixText}</span></div>` : ''}
                                ${typeRestoText ? `<div><span style="font-weight: 600;">üçΩÔ∏è ${typeRestoText}</span></div>` : ''}
                            </div>
                            
                            <!-- Note et avis -->
                            ${noteStars ? `<p style="margin: 10px 0; font-size: 0.9rem; color: #f59e0b; font-weight: 600;">${noteStars} ${avisText}</p>` : ''}
                            
                            <!-- T√©l√©phone -->
                            ${telText ? `<p style="margin: 8px 0; font-size: 0.85rem; color: #6b7280;">${telText}</p>` : ''}
                            
                            <!-- Liens d'action -->
                            <div style="display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap;">
                                ${act.google_maps_link ? `
                                    <a href="${act.google_maps_link}" target="_blank" title="Google Maps" style="background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; padding: 12px 18px; text-decoration: none; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#dc2626'; this.style.color='#dc2626'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.borderColor='#ef4444'; this.style.color='#ef4444'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.2)'; this.style.transform='translateY(0)'">
                                        <img src="./images/location-pin.svg" alt="Localisation" style="width: 24px; height: 24px; object-fit: contain;"> Itin√©raire
                                    </a>
                                ` : ''}
                                ${act.website ? `
                                    <a href="${act.website}" target="_blank" title="Site web" style="background: white; color: #3b82f6; border: 2px solid #3b82f6; border-radius: 8px; padding: 12px 18px; text-decoration: none; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);" onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#1e40af'; this.style.color='#1e40af'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.2)'; this.style.transform='translateY(0)'">
                                        <img src="./images/web-redirect.svg" alt="Web" style="width: 24px; height: 24px; object-fit: contain;"> Site
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
        }
        
        // Modifier une activit√©
        async function modifierActivite(id) {
            try {
                // R√©cup√©rer l'√©l√©ment de l'activit√©
                const element = document.querySelector(`[data-activite-id="${id}"]`);
                let positionY = window.innerHeight / 2; // Par d√©faut au centre
                
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Attendre un peu que le scroll soit fait
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // R√©cup√©rer la position de l'√©l√©ment
                    const rect = element.getBoundingClientRect();
                    positionY = rect.top + window.scrollY + rect.height / 2;
                }
                
                // R√©cup√©rer l'activit√© √† modifier
                const { data, error } = await supabase
                    .from('activites_gites')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Pr√©-remplir le formulaire
                document.getElementById('activite_nom').value = data.nom || '';
                document.getElementById('activite_categorie').value = data.categorie || '';
                document.getElementById('activite_description').value = data.description || '';
                document.getElementById('activite_adresse').value = data.adresse || '';
                document.getElementById('activite_distance').value = data.distance || '';
                document.getElementById('activite_note').value = data.note || '';
                document.getElementById('activite_avis').value = data.avis || '';
                document.getElementById('activite_prix').value = data.prix || '';
                document.getElementById('activite_telephone').value = data.telephone || '';
                document.getElementById('activite_website').value = data.website || '';
                
                // Afficher/cacher le champ type de restaurant selon la cat√©gorie
                afficherTypeRestoSiRestaurant();
                
                // Stocker l'ID en cours de modification
                window.activiteEnCoursDeModification = id;
                
                // Ouvrir la modale en mode modification avec position
                ouvrirModalActivite(true, positionY);
                
                showNotification('‚úèÔ∏è Mode modification activ√©', 'info');
                
            } catch (error) {
                console.error('Erreur modification activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // G√©n√©rer le guide PDF
        function genererGuideDecouverte() {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîÑ G√©n√©ration du guide en cours...', 'info');
            
            // TODO: Impl√©menter la g√©n√©ration PDF avec jsPDF
            setTimeout(() => {
                showNotification('‚úì Guide g√©n√©r√© ! (√Ä impl√©menter)', 'success');
            }, 1000);
        }
        
        // G√©n√©rer la fiche client pour une r√©servation
        async function genererFicheClient(reservation) {
            try {
                showNotification('üîÑ G√©n√©ration de la fiche client...', 'info');
                
                const giteNom = reservation.gite;
                const giteInfo = GITES_INFOS[giteNom];
                
                if (!giteInfo) {
                    showNotification('‚ùå G√Æte non trouv√©', 'error');
                    return;
                }
                
                // R√©cup√©rer les activit√©s du g√Æte
                const activites = activitesParGite[giteNom] || [];
                
                // Calculer le nombre de nuits
                const dateDebut = new Date(reservation.date_debut);
                const dateFin = new Date(reservation.date_fin);
                const nombreNuits = Math.ceil((dateFin - dateDebut) / (1000 * 60 * 60 * 24));
                
                // Formater les dates
                const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateArrivee = dateDebut.toLocaleDateString('fr-FR', optionsDate);
                const dateDepart = dateFin.toLocaleDateString('fr-FR', optionsDate);
                const dateGeneration = new Date().toLocaleDateString('fr-FR', optionsDate);
                
                // G√©n√©rer le contenu des infos pratiques
                let infosPratiquesHTML = '';
                giteInfo.infos_pratiques.forEach(info => {
                    infosPratiquesHTML += `
                        <div class="info-pratique">
                            <h3>${info.titre}</h3>
                            ${info.contenu}
                        </div>
                    `;
                });
                
                // G√©n√©rer le contenu des activit√©s group√©es par cat√©gorie
                let activitesHTML = '';
                
                if (activites.length === 0) {
                    activitesHTML = '<p style="text-align: center; padding: 40px; color: #999;">Aucune activit√© enregistr√©e pour le moment.</p>';
                } else {
                    // Grouper par cat√©gorie
                    const parCategorie = {};
                    activites.forEach(act => {
                        if (!parCategorie[act.categorie]) {
                            parCategorie[act.categorie] = [];
                        }
                        parCategorie[act.categorie].push(act);
                    });
                    
                    // G√©n√©rer le HTML par cat√©gorie
                    Object.keys(parCategorie).sort().forEach(categorie => {
                        activitesHTML += `
                            <div class="categorie-activites">
                                <h3>${categorie}</h3>
                        `;
                        
                        parCategorie[categorie].forEach(act => {
                            const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) : '';
                            
                            activitesHTML += `
                                <div class="activite-card">
                                    <h4>${act.nom}</h4>
                                    ${act.description ? `<p>${act.description}</p>` : ''}
                                    
                                    <div class="meta">
                                        ${act.distance ? `<span>üìç ${act.distance} km du g√Æte</span>` : ''}
                                        ${noteStars ? `<span>${noteStars} ${act.note}/5 ${act.avis ? `(${act.avis} avis)` : ''}</span>` : ''}
                                        ${act.prix ? `<span>üí∞ ${act.prix}</span>` : ''}
                                    </div>
                                    
                                    ${(act.adresse || act.telephone || act.website) ? `
                                        <div class="contact">
                                            ${act.adresse ? `<p>üìç ${act.adresse}</p>` : ''}
                                            ${act.telephone ? `<p>üìû ${act.telephone}</p>` : ''}
                                            ${act.website ? `<p>üåê <a href="${act.website}" target="_blank">${act.website}</a></p>` : ''}
                                            ${act.google_maps_link ? `<p>üó∫Ô∏è <a href="${act.google_maps_link}" target="_blank">Voir sur Google Maps</a></p>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        activitesHTML += '</div>';
                    });
                }
                
                // Template HTML de la fiche
                const ficheHTML = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Client - ${giteInfo.nom}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@300;400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Lato', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .fiche-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, ${giteInfo.couleur_principale} 0%, ${giteInfo.couleur_secondaire} 100%);
            color: white;
            padding: 50px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header .emoji { font-size: 4rem; display: block; margin-bottom: 20px; }
        .header .subtitle { font-size: 1.2rem; opacity: 0.95; font-weight: 300; }
        
        .reservation-info {
            background: #f8f9fa;
            padding: 30px 40px;
            border-bottom: 3px solid ${giteInfo.couleur_principale};
        }
        
        .reservation-info h2 {
            font-size: 1.8rem;
            color: ${giteInfo.couleur_principale};
            margin-bottom: 20px;
            font-family: 'Playfair Display', serif;
        }
        
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .info-item { display: flex; align-items: center; gap: 12px; }
        .info-item .icon { font-size: 1.5rem; color: ${giteInfo.couleur_principale}; }
        .info-item .label { font-weight: 700; color: #666; margin-right: 8px; }
        .info-item .value { color: #333; font-weight: 400; }
        
        .section { padding: 40px; }
        
        .section h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: ${giteInfo.couleur_principale};
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid ${giteInfo.couleur_principale};
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .section h2 .emoji { font-size: 2.5rem; }
        
        .info-pratique {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid ${giteInfo.couleur_principale};
        }
        
        .info-pratique h3 {
            color: ${giteInfo.couleur_principale};
            font-size: 1.3rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-pratique p { margin: 8px 0; padding-left: 30px; }
        
        .info-pratique .highlight {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 700;
            color: ${giteInfo.couleur_principale};
            text-align: center;
            font-size: 1.2rem;
            border: 2px dashed ${giteInfo.couleur_principale};
        }
        
        .categorie-activites { margin-bottom: 35px; }
        
        .categorie-activites h3 {
            color: ${giteInfo.couleur_principale};
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .activite-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid ${giteInfo.couleur_principale};
            page-break-inside: avoid;
        }
        
        .activite-card h4 { color: #2C5F7D; font-size: 1.2rem; margin-bottom: 10px; }
        .activite-card p { margin: 8px 0; color: #555; }
        
        .activite-card .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .activite-card .meta span { display: flex; align-items: center; gap: 5px; }
        
        .activite-card .contact {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
        }
        
        .activite-card .contact a {
            color: ${giteInfo.couleur_principale};
            text-decoration: none;
            font-weight: 600;
        }
        
        .footer {
            background: #2C3E50;
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        .footer p { margin: 8px 0; opacity: 0.9; }
        
        @media print {
            body { background: white; padding: 0; }
            .fiche-container { box-shadow: none; }
            .section { page-break-inside: avoid; }
            .no-print { display: none; }
        }
        
        .btn-print {
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${giteInfo.couleur_principale};
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .info-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
        }
    <\/style>
<\/head>
<body>
    <button class="btn-print no-print" onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
    
    <div class="fiche-container">
        <div class="header">
            <span class="emoji">${giteInfo.emoji}</span>
            <h1>${giteInfo.nom}</h1>
            <p class="subtitle">Votre s√©jour dans l'Ain</p>
        </div>
        
        <div class="reservation-info">
            <h2>üéØ Votre R√©servation</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="icon">üë§</span>
                    <span class="label">Nom :</span>
                    <span class="value">${reservation.nom || 'Non renseign√©'}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üìß</span>
                    <span class="label">Email :</span>
                    <span class="value">${reservation.email || 'Non renseign√©'}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üìÖ</span>
                    <span class="label">Arriv√©e :</span>
                    <span class="value">${dateArrivee}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üìÖ</span>
                    <span class="label">D√©part :</span>
                    <span class="value">${dateDepart}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üåô</span>
                    <span class="label">Dur√©e :</span>
                    <span class="value">${nombreNuits} nuit(s)</span>
                </div>
                <div class="info-item">
                    <span class="icon">üë•</span>
                    <span class="label">Voyageurs :</span>
                    <span class="value">${reservation.nb_voyageurs || 'Non renseign√©'} personne(s)</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2><span class="emoji">üìã</span> Informations Pratiques</h2>
            ${infosPratiquesHTML}
        </div>
        
        <div class="section" style="background: #f8f9fa;">
            <h2><span class="emoji">üó∫Ô∏è</span> √Ä D√©couvrir Autour du G√Æte</h2>
            <p style="margin-bottom: 30px; font-size: 1.1rem; color: #666;">
                Nous avons s√©lectionn√© pour vous les meilleures adresses dans un rayon de 25km.
            </p>
            ${activitesHTML}
        </div>
        
        <div class="footer">
            <p style="font-size: 1.2rem; font-weight: 700; margin-bottom: 15px;">
                Nous vous souhaitons un excellent s√©jour ! üåü
            </p>
            <p>Pour toute question : ${giteInfo.contact_email} | ${giteInfo.contact_telephone}</p>
            <p style="font-size: 0.9rem; margin-top: 15px; opacity: 0.7;">
                Document g√©n√©r√© le ${dateGeneration}
            </p>
        </div>
    </div>
</body>
</html>`;
                
                // Ouvrir dans une nouvelle fen√™tre
                const nouvelleFenetre = window.open('', '_blank');
                nouvelleFenetre.document.write(ficheHTML);
                nouvelleFenetre.document.close();
                
                showNotification('‚úì Fiche client g√©n√©r√©e !', 'success');
                
            } catch (error) {
                console.error('Erreur g√©n√©ration fiche client:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // Aper√ßu fiche client depuis l'ID de r√©servation
        async function aper√ßuFicheClient(reservationId) {
            try {
                const reservations = await getAllReservations();
                const reservation = reservations.find(r => r.id === reservationId);
                
                if (!reservation) {
                    showNotification('‚ùå R√©servation introuvable', 'error');
                    return;
                }
                
                // Fermer le modal
                const modal = document.querySelector('[onclick*="this.closest"]');
                if (modal) modal.closest('div').parentElement.remove();
                
                // G√©n√©rer la fiche
                await genererFicheClient(reservation);
                
            } catch (error) {
                console.error('Erreur aper√ßu fiche client:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        
        // Syst√®me de notifications
        function showNotification(message, type = 'info') {
            // Cr√©er ou r√©cup√©rer le conteneur de notifications
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    max-width: 400px;
                `;
                document.body.appendChild(container);
            }
            
            // Cr√©er la notification
            const notification = document.createElement('div');
            
            // Couleurs selon le type
            const colors = {
                success: '#27AE60',
                error: '#E74C3C',
                warning: '#F39C12',
                info: '#3498DB'
            };
            
            const icons = {
                success: '‚úì',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.style.cssText = `
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <span style="font-size: 1.2rem;">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;
            
            // Ajouter au conteneur
            container.appendChild(notification);
            
            // Supprimer apr√®s 3 secondes
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                    if (container.children.length === 0) {
                        container.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // Ajouter les animations CSS
        if (!document.getElementById('notification-animations')) {
            const style = document.createElement('style');
            style.id = 'notification-animations';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ==================== GOOGLE MAPS - CONFIGURATION & VARIABLES ====================
        let googleMap = null;
        let allMarkers = [];
        let googleGiteMarker = null;
        let infoWindow = null;
        let directionsService = null;
        let directionsRenderer = null;

        // Coordonn√©es des g√Ætes
        const gitesCoordinates = {
            'Tr√©voux': { lat: 45.9423, lng: 4.7681 },
            'Couzon': { lat: 45.8456, lng: 4.8234 }
        };

        // Couleurs par cat√©gorie
        const categoryColors = {
            'gite': '#FF5A5F',
            'restaurant': '#FF8C00',
            'Restaurant': '#FF8C00',
            'culture': '#9B59B6',
            'Mus√©e': '#9B59B6',
            'Ch√¢teau': '#9B59B6',
            'nature': '#27AE60',
            'Parc': '#27AE60',
            'shopping': '#3498DB',
            'Caf√©/Bar': '#3498DB',
            'H√¥tel': '#3498DB',
            'Attraction': '#3498DB'
        };

        // Ic√¥nes emoji par cat√©gorie
        const categoryIcons = {
            'gite': 'üè°',
            'restaurant': 'üçΩÔ∏è',
            'Restaurant': 'üçΩÔ∏è',
            'culture': 'üèõÔ∏è',
            'Mus√©e': 'üèõÔ∏è',
            'Ch√¢teau': 'üè∞',
            'nature': 'üå≥',
            'Parc': 'üå≥',
            'shopping': 'üõçÔ∏è',
            'Caf√©/Bar': '‚òï',
            'H√¥tel': 'üè®',
            'Attraction': 'üé™'
        };

        // Mapping des cat√©gories Supabase vers les cat√©gories du filtre
        const categoryMapping = {
            'Restaurant': 'restaurant',
            'Mus√©e': 'culture',
            'Ch√¢teau': 'culture',
            'Parc': 'nature',
            'Caf√©/Bar': 'shopping',
            'H√¥tel': 'shopping',
            'Attraction': 'nature'
        };

        // ==================== HELPER: HTML ESCAPING ====================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper pour √©chapper les attributs onclick
        function escapeForOnclick(text) {
            if (!text) return '';
            return text.replace(/'/g, '&#39;')
                       .replace(/"/g, '&quot;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;')
                       .replace(/\\/g, '\\\\');
        }

        // ==================== INITIALISATION GOOGLE MAPS ====================
        function initGoogleMap() {
            const giteInput = document.getElementById('decouvrir_gite');
            const giteActuel = giteInput ? giteInput.value : 'Tr√©voux';
            const centerCoords = gitesCoordinates[giteActuel] || gitesCoordinates['Tr√©voux'];
            
            // Cr√©er la carte
            googleMap = new google.maps.Map(document.getElementById('googleMap'), {
                center: centerCoords,
                zoom: 13,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                    position: google.maps.ControlPosition.TOP_RIGHT
                },
                streetViewControl: true,
                fullscreenControl: true,
                zoomControl: true,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "on" }]
                    }
                ]
            });
            
            // Initialiser les services
            infoWindow = new google.maps.InfoWindow();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: googleMap,
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#667eea',
                    strokeWeight: 5
                }
            });
            
            // Ajouter le marqueur du g√Æte
            ajouterMarqueurGite(giteActuel);
            
            // Charger et afficher les POIs
            chargerPOIsFromSupabase(giteActuel);
        }

        // ==================== AJOUTER LE MARQUEUR DU G√éTE ====================
        function ajouterMarqueurGite(nomGite) {
            const coords = gitesCoordinates[nomGite];
            if (!coords) return;
            
            // Supprimer l'ancien marqueur du g√Æte s'il existe
            if (googleGiteMarker) {
                googleGiteMarker.setMap(null);
            }
            
            googleGiteMarker = new google.maps.Marker({
                position: coords,
                map: googleMap,
                title: `üè° G√Æte ${nomGite}`,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 14,
                    fillColor: categoryColors.gite,
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3
                },
                zIndex: 1000,
                animation: google.maps.Animation.DROP
            });
            
            googleGiteMarker.addListener('click', () => {
                infoWindow.setContent(`
                    <div style="padding: 15px; max-width: 280px;">
                        <h3 style="margin: 0 0 10px 0; color: ${categoryColors.gite}; font-size: 1.2rem;">
                            üè° G√Æte ${nomGite}
                        </h3>
                        <p style="margin: 5px 0; color: #666;"><strong>üìç Votre point de d√©part</strong></p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #999;">
                            Cliquez sur un point d'int√©r√™t pour calculer l'itin√©raire
                        </p>
                    </div>
                `);
                infoWindow.open(googleMap, googleGiteMarker);
            });
        }

        // ==================== CHARGER LES POIs DEPUIS SUPABASE ====================
        async function chargerPOIsFromSupabase(giteActuel) {
            // Effacer tous les anciens marqueurs POI
            allMarkers.forEach(marker => marker.setMap(null));
            allMarkers = [];
            
            try {
                // R√©cup√©rer les donn√©es depuis Supabase
                const { data, error } = await supabase
                    .from('activites_gites')
                    .select('*')
                    .eq('gite', giteActuel)
                    .order('type', { ascending: true });
                
                if (error) throw error;
                
                const pois = data || [];
                
                // Ajouter chaque POI sur la carte
                pois.forEach(poi => {
                    ajouterMarqueurPOI(poi, giteActuel);
                });
                
                // Afficher la liste
                afficherListePOIs(pois);
            } catch (error) {
                console.error('Erreur chargement POIs:', error);
                afficherListePOIs([]);
            }
        }

        // ==================== AJOUTER UN MARQUEUR POI ====================
        function ajouterMarqueurPOI(poi, giteActuel) {
            if (!poi.lat || !poi.lng) return;
            
            const category = poi.type || poi.categorie || 'Attraction';
            const filterCategory = categoryMapping[category] || 'shopping';
            
            const marker = new google.maps.Marker({
                position: { 
                    lat: parseFloat(poi.lat), 
                    lng: parseFloat(poi.lng) 
                },
                map: googleMap,
                title: poi.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 11,
                    fillColor: categoryColors[category] || '#999',
                    fillOpacity: 0.95,
                    strokeColor: '#fff',
                    strokeWeight: 2
                },
                animation: google.maps.Animation.DROP
            });
            
            // Stocker les donn√©es du POI dans le marqueur
            marker.poiData = poi;
            marker.poiCategory = filterCategory;
            
            // √âv√©nement click sur le marqueur
            marker.addListener('click', () => {
                const iconEmoji = categoryIcons[category] || 'üìç';
                const color = categoryColors[category] || '#999';
                
                // √âchapper toutes les donn√©es utilisateur
                const safeName = escapeHtml(poi.name);
                const safeDescription = escapeHtml(poi.description);
                const safePhone = escapeHtml(poi.phone);
                const safeWebsite = escapeHtml(poi.website);
                const safeNameForOnclick = escapeForOnclick(poi.name);
                
                const contentHTML = `
                    <div style="padding: 15px; max-width: 320px;">
                        <h3 style="margin: 0 0 10px 0; color: ${color}; font-size: 1.1rem;">
                            ${iconEmoji} ${safeName}
                        </h3>
                        ${poi.description ? `<p style="margin: 8px 0; color: #666; line-height: 1.5;">${safeDescription}</p>` : ''}
                        <div style="margin: 10px 0; display: flex; flex-direction: column; gap: 5px;">
                            ${poi.distance_km ? `<div style="color: #555;"><strong>üìç Distance:</strong> ${poi.distance_km} km</div>` : ''}
                            ${poi.phone ? `<div style="color: #555;"><strong>üìû:</strong> ${safePhone}</div>` : ''}
                            ${poi.website ? `<div><a href="${safeWebsite}" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;">üåê Site web</a></div>` : ''}
                            ${poi.rating ? `<div style="color: #555;"><strong>‚≠ê Note:</strong> ${poi.rating}/5</div>` : ''}
                        </div>
                        <button 
                            onclick="calculerItineraire(${poi.lat}, ${poi.lng}, '${safeNameForOnclick}')" 
                            style="margin-top: 12px; padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; font-size: 0.95rem;">
                            üöó Itin√©raire depuis le g√Æte
                        </button>
                    </div>
                `;
                
                infoWindow.setContent(contentHTML);
                infoWindow.open(googleMap, marker);
            });
            
            allMarkers.push(marker);
        }

        // ==================== CALCULER ITIN√âRAIRE ====================
        function calculerItineraire(destLat, destLng, nomDestination) {
            const giteInput = document.getElementById('decouvrir_gite');
            const giteActuel = giteInput ? giteInput.value : 'Tr√©voux';
            const origin = gitesCoordinates[giteActuel];
            const destination = { lat: parseFloat(destLat), lng: parseFloat(destLng) };
            
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    const route = result.routes[0].legs[0];
                    const message = `üöó Itin√©raire calcul√© vers ${nomDestination}\n\n` +
                                  `üìç Distance: ${route.distance.text}\n` +
                                  `‚è±Ô∏è Dur√©e estim√©e: ${route.duration.text}`;
                    
                    showToast(message, 'success');
                } else {
                    showToast('‚ùå Impossible de calculer l\'itin√©raire: ' + status, 'error');
                }
            });
        }

        // ==================== CENTRER SUR LE G√éTE ====================
        function centrerCarteGite() {
            const giteInput = document.getElementById('decouvrir_gite');
            const giteActuel = giteInput ? giteInput.value : 'Tr√©voux';
            const coords = gitesCoordinates[giteActuel];
            
            if (coords && googleMap) {
                googleMap.panTo(coords);
                googleMap.setZoom(13);
                
                // Effacer l'itin√©raire s'il y en a un
                if (directionsRenderer) {
                    directionsRenderer.setDirections({routes: []});
                }
                
                showToast('üìç Carte recentr√©e sur le g√Æte', 'info');
            }
        }

        // ==================== FILTRER PAR CAT√âGORIE ====================
        function filterMapByCategory() {
            const filter = document.getElementById('mapCategoryFilter').value;
            
            allMarkers.forEach(marker => {
                if (filter === 'all') {
                    marker.setVisible(true);
                } else {
                    marker.setVisible(marker.poiCategory === filter);
                }
            });
            
            const categoryName = filter === 'all' ? 'toutes les cat√©gories' : filter;
            showToast(`üîç Filtrage: ${categoryName}`, 'info');
        }

        // ==================== AFFICHER LA LISTE DES POIs ====================
        function afficherListePOIs(pois) {
            const container = document.getElementById('poiListContainer');
            if (!container) return;
            
            if (pois.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: #999; padding: 40px; font-size: 1.1rem;">
                        üì≠ Aucun point d'int√©r√™t enregistr√© pour ce g√Æte
                    </p>
                `;
                return;
            }
            
            const html = pois.map(poi => {
                const category = poi.type || poi.categorie || 'Attraction';
                const iconEmoji = categoryIcons[category] || 'üìç';
                const color = categoryColors[category] || '#999';
                
                // √âchapper toutes les donn√©es utilisateur
                const safeName = escapeHtml(poi.name);
                const safeDescription = escapeHtml(poi.description);
                const safePhone = escapeHtml(poi.phone);
                const safeWebsite = escapeHtml(poi.website);
                const safeNameForOnclick = escapeForOnclick(poi.name);
                
                return `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid ${color}; transition: all 0.3s;" 
                         onmouseover="this.style.background='#e9ecef'; this.style.transform='translateX(5px)';" 
                         onmouseout="this.style.background='#f8f9fa'; this.style.transform='translateX(0)';">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 250px;">
                                <h4 style="margin: 0 0 10px 0; color: ${color}; font-size: 1.1rem;">
                                    ${iconEmoji} ${safeName}
                                </h4>
                                ${poi.description ? `<p style="margin: 5px 0; color: #666; line-height: 1.6;">${safeDescription}</p>` : ''}
                                <div style="display: flex; gap: 15px; margin-top: 12px; flex-wrap: wrap; font-size: 0.9rem; color: #555;">
                                    ${poi.distance_km ? `<span><strong>üìç</strong> ${poi.distance_km} km</span>` : ''}
                                    ${poi.phone ? `<span><strong>üìû</strong> ${safePhone}</span>` : ''}
                                    ${poi.website ? `<a href="${safeWebsite}" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;"><strong>üåê</strong> Site web</a>` : ''}
                                    ${poi.rating ? `<span><strong>‚≠ê</strong> ${poi.rating}/5</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-direction: column;">
                                <button onclick="zoomOnPOI(${poi.lat}, ${poi.lng}, '${safeNameForOnclick}')" 
                                    style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap; font-weight: 600;">
                                    üîç Voir sur la carte
                                </button>
                                <button onclick="calculerItineraire(${poi.lat}, ${poi.lng}, '${safeNameForOnclick}')" 
                                    style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap; font-weight: 600;">
                                    üöó Itin√©raire
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ==================== ZOOMER SUR UN POI ====================
        function zoomOnPOI(lat, lng, name) {
            const position = { lat: parseFloat(lat), lng: parseFloat(lng) };
            googleMap.panTo(position);
            googleMap.setZoom(16);
            
            // Trouver le marqueur correspondant et d√©clencher son click
            const marker = allMarkers.find(m => 
                m.getPosition().lat() === position.lat && 
                m.getPosition().lng() === position.lng
            );
            
            if (marker) {
                google.maps.event.trigger(marker, 'click');
            }
            
            showToast(`üîç Zoom sur ${name}`, 'info');
        }

        // ==================== MODAL ITIN√âRAIRE ====================
        function afficherItineraireModal() {
            showToast('üí° Cliquez sur un point d\'int√©r√™t sur la carte pour calculer l\'itin√©raire !', 'info');
        }

        // ==================== TOAST NOTIFICATION ====================
        function showToast(message, type = 'info') {
            // Chercher un toast existant ou en cr√©er un
            let toast = document.getElementById('mapToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'mapToast';
                document.body.appendChild(toast);
            }
            
            const colors = {
                'success': '#27ae60',
                'error': '#e74c3c',
                'info': '#3498db'
            };
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                font-weight: 500;
                animation: slideInRight 0.3s ease;
            `;
            
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, 4000);
        }

        // Ajouter les animations CSS pour les toasts
        const styleToast = document.createElement('style');
        styleToast.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(styleToast);

        // ==================== √âV√âNEMENT: Changement de g√Æte ====================
        // L'√©v√©nement sera g√©r√© par la fonction selectGiteDecouvrir existante
        // qui sera modifi√©e pour recharger la carte Google Maps
        
    </script>
    
    <!-- Chargement dynamique des onglets -->
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const tabFiles = {
            'tab-gestion': '/tabs/tab-gestion.html',
            'tab-reservations': '/tabs/tab-reservations.html',
            'tab-archives': '/tabs/tab-archives.html',
            'tab-statistiques': '/tabs/tab-statistiques.html',
            'tab-charges': '/tabs/tab-charges.html',
            'tab-menage': '/tabs/tab-menage.html',
            'tab-infos-gites': '/tabs/tab-infos-gites.html',
            'tab-decouvrir': '/tabs/tab-decouvrir.html',
            'tab-sauvegarde': '/tabs/tab-sauvegarde.html',
        };
        
        // Charger tous les fragments d'onglets
        const loadPromises = Object.entries(tabFiles).map(([tabId, file]) => {
            return fetch(file)
                .then(r => r.text())
                .then(html => {
                    const container = document.getElementById(tabId);
                    if (container) container.innerHTML = html;
                })
                .catch(err => console.error(`Erreur chargement ${file}:`, err));
        });
        
        // Une fois tous les onglets charg√©s
        await Promise.all(loadPromises);
        console.log('‚úÖ Tous les onglets sont charg√©s');
        
        // Attacher les event listeners aux boutons
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = btn.getAttribute('data-tab');
                if (tab && typeof window.switchTab === 'function') {
                    window.switchTab(tab);
                }
            });
        });
        
        // Activer l'onglet R√©servations par d√©faut
        const firstTab = document.querySelector('[data-tab="reservations"]');
        if (firstTab && typeof window.switchTab === 'function') {
            window.switchTab('reservations');
            firstTab.classList.add('active');
        }
    });
    </script>
</body>
</html>
