<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion gites</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Scripts modulaires de l'application -->
    <script src="js/shared-config.js"></script>
    <script src="js/shared-utils.js"></script>
    <script src="js/supabase-operations.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/sync-ical.js"></script>
    <script src="js/statistiques.js"></script>
    <script src="js/menage.js"></script>
    <script src="js/decouvrir.js"></script>
    <script src="js/reservations.js"></script>
    <script src="js/archives.js"></script>
    <script src="js/fiscalite-v2.js?v=1735863600"></script>
    <script src="js/infos-gites.js"></script>
    <script src="js/fiche-client-interactive.js" type="module"></script>
    <script src="js/fiche-client.js" type="module"></script>
    <script src="js/widget-horaires-clients.js" type="module"></script>
    <script src="js/faq.js" type="module"></script>
    <script src="js/fiches-clients.js"></script>
    
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Leaflet pour la carte interactive -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            color: #1a252f;
            font-weight: 900;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 1;
            font-weight: 500;
            color: #1a252f;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Variables CSS */
        :root {
            --primary: #2C5F7D;
            --primary-dark: #1a3a4d;
            --accent: #E8A87C;
            --danger: #E74C3C;
            --success: #27AE60;
            --warning: #F39C12;
            --trevoux: #667eea;
            --couzon: #f093fb;
            --text-dark: #2C3E50;
            --border: #e2e8f0;
            --bg-light: #f8f9fa;
        }
        
        .nav-tab {
            padding: 15px 30px;
            background: white;
            border: 2px solid transparent;
            border-radius: 12px;
            color: #2c3e50;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Work Sans', sans-serif;
            font-size: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .nav-tab:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        
        .nav-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Reste du CSS compact√© conserv√© tel quel pour ne pas casser */
        .main-grid{display:grid;grid-template-columns:400px 1fr;gap:30px;margin-bottom:30px;}@media (max-width:1200px){.main-grid{grid-template-columns:1fr;}}.card{background:white;border-radius:20px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,0.15);}.card-header{display:flex;align-items:center;gap:15px;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid var(--border);}.card-icon{font-size:2.5rem;}.card-title{font-family:'Playfair Display',serif;font-size:1.8rem;color:var(--primary);}.form-group{margin-bottom:20px;}label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-dark);font-size:0.95rem;}input,select,textarea{width:100%;padding:14px 18px;border:2px solid #e2e8f0;border-radius:12px;font-size:1rem;font-family:'Work Sans',sans-serif;transition:all 0.3s ease;background:#fafafa;box-shadow:0 1px 3px rgba(0,0,0,0.05);}input:disabled{background:#f0f0f0;cursor:not-allowed;}input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);background:white;box-shadow:0 0 0 4px rgba(102,126,234,0.1),0 2px 8px rgba(0,0,0,0.08);}input::placeholder,textarea::placeholder{color:#94a3b8;font-style:italic;}.form-control{border-radius:12px;}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;}.btn{width:100%;padding:15px;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;font-family:'Work Sans',sans-serif;display:flex;align-items:center;justify-content:center;gap:10px;}.btn:disabled{opacity:0.5;cursor:not-allowed;}.btn-primary{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;}.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(44,95,125,0.4);}.btn-secondary{background:linear-gradient(135deg,var(--accent) 0%,#D89968 100%);color:white;margin-top:10px;}.btn-sync{background:linear-gradient(135deg,#3498DB 0%,#2874A6 100%);color:white;margin-top:10px;}.btn-sync:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(52,152,219,0.4);}.btn-danger{background:linear-gradient(135deg,var(--danger) 0%,#C0392B 100%);color:white;}.btn-warning{background:linear-gradient(135deg,var(--warning) 0%,#E67E22 100%);color:white;}.btn-menage{background:linear-gradient(135deg,#27AE60 0%,#229954 100%);color:white;margin-top:10px;}.btn-menage:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(39,174,96,0.4);}.menage-item{background:#f0f8ff;padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid #27AE60;}.menage-date{font-weight:700;color:var(--primary);margin-bottom:5px;}.menage-detail{font-size:0.95rem;color:#666;}.charges-list{margin-top:20px;}.charge-item{background:var(--bg-light);padding:15px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}.charge-info{flex:1;}.charge-name{font-weight:600;color:var(--primary);}.charge-amount{font-size:1.2rem;font-weight:700;color:var(--danger);}.btn-small{padding:8px 15px;font-size:0.9rem;width:auto;}.stats-section{background:white;border-radius:20px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,0.15);margin-bottom:30px;}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}.stat-item{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:25px;border-radius:15px;text-align:center;color:white;}.stat-value{font-size:2.5rem;font-weight:700;margin-bottom:5px;}.stat-label{font-size:0.9rem;opacity:0.95;}.chart-container{margin-top:30px;height:350px;}.gite-section{margin-bottom:30px;}.gite-header{font-family:'Playfair Display',serif;font-size:1.5rem;padding:15px 20px;border-radius:12px;margin-bottom:15px;color:white;display:flex;align-items:center;gap:10px;}.gite-header.trevoux{background:linear-gradient(135deg,var(--trevoux) 0%,#667eea 100%);}.gite-header.couzon{background:linear-gradient(135deg,var(--couzon) 0%,#f5576c 100%);}.planning-container{width:100%;padding:20px;}.planning-weeks{display:flex;flex-direction:column;gap:30px;}.week-block{background:white;border-radius:15px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);}.week-header-unique{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);padding:12px;text-align:center;color:white;}.week-number-big{font-weight:700;font-size:1.2rem;font-family:'Playfair Display',serif;margin-bottom:3px;}.week-dates-small{font-size:0.85rem;opacity:0.95;}.week-content-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:3px solid var(--primary);}@media (max-width:1024px){.week-content-grid{grid-template-columns:1fr;}}.gite-column-inline{padding:0;border-right:2px solid var(--border);}.gite-column-inline:last-child{border-right:none;}.gite-label{padding:15px;text-align:center;font-weight:700;font-size:1.1rem;color:white;}.gite-label.trevoux-label{background:linear-gradient(135deg,var(--trevoux) 0%,#667eea 100%);}.gite-label.couzon-label{background:linear-gradient(135deg,var(--couzon) 0%,#f5576c 100%);}.week-reservation{padding:15px;border-bottom:1px solid var(--border);}.week-reservation:last-child{border-bottom:none;}.week-reservation.trevoux{background:rgba(102,126,234,0.05);}.week-reservation.couzon{background:rgba(240,147,251,0.05);}.week-empty{padding:40px 20px;text-align:center;color:#999;font-style:italic;background:var(--bg-light);}.gite-column{background:var(--bg-light);border-radius:15px;overflow:hidden;}.gite-header.trevoux-header{background:linear-gradient(135deg,var(--trevoux) 0%,#667eea 100%);padding:20px;text-align:center;color:white;}.gite-header.couzon-header{background:linear-gradient(135deg,var(--couzon) 0%,#f5576c 100%);padding:20px;text-align:center;color:white;}.gite-header h3{margin:0;font-size:1.5rem;font-family:'Playfair Display',serif;}.week-reservation-name{font-weight:600;color:var(--primary);margin-bottom:5px;}.week-reservation-details{font-size:0.85rem;color:#666;}.month-group{margin-bottom:20px;}.month-title{font-weight:700;font-size:1.1rem;color:var(--primary);margin-bottom:10px;padding:10px 15px;background:var(--bg-light);border-radius:8px;text-transform:uppercase;}.cleaning-week-table{width:100%;margin-bottom:30px;border-radius:15px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);}.cleaning-week-header{background:linear-gradient(135deg,#0f172a 0%,#1f2937 100%);color:white;padding:15px;text-align:center;font-weight:700;font-size:1.1rem;}.cleaning-week-body{display:grid;grid-template-columns:1fr 1fr;gap:0;border:1px solid #e5e7eb;}.cleaning-column{padding:0;}.cleaning-column-header{padding:15px;text-align:center;font-weight:700;font-size:1rem;color:white;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}.cleaning-column-header.couzon{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);}.cleaning-item{padding:15px;border-bottom:1px solid #e5e7eb;min-height:80px;display:flex;flex-direction:column;gap:8px;}
        
        /* Styles additionnels pour modals, toast, etc. */
        .modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;}.modal.show{display:flex;}.modal-content{background:white;border-radius:20px;padding:40px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;}.toast{position:fixed;bottom:30px;right:30px;background:var(--success);color:white;padding:20px 30px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:10000;display:none;align-items:center;gap:15px;font-weight:600;}.toast.show{display:flex;animation:slideIn 0.3s ease;}.validation-status{display:inline-block;width:24px;height:24px;border-radius:50%;text-align:center;line-height:24px;font-size:0.9rem;}.validation-status.validated{background:#27ae60;color:white;}.validation-status.pending{background:#ff9800;color:white;}.validation-status.notvalidated{background:#e74c3c;color:white;}
    </style>
</head>
<body>
    <!-- Cadre bouton commit info -->
    <div style="position: fixed; top: 10px; left: 10px; z-index: 1000;">
        <div style="display: inline-block; position: relative;">
            <button id="commitInfoBtn" style="padding: 8px 16px; border-radius: 8px; background: #1976d2; color: white; border: none; cursor: pointer; font-weight: bold;">
                üìù Dernier commit
            </button>
            <div id="commitInfoTooltip" style="display: none; position: absolute; top: 110%; left: 0; background: #fff; color: #222; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 12px; min-width: 320px; font-size: 0.95em;">
                <div style="text-align: center; color: #999;">Chargement...</div>
            </div>
        </div>
    </div>
    <script>
    const btn = document.getElementById('commitInfoBtn');
    const tooltip = document.getElementById('commitInfoTooltip');
    
    // Afficher/masquer au survol
    btn.addEventListener('mouseenter', () => { tooltip.style.display = 'block'; });
    btn.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });
    
    // Charger le dernier commit depuis Supabase
    async function loadLastCommit() {
        try {
            // Attendre que Supabase soit charg√©
            if (typeof window.supabase === 'undefined') {
                await new Promise(resolve => {
                    const checkSupabase = setInterval(() => {
                        if (typeof window.supabaseClient !== 'undefined') {
                            clearInterval(checkSupabase);
                            resolve();
                        }
                    }, 100);
                });
            }
            
            const supabase = window.supabaseClient;
            
            const { data, error } = await supabase
                .from('commits_log')
                .select('*')
                .order('commit_date', { ascending: false })
                .limit(1);
            
            if (error) {
                console.error('Erreur chargement commit:', error);
                tooltip.innerHTML = '<div style="color: #e74c3c;">‚ùå Erreur de chargement</div>';
                return;
            }
            
            if (data && data.length > 0) {
                const commit = data[0];
                const date = new Date(commit.commit_date);
                const dateStr = date.toLocaleString('fr-FR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                tooltip.innerHTML = `
                    <strong>üìå Commit :</strong> ${commit.commit_ref}<br>
                    <strong>üìÖ Date :</strong> ${dateStr}<br>
                    <strong>üí¨ R√©sum√© :</strong><br>
                    <div style="margin-top: 6px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 0.9em;">
                        ${commit.resume}
                    </div>
                `;
            } else {
                tooltip.innerHTML = '<div style="color: #999;">Aucun commit enregistr√©</div>';
            }
        } catch (err) {
            console.error('Erreur:', err);
            tooltip.innerHTML = '<div style="color: #e74c3c;">‚ùå Erreur</div>';
        }
    }
    
    // Charger au d√©marrage
    loadLastCommit();
    // Chargement dynamique des onglets
    document.addEventListener('DOMContentLoaded', function() {
        const tabFiles = {
            'tab-dashboard': 'tabs/tab-dashboard.html',
            'tab-gestion': 'tabs/tab-gestion.html',
            'tab-reservations': 'tabs/tab-reservations.html',
            'tab-archives': 'tabs/tab-archives.html',
            'tab-statistiques': 'tabs/tab-statistiques.html',
            'tab-charges': 'tabs/tab-fiscalite-v2.html',
            'tab-menage': 'tabs/tab-menage.html',
            'tab-infos-gites': 'tabs/tab-infos-gites.html',
            'tab-decouvrir': 'tabs/tab-decouvrir.html',
            'tab-faq': 'tabs/tab-faq.html',
        };
        for (const [tabId, file] of Object.entries(tabFiles)) {
            fetch(file)
                .then(r => r.text())
                .then(html => {
                    document.getElementById(tabId).innerHTML = html;
                });
        }
    });
    </script>
    </body>
    <div class="container">
        <header style="position: relative;">
            <!-- Menu Actions en haut √† droite -->
            <div style="position: absolute; top: 0; right: 0;">
                <select onchange="handleQuickAction(this.value); this.value='';" style="padding: 12px 16px; border-radius: 10px; background: rgba(255,255,255,0.25); color: white; border: 2px solid rgba(255,255,255,0.4); font-weight: 600; cursor: pointer; font-size: 0.95rem; font-family: 'Work Sans', sans-serif; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <option value="" style="background: #1f2937; color: white;">‚öôÔ∏è Actions</option>
                    <option value="ical" style="background: #1f2937; color: white;">‚öôÔ∏è Config iCal</option>
                    <option value="archives" style="background: #1f2937; color: white;">üì¶ Archives</option>
                </select>
            </div>
            
            <svg width="48" height="48" viewBox="0 0 48 48" style="display: inline-block; vertical-align: middle; margin-right: 12px;">
                <rect x="4" y="20" width="18" height="24" rx="2" fill="#667eea" opacity="0.8"/>
                <rect x="26" y="12" width="18" height="32" rx="2" fill="#764ba2" opacity="0.9"/>
                <circle cx="13" cy="28" r="2" fill="white" opacity="0.6"/>
                <circle cx="13" cy="36" r="2" fill="white" opacity="0.6"/>
                <circle cx="35" cy="20" r="2" fill="white" opacity="0.6"/>
                <circle cx="35" cy="28" r="2" fill="white" opacity="0.6"/>
                <circle cx="35" cy="36" r="2" fill="white" opacity="0.6"/>
            </svg>
            <h1 style="display: inline-block; vertical-align: middle;">Gestion g√Ætes</h1>
            <p class="subtitle">Tr√©voux & Couzon - Synchronisation iCal automatique</p>
        </header>
        
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab" data-tab="dashboard">üìä Tableau de Bord</button>
            <button class="nav-tab" data-tab="gestion" style="display:none;">‚öôÔ∏è Gestion iCal</button>
            <button class="nav-tab" data-tab="reservations">üìù R√©servations</button>
            <button class="nav-tab" data-tab="statistiques">üìä Statistiques</button>
            <button class="nav-tab" data-tab="charges">ÔøΩ Fiscalit√© LMP</button>
            <button class="nav-tab" data-tab="menage">
                üßπ Planning M√©nage
                <span id="cleaning-notif-badge" style="display:none; background:#e74c3c; color:white; border-radius:50%; padding:2px 6px; margin-left:5px; font-size:0.8em; font-weight:bold;">0</span>
            </button>
            <button class="nav-tab" data-tab="infos-gites">üìù Infos Pratiques</button>
            <button class="nav-tab" data-tab="fiches-clients">üìÑ Fiches Clients</button>
            <button class="nav-tab" data-tab="decouvrir">üó∫Ô∏è √Ä D√©couvrir</button>
            <button class="nav-tab" data-tab="faq">‚ùì FAQ</button>
        </div>
        

        <!-- Conteneurs dynamiques pour chaque onglet -->
        <div id="tab-dashboard" class="tab-content"></div>
        <div id="tab-gestion" class="tab-content"></div>
        <div id="tab-reservations" class="tab-content"></div>
        <div id="tab-archives" class="tab-content"></div>
        <div id="tab-faq" class="tab-content"></div>
        <div id="tab-statistiques" class="tab-content"></div>
        <div id="tab-charges" class="tab-content"></div>
        <div id="tab-menage" class="tab-content"></div>
        <div id="tab-infos-gites" class="tab-content"></div>
        <div id="tab-fiches-clients" class="tab-content"></div>
        <div id="tab-decouvrir" class="tab-content"></div>
    </div>
    
        </div>
    </div>
    
    <!-- Modal √âdition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="card-header">
                <span class="card-icon">‚úèÔ∏è</span>
                <h2 class="card-title">Modifier R√©servation</h2>
            </div>
            
            <form id="editForm">
                <input type="hidden" id="editId">
                
                <div class="form-group">
                    <label>Nom <span class="required">*</span></label>
                    <input type="text" id="editNom">
                </div>
                
                <div class="form-group">
                    <label>üì± T√©l√©phone</label>
                    <input type="tel" id="editTelephone" placeholder="+33 6 12 34 56 78">
                </div>
                
                <div class="form-group">
                    <label>Provenance</label>
                    <input type="text" id="editProvenance">
                </div>
                
                <div class="form-group">
                    <label>Nb Personnes</label>
                    <input type="number" id="editNbPersonnes" min="1">
                </div>
                
                <div class="form-group">
                    <label>Montant (‚Ç¨) <span class="required">*</span></label>
                    <input type="number" id="editMontant" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Acompte (‚Ç¨)</label>
                    <input type="number" id="editAcompte" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Statut paiement</label>
                    <select id="editPaiement">
                        <option value="En attente">En attente</option>
                        <option value="Partiellement pay√©">Partiellement pay√©</option>
                        <option value="Pay√©">Pay√©</option>
                        <option value="Annul√©">Annul√©</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span>‚úì</span> Enregistrer
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <span style="font-size: 1.5rem;">‚úì</span>
        <span id="toastMessage"></span>
    </div>

    <!-- Modal R√®gles M√©nage -->
    <div id="rulesModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="card-header" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white;">
                <span class="card-icon">üìã</span>
                <h2 class="card-title">R√®gles de Gestion du Planning M√©nage</h2>
            </div>
            
            <div style="padding: 20px;">
                <h3 style="color: #3498db; margin-bottom: 15px;">üéØ Priorit√©s</h3>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li><strong>Priorit√© 1 :</strong> M√©nages entre r√©servations (m√™me jour)</li>
                    <li><strong>Priorit√© 2 :</strong> M√©nages de fin de p√©riode (d√©part sans nouvelle r√©servation)</li>
                    <li><strong>Priorit√© 3 :</strong> M√©nages d'entretien hebdomadaire si disponible</li>
                </ul>

                <h3 style="color: #e74c3c; margin-bottom: 15px;">‚ö†Ô∏è Contraintes</h3>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>Pas de m√©nage les dimanches (sauf urgence)</li>
                    <li>Pas de m√©nage les jours f√©ri√©s</li>
                    <li>Temps minimum entre m√©nages : 2h</li>
                    <li>Maximum 3 m√©nages par jour pour la soci√©t√©</li>
                </ul>

                <h3 style="color: #27ae60; margin-bottom: 15px;">‚úÖ Validation Soci√©t√©</h3>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>La soci√©t√© de m√©nage doit valider chaque m√©nage dans les 24h</li>
                    <li>En cas de refus, le m√©nage est marqu√© en rouge (√† replanifier)</li>
                    <li>Les m√©nages valid√©s apparaissent en vert</li>
                    <li>Les m√©nages en attente sont en orange</li>
                </ul>

                <h3 style="color: #9b59b6; margin-bottom: 15px;">‚è∞ Horaires</h3>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li><strong>Matin :</strong> 8h - 12h (pour les d√©parts matinaux)</li>
                    <li><strong>Apr√®s-midi :</strong> 14h - 18h (cas g√©n√©ral)</li>
                    <li>Temps estim√© par m√©nage : 2h</li>
                </ul>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                    <p style="margin: 0; color: #555;">
                        <strong>üí° Note :</strong> Ces r√®gles sont appliqu√©es automatiquement lors de la g√©n√©ration du planning. 
                        La soci√©t√© de m√©nage peut proposer des modifications via la page de validation.
                    </p>
                </div>

                <div style="display: flex; justify-content: center; margin-top: 20px;">
                    <button type="button" class="btn btn-primary" onclick="closeRulesModal()">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Les configurations et fonctions de base sont maintenant dans js/shared-config.js et js/shared-utils.js
        // Utiliser window.supabaseClient pour acc√©der au client Supabase
        // Note: On utilise var pour √©viter les conflits de scope avec d'autres scripts
        var supabase = window.supabaseClient;
        
        // Variables globales
        let caChartInstance, gitesChartInstance, platformsChartInstance, profitChartInstance;
        window.ICAL_CONFIGS = window.DEFAULT_ICAL_CONFIGS;
        
        // ==========================================
        // ‚ö†Ô∏è SECTION SYNCHRONISATION iCAL - NE PAS MODIFIER SANS DEMANDE EXPLICITE ‚ö†Ô∏è
        // ==========================================
        
        // Fonction pour obtenir les URLs iCal (depuis localStorage ou d√©faut)
        function getIcalConfigs() {
            const stored = localStorage.getItem('icalUrls');
            if (stored) {
                return JSON.parse(stored);
            }
            return window.DEFAULT_ICAL_CONFIGS;
        }
        
        // Exporter vers le scope global
        window.getIcalConfigs = getIcalConfigs;
        
        // Charger les URLs dans les champs du formulaire
        function chargerUrlsIcal() {
            const configs = getIcalConfigs();
            // V√©rifier que les √©l√©ments existent avant de les modifier
            const airbnbCouzon = document.getElementById('icalAirbnbCouzon');
            const abritelCouzon = document.getElementById('icalAbritelCouzon');
            const gitesCouzon = document.getElementById('icalGitesCouzon');
            const airbnbTrevoux = document.getElementById('icalAirbnbTrevoux');
            const abritelTrevoux = document.getElementById('icalAbritelTrevoux');
            const gitesTrevoux = document.getElementById('icalGitesTrevoux');
            
            if (airbnbCouzon) airbnbCouzon.value = configs.couzon.airbnb;
            if (abritelCouzon) abritelCouzon.value = configs.couzon.abritel;
            if (gitesCouzon) gitesCouzon.value = configs.couzon.gitesDeFrance;
            if (airbnbTrevoux) airbnbTrevoux.value = configs.trevoux.airbnb;
            if (abritelTrevoux) abritelTrevoux.value = configs.trevoux.abritel;
            if (gitesTrevoux) gitesTrevoux.value = configs.trevoux.gitesDeFrance;
        }
        
        // Sauvegarder les URLs depuis le formulaire
        function sauvegarderUrlsIcal() {
            const configs = {
                couzon: {
                    airbnb: document.getElementById('icalAirbnbCouzon').value.trim(),
                    abritel: document.getElementById('icalAbritelCouzon').value.trim(),
                    gitesDeFrance: document.getElementById('icalGitesCouzon').value.trim()
                },
                trevoux: {
                    airbnb: document.getElementById('icalAirbnbTrevoux').value.trim(),
                    abritel: document.getElementById('icalAbritelTrevoux').value.trim(),
                    gitesDeFrance: document.getElementById('icalGitesTrevoux').value.trim()
                }
            };
            localStorage.setItem('icalUrls', JSON.stringify(configs));
            showToast('‚úì URLs iCal sauvegard√©es');
        }
        
        // Variable globale pour les configs (charger depuis localStorage)
        ICAL_CONFIGS = getIcalConfigs();
        
        // ==========================================
        // üîç RECHERCHE R√âSERVATIONS - D√©plac√© dans js/reservations.js
        // ==========================================
        // Functions: filterReservations, displayFilteredReservations
        
        // ==========================================
        // üìä STATISTIQUES - D√©plac√© dans js/statistiques.js
        // ==========================================
        // Functions: updatePlatformCounters, updateAdvancedStats, populateYearFilter, 
        // filterStatsByYear, updateAllCharts
        
        // ==========================================
        // üíæ SAUVEGARDE - D√©plac√© dans js/sauvegarde.js
        // ==========================================
        // Functions: exportToExcel, exportAllData, importAllData, sauvegarderTout
        
        // Gestion du menu Actions
        function handleQuickAction(action) {
            if (action === 'ical') {
                switchTab('gestion');
            } else if (action === 'archives') {
                switchTab('archives');
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            const tabElement = document.getElementById('tab-' + tabName);
            if (tabElement) tabElement.classList.add('active');
            
            // Marquer le bouton comme actif
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Initialiser les fonctionnalit√©s sp√©cifiques √† chaque onglet
            if (tabName === 'dashboard' && typeof refreshDashboard === 'function') {
                refreshDashboard();
            }
            if (tabName === 'reservations' && typeof updateReservationsList === 'function') {
                updateReservationsList();
            }
            if (tabName === 'statistiques') {
                if (typeof populateYearFilter === 'function') populateYearFilter();
                if (typeof displayHistoricalYearsList === 'function') displayHistoricalYearsList();
                if (typeof updateStats === 'function') updateStats();
            }
            if (tabName === 'archives') {
                if (typeof updateArchivesDisplay === 'function') updateArchivesDisplay();
                if (typeof updateArchivedTodos === 'function') updateArchivedTodos();
            }
            if (tabName === 'charges') {
                console.log('üí∞ [SWITCH-TAB] Onglet Fiscalit√© activ√©, initialisation...');
                // Attendre que le HTML soit compl√®tement charg√©
                setTimeout(() => {
                    if (typeof initFiscalite === 'function') {
                        initFiscalite();
                    } else {
                        console.warn('‚ö†Ô∏è [SWITCH-TAB] initFiscalite non disponible');
                    }
                }, 100);
            }
            if (tabName === 'menage' && typeof afficherPlanningMenageNew === 'function') {
                afficherPlanningMenageNew();
            }
            if (tabName === 'infos-gites') {
                if (typeof chargerDonneesInfos === 'function') {
                    chargerDonneesInfos();
                }
                if (typeof chargerActivitesEtSorties === 'function') {
                    chargerActivitesEtSorties();
                }
            }
            if (tabName === 'faq' && typeof initFAQ === 'function') {
                initFAQ();
            }
            if (tabName === 'dashboard') {
                // Charger le widget horaires clients
                import('./js/widget-horaires-clients.js').then(module => {
                    if (module.afficherHorairesClients) {
                        module.afficherHorairesClients();
                    }
                });
            }
            if (tabName === 'decouvrir') {
                // Pr√©-s√©lectionner Tr√©voux si aucun g√Æte n'est s√©lectionn√©
                const giteInput = document.getElementById('decouvrir_gite');
                if (!giteInput || !giteInput.value) {
                    if (typeof selectGiteDecouvrir === 'function') {
                        selectGiteDecouvrir('Tr√©voux');
                    }
                } else {
                    // Si un g√Æte est d√©j√† s√©lectionn√©, charger les √©v√©nements
                    if (typeof rechercherEvenements === 'function') {
                        setTimeout(() => rechercherEvenements(), 100);
                    }
                }
                if (typeof chargerActivites === 'function') {
                    chargerActivites();
                }
                if (typeof chargerToutSurCarte === 'function') {
                    chargerToutSurCarte();
                }
            }
        }
        
        function showRulesModal() {
            const modal = document.getElementById('rulesModal');
            if (modal) modal.style.display = 'flex';
        }
        
        function closeRulesModal() {
            const modal = document.getElementById('rulesModal');
            if (modal) modal.style.display = 'none';
        }
        
        function ouvrirPageValidation() {
            // Ouvrir validation.html dans un nouvel onglet
            window.open('validation.html', '_blank');
        }
        
        function autoSetDateFin() {
            const dateDebut = document.getElementById('dateDebut').value;
            if (dateDebut) {
                const date = new Date(dateDebut);
                date.setDate(date.getDate() + 2);
                document.getElementById('dateFin').value = date.toISOString().split('T')[0];
            }
        }
        
        // ==========================================
        // üîÑ SYNCHRONISATION iCAL - D√©plac√© dans js/sync-ical.js
        // ==========================================
        // Functions: syncAllCalendars, syncCalendar, checkDateOverlap, updateBlockedDates
        
        // ==========================================
        // ‚úèÔ∏è √âDITION R√âSERVATIONS - D√©plac√© dans js/reservations.js
        // ==========================================
        // Functions: autoSaveJSON, openEditModal, closeEditModal, 
        // updatePaiementStatus, deleteReservationById
        
        // ==========================================
        // üìÖ AFFICHAGE R√âSERVATIONS - D√©plac√© dans js/reservations.js
        // ==========================================
        // Functions: updateReservationsList, generateWeekReservations, getPlatformLogo
        
        // ==========================================
        // üßπ PLANNING M√âNAGE - D√©plac√© dans js/menage.js
        // ==========================================
        // Functions: calculerDateMenage, isJourFerie, formatDateShort, genererPlanningMenage, 
        // afficherPlanningParSemaine, generateCleaningItemHTML, telechargerPlanningMenage
        
        // Fonctions additionnelles pour la gestion des modifications par la soci√©t√© de m√©nage
        
        async function updateArchivesDisplay() {
            const reservations = await getAllReservations();
            const section = document.getElementById('archivesSection');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const archives = reservations.filter(r => parseLocalDate(r.dateFin) < today);
            archives.sort((a, b) => parseLocalDate(b.dateFin) - parseLocalDate(a.dateFin));
            
            if (archives.length === 0) {
                section.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune archive</p>';
                return;
            }
            
            let html = '<div class="gite-section">';
            
            archives.forEach(r => {
                const badgeClass = getPlatformBadgeClass(r.site);
                html += `
                    <div class="reservation-item ${r.gite.toLowerCase()}">
                        <div class="reservation-header">
                            <span class="reservation-name">${r.nom} - ${r.gite}</span>
                            <span class="badge-platform ${badgeClass}">
                                ${r.site}
                            </span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem; color: #666;">
                            üìÖ ${formatDate(r.dateDebut)} ‚Üí ${formatDate(r.dateFin)} (${r.nuits} nuits)
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem;">
                            üí∞ ${r.montant ? r.montant.toFixed(2) : '0.00'} ‚Ç¨ | Statut: ${r.paiement}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            section.innerHTML = html;
        }
        
        async function updateStats() {
            const reservations = await getAllReservations();
            const historicalData = await getAllHistoricalData();
            
            // Filtrer par l'ann√©e s√©lectionn√©e
            const selectedYear = parseInt(document.getElementById('yearFilterStats')?.value || new Date().getFullYear());
            
            // V√©rifier si des donn√©es historiques "Total" existent pour cette ann√©e
            const histTotal = historicalData.find(d => d.year === selectedYear && d.gite === 'Total');
            
            let caTotal = 0;
            let totalReservations = 0;
            
            if (histTotal) {
                // Utiliser UNIQUEMENT les donn√©es historiques (pas les r√©servations)
                const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                months.forEach(m => {
                    caTotal += histTotal.months[m] || 0;
                });
                // Pour les donn√©es historiques, on ne peut pas compter les r√©servations individuelles
                totalReservations = '-';
                const statTotalEl = document.getElementById('statTotal');
                const statTrevouxEl = document.getElementById('statTrevoux');
                const statCouzonEl = document.getElementById('statCouzon');
                if (statTotalEl) statTotalEl.textContent = totalReservations;
                if (statTrevouxEl) statTrevouxEl.textContent = '-';
                if (statCouzonEl) statCouzonEl.textContent = '-';
            } else {
                // Utiliser les r√©servations automatiques
                const filteredReservations = reservations.filter(r => {
                    const year = parseLocalDate(r.dateDebut).getFullYear();
                    return year === selectedYear;
                });
                
                const trevoux = filteredReservations.filter(r => isTrevoux(r.gite));
                const couzon = filteredReservations.filter(r => isCouzon(r.gite));
                
                const caTrevoux = trevoux.reduce((sum, r) => sum + r.montant, 0);
                const caCouzon = couzon.reduce((sum, r) => sum + r.montant, 0);
                caTotal = caTrevoux + caCouzon;
                
                totalReservations = trevoux.length + couzon.length;
                
                const statTotalEl = document.getElementById('statTotal');
                const statTrevouxEl = document.getElementById('statTrevoux');
                const statCouzonEl = document.getElementById('statCouzon');
                if (statTotalEl) statTotalEl.textContent = totalReservations;
                if (statTrevouxEl) statTrevouxEl.textContent = trevoux.length;
                if (statCouzonEl) statCouzonEl.textContent = couzon.length;
                
                // Mettre √† jour les compteurs par plateforme et statistiques avanc√©es
                updatePlatformCounters(filteredReservations);
                updateAdvancedStats(filteredReservations);
            }
            
            const statCAEl = document.getElementById('statCA');
            if (statCAEl) statCAEl.textContent = caTotal.toFixed(0) + ' ‚Ç¨';
            
            // G√©n√©rer les checkboxes de comparaison d'ann√©es
            generateYearComparisonCheckboxes(reservations, historicalData);
            
            // Mettre √† jour les graphiques avec les donn√©es filtr√©es
            const filteredReservations = reservations.filter(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                return year === selectedYear;
            });
            updateAllCharts(filteredReservations);
        }
        
        function generateYearComparisonCheckboxes(reservations, historicalData) {
            const container = document.getElementById('yearComparisonCheckboxes');
            if (!container) return; // Conteneur pas encore charg√©
            const allYears = new Set();
            const yearsWithReservations = new Set();
            const yearsWithTotal = new Set();
            
            // Ann√©es des r√©servations
            reservations.forEach(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                allYears.add(year);
                yearsWithReservations.add(year);
            });
            
            // Ann√©es historiques
            historicalData.forEach(d => {
                allYears.add(d.year);
                if (d.gite === 'Total') {
                    yearsWithTotal.add(d.year);
                }
            });
            
            const sortedYears = Array.from(allYears).sort((a, b) => b - a);
            const currentYear = new Date().getFullYear();
            
            let html = '';
            sortedYears.forEach(year => {
                const isCurrentYear = year === currentYear;
                // Badge "Auto" UNIQUEMENT pour l'ann√©e en cours ET qui a des r√©servations ET pas de Total manuel
                const isAuto = isCurrentYear && yearsWithReservations.has(year) && !yearsWithTotal.has(year);
                // Ne cocher automatiquement QUE l'ann√©e en cours
                const checked = isCurrentYear ? 'checked' : '';
                const badge = isAuto ? '<span style="background: #27AE60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 5px;">Auto ‚ö°</span>' : '';
                const bgColor = isAuto ? '#e8f5e9' : 'white';
                const borderColor = isAuto ? '#27AE60' : 'var(--border)';
                const textColor = isAuto ? '#27AE60' : 'var(--primary)';
                
                html += `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" value="${year}" ${checked} onchange="updateAllCharts()" 
                            style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: ${textColor};">${year}${badge}</span>
                    </label>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // Note: updateAllCharts d√©plac√© vers js/statistiques.js
        // Note: exportToExcel, sauvegarderTout, exportAllData, importAllData d√©plac√©s vers js/sauvegarde.js
        // ==========================================
        
        // Gestionnaire formulaire charges - sera appel√© apr√®s chargement de l'onglet
        window.initChargeForm = function() {
            const chargeForm = document.getElementById('chargeForm');
            if (!chargeForm || chargeForm._initialized) return;
            
            chargeForm._initialized = true;
            chargeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const charge = {
                    gite: document.getElementById('chargeGite').value,
                    nom: document.getElementById('chargeNom').value,
                    montant: parseFloat(document.getElementById('chargeMontant').value),
                    type: document.getElementById('chargeType').value,
                    date: document.getElementById('chargeDate').value || new Date().toISOString().split('T')[0],
                    notes: document.getElementById('chargeNotes').value,
                    timestamp: new Date().toISOString()
                };
                
                await addCharge(charge);
                this.reset();
                await updateChargesDisplay();
                await updateStats(); // Mettre √† jour le graphique CA vs Charges
                showToast('‚úì Charge ajout√©e');
            });
        };
        
        async function updateChargesDisplay() {
            const reservations = await getAllReservations();
            const charges = await getAllCharges();
            
            // Calcul recettes
            const totalRecettes = reservations.reduce((sum, r) => sum + r.montant, 0);
            
            // Calcul charges
            let totalCharges = 0;
            charges.forEach(c => {
                if (c.type === 'mensuelle') {
                    totalCharges += c.montant * 12;
                } else if (c.type === 'annuelle') {
                    totalCharges += c.montant;
                } else {
                    totalCharges += c.montant;
                }
            });
            
            // Calcul URSSAF (22% des recettes)
            const provisionUrssaf = totalRecettes * 0.22;
            
            // R√©sultat net
            const resultatNet = totalRecettes - totalCharges - provisionUrssaf;
            
            document.getElementById('totalRecettes').textContent = totalRecettes.toFixed(0) + ' ‚Ç¨';
            document.getElementById('totalCharges').textContent = totalCharges.toFixed(0) + ' ‚Ç¨';
            document.getElementById('provisionUrssaf').textContent = provisionUrssaf.toFixed(0) + ' ‚Ç¨';
            document.getElementById('resultatNet').textContent = resultatNet.toFixed(0) + ' ‚Ç¨';
            
            // Liste des charges
            const chargesList = document.getElementById('chargesList');
            if (charges.length === 0) {
                chargesList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucune charge enregistr√©e</p>';
                return;
            }
            
            let html = '';
            charges.forEach(c => {
                html += `
                    <div class="charge-item">
                        <div class="charge-info">
                            <div class="charge-name">${c.nom} - ${c.gite}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${c.type ? (c.type.charAt(0).toUpperCase() + c.type.slice(1)) : 'Autre'} ${c.date ? '| ' + formatDate(c.date) : ''}
                                ${c.notes ? '<br>' + c.notes : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="charge-amount">${c.montant ? c.montant.toFixed(2) : '0.00'} ‚Ç¨</div>
                            <button class="btn btn-danger btn-small" onclick="deleteChargeById(${c.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            chargesList.innerHTML = html;
        }
        
        async function deleteChargeById(id) {
            if (confirm('Supprimer cette charge ?')) {
                await deleteCharge(id);
                await updateChargesDisplay();
                await updateStats(); // Mettre √† jour le graphique CA vs Charges
                showToast('‚úì Charge supprim√©e');
            }
        }
        
        // ==========================================
        // üìä GESTION DONN√âES HISTORIQUES
        // ==========================================
        
        function toggleHistoricalDataForm() {
            const form = document.getElementById('historicalDataForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                displayHistoricalYearsList();
            } else {
                form.style.display = 'none';
            }
        }
        
        async function saveHistoricalData() {
            const year = parseInt(document.getElementById('historicalYear').value);
            const gite = document.getElementById('historicalGite').value;
            const currentYear = new Date().getFullYear();
            
            if (!year || year < 2000 || year >= currentYear) {
                showToast(`‚ö†Ô∏è Saisissez une ann√©e pr√©c√©dente (max: ${currentYear - 1})`, 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            const data = {
                year: year,
                gite: gite,
                months: {}
            };
            
            months.forEach(m => {
                const value = parseFloat(document.getElementById(`hist_${m}`).value) || 0;
                data.months[m] = value;
            });
            
            try {
                // Supprimer l'ancien si existe
                const existing = await getHistoricalData(year, gite);
                if (existing) {
                    await deleteHistoricalDataById(existing.id);
                }
                
                // Ajouter le nouveau avec Promise
                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(['historicalData'], 'readwrite');
                    const request = transaction.objectStore('historicalData').add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Erreur ajout');
                });
                
                showToast(`‚úì Donn√©es ${year} - ${gite} sauvegard√©es`);
                displayHistoricalYearsList();
                clearHistoricalForm();
                updateStats(); // Rafra√Æchir les graphiques
            } catch (error) {
                showToast('‚ùå Erreur sauvegarde', 'error');
                console.error(error);
            }
        }
        
        // ==========================================
        // üî• FONCTIONS HISTORICAL DATA - SUPABASE
        // ==========================================
        
        async function getHistoricalData(year, gite) {
            try {
                const { data, error } = await supabase
                    .from('historical_data')
                    .select('*')
                    .eq('year', year)
                    .eq('gite', gite)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                return data;
            } catch (error) {
                console.error('Erreur getHistoricalData:', error);
                return null;
            }
        }
        
        async function getAllHistoricalData() {
            try {
                const { data, error } = await supabase
                    .from('historical_data')
                    .select('*')
                    .order('year', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erreur getAllHistoricalData:', error);
                return [];
            }
        }
        
        async function deleteHistoricalDataById(id) {
            try {
                const { error } = await supabase
                    .from('historical_data')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
            } catch (error) {
                console.error('Erreur deleteHistoricalDataById:', error);
                throw error;
            }
        }
        
        async function saveHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year || year < 2000 || year > 2030) {
                showToast('‚ö†Ô∏è Ann√©e invalide (entre 2000 et 2030)', 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            
            const monthsData = {};
            months.forEach(m => {
                const value = parseFloat(document.getElementById(`hist_total_${m}`).value) || 0;
                monthsData[m] = value;
            });
            
            try {
                const existing = await getHistoricalData(year, 'Total');
                
                if (existing) {
                    const { error } = await supabase
                        .from('historical_data')
                        .update({ months: monthsData })
                        .eq('id', existing.id);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('historical_data')
                        .insert({ year: year, gite: 'Total', months: monthsData });
                    
                    if (error) throw error;
                }
                
                showToast(`‚úì Donn√©es ${year} sauvegard√©es`);
                displayHistoricalYearsList();
                clearHistoricalFormTotal();
                updateStats();
            } catch (error) {
                console.error('Erreur saveHistoricalDataTotal:', error);
                showToast('‚ùå Erreur sauvegarde: ' + error.message, 'error');
            }
        }
        
        async function loadHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year) {
                showToast('‚ö†Ô∏è S√©lectionnez une ann√©e', 'error');
                return;
            }
            
            const dataTotal = await getHistoricalData(year, 'Total');
            
            if (!dataTotal) {
                showToast(`‚ÑπÔ∏è Aucune donn√©e pour ${year}`, 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            months.forEach(m => {
                document.getElementById(`hist_total_${m}`).value = dataTotal.months[m] || 0;
            });
            
            showToast(`‚úì Donn√©es ${year} charg√©es`);
        }
        
        async function deleteHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year) {
                showToast('‚ö†Ô∏è S√©lectionnez une ann√©e', 'error');
                return;
            }
            
            if (!confirm(`Supprimer toutes les donn√©es ${year} ?`)) {
                return;
            }
            
            const dataTotal = await getHistoricalData(year, 'Total');
            
            if (dataTotal) {
                await deleteHistoricalDataById(dataTotal.id);
            }
            
            showToast(`‚úì Donn√©es ${year} supprim√©es`);
            clearHistoricalFormTotal();
            displayHistoricalYearsList();
            updateStats();
        }
        
        function clearHistoricalFormTotal() {
            document.getElementById('historicalYear').value = '';
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            months.forEach(m => {
                document.getElementById(`hist_total_${m}`).value = '';
            });
        }
        
        // Fonctions anciennes - d√©sactiv√©es
        async function loadHistoricalData() {
            showToast('‚ö†Ô∏è Utilisez le formulaire Total', 'error');
        }
        
        async function deleteHistoricalData() {
            showToast('‚ö†Ô∏è Utilisez le formulaire Total', 'error');
        }
        
        function clearHistoricalForm() {
            clearHistoricalFormTotal();
        }
        
        async function displayHistoricalYearsList() {
            const data = await getAllHistoricalData();
            const container = document.getElementById('historicalYearsList');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic;">Aucune donn√©e historique enregistr√©e</p>';
                return;
            }
            
            // Grouper par ann√©e
            const byYear = {};
            data.forEach(d => {
                if (!byYear[d.year]) byYear[d.year] = {};
                byYear[d.year][d.gite] = d;
            });
            
            let html = '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
            Object.keys(byYear).sort().reverse().forEach(year => {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid var(--border); min-width: 200px;">
                        <div style="font-weight: 700; color: var(--primary); margin-bottom: 10px; font-size: 1.1rem;">üìÖ ${year}</div>
                `;
                
                if (byYear[year]['Total']) {
                    const total = Object.values(byYear[year]['Total'].months).reduce((a, b) => a + b, 0);
                    html += `
                        <div style="margin-bottom: 5px;">
                            <span style="font-weight: 600;">Total:</span> ${total.toFixed(2)} ‚Ç¨
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // FIN GESTION DONN√âES HISTORIQUES
        // ==========================================
        
        // ==========================================
        // üßπ NOUVEAU SYST√àME PLANNING M√âNAGE
        // ==========================================
        
        /**
         * Parse une date DD/MM/YYYY ou YYYY-MM-DD en objet Date
         */
        function parseDateMenage(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            
            // Format ISO YYYY-MM-DD
            if (dateStr.includes('-')) {
                const [y, m, d] = dateStr.split('-');
                return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
            }
            
            // Format fran√ßais DD/MM/YYYY
            const [d, m, y] = dateStr.split('/');
            return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
        }
        
        /**
         * Calcule le num√©ro de semaine ISO
         */
        function getWeekNum(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        /**
         * V√©rifie si c'est un jour f√©ri√©
         */
        function estJourFerie(date) {
            const y = date.getFullYear();
            const m = date.getMonth() + 1;
            const d = date.getDate();
            
            const feries = [
                `${y}-01-01`, `${y}-05-01`, `${y}-05-08`, `${y}-07-14`,
                `${y}-08-15`, `${y}-11-01`, `${y}-11-11`, `${y}-12-25`
            ];
            
            const key = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            return feries.includes(key);
        }
        
        /**
         * Calcule la date et l'heure du m√©nage selon les r√®gles m√©tier
         */
        function calculerMenageNew(reservation, toutesReservations) {
            const dateFin = parseDateMenage(reservation.date_fin || reservation.dateFin);
            if (!dateFin) {
                console.error('‚ùå Date fin invalide:', reservation);
                return { date: new Date(), moment: 'afternoon' };
            }
            const jour = dateFin.getDay(); // 0=dimanche, 6=samedi
            
            let dateMenage = new Date(dateFin);
            let moment = 'afternoon'; // Par d√©faut apr√®s-midi
            
            // Trouver enchainement (arriv√©e le jour du d√©part)
            const enchainement = toutesReservations.some(r => 
                r.gite === reservation.gite &&
                r.id !== reservation.id &&
                parseDateMenage(r.date_debut || r.dateDebut)?.toDateString() === dateFin.toDateString()
            );
            
            // R√àGLE DIMANCHE (0)
            if (jour === 0) {
                if (enchainement) {
                    // Enchainement dimanche ‚Üí 13h m√™me jour
                    moment = 'afternoon';
                } else {
                    // Pas d'enchainement ‚Üí lundi
                    dateMenage.setDate(dateMenage.getDate() + 1);
                    moment = 'afternoon';
                }
            }
            // R√àGLE SAMEDI (6)
            else if (jour === 6) {
                if (!enchainement) {
                    // V√©rifier si r√©sa samedi ou dimanche
                    const samedi = new Date(dateFin);
                    const dimanche = new Date(dateFin);
                    dimanche.setDate(dimanche.getDate() + 1);
                    
                    const resaWeekend = toutesReservations.some(r =>
                        r.gite === reservation.gite &&
                        r.id !== reservation.id &&
                        (parseDateMenage(r.date_debut || r.dateDebut)?.toDateString() === samedi.toDateString() ||
                         parseDateMenage(r.date_debut || r.dateDebut)?.toDateString() === dimanche.toDateString())
                    );
                    
                    if (!resaWeekend) {
                        // Pas de r√©sa weekend ‚Üí lundi
                        dateMenage.setDate(dateMenage.getDate() + 2);
                    }
                }
                moment = 'afternoon';
            }
            // R√àGLE MERCREDI (3) / JEUDI (4)
            else if (jour === 3 || jour === 4) {
                if (!enchainement) {
                    const vendredi = new Date(dateFin);
                    vendredi.setDate(vendredi.getDate() + (jour === 3 ? 2 : 1));
                    
                    const resaAvantVendredi = toutesReservations.some(r => {
                        const dateDebut = parseDateMenage(r.date_debut || r.dateDebut);
                        return r.gite === reservation.gite &&
                            r.id !== reservation.id &&
                            dateDebut && dateDebut < vendredi;
                    });
                    
                    if (!resaAvantVendredi) {
                        // Pas de r√©sa avant vendredi ‚Üí vendredi
                        dateMenage = vendredi;
                    }
                }
                moment = 'afternoon';
            }
            // AUTRES JOURS (lundi, mardi, vendredi)
            else {
                moment = 'afternoon';
            }
            
            // Reporter si jour f√©ri√© (sauf si enchainement)
            while (estJourFerie(dateMenage) && !enchainement) {
                dateMenage.setDate(dateMenage.getDate() + 1);
                // √âviter les dimanches
                if (dateMenage.getDay() === 0) {
                    dateMenage.setDate(dateMenage.getDate() + 1);
                }
            }
            
            return { date: dateMenage, moment };
        }
        
        /**
         * Affiche le planning par semaine avec les 2 g√Ætes
         */
        async function afficherPlanningMenageNew() {
            try {
                // R√©cup√©rer toutes les r√©servations
                const reservations = await getAllReservations();
                
                // R√©cup√©rer cleaning_schedule
                const { data: cleanings } = await supabase
                    .from('cleaning_schedule')
                    .select('*');
                
                const cleaningMap = {};
                if (cleanings) {
                    cleanings.forEach(c => {
                        if (c.status === 'pending_validation') {
                        }
                        cleaningMap[c.reservation_id] = c;
                    });
                }
                
                // Filtrer futures r√©servations (6 mois)
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const limit = new Date(now);
                limit.setMonth(limit.getMonth() + 6);
                
                const futures = reservations.filter(r => {
                    const fin = parseDateMenage(r.date_fin || r.dateFin);
                    if (!fin) return false;
                    return fin >= now && fin <= limit;
                });
                
                // Calculer pour chaque r√©servation
                const menages = [];
                
                for (const resa of futures) {
                    const cleaning = cleaningMap[resa.id];
                    
                    // Si pas de cleaning, cr√©er automatiquement
                    let dateMenage, moment;
                    if (!cleaning) {
                        const calc = calculerMenageNew(resa, futures);
                        dateMenage = calc.date;
                        moment = calc.moment;
                        
                        // Trouver prochaine r√©sa pour ce g√Æte
                        const nextResa = futures
                            .filter(r => r.gite === resa.gite && parseDateMenage(r.date_debut || r.dateDebut) > parseDateMenage(resa.date_fin || resa.dateFin))
                            .sort((a, b) => parseDateMenage(a.date_debut || a.dateDebut) - parseDateMenage(b.date_debut || b.dateDebut))[0];
                        
                        // Sauvegarder automatiquement dans BD
                        const scheduledDateStr = `${dateMenage.getFullYear()}-${String(dateMenage.getMonth() + 1).padStart(2, '0')}-${String(dateMenage.getDate()).padStart(2, '0')}`;
                        const resaEndDate = parseDateMenage(resa.date_fin || resa.dateFin);
                        const resaEndDateStr = `${resaEndDate.getFullYear()}-${String(resaEndDate.getMonth() + 1).padStart(2, '0')}-${String(resaEndDate.getDate()).padStart(2, '0')}`;
                        let nextResaStartStr = null;
                        if (nextResa) {
                            const nextResaStart = parseDateMenage(nextResa.date_debut || nextResa.dateDebut);
                            nextResaStartStr = `${nextResaStart.getFullYear()}-${String(nextResaStart.getMonth() + 1).padStart(2, '0')}-${String(nextResaStart.getDate()).padStart(2, '0')}`;
                        }
                        
                        await supabase.from('cleaning_schedule').upsert({
                            reservation_id: resa.id,
                            gite: resa.gite,
                            scheduled_date: scheduledDateStr,
                            time_of_day: moment,
                            status: 'pending',
                            validated_by_company: false,
                            reservation_end: resaEndDateStr,
                            reservation_start_after: nextResaStartStr
                        }, { onConflict: 'reservation_id' });
                    } else {
                        // Utiliser la date enregistr√©e (qu'elle soit pending, validated, etc.)
                        dateMenage = parseDateMenage(cleaning.scheduled_date);
                        moment = cleaning.time_of_day;
                    }
                    
                    // Trouver prochaine arriv√©e
                    const nextResa = futures
                        .filter(r => r.gite === resa.gite && parseDateMenage(r.date_debut || r.dateDebut) > parseDateMenage(resa.date_fin || resa.dateFin))
                        .sort((a, b) => parseDateMenage(a.date_debut || a.dateDebut) - parseDateMenage(b.date_debut || b.dateDebut))[0];
                    
                    menages.push({
                        reservation: resa,
                        dateMenage,
                        moment,
                        validated: cleaning?.validated_by_company || false,
                        status: cleaning?.status || 'pending',
                        nextArrivee: nextResa ? parseDateMenage(nextResa.date_debut || nextResa.dateDebut) : null
                    });
                }
                
                // Organiser par semaine
                const weeks = {};
                
                menages.forEach(m => {
                    // Trouver le lundi de la semaine
                    const monday = new Date(m.dateMenage);
                    const day = monday.getDay();
                    monday.setDate(monday.getDate() - (day === 0 ? 6 : day - 1));
                    monday.setHours(0, 0, 0, 0);
                    
                    const key = monday.toISOString().split('T')[0];
                    
                    if (!weeks[key]) {
                        const sunday = new Date(monday);
                        sunday.setDate(monday.getDate() + 6);
                        
                        weeks[key] = {
                            monday,
                            sunday,
                            weekNum: getWeekNum(monday),
                            trevoux: [],
                            couzon: []
                        };
                    }
                    
                    // Dispatcher dans colonnes
                    if (m.reservation.gite.toLowerCase().includes('tr√©voux')) {
                        weeks[key].trevoux.push(m);
                    } else {
                        weeks[key].couzon.push(m);
                    }
                });
                
                // G√©n√©rer HTML
                const sorted = Object.keys(weeks).sort();
                let html = '';
                
                // Afficher propositions en attente dans un bandeau
                const propositionsEnAttente = menages.filter(m => m.status === 'pending_validation');
                
                // Mettre √† jour le titre de l'onglet
                if (propositionsEnAttente.length > 0) {
                    document.title = `(üîî${propositionsEnAttente.length}) Gestion G√Æte`;
                } else {
                    document.title = 'Gestion G√Æte';
                }
                
                // G√©n√©rer le bandeau des propositions
                if (propositionsEnAttente.length > 0) {
                    html += `
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <span style="font-size: 2rem;">‚è∞</span>
                                <h3 style="margin: 0; color: #856404;">Propositions en attente de validation (${propositionsEnAttente.length})</h3>
                            </div>
                    `;
                    
                    propositionsEnAttente.forEach(m => {
                        const dateDepartStr = parseDateMenage(m.reservation.date_fin || m.reservation.dateFin)?.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) || '';
                        const momentIcon = m.moment === 'morning' ? 'üåÖ Matin' : 'üåá Apr√®s-midi';
                        
                        html += `
                            <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; border: 2px solid #ffc107;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-weight: 700; font-size: 1.1rem; color: #333; margin-bottom: 5px;">
                                            ${m.reservation.gite} - ${m.reservation.nom}
                                        </div>
                                        <div style="color: #666;">
                                            üìÖ ${m.dateMenage.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' })} ${momentIcon}
                                        </div>
                                        <div style="color: #666; font-size: 0.9rem;">
                                            üö™ D√©part: ${dateDepartStr}
                                            ${m.nextArrivee ? `| üîë Entr√©e suivante: ${m.nextArrivee.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn btn-success" onclick="approuverProposition(${m.reservation.id})" style="white-space: nowrap;">
                                            ‚úì Approuver
                                        </button>
                                        <button class="btn btn-danger" onclick="afficherRefusForm(${m.reservation.id})" style="white-space: nowrap;">
                                            ‚úó Refuser
                                        </button>
                                    </div>
                                </div>
                                <div id="refus-form-${m.reservation.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <textarea id="refus-reason-${m.reservation.id}" placeholder="Raison du refus..." style="width: 100%; min-height: 60px; margin-bottom: 10px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;"></textarea>
                                    <button class="btn btn-danger" onclick="refuserProposition(${m.reservation.id})">
                                        Envoyer le refus
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
                
                sorted.forEach(key => {
                    const w = weeks[key];
                    html += `
                        <div class="week-card">
                            <div class="week-header">
                                <div class="week-title">Semaine ${w.weekNum}</div>
                                <div class="week-dates">
                                    ${w.monday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })} - 
                                    ${w.sunday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}
                                </div>
                            </div>
                            <div class="week-grid">
                                <div class="gite-column">
                                    <div class="gite-header trevoux">üè° Tr√©voux</div>
                                    ${w.trevoux.length > 0 ? w.trevoux.map(genererMenageCard).join('') : '<div class="empty-column">Aucun m√©nage</div>'}
                                </div>
                                <div class="gite-column">
                                    <div class="gite-header couzon">‚õ∞Ô∏è Couzon</div>
                                    ${w.couzon.length > 0 ? w.couzon.map(genererMenageCard).join('') : '<div class="empty-column">Aucun m√©nage</div>'}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('menagePlanningWeeks').innerHTML = html;
                
            } catch (err) {
                console.error('‚ùå Erreur affichage planning:', err);
                showToast('Erreur chargement planning', 'error');
            }
        }
        
        function genererMenageCard(m) {
            const statusClass = m.validated ? 'validated' : m.status === 'pending_validation' ? 'pending-validation' : '';
            const statusBadge = m.validated ? 
                '<span class="menage-status status-validated">‚úì Valid√©</span>' :
                m.status === 'pending_validation' ?
                '<span class="menage-status status-waiting">‚è∞ En attente validation client</span>' :
                '<span class="menage-status status-pending">‚è≥ √Ä valider</span>';
            
            const momentIcon = m.moment === 'morning' ? 'üåÖ Matin' : 'üåá Apr√®s-midi';
            
            const dateDepartStr = parseDateMenage(m.reservation.date_fin || m.reservation.dateFin)?.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) || 'Date inconnue';
            
            // Formater la date du m√©nage pour le calendrier (√©viter d√©calage UTC)
            const year = m.dateMenage.getFullYear();
            const month = String(m.dateMenage.getMonth() + 1).padStart(2, '0');
            const day = String(m.dateMenage.getDate()).padStart(2, '0');
            const dateMenageISO = `${year}-${month}-${day}`;
            
            return `
                <div class="menage-card ${statusClass}">
                    ${statusBadge}
                    <div class="menage-date-main">
                        üìÖ ${m.dateMenage.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' })}
                        ${momentIcon}
                    </div>
                    <div class="menage-info-row">
                        <span>üë§ ${m.reservation.nom}</span>
                    </div>
                    <div class="menage-info-row">
                        <span>üö™ D√©part: ${dateDepartStr}</span>
                        ${m.nextArrivee ? `<span>üîë Entr√©e suivante: ${m.nextArrivee.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}</span>` : ''}
                    </div>
                    
                    ${m.status === 'pending_validation' ? `
                        <div class="menage-proposition">
                            <p><strong>üì© Proposition soci√©t√© de m√©nage :</strong></p>
                            <div class="proposition-actions">
                                    ‚úì Approuver
                                </button>
                                    ‚úó Refuser
                                </button>
                            </div>
                            <div id="refus-form-${m.reservation.id}" style="display: none; margin-top: 10px;">
                                <textarea id="refus-reason-${m.reservation.id}" placeholder="Raison du refus..." style="width: 100%; min-height: 60px; margin-bottom: 10px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;"></textarea>
                                    Envoyer le refus
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div class="menage-modifier">
                            <div class="modifier-form">
                                <input 
                                    type="date" 
                                    id="date-${m.reservation.id}" 
                                    value="${dateMenageISO}"
                                    onchange="modifierMenageAuto(${m.reservation.id})"
                                >
                                <select id="moment-${m.reservation.id}" onchange="modifierMenageAuto(${m.reservation.id})">
                                    <option value="morning" ${m.moment === 'morning' ? 'selected' : ''}>üåÖ Matin</option>
                                    <option value="afternoon" ${m.moment === 'afternoon' ? 'selected' : ''}>üåá Apr√®s-midi</option>
                                </select>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }
        
        function afficherRefusForm(resaId) {
            const form = document.getElementById(`refus-form-${resaId}`);
            const btnRefuser = event?.target;
            
            if (form) {
                form.style.display = 'block';
                // Scroll jusqu'au formulaire
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                // Focus sur le textarea
                const textarea = document.getElementById(`refus-reason-${resaId}`);
                if (textarea) {
                    setTimeout(() => textarea.focus(), 300);
                }
                
                // Cacher le bouton refuser pour √©viter double clic
                if (btnRefuser) {
                    btnRefuser.style.display = 'none';
                }
            } else {
                console.error('‚ùå Formulaire refus-form-' + resaId + ' non trouv√© dans le DOM');
                // V√©rifier si l'√©l√©ment existe vraiment
            }
        }
        
        async function approuverProposition(resaId) {
            if (!confirm('Approuver cette proposition de la soci√©t√© de m√©nage ?')) return;
            
            try {
                const { error } = await supabase.from('cleaning_schedule')
                    .update({
                        status: 'validated',
                        validated_by_company: true
                    })
                    .eq('reservation_id', resaId);
                
                if (error) throw error;
                
                showToast('‚úì Proposition approuv√©e !', 'success');
                await afficherPlanningMenageNew();
            } catch (error) {
                console.error(error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }
        
        async function refuserProposition(resaId) {
            const reasonElement = document.getElementById(`refus-reason-${resaId}`);
            
            if (!reasonElement) {
                console.error('‚ùå √âl√©ment refus-reason non trouv√© pour r√©sa', resaId);
                showToast('Erreur: formulaire non trouv√©', 'error');
                return;
            }
            
            const reason = reasonElement.value.trim();
            
            if (!reason) {
                showToast('Veuillez indiquer une raison', 'error');
                return;
            }
            
            try {
                // D'abord v√©rifier si la colonne existe, sinon juste update status
                const { error } = await supabase.from('cleaning_schedule')
                    .update({
                        status: 'refused',
                        validated_by_company: false,
                        notes: reason
                    })
                    .eq('reservation_id', resaId);
                
                if (error) throw error;
                
                showToast('‚úó Proposition refus√©e', 'info');
                await afficherPlanningMenageNew();
            } catch (error) {
                console.error(error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }
        
        async function modifierMenageAuto(resaId) {
            const newDate = document.getElementById(`date-${resaId}`).value;
            const newMoment = document.getElementById(`moment-${resaId}`).value;
            
            try {
                // R√©cup√©rer le gite de la r√©servation
                const reservations = await getAllReservations();
                const reservation = reservations.find(r => r.id === resaId);
                
                if (!reservation) {
                    throw new Error('R√©servation non trouv√©e');
                }
                
                const dataToUpdate = {
                    reservation_id: resaId,
                    gite: reservation.gite,
                    scheduled_date: newDate,
                    time_of_day: newMoment,
                    status: 'pending'
                };
                
                
                const { data, error } = await supabase.from('cleaning_schedule').upsert(dataToUpdate, { onConflict: 'reservation_id' });
                
                if (error) {
                    console.error('Erreur Supabase:', error);
                    throw error;
                }
                
                
                showToast('‚úì Enregistr√©', 'success');
                await afficherPlanningMenageNew();
            } catch (err) {
                console.error('Erreur modification:', err);
                showToast('Erreur enregistrement', 'error');
            }
        }
        
        // ==========================================
        // FIN NOUVEAU SYST√àME PLANNING M√âNAGE
        // ==========================================
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        async function exportPlanningMenageMois() {
            const reservations = await getAllReservations();
            
            // R√©cup√©rer les validations de la soci√©t√© de m√©nage
            const { data: cleaningSchedules } = await supabase
                .from('cleaning_schedule')
                .select('*');
            
            const validationMap = {};
            let pendingModifications = 0;
            if (cleaningSchedules) {
                cleaningSchedules.forEach(cs => {
                    validationMap[cs.reservation_id] = cs;
                    if (cs.status === 'proposed') {
                        pendingModifications++;
                    }
                });
            }
            
            // Afficher le badge de notification si modifications en attente
            const notifBadge = document.getElementById('cleaning-notif-badge');
            if (notifBadge) {
                if (pendingModifications > 0) {
                    notifBadge.textContent = pendingModifications;
                    notifBadge.style.display = 'inline-block';
                } else {
                    notifBadge.style.display = 'none';
                }
            }
            
            // Filtrer √† partir de la date actuelle
            const now = new Date();
            now.setHours(0, 0, 0, 0); // D√©but de journ√©e
            const twoMonthsLater = new Date(now);
            twoMonthsLater.setMonth(now.getMonth() + 12);
            
            // Adapter les r√©servations de snake_case √† camelCase pour calculerDateMenage()
            const reservationsAdapted = reservations.map(r => ({
                ...r,
                dateFin: r.dateFin || r.date_fin,
                dateDebut: r.dateDebut || r.date_debut
            }));
            
            const relevant = reservationsAdapted.filter(r => {
                const dateFin = parseLocalDate(r.dateFin);
                return dateFin >= now && dateFin <= twoMonthsLater;
            });
            
            // Organiser par semaine
            const weeks = {};
            const weekStarts = new Set();
            
            for (const r of relevant) {
                const dateFin = parseLocalDate(r.dateFin);
                const validation = validationMap[r.id];
                
                // Calculer la date avec les r√®gles m√©tier
                const dateMenageFormatted = calculerDateMenage(r, relevant);
                
                // Parser le r√©sultat "Lundi 23 d√©c. √† 12h00" (avec accents possibles)
                const match = dateMenageFormatted.match(/(\w+) (\d+) ([a-z√©√ª]+)\. √† (\d+h\d+)/i);
                let dateMenage;
                let calculatedTimeOfDay;
                
                if (match) {
                    const [_, jourNom, jour, mois, heure] = match;
                    const moisMap = {
                        'janv': 0, 'f√©vr': 1, 'mars': 2, 'avr': 3, 'mai': 4, 'juin': 5,
                        'juil': 6, 'ao√ªt': 7, 'sept': 8, 'oct': 9, 'nov': 10, 'd√©c': 11
                    };
                    
                    const moisIndex = moisMap[mois];
                    const jourInt = parseInt(jour);
                    
                    // Cr√©er la date avec l'ann√©e actuelle d'abord
                    dateMenage = new Date(dateFin.getFullYear(), moisIndex, jourInt);
                    
                    // Si la date est avant la date de fin, c'est l'ann√©e suivante
                    if (dateMenage < dateFin) {
                        dateMenage = new Date(dateFin.getFullYear() + 1, moisIndex, jourInt);
                    }
                    
                    calculatedTimeOfDay = (heure.startsWith('07') || heure.startsWith('08')) ? 'morning' : 'afternoon';
                } else {
                    dateMenage = new Date(dateFin);
                    calculatedTimeOfDay = 'afternoon';
                }
                
                // Trouver le lundi de cette semaine
                const dayOfWeek = dateMenage.getDay();
                const monday = new Date(dateMenage);
                monday.setDate(dateMenage.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                monday.setHours(0, 0, 0, 0);
                
                const weekKey = monday.toISOString().split('T')[0];
                weekStarts.add(weekKey);
                
                if (!weeks[weekKey]) {
                    weeks[weekKey] = {
                        monday: monday,
                        trevoux: [],
                        couzon: []
                    };
                }
                
                // Sauvegarder si pas encore fait ou si status pending
                if (!validation || validation.status === 'pending') {
                    const nextRes = reservations
                        .filter(next => next.gite === r.gite && parseLocalDate(next.dateFin || next.date_fin) > dateFin)
                        .sort((a, b) => parseLocalDate(a.dateDebut || a.date_debut) - parseLocalDate(b.dateDebut || b.date_debut))[0];
                    
                    try {
                        const scheduledDateStr = `${dateMenage.getFullYear()}-${String(dateMenage.getMonth() + 1).padStart(2, '0')}-${String(dateMenage.getDate()).padStart(2, '0')}`;
                        const dateFinStr = `${dateFin.getFullYear()}-${String(dateFin.getMonth() + 1).padStart(2, '0')}-${String(dateFin.getDate()).padStart(2, '0')}`;
                        let nextResStartStr = null;
                        if (nextRes) {
                            const nextResStart = parseLocalDate(nextRes.dateFin || nextRes.date_fin);
                            nextResStartStr = `${nextResStart.getFullYear()}-${String(nextResStart.getMonth() + 1).padStart(2, '0')}-${String(nextResStart.getDate()).padStart(2, '0')}`;
                        }
                        
                        await supabase.from('cleaning_schedule').upsert({
                            reservation_id: r.id,
                            gite: r.gite,
                            scheduled_date: scheduledDateStr,
                            time_of_day: calculatedTimeOfDay,
                            status: 'pending',
                            validated_by_company: false,
                            reservation_end: dateFinStr,
                            reservation_start_after: nextResStartStr
                        }, { onConflict: 'reservation_id' });
                    } catch (err) {
                        console.error('Erreur upsert:', err);
                    }
                }
                
                const menageInfo = {
                    reservation: r,
                    dateMenage: dateMenage,
                    validated: validation ? validation.validated_by_company : false,
                    proposedDate: validation ? validation.proposed_date : null,
                    status: validation ? validation.status : 'pending',
                    timeOfDay: validation ? validation.time_of_day : calculatedTimeOfDay,
                    reservationEndBefore: dateFin,
                    reservationStartAfter: null // √Ä calculer
                };
                
                // Chercher la r√©servation suivante pour ce g√Æte
                const nextReservation = reservations
                    .filter(next => next.gite === r.gite && parseLocalDate(next.dateDebut || next.date_debut) > dateFin)
                    .sort((a, b) => parseLocalDate(a.dateDebut || a.date_debut) - parseLocalDate(b.dateDebut || b.date_debut))[0];
                
                if (nextReservation) {
                    menageInfo.reservationStartAfter = parseLocalDate(nextReservation.dateDebut || nextReservation.date_debut);
                }
                
                // Ajouter dans la bonne colonne
                if (r.gite.toLowerCase().includes('tr√©voux') || r.gite.toLowerCase().includes('trevoux')) {
                    weeks[weekKey].trevoux.push(menageInfo);
                } else {
                    weeks[weekKey].couzon.push(menageInfo);
                }
            }
            
            // Trier les semaines
            const sortedWeeks = Array.from(weekStarts).sort();
            
            // G√©n√©rer le HTML
            let html = '<div style="margin-top: 20px;">';
            
            sortedWeeks.forEach((weekKey, index) => {
                const week = weeks[weekKey];
                const monday = week.monday;
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                
                // Calculer le vrai num√©ro de semaine de l'ann√©e
                const weekNumber = `S${getWeekNumber(monday)}`;
                const weekDisplay = `${monday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })} - ${sunday.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}`;
                
                html += `
                    <div class="cleaning-week-table">
                        <div class="cleaning-week-header">
                            <div class="week-number-big">${weekNumber}</div>
                            <div class="week-dates-small">${weekDisplay}</div>
                        </div>
                        <div class="cleaning-week-body">
                            <div class="cleaning-column">
                                <div class="cleaning-column-header">üè° Tr√©voux</div>
                                ${week.trevoux.length > 0 ? 
                                    week.trevoux.map(m => generateCleaningItemHTML(m)).join('') :
                                    '<div class="cleaning-item empty">Aucun m√©nage pr√©vu</div>'
                                }
                            </div>
                            <div class="cleaning-column">
                                <div class="cleaning-column-header couzon">‚õ∞Ô∏è Couzon</div>
                                ${week.couzon.length > 0 ? 
                                    week.couzon.map(m => generateCleaningItemHTML(m)).join('') :
                                    '<div class="cleaning-item empty">Aucun m√©nage pr√©vu</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('menagePlanning').innerHTML = html;
        }
        
        function generateCleaningItemHTML(menageInfo) {
            const { reservation, dateMenage, validated, proposedDate, reservationEndBefore, reservationStartAfter, status, timeOfDay } = menageInfo;
            const displayDate = proposedDate ? new Date(proposedDate) : dateMenage;
            
            // Ic√¥ne et badge de statut - 3 √©tats uniquement :
            // Rouge = √† valider, Orange = en attente, Vert = valid√©
            let statusIcon = '';
            if (validated) {
                // VERT = Valid√©
                statusIcon = '<span class="validation-status validated" title="Valid√© par soci√©t√©">‚úì</span>';
            } else if (status === 'proposed') {
                // ORANGE = En attente de validation
                statusIcon = '<span class="validation-status pending" title="En attente validation">‚è≥</span>';
            } else {
                // ROUGE = √Ä valider
                statusIcon = '<span class="validation-status notvalidated" title="√Ä valider">‚úó</span>';
            }
            
            const dateStr = displayDate.toLocaleDateString('fr-FR', { 
                weekday: 'short', 
                day: '2-digit', 
                month: 'short' 
            });
            
            // R√©cup√©rer le moment sauvegard√©
            const savedTime = timeOfDay || localStorage.getItem(`cleaning_time_${reservation.id}`) || 'afternoon';
            
            // Afficher une alerte si modification propos√©e par la soci√©t√©
            const proposalAlert = status === 'proposed' ? `
                <div style="background: #fff3cd; border-left: 4px solid #ff9800; padding: 10px; margin: 10px 0; border-radius: 6px;">
                    <strong>‚ö†Ô∏è Modification propos√©e par la soci√©t√© de m√©nage</strong><br>
                    Nouvelle date: ${displayDate.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' })} - ${savedTime === 'morning' ? 'üåÖ Matin' : '‚òÄÔ∏è Apr√®s-midi'}
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn-small" onclick="approveModification(${reservation.id})" style="flex: 1; background: #27ae60;">
                            ‚úì Approuver
                        </button>
                        <button class="btn-small" onclick="rejectModification(${reservation.id})" style="flex: 1; background: #e74c3c;">
                            ‚úó Refuser
                        </button>
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="cleaning-item ${status === 'proposed' ? 'pending-approval' : ''}" style="${status === 'proposed' ? 'border: 2px solid #ff9800;' : ''}">
                    <div class="cleaning-date-row">
                        <span class="cleaning-date">üìÖ ${dateStr}</span>
                        ${statusIcon}
                    </div>
                    <div class="cleaning-details">
                        üö™ D√©part: ${reservationEndBefore.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}
                        ${reservationStartAfter ? `<br>üîë Arriv√©e suivante: ${reservationStartAfter.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}` : ''}
                    </div>
                    ${proposalAlert}
                    <div style="margin-top: 10px; display: flex; gap: 8px; align-items: center;">
                        <input type="date" id="date-${reservation.id}" value="${displayDate.toISOString().split('T')[0]}" style="flex: 1; padding: 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.9rem;">
                        <select id="time-${reservation.id}" style="padding: 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.9rem;">
                            <option value="morning" ${savedTime === 'morning' ? 'selected' : ''}>üåÖ Matin</option>
                            <option value="afternoon" ${savedTime === 'afternoon' ? 'selected' : ''}>‚òÄÔ∏è Apr√®s-midi</option>
                        </select>
                    </div>
                    <div class="cleaning-actions">
                        <button class="btn-small" onclick="modifierDateMenage(${reservation.id})" style="width: 100%;">
                            ‚úèÔ∏è Enregistrer
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function modifierDateMenage(reservationId) {
            const newDate = document.getElementById(`date-${reservationId}`).value;
            const timeOfDay = document.getElementById(`time-${reservationId}`).value;
            
            if (!newDate) {
                showToast('Veuillez s√©lectionner une date', 'error');
                return;
            }
            
            const reservation = (await getAllReservations()).find(r => r.id === reservationId);
            if (!reservation) {
                showToast('R√©servation non trouv√©e', 'error');
                return;
            }
            
            // Sauvegarder le moment dans localStorage
            localStorage.setItem(`cleaning_time_${reservationId}`, timeOfDay);
            
            // Sauvegarder dans cleaning_schedule avec le moment
            const { error } = await supabase
                .from('cleaning_schedule')
                .upsert({
                    reservation_id: reservationId,
                    gite: reservation.gite,
                    scheduled_date: newDate,
                    time_of_day: timeOfDay,
                    status: 'modified',
                    validated_by_company: false,
                    reservation_end: reservation.dateFin,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'reservation_id' });
            
            if (error) {
                showToast('Erreur: ' + error.message, 'error');
            } else {
                showToast('Date et horaire de m√©nage enregistr√©s avec succ√®s');
                afficherPlanningParSemaine();
            }
        }
        
        async function approveModification(reservationId) {
            const { error } = await supabase
                .from('cleaning_schedule')
                .update({
                    status: 'validated',
                    validated_by_company: true,
                    updated_at: new Date().toISOString()
                })
                .eq('reservation_id', reservationId);
            
            if (error) {
                showToast('Erreur lors de l\'approbation: ' + error.message, 'error');
            } else {
                showToast('‚úì Modification approuv√©e');
                afficherPlanningParSemaine();
            }
        }
        
        async function rejectModification(reservationId) {
            // Remettre la date d'origine (jour du d√©part) et supprimer la proposition
            const reservation = (await getAllReservations()).find(r => r.id === reservationId);
            if (!reservation) return;
            
            const { error } = await supabase
                .from('cleaning_schedule')
                .update({
                    scheduled_date: reservation.dateFin,
                    proposed_date: null,
                    status: 'pending',
                    validated_by_company: false,
                    updated_at: new Date().toISOString()
                })
                .eq('reservation_id', reservationId);
            
            if (error) {
                showToast('Erreur lors du refus: ' + error.message, 'error');
            } else {
                showToast('‚úó Modification refus√©e - Date d\'origine restaur√©e');
                afficherPlanningParSemaine();
            }
        }

        function telechargerPlanningMenage() {
            if (!window.planningMenageData || window.planningMenageData.length === 0) {
                showToast('Aucun planning √† t√©l√©charger. G√©n√©rez d\'abord le planning.', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(window.planningMenageData);
            
            // D√©finir les largeurs de colonnes
            ws['!cols'] = [
                { wch: 35 }, // Date compl√®te
                { wch: 10 }, // Heure
                { wch: 12 }, // G√Æte
                { wch: 20 }, // Client
                { wch: 15 }, // D√©part
                { wch: 15 }  // Enchainement
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Planning M√©nages');
            const dateToday = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `MenageCalvignac_${dateToday}.xlsx`);
            
            showToast('‚úì Planning Excel t√©l√©charg√©');
        }
        
        // ==========================================
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FIN SECTION PLANNING M√âNAGE - VERROUILL√âE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // ==========================================
        
        async function exportPlanningMenageMois() {
            const monthInput = document.getElementById('menageExportMonth').value;
            if (!monthInput) {
                showToast('S√©lectionnez un mois √† exporter', 'error');
                return;
            }

            const [yearStr, monthStr] = monthInput.split('-');
            const targetYear = parseInt(yearStr, 10);
            const targetMonth = parseInt(monthStr, 10) - 1;

            const reservations = await getAllReservations();
            if (!reservations || reservations.length === 0) {
                showToast('Aucune r√©servation enregistr√©e', 'error');
                return;
            }

            // On calcule un planning global puis on filtre sur le mois demand√©
            const relevant = [...reservations].sort((a, b) => parseLocalDate(a.dateFin) - parseLocalDate(b.dateFin));

            const planning = [];
            const occupiedSlots = {};

            relevant.forEach(r => {
                const departDate = parseLocalDate(r.dateFin);
                if (isNaN(departDate)) return;

                const departDay = departDate.getDay();

                const arriveeMemejour = relevant.find(resa =>
                    resa.gite === r.gite &&
                    parseLocalDate(resa.dateDebut).toDateString() === departDate.toDateString()
                );

                let menageDate = new Date(departDate);
                let heure = '12h00';

                // R√àGLE 1: D√©part dimanche
                if (departDay === 0) {
                    if (!arriveeMemejour) {
                        menageDate.setDate(menageDate.getDate() + 1);
                        const arriveeLundi = relevant.find(resa =>
                            resa.gite === r.gite &&
                            parseLocalDate(resa.dateDebut).toDateString() === menageDate.toDateString()
                        );
                        heure = arriveeLundi ? '07h00' : '12h00';
                    } else {
                        heure = '12h00';
                    }
                }
                // R√àGLE 2: Samedi
                else if (departDay === 6) {
                    if (arriveeMemejour) {
                        heure = '12h00';
                    } else {
                        menageDate.setDate(menageDate.getDate() + 2);
                        heure = '12h00';
                    }
                }
                // R√àGLE 3: Lundi-Vendredi
                else {
                    heure = '12h00';
                }

                const dateKey = menageDate.toISOString().split('T')[0];
                const period = heure === '07h00' ? 'matin' : 'apr√®s-midi';

                if (!occupiedSlots[dateKey]) {
                    occupiedSlots[dateKey] = { matin: null, 'apr√®s-midi': null };
                }

                if (!occupiedSlots[dateKey][period]) {
                    occupiedSlots[dateKey][period] = r.gite;
                    planning.push({
                        date: menageDate,
                        heure: heure,
                        period: period,
                        gite: r.gite,
                        clientName: r.nom,
                        departDate: departDate
                    });
                } else {
                    const autreCreneau = period === 'matin' ? 'apr√®s-midi' : 'matin';
                    const autreHeure = period === 'matin' ? '12h00' : '07h00';

                    if (!occupiedSlots[dateKey][autreCreneau]) {
                        occupiedSlots[dateKey][autreCreneau] = r.gite;
                        planning.push({
                            date: menageDate,
                            heure: autreHeure,
                            period: autreCreneau,
                            gite: r.gite,
                            clientName: r.nom,
                            departDate: departDate
                        });
                    }
                }
            });

            const planningForMonth = planning.filter(p =>
                p.date.getFullYear() === targetYear && p.date.getMonth() === targetMonth
            );

            if (planningForMonth.length === 0) {
                showToast('Aucun m√©nage √† planifier pour ce mois', 'error');
                return;
            }

            // Cr√©er le workbook avec style
            const wb = XLSX.utils.book_new();
            
            // Pr√©parer les donn√©es avec formatage
            const data = planningForMonth.map(p => ({
                'üìÖ Date': p.date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }),
                '‚è∞ Heure': p.heure,
                'üè† G√Æte': p.gite,
                'üë§ Client': p.clientName,
                'üö™ D√©part': p.departDate.toLocaleDateString('fr-FR'),
                '‚ö° Enchainement': p.period === 'matin' ? 'Oui' : 'Non'
            }));

            // Cr√©er la feuille
            const ws = XLSX.utils.json_to_sheet(data);
            
            // D√©finir les largeurs de colonnes
            ws['!cols'] = [
                { wch: 35 }, // Date
                { wch: 10 }, // Heure
                { wch: 12 }, // G√Æte
                { wch: 20 }, // Client
                { wch: 12 }, // D√©part
                { wch: 15 }  // Enchainement
            ];
            
            const sheetName = `M√©nages ${monthInput}`;
            XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31));
            const dateToday = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `MenageCalvignac_${dateToday}.xlsx`);

            showToast(`‚úì Export Excel t√©l√©charg√© ! (${planningForMonth.length} m√©nages)`);
        }

        
        
        // ==========================================
        // üìÑ GESTION INFOS G√éTES & COMMUNICATION CLIENTS
        // ==========================================
        // D√âPLAC√â dans js/infos-gites.js et js/fiche-client.js
        // Fonctions disponibles :
        // - loadInfosGites, genererPageClient, envoyerViaWhatsApp, envoyerViaSMS
        // - telechargerPageHTML, aper√ßuFicheClient
        // - sauvegarder/chargerActivitesEtSorties (restaurants, Lyon, Dombes, parcs)
        // - rechercherEvenements, clearAllData
        // - saveInfosGiteToSupabase, loadInfosGiteFromSupabase
        
        // ==========================================
        // üó∫Ô∏è GESTION "√Ä D√âCOUVRIR"
        // ==========================================
        
        // Coordonn√©es GPS des g√Ætes (d√©finies dans shared-config.js)
        // Utiliser window.GITES_COORDS
        
        // Informations compl√®tes des g√Ætes
        const GITES_INFOS = {
            'Tr√©voux': {
                nom: 'G√Æte de Tr√©voux',
                emoji: 'üè∞',
                couleur_principale: '#667eea',
                couleur_secondaire: '#764ba2',
                adresse: '2 Grande Rue, 01600 Tr√©voux',
                code_acces: '1234A',
                wifi_nom: 'Gite_Trevoux',
                wifi_mdp: 'BienvenueTrevoux2024',
                parking: 'Parking gratuit rue de la R√©publique (2min √† pied)',
                contact_email: 'gite.trevoux@example.com',
                contact_telephone: '06 12 34 56 78',
                check_in: '16h00',
                check_out: '10h00',
                infos_pratiques: [
                    {
                        titre: 'üîë Acc√®s au Logement',
                        contenu: `
                            <p><strong>Adresse :</strong> 2 Grande Rue, 01600 Tr√©voux</p>
                            <p><strong>Code d'acc√®s :</strong></p>
                            <div class="highlight">1234A</div>
                            <p>Le bo√Ætier √† code est situ√© √† gauche de la porte d'entr√©e.</p>
                        `
                    },
                    {
                        titre: 'üì∂ WiFi',
                        contenu: `
                            <p><strong>R√©seau :</strong> Gite_Trevoux</p>
                            <div class="highlight">Mot de passe : BienvenueTrevoux2024</div>
                        `
                    },
                    {
                        titre: 'üöó Parking',
                        contenu: `
                            <p>Parking public gratuit rue de la R√©publique (2 minutes √† pied)</p>
                            <p>Places limit√©es, arrivez t√¥t le week-end.</p>
                        `
                    },
                    {
                        titre: 'üïê Horaires',
                        contenu: `
                            <p><strong>Arriv√©e :</strong> √† partir de 16h00</p>
                            <p><strong>D√©part :</strong> avant 10h00</p>
                            <p>Merci de respecter ces horaires pour permettre le m√©nage.</p>
                        `
                    },
                    {
                        titre: '‚ôªÔ∏è Tri des D√©chets',
                        contenu: `
                            <p><strong>Poubelle jaune :</strong> Recyclables (plastique, carton, m√©tal)</p>
                            <p><strong>Poubelle noire :</strong> Ordures m√©nag√®res</p>
                            <p><strong>Poubelle verte :</strong> Verre</p>
                            <p>Conteneurs situ√©s rue de la Mairie (50m)</p>
                        `
                    },
                    {
                        titre: 'üèõÔ∏è √Ä Proximit√© Imm√©diate',
                        contenu: `
                            <p>‚Ä¢ Boulangerie Chazelle (100m)</p>
                            <p>‚Ä¢ Supermarch√© Carrefour City (200m)</p>
                            <p>‚Ä¢ Pharmacie (150m)</p>
                            <p>‚Ä¢ Ch√¢teau-Fort de Tr√©voux (400m)</p>
                        `
                    },
                    {
                        titre: 'üö® Urgences',
                        contenu: `
                            <p><strong>Pompiers :</strong> 18</p>
                            <p><strong>SAMU :</strong> 15</p>
                            <p><strong>Police :</strong> 17</p>
                            <p><strong>H√¥pital le plus proche :</strong> Centre Hospitalier de Tr√©voux (1km)</p>
                        `
                    }
                ]
            },
            'Couzon': {
                nom: 'G√Æte de Couzon-au-Mont-d\'Or',
                emoji: '‚õ∞Ô∏è',
                couleur_principale: '#f093fb',
                couleur_secondaire: '#f5576c',
                adresse: '14 rue de la R√©publique, 69270 Couzon-au-Mont-d\'Or',
                code_acces: '5678B',
                wifi_nom: 'Gite_Couzon',
                wifi_mdp: 'BienvenueCouzon2024',
                parking: 'Parking priv√© derri√®re le g√Æte',
                contact_email: 'gite.couzon@example.com',
                contact_telephone: '06 98 76 54 32',
                check_in: '16h00',
                check_out: '10h00',
                infos_pratiques: [
                    {
                        titre: 'üîë Acc√®s au Logement',
                        contenu: `
                            <p><strong>Adresse :</strong> 14 rue de la R√©publique, 69270 Couzon-au-Mont-d'Or</p>
                            <p><strong>Code d'acc√®s :</strong></p>
                            <div class="highlight">5678B</div>
                            <p>Le bo√Ætier √† code est situ√© √† droite de la porte d'entr√©e.</p>
                        `
                    },
                    {
                        titre: 'üì∂ WiFi',
                        contenu: `
                            <p><strong>R√©seau :</strong> Gite_Couzon</p>
                            <div class="highlight">Mot de passe : BienvenueCouzon2024</div>
                        `
                    },
                    {
                        titre: 'üöó Parking',
                        contenu: `
                            <p><strong>Parking priv√©</strong> derri√®re le g√Æte</p>
                            <p>Acc√®s par le portail, code identique √† l'entr√©e du g√Æte.</p>
                            <p>2 places disponibles.</p>
                        `
                    },
                    {
                        titre: 'üïê Horaires',
                        contenu: `
                            <p><strong>Arriv√©e :</strong> √† partir de 16h00</p>
                            <p><strong>D√©part :</strong> avant 10h00</p>
                            <p>Merci de respecter ces horaires pour permettre le m√©nage.</p>
                        `
                    },
                    {
                        titre: '‚ôªÔ∏è Tri des D√©chets',
                        contenu: `
                            <p><strong>Poubelle jaune :</strong> Recyclables (plastique, carton, m√©tal)</p>
                            <p><strong>Poubelle noire :</strong> Ordures m√©nag√®res</p>
                            <p><strong>Poubelle verte :</strong> Verre</p>
                            <p>Conteneurs au fond de l'impasse</p>
                        `
                    },
                    {
                        titre: 'üèõÔ∏è √Ä Proximit√© Imm√©diate',
                        contenu: `
                            <p>‚Ä¢ Boulangerie (200m)</p>
                            <p>‚Ä¢ Supermarch√© Intermarch√© √† Albigny (2km)</p>
                            <p>‚Ä¢ Pharmacie √† Albigny (2km)</p>
                            <p>‚Ä¢ Sentiers de randonn√©e Mont d'Or (500m)</p>
                        `
                    },
                    {
                        titre: 'üö® Urgences',
                        contenu: `
                            <p><strong>Pompiers :</strong> 18</p>
                            <p><strong>SAMU :</strong> 15</p>
                            <p><strong>Police :</strong> 17</p>
                            <p><strong>H√¥pital le plus proche :</strong> H√¥pital Lyon Nord (8km)</p>
                        `
                    }
                ]
            }
        };
        
        // Stocker les activit√©s par g√Æte
        let activitesParGite = {
            'Tr√©voux': [],
            'Couzon': []
        };
        
        // Ouvrir la modale d'activit√©
        function ouvrirModalActivite(isModification = false, positionY = null) {
            const modal = document.getElementById('modalActivite');
            const overlay = document.getElementById('modalOverlay');
            
            modal.style.display = 'block';
            overlay.style.display = 'block';
            
            // Si une position est fournie, la modale s'affiche √† cet endroit
            if (positionY !== null) {
                modal.style.top = positionY + 'px';
                modal.style.transform = 'translate(-50%, -50%)';
            } else {
                // Sinon, centr√©e au milieu de l'√©cran
                modal.style.top = '50%';
                modal.style.transform = 'translate(-50%, -50%)';
            }
            
            const modalTitle = document.getElementById('modalTitle');
            const btnSave = document.getElementById('btnSaveActivite');
            
            if (isModification) {
                modalTitle.textContent = '‚úèÔ∏è Modifier l\'Activit√©';
                btnSave.textContent = '‚úèÔ∏è Modifier cette activit√©';
                btnSave.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else {
                modalTitle.textContent = '‚ûï Ajouter une Activit√©';
                btnSave.textContent = '‚ûï Ajouter cette activit√©';
                btnSave.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)';
            }
        }
        
        // Fermer la modale d'activit√©
        function fermerModalActivite() {
            document.getElementById('modalActivite').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            // R√©initialiser le formulaire
            document.getElementById('activite_nom').value = '';
            document.getElementById('activite_categorie').value = '';
            document.getElementById('activite_description').value = '';
            document.getElementById('activite_adresse').value = '';
            document.getElementById('activite_latitude').value = '';
            document.getElementById('activite_longitude').value = '';
            document.getElementById('activite_distance').value = '';
            document.getElementById('activite_note').value = '';
            document.getElementById('activite_avis').value = '';
            document.getElementById('activite_prix').value = '';
            document.getElementById('activite_telephone').value = '';
            document.getElementById('activite_website').value = '';
            document.getElementById('activite_type_resto').value = '';
            document.getElementById('typeRestoDiv').style.display = 'none';
            delete window.activiteEnCoursDeModification;
        }
        
        // Utiliser GITES_COORDS depuis shared-config.js (window.GITES_COORDS)
        // Pas besoin de red√©clarer ici
        
        // Calculer la distance entre deux points GPS (formule de Haversine)
        function calculerDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return Math.round(distance * 100) / 100; // Arrondi √† 2 d√©cimales
        }
        
        // Obtenir les coordonn√©es GPS depuis l'adresse
        async function obtenirCoordonnees() {
            const adresse = document.getElementById('activite_adresse').value.trim();
            
            if (!adresse) {
                showNotification('‚ö†Ô∏è Veuillez d\'abord entrer une adresse', 'warning');
                return;
            }
            
            showNotification('üìç R√©cup√©ration des coordonn√©es GPS...', 'info');
            
            const gite = document.getElementById('decouvrir_gite').value;
            const coords = await geocodeAddress(adresse, gite);
            
            if (coords && coords.lat && coords.lng) {
                document.getElementById('activite_latitude').value = coords.lat;
                document.getElementById('activite_longitude').value = coords.lng;
                
                // Calculer et afficher les distances pour les deux g√Ætes
                const distTrevoux = calculerDistance(window.GITES_COORDS['Tr√©voux'].lat, window.GITES_COORDS['Tr√©voux'].lng, coords.lat, coords.lng);
                const distCouzon = calculerDistance(window.GITES_COORDS['Couzon'].lat, window.GITES_COORDS['Couzon'].lng, coords.lat, coords.lng);
                
                showNotification(`‚úì Coordonn√©es trouv√©es : ${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}\nüìè Distance Tr√©voux: ${distTrevoux}km | Couzon: ${distCouzon}km`, 'success');
            } else {
                showNotification('‚ùå Impossible de trouver les coordonn√©es pour cette adresse', 'error');
            }
        }
        
        // Charger les activit√©s depuis Supabase
        // Afficher/cacher le champ type de restaurant selon la cat√©gorie
        function afficherTypeRestoSiRestaurant() {
            const categorie = document.getElementById('activite_categorie').value;
            const typeRestoDiv = document.getElementById('typeRestoDiv');
            if (categorie === 'Restaurant') {
                typeRestoDiv.style.display = 'block';
            } else {
                typeRestoDiv.style.display = 'none';
            }
        }
        
        // ==================== CHARGER ACTIVIT√âS - D√©plac√© dans js/decouvrir.js ====================
        // Voir js/decouvrir.js pour: chargerActivites, chargerToutSurCarte, afficherActivites,
        // supprimerActivite, modifierActivite, filtrerActivitesParCategorie, etc.
        
        // S√©lectionner un g√Æte pour "√Ä D√©couvrir"
        function selectGiteDecouvrir(gite) {
            document.getElementById('decouvrir_gite').value = gite;
            document.getElementById('formDecouvrir').style.display = 'block';
            
            // Mettre √† jour les styles des boutons de s√©lection de g√Æte
            const boutonTrevoux = document.querySelector('[onclick*="selectGiteDecouvrir(\'Tr√©voux\')"]');
            const boutonCouzon = document.querySelector('[onclick*="selectGiteDecouvrir(\'Couzon\')"]');
            
            if (gite === 'Tr√©voux') {
                if (boutonTrevoux) {
                    boutonTrevoux.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    boutonTrevoux.style.color = 'white';
                }
                if (boutonCouzon) {
                    boutonCouzon.style.background = 'white';
                    boutonCouzon.style.color = '#FF6B6B';
                }
            } else {
                if (boutonCouzon) {
                    boutonCouzon.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    boutonCouzon.style.color = 'white';
                }
                if (boutonTrevoux) {
                    boutonTrevoux.style.background = 'white';
                    boutonTrevoux.style.color = '#FF6B6B';
                }
            }
            
            // Masquer le message de g√Æte s√©lectionn√©
            const alertInfo = document.querySelector('#formDecouvrir .alert.alert-info');
            if (alertInfo) alertInfo.style.display = 'none';
            
            // Charger et afficher les activit√©s
            chargerActivites();
            
            // Charger automatiquement les √©v√©nements de la semaine
            setTimeout(() => {
                rechercherEvenements();
            }, 100);
            
            // Charger automatiquement les √©v√©nements et afficher TOUT sur la carte
            setTimeout(() => {
                chargerToutSurCarte();
            }, 500);
        }
        
        // Fonction pour g√©ocoder une adresse (convertir adresse ‚Üí coordonn√©es GPS)
        async function geocodeAddress(address, gite) {
            try {
                // Si l'adresse est vide, utiliser les coordonn√©es du g√Æte
                if (!address || address.trim() === '') {
                    return gite === 'Tr√©voux' 
                        ? { lat: 45.9394, lng: 4.7728 }
                        : { lat: 45.8442, lng: 4.8365 };
                }
                
                // Utiliser Nominatim (OpenStreetMap) pour le g√©ocodage
                const encodedAddress = encodeURIComponent(address + ', France');
                
                // Ajouter un d√©lai pour respecter la politique de Nominatim (1 req/sec max)
                await new Promise(resolve => setTimeout(resolve, 1100));
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`, {
                    headers: {
                        'User-Agent': 'GestionGite/1.0 (gite.welcomehome@gmail.com)'
                    }
                });
                
                if (!response.ok) {
                    // Utiliser coordonn√©es par d√©faut
                    return gite === 'Tr√©voux' 
                        ? { lat: 45.9394, lng: 4.7728 }
                        : { lat: 45.8442, lng: 4.8365 };
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                
                // Si le g√©ocodage √©choue, coordonn√©es par d√©faut du g√Æte
                return gite === 'Tr√©voux' 
                    ? { lat: 45.9394, lng: 4.7728 }
                    : { lat: 45.8442, lng: 4.8365 };
            } catch (error) {
                console.error('Erreur g√©ocodage:', address, error);
                return gite === 'Tr√©voux' 
                    ? { lat: 45.9394, lng: 4.7728 }
                    : { lat: 45.8442, lng: 4.8365 };
            }
        }
        
        // ==================== CHARGER TOUT SUR CARTE - D√©plac√© dans js/decouvrir.js ====================
        
        // Rechercher automatiquement via Google Places API (simulation sans cl√© API)
        async function rechercherAutomatique(type) {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîç Filtrage en cours...', 'info');
            
            // Mapper les types de recherche vers les cat√©gories
            const typeToCategorie = {
                'restaurants': 'üçΩÔ∏è Restaurant',
                'tourist_attraction': 'üèõÔ∏è Site Touristique',
                'shopping_mall': 'üõçÔ∏è Commerce',
                'park': 'üå≥ Nature & Randonn√©e'
            };
            
            const categorieRecherchee = typeToCategorie[type];
            
            if (!categorieRecherchee) {
                showNotification('‚ö†Ô∏è Type de recherche non reconnu', 'warning');
                return;
            }
            
            // R√©cup√©rer la distance max actuelle
            const maxDistance = parseInt(document.getElementById('distanceFilter').value);
            
            // Filtrer tous les points (√©v√©nements + activit√©s) selon la cat√©gorie ET la distance
            if (window.allEvenements) {
                const pointsFiltres = window.allEvenements.filter(item => {
                    return item.categorie === categorieRecherchee && item.distance <= maxDistance;
                });
                
                
                // Mettre √† jour la carte avec les points filtr√©s
                if (pointsFiltres.length > 0) {
                    afficherCarteEvenements(pointsFiltres);
                    showNotification(`‚úì ${pointsFiltres.length} point(s) de type "${categorieRecherchee}" (‚â§${maxDistance}km)`, 'success');
                } else {
                    showNotification(`‚ÑπÔ∏è Aucun point de type "${categorieRecherchee}" √† ‚â§${maxDistance}km`, 'info');
                }
            }
            
            // R√©cup√©rer les activit√©s du g√Æte s√©lectionn√©
            const activites = activitesParGite[gite] || [];
            
            // Filtrer par cat√©gorie
            const activitesFiltrees = activites.filter(act => act.categorie === categorieRecherchee);
            
            // Afficher les r√©sultats dans la liste
            const container = document.getElementById('activitesParCategorie');
            
            if (activitesFiltrees.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <h3 style="color: #856404; margin-bottom: 10px;">Aucun r√©sultat pour "${categorieRecherchee}"</h3>
                        <p style="color: #666;">Essayez d'ajouter des activit√©s de cette cat√©gorie manuellement ci-dessous.</p>
                    </div>
                `;
                return;
                return;
            }
            
            // Afficher uniquement cette cat√©gorie
            let html = `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--primary); font-size: 1.3rem; border-bottom: 2px solid var(--border); padding-bottom: 10px; flex: 1;">
                            ${categorieRecherchee} (${activitesFiltrees.length})
                        </h3>
                        <button onclick="afficherActivites('${gite}')" class="btn" style="background: #6c757d; color: white; padding: 8px 16px; font-size: 0.9rem;">
                            üîÑ Tout Afficher
                        </button>
                    </div>
                    <div style="display: grid; gap: 15px;">
            `;
            
            activitesFiltrees.forEach(act => {
                const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) : '';
                const distanceText = act.distance ? `üìç ${act.distance} km` : '';
                const prixText = act.prix || '';
                
                html += `
                    <div style="background: #f8f9fa; border-left: 4px solid var(--primary); padding: 20px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h4 style="margin: 0; font-size: 1.1rem; color: #2C5F7D;">${act.nom}</h4>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="modifierActivite(${act.id})" title="Modifier" style="background: transparent; border: none; cursor: pointer; font-size: 1.4rem; padding: 4px 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="supprimerActivite(${act.id})" title="Supprimer" style="background: transparent; border: none; cursor: pointer; font-size: 1.4rem; padding: 4px 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        ${act.description ? `<p style="margin: 10px 0; color: #555;">${act.description}</p>` : ''}
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; font-size: 0.9rem; color: #666;">
                            ${distanceText ? `<span>${distanceText}</span>` : ''}
                            ${noteStars ? `<span>${noteStars} ${act.note}/5 ${act.avis ? `(${act.avis} avis)` : ''}</span>` : ''}
                            ${prixText ? `<span>üí∞ ${prixText}</span>` : ''}
                        </div>
                        
                        ${act.adresse ? `<p style="margin: 10px 0 5px 0; color: #666; font-size: 0.9rem;">üìç ${act.adresse}</p>` : ''}
                        ${act.telephone ? `<p style="margin: 5px 0; color: #666; font-size: 0.9rem;">üìû ${act.telephone}</p>` : ''}
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            ${act.google_maps_link ? `
                                <a href="${act.google_maps_link}" target="_blank" title="Itin√©raire Google Maps" style="background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; padding: 10px 16px; text-decoration: none; font-size: 1.2rem; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#dc2626'; this.style.color='#dc2626'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.borderColor='#ef4444'; this.style.color='#ef4444'; this.style.transform='translateY(0)'">
                                    <img src="./images/location-pin.svg" alt="Localisation" style="width: 20px; height: 20px; object-fit: contain;">
                                </a>
                            ` : ''}
                            ${act.website ? `
                                <a href="${act.website}" target="_blank" title="Site web" style="background: white; color: #3b82f6; border: 2px solid #3b82f6; border-radius: 8px; padding: 10px 16px; text-decoration: none; font-size: 1.2rem; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);" onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#1e40af'; this.style.color='#1e40af'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'; this.style.transform='translateY(0)'">
                                    <img src="./images/web-redirect.svg" alt="Web" style="width: 20px; height: 20px; object-fit: contain;">
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            container.innerHTML = html;
            
            showNotification(`‚úì ${activitesFiltrees.length} activit√©(s) trouv√©e(s) pour "${categorieRecherchee}"`, 'success');
        }
        
        // Rechercher les √©v√©nements de la semaine
        async function rechercherEvenements() {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîç Recherche d\'√©v√©nements...', 'info');
            
            const evenementsDiv = document.getElementById('evenementsListe');
            const mapDiv = document.getElementById('mapEvenements');
            
            // Obtenir la date d'ouverture de la page (aujourd'hui)
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Lundi de cette semaine
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Dimanche
            
            const dateRangeStr = `${startOfWeek.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })} au ${endOfWeek.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}`;
            document.getElementById('dateEvenements').textContent = dateRangeStr;
            
            // Fonction pour g√©n√©rer les √©v√©nements de la semaine en cours
            function genererEvenementsSemaine(gite) {
                const evenements = [];
                const joursSemaine = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
                
                // √âv√©nements r√©currents selon le g√Æte
                if (gite === 'Tr√©voux') {
                    // March√© de Tr√©voux - tous les samedis
                    const samedi = new Date(startOfWeek);
                    samedi.setDate(startOfWeek.getDate() + 5); // Samedi
                    evenements.push({
                        titre: 'March√© de Tr√©voux',
                        date: `Samedi ${samedi.getDate()}/${samedi.getMonth() + 1} - 8h √† 13h`,
                        dateDebut: samedi,
                        dateFin: new Date(samedi.getTime() + 5 * 60 * 60 * 1000), // +5h
                        lieu: 'Place de la Terrasse, Tr√©voux',
                        description: 'March√© hebdomadaire avec produits locaux, fromages, fruits et l√©gumes frais',
                        lien: 'https://www.ville-trevoux.fr',
                        icone: 'üõí',
                        distance: 0.5,
                        lat: 45.9394,
                        lng: 4.7728,
                        type: 'evenement'
                    });
                    
                    // Visite du Ch√¢teau - mercredi au dimanche
                    for (let i = 3; i <= 6; i++) { // Mercredi √† samedi
                        const jour = new Date(startOfWeek);
                        jour.setDate(startOfWeek.getDate() + i - 1);
                        if (i === 3) { // Ajouter seulement une fois
                            evenements.push({
                                titre: 'Visite du Ch√¢teau-Fort',
                                date: `Mercredi au dimanche - 14h √† 18h`,
                                dateDebut: jour,
                                dateFin: endOfWeek,
                                lieu: 'Mont√©e du Ch√¢teau, Tr√©voux',
                                description: 'Monument Historique class√© en 1913. D√©couvrez l\'histoire du Parlement de Dombes',
                                lien: 'https://www.ain-tourisme.com',
                                icone: 'üè∞',
                                distance: 1,
                                lat: 45.9404,
                                lng: 4.7738,
                                type: 'evenement'
                            });
                        }
                    }
                    
                    // Concert √† l'√©glise - vendredi soir
                    const vendredi = new Date(startOfWeek);
                    vendredi.setDate(startOfWeek.getDate() + 4);
                    evenements.push({
                        titre: 'Concert √† l\'√âglise Saint-Symphorien',
                        date: `Vendredi ${vendredi.getDate()}/${vendredi.getMonth() + 1} - 20h30`,
                        dateDebut: vendredi,
                        dateFin: new Date(vendredi.getTime() + 2 * 60 * 60 * 1000),
                        lieu: '√âglise Saint-Symphorien, Tr√©voux',
                        description: 'Concert de musique classique avec l\'ensemble Les Cordes de l\'Ain',
                        lien: 'https://www.ville-trevoux.fr/culture',
                        icone: 'üéµ',
                        distance: 0.8,
                        lat: 45.9410,
                        lng: 4.7745,
                        type: 'evenement'
                    });
                    
                    // Atelier cr√©atif - mercredi apr√®s-midi
                    const mercredi = new Date(startOfWeek);
                    mercredi.setDate(startOfWeek.getDate() + 2);
                    evenements.push({
                        titre: 'Atelier Cr√©atif Enfants',
                        date: `Mercredi ${mercredi.getDate()}/${mercredi.getMonth() + 1} - 14h √† 16h`,
                        dateDebut: mercredi,
                        dateFin: new Date(mercredi.getTime() + 2 * 60 * 60 * 1000),
                        lieu: 'M√©diath√®que de Tr√©voux',
                        description: 'Atelier de cr√©ation manuelle pour les 6-12 ans. Inscription gratuite.',
                        lien: 'https://www.mediatheque-trevoux.fr',
                        icone: 'üé®',
                        distance: 0.6,
                        lat: 45.9398,
                        lng: 4.7720,
                        type: 'evenement'
                    });
                    
                } else if (gite === 'Couzon') {
                    // March√© de Couzon - tous les dimanches
                    const dimanche = new Date(startOfWeek);
                    dimanche.setDate(startOfWeek.getDate() + 6);
                    evenements.push({
                        titre: 'March√© de Couzon',
                        date: `Dimanche ${dimanche.getDate()}/${dimanche.getMonth() + 1} - 8h √† 13h`,
                        dateDebut: dimanche,
                        dateFin: new Date(dimanche.getTime() + 5 * 60 * 60 * 1000),
                        lieu: 'Place du village, Couzon',
                        description: 'March√© local avec producteurs de la r√©gion',
                        lien: 'https://www.couzon-au-mont-dor.fr',
                        icone: 'üõí',
                        distance: 0.3,
                        lat: 45.8452,
                        lng: 4.8375,
                        type: 'evenement'
                    });
                    
                    // Randonn√©e guid√©e - samedi matin
                    const samedi = new Date(startOfWeek);
                    samedi.setDate(startOfWeek.getDate() + 5);
                    evenements.push({
                        titre: 'Randonn√©e Guid√©e Mont d\'Or',
                        date: `Samedi ${samedi.getDate()}/${samedi.getMonth() + 1} - 9h`,
                        dateDebut: samedi,
                        dateFin: new Date(samedi.getTime() + 3 * 60 * 60 * 1000),
                        lieu: 'D√©part parking Mont d\'Or, Couzon',
                        description: 'Randonn√©e de 3h avec guide pour d√©couvrir la faune et la flore locale',
                        lien: 'https://www.monts-dor.com',
                        icone: 'ü•æ',
                        distance: 0.5,
                        lat: 45.8442,
                        lng: 4.8365,
                        type: 'evenement'
                    });
                    
                    // Yoga en plein air - mercredi et vendredi
                    const mercredi = new Date(startOfWeek);
                    mercredi.setDate(startOfWeek.getDate() + 2);
                    evenements.push({
                        titre: 'Yoga en Plein Air',
                        date: `Mercredi ${mercredi.getDate()}/${mercredi.getMonth() + 1} - 18h30`,
                        dateDebut: mercredi,
                        dateFin: new Date(mercredi.getTime() + 1.5 * 60 * 60 * 1000),
                        lieu: 'Parc de Couzon',
                        description: 'S√©ance de yoga tous niveaux en ext√©rieur. Apportez votre tapis.',
                        lien: 'https://www.couzon-au-mont-dor.fr/yoga',
                        icone: 'üßò',
                        distance: 0.4,
                        lat: 45.8445,
                        lng: 4.8370,
                        type: 'evenement'
                    });
                    
                    // D√©gustation de vins - jeudi soir
                    const jeudi = new Date(startOfWeek);
                    jeudi.setDate(startOfWeek.getDate() + 3);
                    evenements.push({
                        titre: 'D√©gustation Vins Locaux',
                        date: `Jeudi ${jeudi.getDate()}/${jeudi.getMonth() + 1} - 19h`,
                        dateDebut: jeudi,
                        dateFin: new Date(jeudi.getTime() + 2 * 60 * 60 * 1000),
                        lieu: 'Cave du Mont d\'Or, Couzon',
                        description: 'D√©couverte des vins de la r√©gion avec un sommelier. R√©servation conseill√©e.',
                        lien: 'https://www.cave-montdor.fr',
                        icone: 'üç∑',
                        distance: 0.7,
                        lat: 45.8448,
                        lng: 4.8372,
                        type: 'evenement'
                    });
                }
                
                return evenements;
            }
            
            // G√©n√©rer les √©v√©nements de la semaine en cours
            window.allEvenements = genererEvenementsSemaine(gite);
            
            if (window.allEvenements.length === 0) {
                evenementsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun √©v√©nement trouv√© pour ce g√Æte</p>';
                showNotification('‚ö†Ô∏è Aucun √©v√©nement trouv√©', 'warning');
                mapDiv.style.display = 'none';
                return;
            }
            
            // Afficher la carte
            mapDiv.style.display = 'block';
            afficherCarteEvenements(window.allEvenements);
            
            // Appliquer le filtre de distance
            filtrerEvenements();
            
            showNotification(`‚úì ${window.allEvenements.length} √©v√©nement(s) trouv√©(s)`, 'success');
        }
        
        // Fonction pour filtrer les √©v√©nements selon la distance
        function filtrerEvenements() {
            const distanceFilter = document.getElementById('distanceFilter');
            let maxDistance = 50; // Distance par d√©faut si pas de slider
            
            if (!distanceFilter) {
            } else {
                maxDistance = parseInt(distanceFilter.value);
            }
            
            const evenementsFiltres = window.allEvenements.filter(e => e.distance <= maxDistance);
            
            const evenementsDiv = document.getElementById('evenementsListe');
            const gite = document.getElementById('decouvrir_gite').value;
            
            if (evenementsFiltres.length === 0) {
                evenementsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun √©v√©nement trouv√© dans ce rayon</p>';
                return;
            }
            
            let html = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <strong>üìÖ ${evenementsFiltres.length} √©v√©nement(s) autour de ${gite}</strong> (‚â§ ${maxDistance} km)<br>
                    <small style="color: #666;">Mis √† jour le ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</small>
                </div>
            `;
            
            evenementsFiltres.forEach(event => {
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">${event.icone}</span> ${event.titre}
                        </h3>
                        <p style="margin: 5px 0; opacity: 0.95; font-size: 0.95rem;"><strong>üìç</strong> ${event.lieu} <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; margin-left: 8px;">${event.distance} km</span></p>
                        <p style="margin: 5px 0; opacity: 0.95; font-size: 0.95rem;"><strong>üóìÔ∏è</strong> ${event.date}</p>
                        <p style="margin: 15px 0; line-height: 1.5;">${event.description}</p>
                        <a href="${event.lien}" target="_blank" style="background: white; color: #667eea; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            üîó Plus d'infos
                        </a>
                    </div>
                `;
            });
            
            evenementsDiv.innerHTML = html;
        }
        
        // Variables globales pour la carte
        let mapInstance = null;
        let markersLayer = null;
        let giteMarker = null;
        let filtreCategorieActive = null; // Variable pour stocker le filtre de cat√©gorie actif
        
        // Coordonn√©es des g√Ætes
        const giteCoords = {
            'Tr√©voux': { lat: 45.9396, lng: 4.7733 },
            'Couzon': { lat: 45.8439, lng: 4.8288 }
        };
        
        // Fonction pour afficher tout (r√©initialise les filtres)
        function afficherTout() {
            if (window.allEvenements && window.allEvenements.length > 0) {
                // R√©initialiser le filtre de distance
                const maxDistance = parseInt(document.getElementById('distanceFilter').value);
                const pointsFiltres = window.allEvenements.filter(e => e.distance <= maxDistance);
                
                afficherCarteEvenements(pointsFiltres);
                showNotification(`‚úì ${pointsFiltres.length} points affich√©s (‚â§${maxDistance}km)`, 'success');
            }
        }
        
        // Fonction pour afficher la carte avec les √©v√©nements
        // üé® Fonction pour obtenir l'ic√¥ne du marqueur selon la cat√©gorie
        function getMarkerIcon(item) {
            let markerUrl = './images/location-pin.svg';
            let markerColor = '#667eea';
            
            if (item.isActivite && item.categorie) {
                switch(item.categorie) {
                    case 'Restaurant':
                        markerUrl = './images/marker-restaurant.svg';
                        markerColor = '#10b981';
                        break;
                    case 'Mus√©e':
                        markerUrl = './images/marker-musee.svg';
                        markerColor = '#3b82f6';
                        break;
                    case 'Caf√©':
                        markerUrl = './images/marker-cafe.svg';
                        markerColor = '#f59e0b';
                        break;
                    case 'Parc':
                        markerUrl = './images/marker-parc.svg';
                        markerColor = '#8b5cf6';
                        break;
                    case 'H√¥tel':
                        markerUrl = './images/marker-hotel.svg';
                        markerColor = '#ec4899';
                        break;
                }
            }
            
            // Cr√©er une ic√¥ne avec l'image SVG
            const iconHtml = `<img src="${markerUrl}" alt="${item.categorie || 'Marqueur'}" style="width: 40px; height: 40px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">`;
            
            return L.divIcon({
                html: iconHtml,
                className: 'custom-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }
        
        function afficherCarteEvenements(evenements) {
            const mapContainer = document.getElementById('mapEvenements');
            
            // Si aucun √©v√©nement n'est fourni, utiliser les activit√©s charg√©es
            if (!evenements) {
                const gite = document.getElementById('decouvrir_gite')?.value;
                if (gite && window.activitesParGite && window.activitesParGite[gite]) {
                    evenements = window.activitesParGite[gite];
                } else {
                    evenements = [];
                }
            }
            
            // Filtrer les √©v√©nements (ne garder que les activit√©s permanentes, pas les √©v√©nements)
            evenements = evenements.filter(e => !e.type || e.type !== 'evenement');
            
            // Filtrer les points avec des coordonn√©es valides
            let evenementsValides = evenements.filter(e => {
                const isValid = e.lat && e.lng && !isNaN(e.lat) && !isNaN(e.lng) && 
                               isFinite(e.lat) && isFinite(e.lng);
                return isValid;
            });
            
            const nbInvalides = evenements.length - evenementsValides.length;
            if (nbInvalides > 0) {
            }
            
            // üîç Appliquer le filtre de cat√©gorie s'il est actif
            if (window.filtreCategorieActive) {
                evenementsValides = evenementsValides.filter(e => 
                    e.categorie && e.categorie.toLowerCase().includes(window.filtreCategorieActive.toLowerCase())
                );
            }
            
            if (evenementsValides.length === 0) {
                console.error('‚ùå Aucun point avec coordonn√©es valides');
                mapContainer.style.display = 'none';
                return;
            }
            
            mapContainer.style.display = 'block';
            
            // V√©rifier si la carte existe d√©j√† (via l'attribut Leaflet)
            const carteExiste = mapContainer._leaflet_id !== undefined;
            
            // Si la carte n'existe pas encore, la cr√©er
            if (!carteExiste && !mapInstance) {
                try {
                    
                    // Cr√©er la carte Leaflet avec zoom activ√©
                    mapInstance = L.map('mapEvenements', {
                        center: [46.2276, 2.2137],
                        zoom: 6,
                        zoomControl: true,
                        scrollWheelZoom: true,
                        doubleClickZoom: true,
                        boxZoom: true,
                        keyboard: true,
                        dragging: true
                    });
                    
                    // Ajouter les tuiles OpenStreetMap
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 18
                    }).addTo(mapInstance);
                    
                    // Cr√©er un layer group pour les marqueurs
                    markersLayer = L.layerGroup().addTo(mapInstance);
                    
                } catch (error) {
                    console.error('‚ùå Erreur cr√©ation carte:', error);
                    mapContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Erreur lors du chargement de la carte</p>';
                    return;
                }
            }
            
            // Si la carte existe mais les layers pas, les recr√©er
            if (mapInstance && !markersLayer) {
                markersLayer = L.layerGroup().addTo(mapInstance);
            }
            
            if (!mapInstance || !markersLayer) {
                console.error('‚ùå Carte ou layer non disponibles');
                return;
            }
            
            // Effacer tous les marqueurs existants
            markersLayer.clearLayers();
            
            // Ajouter un marqueur pour le g√Æte s√©lectionn√©
            const giteSelectionne = document.getElementById('decouvrir_gite').value;
            if (giteSelectionne && giteCoords[giteSelectionne]) {
                const coords = giteCoords[giteSelectionne];
                const giteIconHtml = `
                    <div style="background: #ff5a5f; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 12px rgba(255,90,95,0.5); border: 4px solid white;">
                        üè†
                    </div>
                `;
                const giteIcon = L.divIcon({
                    html: giteIconHtml,
                    className: 'gite-marker',
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                });
                
                giteMarker = L.marker([coords.lat, coords.lng], { icon: giteIcon });
                giteMarker.bindPopup(`
                    <div style="text-align: center; padding: 10px;">
                        <h3 style="margin: 0; color: #ff5a5f;">üè† G√Æte ${giteSelectionne}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 0.9rem;">Point de r√©f√©rence</p>
                    </div>
                `);
                giteMarker.addTo(markersLayer);
            }
            
            // Ajouter les nouveaux marqueurs
            evenementsValides.forEach((item, index) => {
                // Debug: afficher les 3 premiers points
                if (index < 3) {
                }
                
                // Utiliser la fonction pour obtenir l'ic√¥ne appropri√©e
                const customIcon = getMarkerIcon(item);
                
                const marker = L.marker([item.lat, item.lng], { icon: customIcon });
                
                // Popup avec les informations
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #667eea; font-size: 1.1rem;">
                            ${item.titre || item.nom}
                        </h3>
                        ${item.categorie ? `<p style="margin: 5px 0; font-size: 0.85rem; display: inline-block; padding: 4px 10px; border-radius: 16px; background: #f0f4f8; color: #667eea; font-weight: 600;"><strong>üìÇ</strong> ${item.categorie}</p>` : ''}
                        <p style="margin: 8px 0; font-size: 0.9rem;"><strong>üìç</strong> ${item.lieu || item.adresse || 'Non sp√©cifi√©'}</p>
                        ${item.date ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>üóìÔ∏è</strong> ${item.date}</p>` : ''}
                        ${item.distance ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>üìè</strong> ${item.distance} km</p>` : ''}
                        ${item.description ? `<p style="margin: 10px 0; font-size: 0.85rem; line-height: 1.4;">${item.description}</p>` : ''}
                        ${item.note ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>‚≠ê</strong> ${item.note}/5</p>` : ''}
                        ${item.telephone ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>üìû</strong> ${item.telephone}</p>` : ''}
                        ${item.lien ? `<a href="${item.lien}" target="_blank" style="display: inline-block; margin-top: 10px; padding: 8px 15px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-size: 0.85rem;">üîó Plus d'infos</a>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.addTo(markersLayer);
            });
            
            // Ajuster la vue pour inclure tous les marqueurs
            if (evenementsValides.length > 0) {
                const bounds = L.latLngBounds(evenementsValides.map(e => [e.lat, e.lng]));
                mapInstance.fitBounds(bounds.pad(0.1));
            }
        }
        
        // Mettre √† jour le label de distance
        function updateDistanceLabel() {
            const distance = document.getElementById('distanceFilter').value;
            document.getElementById('distanceLabel').textContent = `‚â§ ${distance} km`;
            
            // Refiltrer les √©v√©nements et la carte si des √©v√©nements sont charg√©s
            if (window.allEvenements && window.allEvenements.length > 0) {
                const maxDistance = parseInt(distance);
                const pointsFiltres = window.allEvenements.filter(e => e.distance <= maxDistance);
                
                // Mettre √† jour la carte avec les points filtr√©s
                afficherCarteEvenements(pointsFiltres);
                
                // Mettre √† jour la liste
                filtrerEvenements();
            }
        }
        
        // Rafra√Æchir les √©v√©nements
        function refreshEvenements() {
            rechercherEvenements();
        }
        
        // Mettre √† jour le label de distance pour la carte
        function updateDistanceLabelCarte() {
            const distance = document.getElementById('distanceSliderCarte')?.value || 50;
            const label = document.getElementById('distanceLabelCarte');
            if (label) label.textContent = `‚â§ ${distance} km`;
            
            // Filtrer les activit√©s affich√©es sur la carte par distance
            if (window.allActivites && window.allActivites.length > 0) {
                const distanceMax = parseFloat(distance);
                const activitesFiltrees = window.allActivites.filter(act => {
                    const actDistance = parseFloat(act.distance) || 0;
                    return actDistance <= distanceMax;
                });
                
                afficherCarteEvenements(activitesFiltrees);
            }
        }
        
        // Filtrer la carte par cat√©gorie
        function filtrerCarteParcategorie(categorie) {
            // Si pas de cat√©gorie fournie, utiliser "tous"
            if (!categorie) categorie = 'tous';
            
            // Mettre √† jour les boutons actifs
            const boutons = document.querySelectorAll('.btn-filtre-cat');
            boutons.forEach(btn => {
                const btnCat = btn.getAttribute('data-categorie');
                if (btnCat === categorie) {
                    btn.style.background = 'rgba(255,255,255,0.9)';
                    btn.style.color = '#667eea';
                    btn.style.borderColor = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'rgba(255,255,255,0.2)';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'transparent';
                    btn.classList.remove('active');
                }
            });
            
            const giteInput = document.getElementById('decouvrir_gite');
            const gite = giteInput ? giteInput.value : 'Tr√©voux';
            
            if (categorie === 'tous') {
                // Afficher toutes les activit√©s
                if (window.activitesParGite && window.activitesParGite[gite]) {
                    afficherCarteEvenements(window.activitesParGite[gite]);
                }
            } else {
                // Filtrer par cat√©gorie
                if (window.activitesParGite && window.activitesParGite[gite]) {
                    const filtered = window.activitesParGite[gite].filter(act => {
                        const actCategorie = act.categorie || act.type || '';
                        return actCategorie.toLowerCase().includes(categorie.toLowerCase()) || 
                               categorie.toLowerCase().includes(actCategorie.toLowerCase());
                    });
                    afficherCarteEvenements(filtered);
                }
            }
        }
        
        // Afficher tous les points sur la carte
        function afficherTout() {
            if (window.allEvenements && window.allEvenements.length > 0) {
                afficherCarteEvenements(window.allEvenements);
                filtrerEvenements();
                showNotification(`‚úì ${window.allEvenements.length} points affich√©s`, 'success');
                
                // R√©afficher toutes les activit√©s dans la liste
                const gite = document.getElementById('decouvrir_gite').value;
                if (gite) {
                    afficherActivites(gite);
                }
            } else {
                showNotification('‚ö†Ô∏è Chargez d\'abord les donn√©es en s√©lectionnant un g√Æte', 'warning');
            }
        }
        
        // Toggle du formulaire d'ajout d'activit√©
        function toggleFormAjout() {
            // Ouvrir la modale pour ajouter une activit√©
            ouvrirModalActivite(false);
        }
        
        // Ajouter une activit√© manuellement
        async function ajouterActivite() {
            const gite = document.getElementById('decouvrir_gite').value;
            const nom = document.getElementById('activite_nom').value.trim();
            const categorie = document.getElementById('activite_categorie').value;
            const description = document.getElementById('activite_description').value.trim();
            const adresse = document.getElementById('activite_adresse').value.trim();
            const distance = document.getElementById('activite_distance').value;
            const website = document.getElementById('activite_website').value.trim();
            const telephone = document.getElementById('activite_telephone').value.trim();
            const note = document.getElementById('activite_note').value;
            const avis = document.getElementById('activite_avis').value;
            const prixValue = document.getElementById('activite_prix').value;
            const typeRestaurant = document.getElementById('activite_type_resto').value.trim();
            const latitudeManuelle = document.getElementById('activite_latitude').value;
            const longitudeManuelle = document.getElementById('activite_longitude').value;
            
            if (!gite || !nom || !categorie || !adresse) {
                showNotification('‚ö†Ô∏è Remplissez les champs obligatoires (nom, cat√©gorie, adresse)', 'warning');
                return;
            }
            
            // Utiliser les coordonn√©es manuelles si fournies, sinon g√©ocoder
            let coords;
            if (latitudeManuelle && longitudeManuelle) {
                coords = {
                    lat: parseFloat(latitudeManuelle),
                    lng: parseFloat(longitudeManuelle)
                };
                showNotification('üìç Utilisation des coordonn√©es manuelles', 'info');
            } else {
                showNotification('üìç G√©ocodage de l\'adresse...', 'info');
                coords = await geocodeAddress(adresse, gite);
            }
            
            // Pr√©parer les donn√©es de base (sans gite ni distance)
            const activiteBase = {
                nom,
                categorie,
                description,
                adresse,
                website,
                telephone,
                note: note ? parseFloat(note) : null,
                avis: avis ? parseInt(avis) : null,
                prix: prixValue || null,
                latitude: coords.lat,
                longitude: coords.lng
            };
            
            try {
                // Mode MODIFICATION si un ID est stock√©
                if (window.activiteEnCoursDeModification) {
                    const { data, error } = await supabase
                        .from('activites_gites')
                        .update({ ...activiteBase, gite })
                        .eq('id', window.activiteEnCoursDeModification)
                        .select();
                    
                    if (error) throw error;
                    
                    showNotification('‚úì Activit√© modifi√©e avec succ√®s !', 'success');
                    
                    // R√©initialiser le mode modification
                    delete window.activiteEnCoursDeModification;
                    
                    // Fermer la modale
                    fermerModalActivite();
                    
                    // Recharger les activit√©s
                    await chargerActivites();
                    
                } else {
                    // Mode AJOUT : Cr√©er l'activit√© dans les DEUX g√Ætes avec distance calcul√©e
                    const activites = [];
                    
                    // Pour chaque g√Æte, calculer la distance et cr√©er une entr√©e
                    for (const [nomGite, coordsGite] of Object.entries(window.GITES_COORDS)) {
                        const distanceCalculee = calculerDistance(
                            coordsGite.lat, coordsGite.lng,
                            coords.lat, coords.lng
                        );
                        
                        activites.push({
                            ...activiteBase,
                            gite: nomGite,
                            distance: distanceCalculee
                        });
                    }
                    
                    const { data, error } = await supabase
                        .from('activites_gites')
                        .insert(activites)
                        .select();
                    
                    if (error) throw error;
                    
                    showNotification(`‚úì Activit√© ajout√©e dans Tr√©voux et Couzon !`, 'success');
                    
                    // Fermer la modale apr√®s ajout
                    fermerModalActivite();
                    
                    // Recharger les activit√©s
                    await chargerActivites();
                }
                
            } catch (error) {
                console.error('Erreur activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // Afficher les activit√©s par cat√©gorie
        // Fonction d'aide pour obtenir les couleurs par cat√©gorie
        function getCategoryColor(categorie) {
            const colors = {
                'Restaurant': { badge: '#10b981', light: '#d1fae5' },
                'Mus√©e': { badge: '#3b82f6', light: '#dbeafe' },
                'Caf√©': { badge: '#f59e0b', light: '#fef3c7' },
                'Parc': { badge: '#8b5cf6', light: '#ede9fe' },
                'H√¥tel': { badge: '#ec4899', light: '#fce7f3' }
            };
            return colors[categorie] || { badge: '#667eea', light: '#e0e7ff' };
        }
        
        // ‚ö†Ô∏è FONCTION SUPPRIM√âE - Maintenant dans js/decouvrir.js
        // La fonction afficherActivites() est d√©finie dans js/decouvrir.js
        // et export√©e vers window.afficherActivites
        
        // Supprimer une activit√©
        async function supprimerActivite(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette activit√© ?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('activites_gites')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showNotification('‚úì Activit√© supprim√©e', 'success');
                await chargerActivites();
                
            } catch (error) {
                console.error('Erreur suppression activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // ‚ö†Ô∏è FONCTIONS SUPPRIM√âES - Maintenant dans js/decouvrir.js
        // Les fonctions suivantes sont d√©finies dans js/decouvrir.js et export√©es vers window:
        // - filtrerActivitesParCategorie()
        // - afficherToutesActivites()
        // - afficherActivitesFiltr√©es()
        
        // Modifier une activit√©
        async function modifierActivite(id) {
            try {
                // R√©cup√©rer l'√©l√©ment de l'activit√©
                const element = document.querySelector(`[data-activite-id="${id}"]`);
                let positionY = window.innerHeight / 2; // Par d√©faut au centre
                
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Attendre un peu que le scroll soit fait
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // R√©cup√©rer la position de l'√©l√©ment
                    const rect = element.getBoundingClientRect();
                    positionY = rect.top + window.scrollY + rect.height / 2;
                }
                
                // R√©cup√©rer l'activit√© √† modifier
                const { data, error } = await supabase
                    .from('activites_gites')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Pr√©-remplir le formulaire
                document.getElementById('activite_nom').value = data.nom || '';
                document.getElementById('activite_categorie').value = data.categorie || '';
                document.getElementById('activite_description').value = data.description || '';
                document.getElementById('activite_adresse').value = data.adresse || '';
                document.getElementById('activite_distance').value = data.distance || '';
                document.getElementById('activite_note').value = data.note || '';
                document.getElementById('activite_avis').value = data.avis || '';
                document.getElementById('activite_prix').value = data.prix || '';
                document.getElementById('activite_telephone').value = data.telephone || '';
                document.getElementById('activite_website').value = data.website || '';
                
                // Afficher/cacher le champ type de restaurant selon la cat√©gorie
                afficherTypeRestoSiRestaurant();
                
                // Stocker l'ID en cours de modification
                window.activiteEnCoursDeModification = id;
                
                // Ouvrir la modale en mode modification avec position
                ouvrirModalActivite(true, positionY);
                
                showNotification('‚úèÔ∏è Mode modification activ√©', 'info');
                
            } catch (error) {
                console.error('Erreur modification activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // G√©n√©rer le guide PDF
        function genererGuideDecouverte() {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîÑ G√©n√©ration du guide en cours...', 'info');
            
            // TODO: Impl√©menter la g√©n√©ration PDF avec jsPDF
            setTimeout(() => {
                showNotification('‚úì Guide g√©n√©r√© ! (√Ä impl√©menter)', 'success');
            }, 1000);
        }
        
        // G√©n√©rer la fiche client pour une r√©servation
        async function genererFicheClient(reservation) {
            try {
                showNotification('üîÑ G√©n√©ration de la fiche client...', 'info');
                
                const giteNom = reservation.gite;
                const giteInfo = GITES_INFOS[giteNom];
                
                if (!giteInfo) {
                    showNotification('‚ùå G√Æte non trouv√©', 'error');
                    return;
                }
                
                // R√©cup√©rer les activit√©s du g√Æte
                const activites = activitesParGite[giteNom] || [];
                
                // Calculer le nombre de nuits
                const dateDebut = new Date(reservation.date_debut);
                const dateFin = new Date(reservation.date_fin);
                const nombreNuits = Math.ceil((dateFin - dateDebut) / (1000 * 60 * 60 * 24));
                
                // Formater les dates
                const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateArrivee = dateDebut.toLocaleDateString('fr-FR', optionsDate);
                const dateDepart = dateFin.toLocaleDateString('fr-FR', optionsDate);
                const dateGeneration = new Date().toLocaleDateString('fr-FR', optionsDate);
                
                // G√©n√©rer le contenu des infos pratiques
                let infosPratiquesHTML = '';
                giteInfo.infos_pratiques.forEach(info => {
                    infosPratiquesHTML += `
                        <div class="info-pratique">
                            <h3>${info.titre}</h3>
                            ${info.contenu}
                        </div>
                    `;
                });
                
                // G√©n√©rer le contenu des activit√©s group√©es par cat√©gorie
                let activitesHTML = '';
                
                if (activites.length === 0) {
                    activitesHTML = '<p style="text-align: center; padding: 40px; color: #999;">Aucune activit√© enregistr√©e pour le moment.</p>';
                } else {
                    // Grouper par cat√©gorie
                    const parCategorie = {};
                    activites.forEach(act => {
                        if (!parCategorie[act.categorie]) {
                            parCategorie[act.categorie] = [];
                        }
                        parCategorie[act.categorie].push(act);
                    });
                    
                    // G√©n√©rer le HTML par cat√©gorie
                    Object.keys(parCategorie).sort().forEach(categorie => {
                        activitesHTML += `
                            <div class="categorie-activites">
                                <h3>${categorie}</h3>
                        `;
                        
                        parCategorie[categorie].forEach(act => {
                            const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) : '';
                            
                            activitesHTML += `
                                <div class="activite-card">
                                    <h4>${act.nom}</h4>
                                    ${act.description ? `<p>${act.description}</p>` : ''}
                                    
                                    <div class="meta">
                                        ${act.distance ? `<span>üìç ${act.distance} km du g√Æte</span>` : ''}
                                        ${noteStars ? `<span>${noteStars} ${act.note}/5 ${act.avis ? `(${act.avis} avis)` : ''}</span>` : ''}
                                        ${act.prix ? `<span>üí∞ ${act.prix}</span>` : ''}
                                    </div>
                                    
                                    ${(act.adresse || act.telephone || act.website) ? `
                                        <div class="contact">
                                            ${act.adresse ? `<p>üìç ${act.adresse}</p>` : ''}
                                            ${act.telephone ? `<p>üìû ${act.telephone}</p>` : ''}
                                            ${act.website ? `<p>üåê <a href="${act.website}" target="_blank">${act.website}</a></p>` : ''}
                                            ${act.google_maps_link ? `<p>üó∫Ô∏è <a href="${act.google_maps_link}" target="_blank">Voir sur Google Maps</a></p>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        activitesHTML += '</div>';
                    });
                }
                
                // Template HTML de la fiche
                const ficheHTML = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Client - ${giteInfo.nom}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@300;400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Lato', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .fiche-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, ${giteInfo.couleur_principale} 0%, ${giteInfo.couleur_secondaire} 100%);
            color: white;
            padding: 50px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header .emoji { font-size: 4rem; display: block; margin-bottom: 20px; }
        .header .subtitle { font-size: 1.2rem; opacity: 0.95; font-weight: 300; }
        
        .reservation-info {
            background: #f8f9fa;
            padding: 30px 40px;
            border-bottom: 3px solid ${giteInfo.couleur_principale};
        }
        
        .reservation-info h2 {
            font-size: 1.8rem;
            color: ${giteInfo.couleur_principale};
            margin-bottom: 20px;
            font-family: 'Playfair Display', serif;
        }
        
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .info-item { display: flex; align-items: center; gap: 12px; }
        .info-item .icon { font-size: 1.5rem; color: ${giteInfo.couleur_principale}; }
        .info-item .label { font-weight: 700; color: #666; margin-right: 8px; }
        .info-item .value { color: #333; font-weight: 400; }
        
        .section { padding: 40px; }
        
        .section h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: ${giteInfo.couleur_principale};
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid ${giteInfo.couleur_principale};
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .section h2 .emoji { font-size: 2.5rem; }
        
        .info-pratique {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid ${giteInfo.couleur_principale};
        }
        
        .info-pratique h3 {
            color: ${giteInfo.couleur_principale};
            font-size: 1.3rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-pratique p { margin: 8px 0; padding-left: 30px; }
        
        .info-pratique .highlight {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 700;
            color: ${giteInfo.couleur_principale};
            text-align: center;
            font-size: 1.2rem;
            border: 2px dashed ${giteInfo.couleur_principale};
        }
        
        .categorie-activites { margin-bottom: 35px; }
        
        .categorie-activites h3 {
            color: ${giteInfo.couleur_principale};
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .activite-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid ${giteInfo.couleur_principale};
            page-break-inside: avoid;
        }
        
        .activite-card h4 { color: #2C5F7D; font-size: 1.2rem; margin-bottom: 10px; }
        .activite-card p { margin: 8px 0; color: #555; }
        
        .activite-card .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .activite-card .meta span { display: flex; align-items: center; gap: 5px; }
        
        .activite-card .contact {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
        }
        
        .activite-card .contact a {
            color: ${giteInfo.couleur_principale};
            text-decoration: none;
            font-weight: 600;
        }
        
        .footer {
            background: #2C3E50;
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        .footer p { margin: 8px 0; opacity: 0.9; }
        
        @media print {
            body { background: white; padding: 0; }
            .fiche-container { box-shadow: none; }
            .section { page-break-inside: avoid; }
            .no-print { display: none; }
        }
        
        .btn-print {
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${giteInfo.couleur_principale};
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .info-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
        }
    <\/style>
<\/head>
<body>
    <button class="btn-print no-print" onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
    
    <div class="fiche-container">
        <div class="header">
            <span class="emoji">${giteInfo.emoji}</span>
            <h1>${giteInfo.nom}</h1>
            <p class="subtitle">Votre s√©jour dans l'Ain</p>
        </div>
        
        <div class="reservation-info">
            <h2>üéØ Votre R√©servation</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="icon">üë§</span>
                    <span class="label">Nom :</span>
                    <span class="value">${reservation.nom || 'Non renseign√©'}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üìß</span>
                    <span class="label">Email :</span>
                    <span class="value">${reservation.email || 'Non renseign√©'}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üìÖ</span>
                    <span class="label">Arriv√©e :</span>
                    <span class="value">${dateArrivee}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üìÖ</span>
                    <span class="label">D√©part :</span>
                    <span class="value">${dateDepart}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üåô</span>
                    <span class="label">Dur√©e :</span>
                    <span class="value">${nombreNuits} nuit(s)</span>
                </div>
                <div class="info-item">
                    <span class="icon">üë•</span>
                    <span class="label">Voyageurs :</span>
                    <span class="value">${reservation.nb_voyageurs || 'Non renseign√©'} personne(s)</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2><span class="emoji">üìã</span> Informations Pratiques</h2>
            ${infosPratiquesHTML}
        </div>
        
        <div class="section" style="background: #f8f9fa;">
            <h2><span class="emoji">üó∫Ô∏è</span> √Ä D√©couvrir Autour du G√Æte</h2>
            <p style="margin-bottom: 30px; font-size: 1.1rem; color: #666;">
                Nous avons s√©lectionn√© pour vous les meilleures adresses dans un rayon de 25km.
            </p>
            ${activitesHTML}
        </div>
        
        <div class="footer">
            <p style="font-size: 1.2rem; font-weight: 700; margin-bottom: 15px;">
                Nous vous souhaitons un excellent s√©jour ! üåü
            </p>
            <p>Pour toute question : ${giteInfo.contact_email} | ${giteInfo.contact_telephone}</p>
            <p style="font-size: 0.9rem; margin-top: 15px; opacity: 0.7;">
                Document g√©n√©r√© le ${dateGeneration}
            </p>
        </div>
    </div>
</body>
</html>`;
                
                // Ouvrir dans une nouvelle fen√™tre
                const nouvelleFenetre = window.open('', '_blank');
                nouvelleFenetre.document.write(ficheHTML);
                nouvelleFenetre.document.close();
                
                showNotification('‚úì Fiche client g√©n√©r√©e !', 'success');
                
            } catch (error) {
                console.error('Erreur g√©n√©ration fiche client:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // Aper√ßu fiche client depuis l'ID de r√©servation
        async function aper√ßuFicheClient(reservationId) {
            try {
                const reservations = await getAllReservations();
                const reservation = reservations.find(r => r.id === reservationId);
                
                if (!reservation) {
                    showNotification('‚ùå R√©servation introuvable', 'error');
                    return;
                }
                
                // Fermer le modal
                const modal = document.querySelector('[onclick*="this.closest"]');
                if (modal) modal.closest('div').parentElement.remove();
                
                // G√©n√©rer la fiche
                await genererFicheClient(reservation);
                
            } catch (error) {
                console.error('Erreur aper√ßu fiche client:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        
        // Syst√®me de notifications
        function showNotification(message, type = 'info') {
            // Cr√©er ou r√©cup√©rer le conteneur de notifications
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    max-width: 400px;
                `;
                document.body.appendChild(container);
            }
            
            // Cr√©er la notification
            const notification = document.createElement('div');
            
            // Couleurs selon le type
            const colors = {
                success: '#27AE60',
                error: '#E74C3C',
                warning: '#F39C12',
                info: '#3498DB'
            };
            
            const icons = {
                success: '‚úì',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.style.cssText = `
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <span style="font-size: 1.2rem;">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;
            
            // Ajouter au conteneur
            container.appendChild(notification);
            
            // Supprimer apr√®s 3 secondes
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                    if (container.children.length === 0) {
                        container.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // Ajouter les animations CSS
        if (!document.getElementById('notification-animations')) {
            const style = document.createElement('style');
            style.id = 'notification-animations';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ==================== GOOGLE MAPS - VARIABLES D√âPLAC√âES DANS js/decouvrir.js ====================
        // Voir js/decouvrir.js pour: googleMap, allMarkers, googleGiteMarker, infoWindow,
        // directionsService, directionsRenderer, gitesCoordinates, categoryColors, etc.

        // ==================== TOAST NOTIFICATION ====================
        function showToast(message, type = 'info') {
            // Chercher un toast existant ou en cr√©er un
            let toast = document.getElementById('mapToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'mapToast';
                document.body.appendChild(toast);
            }
            
            const colors = {
                'success': '#27ae60',
                'error': '#e74c3c',
                'info': '#3498db'
            };
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                font-weight: 500;
                animation: slideInRight 0.3s ease;
            `;
            
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, 4000);
        }

        // Ajouter les animations CSS pour les toasts
        const styleToast = document.createElement('style');
        styleToast.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(styleToast);

        // ==================== √âV√âNEMENT: Changement de g√Æte ====================
        // L'√©v√©nement sera g√©r√© par la fonction selectGiteDecouvrir existante
        // qui sera modifi√©e pour recharger la carte Google Maps
        
    </script>
    
    <!-- Chargement dynamique des onglets -->
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const tabFiles = {
            'tab-gestion': '/tabs/tab-gestion.html',
            'tab-reservations': '/tabs/tab-reservations.html',
            'tab-archives': '/tabs/tab-archives.html',
            'tab-statistiques': '/tabs/tab-statistiques.html',
            'tab-charges': '/tabs/tab-fiscalite-v2.html',
            'tab-menage': '/tabs/tab-menage.html',
            'tab-infos-gites': '/tabs/tab-infos-gites.html',
            'tab-fiches-clients': '/tabs/tab-fiches-clients.html',
            'tab-decouvrir': '/tabs/tab-decouvrir.html',
        };
        
        // Charger tous les fragments d'onglets
        const loadPromises = Object.entries(tabFiles).map(([tabId, file]) => {
            return fetch(file)
                .then(r => r.text())
                .then(html => {
                    const container = document.getElementById(tabId);
                    if (container) container.innerHTML = html;
                })
                .catch(err => console.error(`Erreur chargement ${file}:`, err));
        });
        
        // Une fois tous les onglets charg√©s
        await Promise.all(loadPromises);
        
        // Synchronisation automatique au d√©marrage (si pas d√©j√† faite r√©cemment)
        const lastSync = localStorage.getItem('lastAutoSync');
        const now = Date.now();
        const SYNC_INTERVAL = 3600000; // 1 heure
        
        if (!lastSync || (now - parseInt(lastSync)) > SYNC_INTERVAL) {
            localStorage.setItem('lastAutoSync', now.toString());
            // Lancer en arri√®re-plan sans bloquer l'UI
            syncAllCalendars().catch(err => console.error('Erreur sync auto:', err));
        } else {
        }
        
        // Attacher les event listeners aux boutons
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = btn.getAttribute('data-tab');
                if (tab && typeof window.switchTab === 'function') {
                    window.switchTab(tab);
                }
            });
        });
        
        // Activer l'onglet Dashboard par d√©faut
        const firstTab = document.querySelector('[data-tab="dashboard"]');
        if (firstTab && typeof window.switchTab === 'function') {
            window.switchTab('dashboard');
            firstTab.classList.add('active');
        }
    });
    </script>
</body>
</html>
