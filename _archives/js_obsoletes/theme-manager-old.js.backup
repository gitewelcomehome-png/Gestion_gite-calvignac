/**
 * ===================================
 * ğŸ¨ GESTIONNAIRE DE THÃˆMES ICALOU
 * Gestion centralisÃ©e des thÃ¨mes et styles
 * ===================================
 */

class ThemeManager {
    constructor() {
        this.THEME_KEY = 'icalou-theme';
        this.STYLE_KEY = 'icalou-style';
        
        // ThÃ¨mes disponibles
        this.themes = {
            light: 'â˜€ï¸ Jour',
            dark: 'ğŸŒ™ Nuit'
        };
        
        // Styles disponibles (2 styles : Apple et Sidebar)
        this.styles = {
            apple: 'ğŸ Apple',
            sidebar: 'ğŸ“Š Sidebar'
        };
        
        this.init();
    }
    
    /**
     * Initialisation du gestionnaire
     */
    init() {
        // Charger les prÃ©fÃ©rences sauvegardÃ©es
        const savedTheme = this.getSavedTheme();
        const savedStyle = this.getSavedStyle();
        
        // Appliquer les prÃ©fÃ©rences
        this.setTheme(savedTheme);
        this.setStyle(savedStyle);
        
        // CrÃ©er le sÃ©lecteur de thÃ¨me si demandÃ©
        if (window.ICALOU_SHOW_THEME_SWITCHER !== false) {
            this.createThemeSwitcher();
        }
        
        console.log('ğŸ¨ ThemeManager initialisÃ©:', {
            theme: savedTheme,
            style: savedStyle
        });
    }
    
    /**
     * RÃ©cupÃ©rer le thÃ¨me sauvegardÃ©
     */
    getSavedTheme() {
        return localStorage.getItem(this.THEME_KEY) || 'light';
    }
    
    /**
     * RÃ©cupÃ©rer le style sauvegardÃ©
     */
    getSavedStyle() {
        return localStorage.getItem(this.STYLE_KEY) || 'modern';
    }
    
    /**
     * DÃ©finir le thÃ¨me
     */
    setTheme(theme) {
        if (!this.themes[theme]) {
            console.warn('ThÃ¨me invalide:', theme);
            return;
        }
        
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem(this.THEME_KEY, theme);
        
        // Mettre Ã  jour le sÃ©lecteur si prÃ©sent
        this.updateSwitcherButtons();
        
        console.log('ğŸ¨ ThÃ¨me changÃ©:', theme);
    }
    
    /**
     * DÃ©finir le style
     */
    setStyle(style) {
        if (!this.styles[style]) {
            console.warn('Style invalide:', style);
            return;
        }
        
        document.documentElement.setAttribute('data-style', style);
        localStorage.setItem(this.STYLE_KEY, style);
        
        // Mettre Ã  jour le sÃ©lecteur si prÃ©sent
        this.updateSwitcherButtons();
        
        // RÃ©initialiser les icÃ´nes Lucide pour appliquer les nouveaux styles
        if (window.lucide) {
            setTimeout(() => lucide.createIcons(), 100);
        }
        
        console.log('ğŸ¨ Style changÃ©:', style);
    }
    
    /**
     * Basculer entre jour et nuit
     */
    toggleTheme() {
        const currentTheme = this.getSavedTheme();
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        this.setTheme(newTheme);
    }
    
    /**
     * CrÃ©er le sÃ©lecteur de thÃ¨me flottant
     */
    createThemeSwitcher() {
        // VÃ©rifier si dÃ©jÃ  crÃ©Ã©
        if (document.getElementById('icalou-theme-switcher')) {
            return;
        }
        
        const switcher = document.createElement('div');
        switcher.id = 'icalou-theme-switcher';
        switcher.className = 'theme-switcher';
        switcher.innerHTML = `
            <div style="display: flex; gap: 8px; align-items: center;">
                <!-- ThÃ¨me Jour/Nuit -->
                <button class="theme-btn" data-theme="light" title="Mode Jour">â˜€ï¸</button>
                <button class="theme-btn" data-theme="dark" title="Mode Nuit">ğŸŒ™</button>
                
                <div style="width: 1px; height: 30px; background: var(--border); margin: 0 4px;"></div>
                
                <!-- Styles -->
                <button class="style-btn" data-style="modern" title="Modern">âœ¨</button>
                <button class="style-btn" data-style="neo-brutal" title="Neo-Brutal">âš¡</button>
                <button class="style-btn" data-style="minimal" title="Minimal">ğŸ¯</button>
                <button class="style-btn" data-style="glass" title="Glass">ğŸ”®</button>
            </div>
        `;
        
        document.body.appendChild(switcher);
        
        // Ajouter les Ã©vÃ©nements
        switcher.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                this.setTheme(theme);
            });
        });
        
        switcher.querySelectorAll('.style-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const style = btn.dataset.style;
                this.setStyle(style);
            });
        });
        
        // Mettre Ã  jour l'Ã©tat initial
        this.updateSwitcherButtons();
    }
    
    /**
     * Mettre Ã  jour les boutons actifs du sÃ©lecteur
     */
    updateSwitcherButtons() {
        const switcher = document.getElementById('icalou-theme-switcher');
        if (!switcher) return;
        
        const currentTheme = this.getSavedTheme();
        const currentStyle = this.getSavedStyle();
        
        // Mettre Ã  jour les thÃ¨mes
        switcher.querySelectorAll('.theme-btn').forEach(btn => {
            if (btn.dataset.theme === currentTheme) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Mettre Ã  jour les styles
        switcher.querySelectorAll('.style-btn').forEach(btn => {
            if (btn.dataset.style === currentStyle) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
    
    /**
     * Obtenir les informations du thÃ¨me actuel
     */
    getCurrentTheme() {
        return {
            theme: this.getSavedTheme(),
            style: this.getSavedStyle(),
            themeName: this.themes[this.getSavedTheme()],
            styleName: this.styles[this.getSavedStyle()]
        };
    }
}

// Initialisation automatique au chargement
let themeManager;

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        themeManager = new ThemeManager();
        window.themeManager = themeManager;
    });
} else {
    themeManager = new ThemeManager();
    window.themeManager = themeManager;
}

// Export global
window.ThemeManager = ThemeManager;
