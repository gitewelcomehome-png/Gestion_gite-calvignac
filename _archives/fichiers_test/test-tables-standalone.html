<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Tables Tarifs</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: system-ui; padding: 40px; max-width: 900px; margin: 0 auto; }
        button { padding: 12px 24px; margin: 10px; font-size: 16px; font-weight: 600; cursor: pointer; border: 2px solid #000; border-radius: 8px; background: #4CAF50; color: white; }
        button:hover { background: #45a049; }
        pre { background: #f4f4f4; padding: 20px; border-radius: 8px; border: 2px solid #ddd; white-space: pre-wrap; font-size: 13px; line-height: 1.5; }
        .loading { color: #666; }
    </style>
</head>
<body>
    <h1>ğŸ” Diagnostic Tables Tarifs</h1>
    <div>
        <button onclick="checkTables()">ğŸ” VÃ©rifier Tables</button>
        <button onclick="checkRLS()">ğŸ” Tester INSERT</button>
    </div>
    <pre id="result" class="loading">Cliquez sur un bouton pour lancer le diagnostic...</pre>
    
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://zgdjpetmnmetfkboxeyo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnZGpwZXRtbm1ldGZrYm94ZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQwNzI0NjMsImV4cCI6MjA0OTY0ODQ2M30.nGYVBB3fNL88zzrWW4bHR0wTMd2w56oUXDCdvCnkL7M';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        async function checkTables() {
            const log = [];
            document.getElementById('result').textContent = 'â³ VÃ©rification en cours...';
            
            try {
                // VÃ©rifier session
                const { data: { session } } = await supabase.auth.getSession();
                log.push(`Session: ${session ? 'âœ… ConnectÃ©' : 'âŒ Non connectÃ©'}`);
                log.push(`User ID: ${session?.user?.id || 'N/A'}`);
                log.push('');
                
                // Test 1: Tarifs base
                try {
                    const { data, error, count } = await supabase
                        .from('tarifs_base')
                        .select('*', { count: 'exact', head: false });
                        
                    log.push('ğŸ“Š TABLE: tarifs_base');
                    if (error) {
                        log.push(`  âŒ Erreur: ${error.message}`);
                        log.push(`  Code: ${error.code || 'N/A'}`);
                        if (error.code === 'PGRST116' || error.code === '42P01') {
                            log.push(`  ğŸš¨ La table N'EXISTE PAS dans la base !`);
                        }
                    } else {
                        log.push(`  âœ… Table accessible`);
                        log.push(`  Lignes: ${count || 0}`);
                        if (data && data.length > 0) {
                            log.push(`  Premier enregistrement: ${JSON.stringify(data[0], null, 2)}`);
                        }
                    }
                } catch (e) {
                    log.push(`  ğŸ’¥ Exception: ${e.message}`);
                }
                log.push('');
                
                // Test 2: RÃ¨gles tarifaires
                try {
                    const { data, error, count } = await supabase
                        .from('regles_tarifaires')
                        .select('*', { count: 'exact' });
                        
                    log.push('âš™ï¸ TABLE: regles_tarifaires');
                    if (error) {
                        log.push(`  âŒ Erreur: ${error.message}`);
                        log.push(`  Code: ${error.code || 'N/A'}`);
                        if (error.code === 'PGRST116' || error.code === '42P01') {
                            log.push(`  ğŸš¨ La table N'EXISTE PAS dans la base !`);
                        }
                    } else {
                        log.push(`  âœ… Table accessible`);
                        log.push(`  Lignes: ${count || 0}`);
                    }
                } catch (e) {
                    log.push(`  ğŸ’¥ Exception: ${e.message}`);
                }
                log.push('');
                
                // Test 3: Configuration
                try {
                    const { data, error, count } = await supabase
                        .from('configuration_calendrier')
                        .select('*', { count: 'exact' });
                        
                    log.push('ğŸ”§ TABLE: configuration_calendrier');
                    if (error) {
                        log.push(`  âŒ Erreur: ${error.message}`);
                        log.push(`  Code: ${error.code || 'N/A'}`);
                        if (error.code === 'PGRST116' || error.code === '42P01') {
                            log.push(`  ğŸš¨ La table N'EXISTE PAS dans la base !`);
                        }
                    } else {
                        log.push(`  âœ… Table accessible`);
                        log.push(`  Lignes: ${count || 0}`);
                    }
                } catch (e) {
                    log.push(`  ğŸ’¥ Exception: ${e.message}`);
                }
                log.push('');
                
                // Test 4: VÃ©rifier organization_members
                if (session) {
                    try {
                        const { data, error } = await supabase
                            .from('organization_members')
                            .select('organization_id, role')
                            .eq('user_id', session.user.id);
                            
                        log.push('ğŸ¢ MEMBERSHIP:');
                        if (error) {
                            log.push(`  âŒ Erreur: ${error.message}`);
                        } else if (data && data.length > 0) {
                            log.push(`  âœ… Organization ID: ${data[0].organization_id}`);
                            log.push(`  âœ… Role: ${data[0].role}`);
                        } else {
                            log.push(`  âš ï¸ Aucune organisation associÃ©e`);
                        }
                    } catch (e) {
                        log.push(`  ğŸ’¥ Exception: ${e.message}`);
                    }
                }
                
                log.push('');
                log.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                log.push('CONCLUSION:');
                if (log.join('').includes('ğŸš¨')) {
                    log.push('âŒ Les tables ne sont PAS crÃ©Ã©es dans Supabase');
                    log.push('â¡ï¸ ExÃ©cutez sql/migrations/20260111_create_tarifs_tables.sql');
                } else {
                    log.push('âœ… Toutes les tables existent');
                }
                
            } catch (e) {
                log.push(`ğŸ’¥ Erreur globale: ${e.message}`);
            }
            
            document.getElementById('result').textContent = log.join('\n');
        }
        
        async function checkRLS() {
            const log = [];
            document.getElementById('result').textContent = 'â³ Test RLS en cours...';
            
            try {
                // VÃ©rifier session
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    log.push('âŒ Vous devez Ãªtre connectÃ© pour tester les RLS');
                    document.getElementById('result').textContent = log.join('\n');
                    return;
                }
                
                log.push('ğŸ§ª Test INSERT dans tarifs_base:');
                log.push('');
                
                // RÃ©cupÃ©rer un gÃ®te
                const { data: gites, error: giteError } = await supabase
                    .from('gites')
                    .select('id, organization_id, nom')
                    .limit(1);
                    
                if (giteError) {
                    log.push(`âŒ Erreur rÃ©cupÃ©ration gÃ®te: ${giteError.message}`);
                } else if (!gites || gites.length === 0) {
                    log.push('âŒ Aucun gÃ®te trouvÃ©');
                } else {
                    log.push(`âœ… GÃ®te test: ${gites[0].nom}`);
                    log.push(`   Organization: ${gites[0].organization_id}`);
                    log.push('');
                    
                    const testData = {
                        organization_id: gites[0].organization_id,
                        gite_id: gites[0].id,
                        date: '2026-12-31',
                        prix_nuit: 99.99
                    };
                    
                    log.push('Tentative INSERT:');
                    log.push(JSON.stringify(testData, null, 2));
                    log.push('');
                    
                    const { data, error } = await supabase
                        .from('tarifs_base')
                        .upsert(testData, { onConflict: 'gite_id,date' })
                        .select();
                    
                    if (error) {
                        log.push('âŒ Ã‰CHEC:');
                        log.push(`   Message: ${error.message}`);
                        log.push(`   Code: ${error.code || 'N/A'}`);
                        log.push(`   Details: ${JSON.stringify(error.details || {})}`);
                        log.push(`   Hint: ${error.hint || 'N/A'}`);
                        
                        if (error.code === 'PGRST116' || error.code === '42P01') {
                            log.push('');
                            log.push('ğŸš¨ La table tarifs_base N\'EXISTE PAS !');
                        } else if (error.code === '42501') {
                            log.push('');
                            log.push('ğŸš¨ ProblÃ¨me de permissions RLS');
                        }
                    } else {
                        log.push('âœ… INSERT RÃ‰USSI !');
                        log.push('');
                        log.push('DonnÃ©es insÃ©rÃ©es:');
                        log.push(JSON.stringify(data, null, 2));
                    }
                }
            } catch (e) {
                log.push(`ğŸ’¥ Exception: ${e.message}`);
            }
            
            document.getElementById('result').textContent = log.join('\n');
        }
    </script>
</body>
</html>
