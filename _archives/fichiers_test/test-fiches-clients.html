<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Test Fiches Clients - Diagnostic</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 30px; }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #555;
        }
        .result {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 5px;
        }
        button:hover { background: #5568d3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin-top: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Syst√®me Fiches Clients</h1>
        
        <!-- Configuration -->
        <div class="test-section">
            <h2>1Ô∏è‚É£ Configuration Supabase</h2>
            <div id="config-result"></div>
        </div>

        <!-- Tables -->
        <div class="test-section">
            <h2>2Ô∏è‚É£ V√©rification des tables</h2>
            <button onclick="testTables()">üß™ Tester les tables</button>
            <div id="tables-result"></div>
        </div>

        <!-- RLS -->
        <div class="test-section">
            <h2>3Ô∏è‚É£ √âtat du RLS (Row Level Security)</h2>
            <button onclick="testRLS()">üîí V√©rifier RLS</button>
            <div id="rls-result"></div>
        </div>

        <!-- Donn√©es -->
        <div class="test-section">
            <h2>4Ô∏è‚É£ Donn√©es existantes</h2>
            <button onclick="testData()">üìä Analyser les donn√©es</button>
            <div id="data-result"></div>
        </div>

        <!-- Test g√©n√©ration -->
        <div class="test-section">
            <h2>5Ô∏è‚É£ Test g√©n√©ration de token</h2>
            <button onclick="testTokenGeneration()">üé´ G√©n√©rer un token de test</button>
            <div id="token-result"></div>
        </div>

        <!-- Fonctions JS -->
        <div class="test-section">
            <h2>6Ô∏è‚É£ Fonctions JavaScript</h2>
            <button onclick="testJSFunctions()">‚öôÔ∏è V√©rifier les fonctions</button>
            <div id="js-result"></div>
        </div>

        <!-- R√©sum√© -->
        <div class="test-section">
            <h2>üìã R√©sum√©</h2>
            <div id="summary-result"></div>
        </div>
    </div>

    <script>
        let supabase;
        const issues = [];

        // Initialiser Supabase depuis shared-config.js
        async function initSupabase() {
            const configResult = document.getElementById('config-result');
            
            try {
                // Charger shared-config.js
                const response = await fetch('js/shared-config.js');
                const configText = await response.text();
                
                // Extraire l'URL et la cl√© (m√©thode simple)
                const urlMatch = configText.match(/SUPABASE_URL\s*=\s*['"]([^'"]+)['"]/);
                const keyMatch = configText.match(/SUPABASE_ANON_KEY\s*=\s*['"]([^'"]+)['"]/);
                
                if (!urlMatch || !keyMatch) {
                    throw new Error('Impossible de trouver les credentials Supabase');
                }
                
                const SUPABASE_URL = urlMatch[1];
                const SUPABASE_KEY = keyMatch[1];
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                configResult.innerHTML = `
                    <div class="result success">‚úÖ Supabase initialis√©</div>
                    <div class="result info">üìç URL: ${SUPABASE_URL.substring(0, 30)}...</div>
                `;
            } catch (error) {
                configResult.innerHTML = `
                    <div class="result error">‚ùå Erreur: ${error.message}</div>
                `;
                issues.push('Configuration Supabase');
            }
        }

        async function testTables() {
            const result = document.getElementById('tables-result');
            result.innerHTML = '<div class="result info">‚è≥ V√©rification en cours...</div>';
            
            const requiredTables = [
                'infos_gites',
                'checklists',
                'checklist_validations',
                'demandes_horaires',
                'retours_clients',
                'client_access_tokens',
                'fiche_generation_logs',
                'activites_consultations'
            ];
            
            let html = '';
            let missingTables = [];
            
            for (const table of requiredTables) {
                try {
                    const { data, error } = await supabase.from(table).select('id').limit(1);
                    
                    if (error && error.message.includes('does not exist')) {
                        html += `<div class="result error">‚ùå Table manquante: ${table}</div>`;
                        missingTables.push(table);
                    } else if (error) {
                        html += `<div class="result warning">‚ö†Ô∏è ${table}: ${error.message}</div>`;
                    } else {
                        html += `<div class="result success">‚úÖ ${table}: OK</div>`;
                    }
                } catch (err) {
                    html += `<div class="result error">‚ùå ${table}: ${err.message}</div>`;
                }
            }
            
            if (missingTables.length > 0) {
                issues.push(`Tables manquantes: ${missingTables.join(', ')}`);
                html += `<div class="result error" style="margin-top: 20px;">
                    <strong>üîß Action requise:</strong><br>
                    Ex√©cutez le script <code>sql/create_fiches_clients_tables.sql</code> dans Supabase SQL Editor
                </div>`;
            }
            
            result.innerHTML = html;
            updateSummary();
        }

        async function testRLS() {
            const result = document.getElementById('rls-result');
            result.innerHTML = '<div class="result info">‚è≥ V√©rification RLS...</div>';
            
            try {
                // On ne peut pas v√©rifier directement le RLS via l'API
                // Mais on peut tester l'acc√®s
                const { data, error } = await supabase
                    .from('client_access_tokens')
                    .select('*')
                    .limit(1);
                
                if (error && error.message.includes('row-level security')) {
                    result.innerHTML = `
                        <div class="result error">‚ùå RLS est ACTIV√â - Les clients ne pourront pas acc√©der aux fiches</div>
                        <div class="result warning" style="margin-top: 10px;">
                            <strong>üîß Action requise:</strong><br>
                            Ex√©cutez le script <code>sql/force_disable_rls.sql</code> dans Supabase SQL Editor
                        </div>
                    `;
                    issues.push('RLS activ√©');
                } else {
                    result.innerHTML = `<div class="result success">‚úÖ RLS d√©sactiv√© correctement</div>`;
                }
            } catch (err) {
                result.innerHTML = `<div class="result error">‚ùå Erreur test RLS: ${err.message}</div>`;
            }
            
            updateSummary();
        }

        async function testData() {
            const result = document.getElementById('data-result');
            result.innerHTML = '<div class="result info">‚è≥ Analyse des donn√©es...</div>';
            
            try {
                // Compter les donn√©es
                const { count: reservations } = await supabase.from('reservations').select('*', { count: 'exact', head: true });
                const { count: gites } = await supabase.from('infos_gites').select('*', { count: 'exact', head: true });
                const { count: checklists } = await supabase.from('checklists').select('*', { count: 'exact', head: true });
                const { count: tokens } = await supabase.from('client_access_tokens').select('*', { count: 'exact', head: true });
                
                let html = '<div class="stats">';
                html += `<div class="stat-card"><div class="stat-value">${reservations || 0}</div><div class="stat-label">R√©servations</div></div>`;
                html += `<div class="stat-card"><div class="stat-value">${gites || 0}</div><div class="stat-label">G√Ætes configur√©s</div></div>`;
                html += `<div class="stat-card"><div class="stat-value">${checklists || 0}</div><div class="stat-label">Checklists</div></div>`;
                html += `<div class="stat-card"><div class="stat-value">${tokens || 0}</div><div class="stat-label">Fiches g√©n√©r√©es</div></div>`;
                html += '</div>';
                
                if (gites === 0) {
                    html += `<div class="result warning" style="margin-top: 20px;">
                        ‚ö†Ô∏è Aucun g√Æte configur√©. Allez dans l'onglet "Fiches Clients" ‚Üí "Configuration g√Ætes"
                    </div>`;
                    issues.push('G√Ætes non configur√©s');
                }
                
                result.innerHTML = html;
            } catch (err) {
                result.innerHTML = `<div class="result error">‚ùå Erreur: ${err.message}</div>`;
            }
            
            updateSummary();
        }

        async function testTokenGeneration() {
            const result = document.getElementById('token-result');
            result.innerHTML = '<div class="result info">‚è≥ G√©n√©ration d\'un token de test...</div>';
            
            try {
                // R√©cup√©rer une r√©servation
                const { data: reservations } = await supabase
                    .from('reservations')
                    .select('*')
                    .limit(1);
                
                if (!reservations || reservations.length === 0) {
                    result.innerHTML = `<div class="result warning">‚ö†Ô∏è Aucune r√©servation disponible pour tester</div>`;
                    return;
                }
                
                const reservation = reservations[0];
                
                // G√©n√©rer un token
                const token = Array.from(crypto.getRandomValues(new Uint8Array(32)), 
                    byte => byte.toString(16).padStart(2, '0')).join('');
                
                const expiresAt = new Date(reservation.date_fin || new Date());
                expiresAt.setDate(expiresAt.getDate() + 7);
                
                const { data, error } = await supabase
                    .from('client_access_tokens')
                    .insert({
                        token: token,
                        reservation_id: reservation.id,
                        expires_at: expiresAt.toISOString()
                    })
                    .select();
                
                if (error) {
                    result.innerHTML = `<div class="result error">‚ùå Erreur g√©n√©ration: ${error.message}</div>`;
                    issues.push('G√©n√©ration de token');
                } else {
                    const ficheUrl = `${window.location.origin}/fiche-client.html?token=${token}`;
                    result.innerHTML = `
                        <div class="result success">‚úÖ Token g√©n√©r√© avec succ√®s</div>
                        <div class="result info" style="margin-top: 10px;">
                            <strong>R√©servation:</strong> ${reservation.nom_client || reservation.nom}<br>
                            <strong>Token:</strong> ${token.substring(0, 20)}...<br>
                            <strong>Expire:</strong> ${expiresAt.toLocaleDateString()}<br><br>
                            <strong>URL de la fiche:</strong><br>
                            <a href="${ficheUrl}" target="_blank" style="color: #667eea; word-break: break-all;">${ficheUrl}</a>
                        </div>
                        <button onclick="window.open('${ficheUrl}', '_blank')" style="margin-top: 15px;">
                            üåê Ouvrir la fiche de test
                        </button>
                    `;
                }
            } catch (err) {
                result.innerHTML = `<div class="result error">‚ùå Erreur: ${err.message}</div>`;
            }
            
            updateSummary();
        }

        async function testJSFunctions() {
            const result = document.getElementById('js-result');
            
            const functions = [
                { name: 'aper√ßuFicheClient', global: 'window.aper√ßuFicheClient' },
                { name: 'getAllReservations', global: 'window.getAllReservations' },
                { name: 'supabaseClient', global: 'window.supabaseClient' },
                { name: 'initFichesClients', global: 'window.initFichesClients' }
            ];
            
            let html = '';
            let missingFunctions = [];
            
            for (const func of functions) {
                try {
                    const exists = eval(`typeof ${func.global}`) !== 'undefined';
                    if (exists) {
                        html += `<div class="result success">‚úÖ ${func.name}: Disponible</div>`;
                    } else {
                        html += `<div class="result error">‚ùå ${func.name}: Non trouv√©e</div>`;
                        missingFunctions.push(func.name);
                    }
                } catch (err) {
                    html += `<div class="result error">‚ùå ${func.name}: ${err.message}</div>`;
                }
            }
            
            if (missingFunctions.length > 0) {
                issues.push(`Fonctions JS manquantes: ${missingFunctions.join(', ')}`);
            }
            
            result.innerHTML = html;
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary-result');
            
            if (issues.length === 0) {
                summary.innerHTML = `
                    <div class="result success" style="font-size: 1.1rem; padding: 20px;">
                        üéâ <strong>Tout fonctionne parfaitement !</strong><br><br>
                        Le syst√®me de fiches clients est op√©rationnel.<br>
                        Testez en cliquant sur "üìÑ Fiche Client" dans le dashboard.
                    </div>
                `;
            } else {
                summary.innerHTML = `
                    <div class="result error" style="font-size: 1.1rem; padding: 20px;">
                        ‚ö†Ô∏è <strong>${issues.length} probl√®me(s) d√©tect√©(s):</strong><br><br>
                        ${issues.map(i => `‚Ä¢ ${i}`).join('<br>')}
                    </div>
                `;
            }
        }

        // Auto-init
        window.addEventListener('DOMContentLoaded', async () => {
            await initSupabase();
        });
    </script>
</body>
</html>
