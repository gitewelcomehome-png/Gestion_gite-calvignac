<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Debug Vercel - Retours M√©nage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>üîç Diagnostic Retours M√©nage</h1>
    <div id="results"></div>
    
    <script src="js/shared-config.js"></script>
    <script>
        async function diagnostic() {
            const div = document.getElementById('results');
            let html = '<h2>Tests en cours...</h2>';
            
            // Test 1: V√©rifier supabaseClient
            html += '<h3>1Ô∏è‚É£ Test Supabase Client</h3>';
            if (window.supabaseClient) {
                html += '<p class="success">‚úÖ window.supabaseClient charg√©</p>';
            } else {
                html += '<p class="error">‚ùå window.supabaseClient non d√©fini</p>';
                div.innerHTML = html;
                return;
            }
            
            // Test 2: Tester la table
            html += '<h3>2Ô∏è‚É£ Test Table retours_menage</h3>';
            try {
                const { data, error } = await window.supabaseClient
                    .from('retours_menage')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    if (error.code === '42P01') {
                        html += '<p class="error">‚ùå TABLE N\'EXISTE PAS dans Supabase</p>';
                        html += '<p>üëâ Vous devez ex√©cuter sql/create_retours_menage.sql dans Supabase SQL Editor</p>';
                    } else {
                        html += '<p class="error">‚ùå Erreur: ' + error.message + '</p>';
                    }
                } else {
                    html += '<p class="success">‚úÖ Table accessible</p>';
                }
            } catch (e) {
                html += '<p class="error">‚ùå Exception: ' + e.message + '</p>';
            }
            
            // Test 3: Compter les retours
            html += '<h3>3Ô∏è‚É£ Comptage Retours</h3>';
            try {
                const { count: total } = await window.supabaseClient
                    .from('retours_menage')
                    .select('*', { count: 'exact', head: true });
                
                const { count: nonValides } = await window.supabaseClient
                    .from('retours_menage')
                    .select('*', { count: 'exact', head: true })
                    .eq('validated', false);
                
                html += '<p>Total retours: <strong>' + (total || 0) + '</strong></p>';
                html += '<p>Retours non valid√©s: <strong>' + (nonValides || 0) + '</strong></p>';
                
                if (nonValides === 0) {
                    html += '<p class="error">‚ö†Ô∏è Aucun retour en attente ‚Üí Les alertes ne s\'afficheront pas</p>';
                }
            } catch (e) {
                html += '<p class="error">‚ùå Impossible de compter: ' + e.message + '</p>';
            }
            
            // Test 4: V√©rifier version dashboard.js
            html += '<h3>4Ô∏è‚É£ Cache Dashboard</h3>';
            const scripts = document.querySelectorAll('script[src*="dashboard.js"]');
            if (scripts.length > 0) {
                html += '<p>Script d√©tect√©: ' + scripts[0].src + '</p>';
            }
            html += '<p>üëâ Rafra√Æchir avec <kbd>Ctrl+Shift+R</kbd> (Windows/Linux) ou <kbd>Cmd+Shift+R</kbd> (Mac)</p>';
            
            div.innerHTML = html;
        }
        
        setTimeout(diagnostic, 500);
    </script>
</body>
</html>
